{"data":{"site":{"siteMetadata":{"title":"Takumon Blog","author":"Takuto Inoue"}},"markdownRemark":{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AppSyncのリゾルバーでDynamoDBのデータを更新する場合、更新処理の前に入力チェックは必ず実施すると思います。\nこの時、入力チェックエラーを見つけた時点で1つのエラーメッセージを返すより、\nすべてのチェック実施後にまとめてエラーメッセージを返してあげたほうが、AppSyncの呼び出し側としては助かります。\nただ、このやり方は調べてもあまり出てきませんでした。そのため本記事で紹介します。</p>\n<h2 id=\"結論\"><a href=\"#%E7%B5%90%E8%AB%96\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論</h2>\n<p>たとえば、人(ID、名前、組織名)を更新する場合</p>\n<div class=\"gatsby-code-title\">人(ID、名前、組織名)を更新するmutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  updatePerson <span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    id\n    name\n    organizationName\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    person <span class=\"token punctuation\">{</span>\n      id\n      name\n      organizationName\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>以下のようにリクエストマッピングテンプレートのVTLを記述します。</p>\n<div class=\"gatsby-code-title\">複数エラーメッセージを返すVTL</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n</span><span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n</span><span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n</span><span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n</span><span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>outErrors<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token directive\"><span class=\"token keyword\">#return</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>outErrors</span><span class=\"token punctuation\">)</span></span>\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n</span>\n{\n  \"operation\" : \"PutItem\",\n  \"key\" : {\n    \"id\" : { \"S\" : \"<span class=\"token variable\">$<span class=\"token punctuation\">{</span>ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span>\" }\n  },\n  \"condition\" : {\n    \"expression\" : \"attribute_exists(id)\"\n  },\n  \"attributeValues\" : <span class=\"token variable\">$util<span class=\"token punctuation\">.</span>dynamodb<span class=\"token punctuation\">.</span><span class=\"token function\">toMapValuesJson</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">)</span></span>\n}</code></pre></div>\n<br/>\n<h2 id=\"実際どのようなレスポンスが返ってくるか\"><a href=\"#%E5%AE%9F%E9%9A%9B%E3%81%A9%E3%81%AE%E3%82%88%E3%81%86%E3%81%AA%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%81%8C%E8%BF%94%E3%81%A3%E3%81%A6%E3%81%8F%E3%82%8B%E3%81%8B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実際どのようなレスポンスが返ってくるか</h2>\n<p>以下のmutationを発行してみると...</p>\n<div class=\"gatsby-code-title\">複数の入力チェックエラーになるようなmutation</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">mutation</span> <span class=\"token punctuation\">{</span>\n  updatePerson<span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1234\"</span>\n    <span class=\"token attr-name\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前\"</span>\n    <span class=\"token attr-name\">organizationName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    person <span class=\"token punctuation\">{</span>\n      id\n      name\n      organizationName\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>複数エラーメッセージを含むレスポンスが返ってきます！</p>\n<div class=\"gatsby-code-title\">複数エラーメッセージを含むレスポンス</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"updatePerson\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"person\"</span><span class=\"token punctuation\">:</span> null\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"errors\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token string\">\"updatePerson\"</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> null<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"errorType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"errorInfo\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前あきらかに文字数オーバーの名前\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"locations\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"line\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"column\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"sourceName\"</span><span class=\"token punctuation\">:</span> null\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"名前は30文字以下で入力してください。\"</span>\n</span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"path\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token string\">\"updatePerson\"</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"data\"</span><span class=\"token punctuation\">:</span> null<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"errorType\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"errorInfo\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名あきらかに文字数オーバーの組織名\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"locations\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"line\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"column\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token string\">\"sourceName\"</span><span class=\"token punctuation\">:</span> null\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"message\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span>\n</span>    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<h2 id=\"結論に至るまでの試行錯誤\"><a href=\"#%E7%B5%90%E8%AB%96%E3%81%AB%E8%87%B3%E3%82%8B%E3%81%BE%E3%81%A7%E3%81%AE%E8%A9%A6%E8%A1%8C%E9%8C%AF%E8%AA%A4\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>結論に至るまでの試行錯誤</h2>\n<p><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/resolver-util-reference.html\">AppSyncの公式ドキュメント</a>を見ると、<code class=\"language-text\">$util.appendError</code>が使えそうだと思ったのですが、いざ書こうとすると、以下2点につまづきました。</p>\n<ol>\n<li>「1つ以上入力チェックエラーがある」ことをどうやって判定するのか</li>\n<li>複数エラー情報をどうやってレスポンスとして返すのか</li>\n</ol>\n<h3 id=\"1-「1つ以上入力チェックエラーがある」ことをどうやって判定するのか\"><a href=\"#1-%E3%80%8C1%E3%81%A4%E4%BB%A5%E4%B8%8A%E5%85%A5%E5%8A%9B%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E3%81%82%E3%82%8B%E3%80%8D%E3%81%93%E3%81%A8%E3%82%92%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E5%88%A4%E5%AE%9A%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 「1つ以上入力チェックエラーがある」ことをどうやって判定するのか</h3>\n<p>最初に考えたのは、<code class=\"language-text\">#set($valid=true)</code>のようにフラグで判断する方法です。</p>\n<div class=\"gatsby-code-title\">validフラグで判定する方法</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\"><span class=\"gatsby-highlight-code-line\"><span class=\"token velocity-comment comment\">## 事前にフラグを定義しておく</span>\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span></span>\n</span>\n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token velocity-comment comment\">## チェックNGの場合はフラグを更新</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n</span>  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n</span>  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n</span>  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span><span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n</span>  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$valid</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token velocity-comment comment\">## 異常時の処理</span>\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n</span></code></pre></div>\n<br/>\n<p>ただこれだと記述が冗長です。<br/>\nappendErrorしたエラーはどこに格納されているのか？<br/>\n<code class=\"language-text\">$util.error($util.toJson($context))</code>をして<code class=\"language-text\">$context</code>の中身を確認してみると、\nどうやら<code class=\"language-text\">$context.outErrors</code>に格納されているということがわかりました。<br/>\nそれを踏まえて処理を以下のようにリファクタリングしました。</p>\n<div class=\"gatsby-code-title\">validフラグを使わずに判定する方法</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"名前は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrBlank</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span> \n<span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span></span>)\n  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">appendError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"組織名は30文字以下で入力してください。\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"organizationName\"</span><span class=\"token punctuation\">,</span> null<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">.</span>organizationName<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>outErrors<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token velocity-comment comment\">## 異常時の処理</span>\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n</span></code></pre></div>\n<br/>\n<h3 id=\"2-複数エラー情報をどうやってレスポンスとして返すのか\"><a href=\"#2-%E8%A4%87%E6%95%B0%E3%82%A8%E3%83%A9%E3%83%BC%E6%83%85%E5%A0%B1%E3%82%92%E3%81%A9%E3%81%86%E3%82%84%E3%81%A3%E3%81%A6%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%81%A8%E3%81%97%E3%81%A6%E8%BF%94%E3%81%99%E3%81%AE%E3%81%8B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 複数エラー情報をどうやってレスポンスとして返すのか</h3>\n<p><code class=\"language-text\">$util.appendError</code>はエラーを追加してくれるだけです。<code class=\"language-text\">$util.error</code>は1つのエラー情報しか返してくれません。<br/>\n試行錯誤した結果、<code class=\"language-text\">#return</code>で返せそうだということがわかりました。<br/>\n1の調査結果により<code class=\"language-text\">$util.appendError</code>で詰めたエラー情報は<code class=\"language-text\">$ctx.outErrors</code>に格納されていることがわかっていたので、\nそれら踏まえて以下のようにしました。</p>\n<div class=\"gatsby-code-title\">エラー時に複数エラーメッセージを返すにはreturnを使う</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\">  <span class=\"token directive\"><span class=\"token keyword\">#return</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>outErrors</span><span class=\"token punctuation\">)</span></span></code></pre></div>\n<br/>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>VLTは結構めんどくさいですが、ちょっとずつ慣れてきました。\nググってもAppSyncのVTL系の情報は、まだあまり見かけません。そのため今後もノウハウがたまったら記事を書きます🍅</p>","headingsDetail":[{"id":"なにこれ","value":"なにこれ","depth":2,"parents":[]},{"id":"結論","value":"結論","depth":2,"parents":[]},{"id":"実際どのようなレスポンスが返ってくるか","value":"実際どのようなレスポンスが返ってくるか","depth":2,"parents":[]},{"id":"結論に至るまでの試行錯誤","value":"結論に至るまでの試行錯誤","depth":2,"parents":[]},{"id":"1-「1つ以上入力チェックエラーがある」ことをどうやって判定するのか","value":"1. 「1つ以上入力チェックエラーがある」ことをどうやって判定するのか","depth":3,"parents":[{"id":"結論に至るまでの試行錯誤","value":"結論に至るまでの試行錯誤","depth":2}]},{"id":"2-複数エラー情報をどうやってレスポンスとして返すのか","value":"2. 複数エラー情報をどうやってレスポンスとして返すのか","depth":3,"parents":[{"id":"結論に至るまでの試行錯誤","value":"結論に至るまでの試行錯誤","depth":2}]},{"id":"まとめ","value":"まとめ","depth":2,"parents":[]}],"fields":{"title":"AWS AppSyncで入力チェックエラーを複数返す方法","excerpt":"なにこれAppSyncのリゾルバーでDynamoDBのデータを更新する場合、更新処理の前に入力チェックは必ず実施すると思います。この時、入力チェックエラーを見つけた時点で1つのエラーメッセージを返すより、すべてのチェック実施後にまとめてエラ...","date":"2019-02-26T07:30:00.000+09:00","tags":["AppSync","AWS","GraphQL"],"thumbnail":"thumbnail/2019/02/mutliple-validation-errors-in-aws-appsync.png"}}},"pageContext":{"slug":"/mutliple-validation-errors-in-aws-appsync","relatedPosts":[{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AWSのGraphQLマネージドサービス「<a href=\"https://aws.amazon.com/jp/appsync/\">AppSync</a>」はGUIで簡単に設定ができて便利ですが、\n本格的に開発を進めていくとGUIポチポチでソースコードを管理するのはつらくなってきます。\n<strong><a href=\"https://serverless.com/\">Serverless Framework</a>というツールと<a href=\"https://github.com/sid88in/serverless-appsync-plugin\">serverless-appsync-plugin</a>（Serverless Frameworkのプラグイン）を使うと、AppSyncの設定をymlファイルで管理し、CLIでAWS上にデプロイできるので、GitHub等で構成管理が可能になります。</strong>\n今回はAppSyncからDynamoDBのユーザー情報を1件取得する場合を例にしてAppSync + Serverless Frameworkの使い方をご紹介します。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b4e940dd98c7ab5be67d93e353ffd018/57373/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 27.04186684969115%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABcRAAAXEQHKJvM/AAABOUlEQVQY012PvU7DQAzH8xLwQuwdmVh4ERbUhVfgY+ABWBgQLMwIUEWhLbS95tK4adLQpvm4JJc7n7lmQAJLP/kv27L/djjn90QUK6XmFmiaBogMGGNavaOqqjZLKS11S13XgFpBWTWwLSQY1Is8z5kDAG9aa9okCQkhyBgiz5uT7wMphbSLLMvJDtP/yERNh6c3dHByR+9+aiuoHMbYi4UAfDUafeLMX2Pvg+Frf4LM6kW4xvGYoet6GKxShFWBPEgQwhSfh3Pc63Rx/+gKrx8n1ooRThAse4PBiM4vLs1kykhbU0Uh7IEFxXFM9lUKlhGFkdVKt27DMCKPc8pFRcdnt9TpPlCfJ3afrp2Z6z2lJdL3tq4yoaSopLTefynKRg5ZJL94bPXfXrwRcgZbOfWT2oWNLMsq/QGLmW71JK3q7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"image\"\n        title=\"\"\n        src=\"/static/b4e940dd98c7ab5be67d93e353ffd018/42603/image.png\"\n        srcset=\"/static/b4e940dd98c7ab5be67d93e353ffd018/f931c/image.png 200w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/e8031/image.png 400w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/42603/image.png 800w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/5b8b9/image.png 1200w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/c7ea5/image.png 1600w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/bc63a/image.png 2400w,\n/static/b4e940dd98c7ab5be67d93e353ffd018/57373/image.png 2914w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol>\n<li><a href=\"#1-serverless-framework%E3%81%AE%E8%A8%AD%E5%AE%9A\">🔰 Serverless Frameworkの設定</a></li>\n<li><a href=\"#2-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%81%B2%E3%81%AA%E5%9E%8B%E4%BD%9C%E6%88%90\">💪 プロジェクトのひな型作成</a></li>\n<li><a href=\"#3-%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BD%9C%E6%88%90\">📝 設定ファイル作成</a></li>\n<li><a href=\"#4-%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E4%BD%9C%E6%88%90\">💖 リゾルバー作成</a></li>\n<li><a href=\"#5-%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E4%BD%9C%E6%88%90\">💎 スキーマ作成</a></li>\n<li><a href=\"#6-aws%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4\">🎊 AWSにデプロイ</a></li>\n</ol>\n<h2 id=\"1-serverless-frameworkの設定\"><a href=\"#1-serverless-framework%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Serverless Frameworkの設定</h2>\n<ul>\n<li>Serverless Frameworkはnpmで提供されるCLIツールです。まずはnpmでインストールします。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm i -g serverless</code></pre></div>\n<ul>\n<li>クレデンシャルを設定します（事前にIAMでユーザを作成しておいてください）</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">serverless config credentials --provider aws --key AKIAIOSFODNN7EXAMPLE --secret wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</code></pre></div>\n<p><small>※詳細：<a href=\"https://serverless.com/framework/docs/providers/aws/guide/credentials#using-aws-profiles\">Serverless Framework - AWS Lambda Guide - Credentials</a></small></p>\n<h2 id=\"2-プロジェクトのひな型作成\"><a href=\"#2-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E3%81%B2%E3%81%AA%E5%9E%8B%E4%BD%9C%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. プロジェクトのひな型作成</h2>\n<p>プロジェクトのひな型を作ります。\nServerless FrameworkでAppSync資産を扱えるように、<a href=\"https://github.com/sid88in/serverless-appsync-plugin\">serverless-appsync-plugin</a>と<a href=\"https://github.com/aws/aws-sdk-js\">aws-sdk</a>をインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">mkdir appsync-sample-with-serverless\ncd appsync-sample-with-serverless\nnpm init -y\nnpm i serverless-appsync-plugin aws-sdk</code></pre></div>\n<br/>\n<h2 id=\"3-設定ファイル作成\"><a href=\"#3-%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E4%BD%9C%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 設定ファイル作成</h2>\n<p>プロジェクト直下にServerless Frameworkの設定ファイル<code class=\"language-text\">serverless.yml</code>を作ります。<br/>\n<small>※ここではserverless.ymlの全量を示して、次のセクションでブロックごとに詳細を説明します。</small></p>\n<div class=\"gatsby-code-title\">serverless.yml</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># サービス名</span>\n<span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> appsync<span class=\"token punctuation\">-</span>sample<span class=\"token punctuation\">-</span>with<span class=\"token punctuation\">-</span>serverless\n<span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token comment\"># ステージ、デプロイ先を開発、運用などで分けたい場合はココを切り替えます</span>\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> production\n  <span class=\"token comment\"># デプロイ先のリージョンです</span>\n  <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n<span class=\"token comment\"># AppSyncのプラグインを指定します</span>\n<span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> serverless<span class=\"token punctuation\">-</span>appsync<span class=\"token punctuation\">-</span>plugin\n<span class=\"token comment\"># プラグイン関連の設定はcustomで行います</span>\n<span class=\"token key atrule\">custom</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># ここでAppSyncの設定を行います</span>\n  <span class=\"token key atrule\">appSync</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># エンドポイントの名前を指定します</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> appsync<span class=\"token punctuation\">-</span>serverless<span class=\"token punctuation\">-</span>sample\n    <span class=\"token comment\"># AppSyncの認証方法を指定します</span>\n    <span class=\"token comment\"># ここではCognitoによる認証方法を指定しています</span>\n    <span class=\"token key atrule\">authenticationType</span><span class=\"token punctuation\">:</span> AMAZON_COGNITO_USER_POOLS\n    <span class=\"token comment\"># Cogtnitoによる認証方法の場合、Cognito側の情報を指定する必要があります</span>\n    <span class=\"token key atrule\">userPoolConfig</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Cognitoが存在するリージョンを指定します</span>\n      <span class=\"token comment\"># デフォルトだとproviderのregionで指定した値になります</span>\n      <span class=\"token key atrule\">awsRegion</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n      <span class=\"token comment\"># CognitoのユーザープールのIDを指定します</span>\n      <span class=\"token key atrule\">userPoolId</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span>1_U0e7zFRLQ\n      <span class=\"token comment\"># スキーマ定義で認証設定が記述されていない場合の挙動を指定します</span>\n      <span class=\"token comment\"># DENYを指定すると、認証されたいかなるユーザーも認可エラーに倒します</span>\n      <span class=\"token key atrule\">defaultAction</span><span class=\"token punctuation\">:</span> DENY\n    <span class=\"token comment\"># AppSyncのスキーマ定義ファイルのパスを指定します</span>\n    <span class=\"token comment\"># デフォルトだとschema.graphqlです</span>\n    <span class=\"token key atrule\">schema</span><span class=\"token punctuation\">:</span> schema.graphql\n    <span class=\"token comment\"># データソースを指定します(複数指定可能)</span>\n    <span class=\"token key atrule\">dataSources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># データソースの型を指定します</span>\n      <span class=\"token comment\"># 以下が指定できます</span>\n      <span class=\"token comment\"># AMAZON_DYNAMODB ・・・DynamoDB</span>\n      <span class=\"token comment\"># AMAZON_ELASTICSEARCH ・・・Elasticsearch</span>\n      <span class=\"token comment\"># AWS_LAMBDA ・・・Lambda関数</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> AMAZON_DYNAMODB\n        <span class=\"token comment\"># データソース名を指定します</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dynamo_user\n        <span class=\"token comment\"># DynamoDBのテーブルの説明を指定します</span>\n        <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ユーザー情報テーブル'</span>\n        <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># 参照するテーブル名を指定します</span>\n          <span class=\"token key atrule\">tableName</span><span class=\"token punctuation\">:</span> dynamo_user\n          <span class=\"token comment\"># データソースのロールARNを指定します</span>\n          <span class=\"token key atrule\">serviceRoleArn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>999999999999<span class=\"token punctuation\">:</span>role/sample_role_arn\n          <span class=\"token comment\"># データソースのリージョンを指定します</span>\n          <span class=\"token comment\"># デフォルトだとproviderのregionで指定した値になります</span>\n          <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n    <span class=\"token comment\"># マッピングテンプレートのVTLファイルの格納先を指定します</span>\n    <span class=\"token comment\"># デフォルトはmapping-templatesです</span>\n    <span class=\"token key atrule\">mappingTemplatesLocation</span><span class=\"token punctuation\">:</span> mapping<span class=\"token punctuation\">-</span>templates\n    <span class=\"token comment\"># リゾルバー定義を指定します</span>\n    <span class=\"token comment\"># ※ここではPipeline Resolverの例を示します</span>\n    <span class=\"token key atrule\">mappingTemplates</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># リゾルバーの方を指定します</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Query\n        <span class=\"token comment\"># リゾルバーを紐づけるスキーマ中のフィールド名を指定します</span>\n        <span class=\"token key atrule\">field</span><span class=\"token punctuation\">:</span> user\n        <span class=\"token comment\"># Pipeline Resolverを使い場合、以下を指定します</span>\n        <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PIPELINE\n        <span class=\"token comment\"># リクエストマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token comment\"># ファイルパスはmappingTemplatesLocationで指定したパスからの相対パスになります</span>\n        <span class=\"token key atrule\">request</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'start.vtl'</span>\n        <span class=\"token comment\"># レスポンスマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token key atrule\">response</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'end.vtl'</span>\n        <span class=\"token comment\"># リゾルバーで使う関数を実行順に指定します</span>\n        <span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> GetUser\n    <span class=\"token comment\"># 関数定義を指定します</span>\n    <span class=\"token key atrule\">functionConfigurations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># ユーザー一覧取得</span>\n        <span class=\"token comment\"># 関数で扱うデータソース名を指定します</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">dataSource</span><span class=\"token punctuation\">:</span> dynamo_user\n        <span class=\"token comment\"># 関数名を指定します</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser'</span>\n        <span class=\"token comment\"># 関数のリクエストマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token comment\"># ファイルパスはmappingTemplatesLocationで指定したパスからの相対パスになります</span>\n        <span class=\"token key atrule\">request</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser.req.vtl'</span>\n        <span class=\"token comment\"># 関数のレスポンスマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token key atrule\">response</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser.res.vtl'</span></code></pre></div>\n<br/>\n<p>以下で、<code class=\"language-text\">serverless.yml</code>に定義したプロパティがAWSコンソール上のどの項目に紐づくかを説明します。</p>\n<h3 id=\"appsyncの基本設定\"><a href=\"#appsync%E3%81%AE%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AppSyncの基本設定</h3>\n<div class=\"gatsby-code-title\">serverless.ymlからAppSyncの基本設定を抜粋</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token comment\"># ここでAppSyncの設定を行います</span>\n  <span class=\"token key atrule\">appSync</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># エンドポイントの名前を指定します</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> appsync<span class=\"token punctuation\">-</span>serverless<span class=\"token punctuation\">-</span>sample\n    <span class=\"token comment\"># AppSyncの認証方法を指定します</span>\n    <span class=\"token comment\"># ここではCognitoによる認証方法を指定しています</span>\n    <span class=\"token key atrule\">authenticationType</span><span class=\"token punctuation\">:</span> AMAZON_COGNITO_USER_POOLS\n    <span class=\"token comment\"># Cogtnitoによる認証方法の場合、Cognito側の情報を指定する必要があります</span>\n    <span class=\"token key atrule\">userPoolConfig</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Cognitoが存在するリージョンを指定します</span>\n      <span class=\"token comment\"># デフォルトだとproviderのregionで指定した値になります</span>\n      <span class=\"token key atrule\">awsRegion</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span>\n      <span class=\"token comment\"># CognitoのユーザープールのIDを指定します</span>\n      <span class=\"token key atrule\">userPoolId</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span>1_U0e7zFRLQ\n      <span class=\"token comment\"># スキーマ定義で認証設定が記述されていない場合の挙動を指定します</span>\n      <span class=\"token comment\"># DENYを指定すると、認証されたいかなるユーザーも認可エラーに倒します</span>\n      <span class=\"token key atrule\">defaultAction</span><span class=\"token punctuation\">:</span> DENY</code></pre></div>\n<br/>\n<p>AWSコンソールのAppSyncの画面で、エンドポイント一覧が表示されます。\n<code class=\"language-text\">serverless.yml</code>で定義したエンドポイント名はココで確認できます。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0d72e5f2831b7d4fea63c5eda934a0c0/754f7/appsync-gui-main-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 53.31715210355987%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABcRAAAXEQHKJvM/AAAB1ElEQVQoz42Sy3KbMBSGebv2JdpF+3bNNLvaronKrvY6m8TZkICpAWNA3C8H/T2SGceTZlHNfHMkwfl1bpbn+VvXde/CMHKklI7McydNUyeKY2cfBM6L7zvPnud4bPX5Lf5+r63g75tvNzcfLfBq2xbvLcXIokAmCwxE5jwp9Q8jf9NrvV5/sWbfniGllEHvx3Gkoixpt9vR84tHVV1TLuW78KNDw0EtV6tPRnCappGFzlHNlvhVHV3BHJMEZVmiaRrUTHMFnxWLkfaybfuzNYuMOkF1JcgRGrE0y8B1Ms76bhiGtyidjfb55Tivguq8gZproP/IqxplXaPtOnSMTqudaV4xEWqfOyFmQU5ZixlBXWApQWEI6XsoeV9UDUoWl0xxsRW4rhrFaZNuzI/FYhbkDC+d1cIPD6DtFtVmgzJO4Gc1orxCkJYI2e7TCnVP18NgDtwUFuS6TIdDr5KE1OlE2iJNiXgvgz/UZpnptu5y3/fU9R1x3S4Tca6/mRIslkvuMhcej4+A5wG+D7guEATA0xNwf89D2mCYJvzPWq5+frW6adpU42jX4yjqYRDGMkXXicPpJKKEiWIRRpE4hOGFMI5FfDyKiImPic13v7/f3n74C7W6OcaoFOEsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui main 1\"\n        title=\"\"\n        src=\"/static/0d72e5f2831b7d4fea63c5eda934a0c0/42603/appsync-gui-main-1.png\"\n        srcset=\"/static/0d72e5f2831b7d4fea63c5eda934a0c0/f931c/appsync-gui-main-1.png 200w,\n/static/0d72e5f2831b7d4fea63c5eda934a0c0/e8031/appsync-gui-main-1.png 400w,\n/static/0d72e5f2831b7d4fea63c5eda934a0c0/42603/appsync-gui-main-1.png 800w,\n/static/0d72e5f2831b7d4fea63c5eda934a0c0/5b8b9/appsync-gui-main-1.png 1200w,\n/static/0d72e5f2831b7d4fea63c5eda934a0c0/754f7/appsync-gui-main-1.png 1236w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>エンドポイントの画面を開き<code class=\"language-text\">Settings</code>を確認するとuserPoolConfigなどの詳細が確認できます。\nほぼ<code class=\"language-text\">serverless.yml</code>のプロパティ名と一致しているので、なんとなく紐づけがわかると思います。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ebbcece7c06dbe507ee4c1450e51f3f6/68bc8/appsync-gui-main-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 85.01818181818183%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABcRAAAXEQHKJvM/AAACvElEQVQ4y41UXW/TQBD07+d/ICHBM4qgQfQBtQ+tGjVx3NKq8Wdix46/z46b8y2zF5eaUCROWmd9uZvbmZ2zcX5+/s40lz8sy/oahtE0vLycBh8/Te2zs6mFfDZfTE3TnDqOM3Vd983Af2ee5327vr7+YNi2/Z3Go+uIkoQoy0i1Lcle0f+OLYYxXyw+d0pR2e67rBbyQCQBISspZdG2cpemsqwq2e73kkff938FHgc+NoqilfFoWZPm4YGEZcnetkm5LqmnJxKYq5FnRUFZnlOKikXT0B4MAE77UeBdHaQkPwgc48lcTCQA5GqFGY+IAX2fGnNJ+cUFhbsdn0xpmlIDQDFEMwq8q+fnZ2x1HcNznQnzV0eqNORUY2GN6nJEVVXUQE8FaThAk8B+HHprGIaO4XveEZBnsRCrOada1FSKBkLHBA2pKEoqypLKsqIW4HrPcIDix7EpqPAFcFQhYEFDUFo1FAEwirYakGm9gJwMPRHH8QiwaaSCwFBZ26UCVVHXg17tsRmYFyMdX6IWQnU4zNEarlYT3QjTlAgiyyK1WJBYLikNAgq3WwqCNS/WneYq9yddRijW1ff9AZCpJIlUAKGbGwYn8fMnVQDMUaXehAq77hlG76kfGjMKTRluGACZMkysYA9yHFLwo0BF5TaiDTSMkx0xJfYfVyjf6DIjrjebAZA7K4RU9/dEbO7HRxLzOQl4MOfuQk/22+Fw0A05AfsNuNGArjshXnh1JdXdHdHtLSmANdCyhNE3cUJ5Xmi7sBe5UgZ+rbL/04ee72vKfZoeVJ4rVRSqzzIl4ljlaapw7RRfLQAp6KhzAHITtHWH6FnX9XptG0EQfHnry9Hh9AaaVWhK0+5fm8GUkfPdPR3woWfMZrP3WZYhj1cJjJkkicMG5XsZrNdOiM5tQOVfER5/bZjfw3fz8heLbQepoY3dIgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui main 2\"\n        title=\"\"\n        src=\"/static/ebbcece7c06dbe507ee4c1450e51f3f6/42603/appsync-gui-main-2.png\"\n        srcset=\"/static/ebbcece7c06dbe507ee4c1450e51f3f6/f931c/appsync-gui-main-2.png 200w,\n/static/ebbcece7c06dbe507ee4c1450e51f3f6/e8031/appsync-gui-main-2.png 400w,\n/static/ebbcece7c06dbe507ee4c1450e51f3f6/42603/appsync-gui-main-2.png 800w,\n/static/ebbcece7c06dbe507ee4c1450e51f3f6/5b8b9/appsync-gui-main-2.png 1200w,\n/static/ebbcece7c06dbe507ee4c1450e51f3f6/68bc8/appsync-gui-main-2.png 1375w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h3 id=\"データソース定義\"><a href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BD%E3%83%BC%E3%82%B9%E5%AE%9A%E7%BE%A9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>データソース定義</h3>\n<div class=\"gatsby-code-title\">serverless.ymlからデータソース定義を抜粋</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token comment\"># データソースを指定します(複数指定可能)</span>\n    <span class=\"token key atrule\">dataSources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># データソースの型を指定します</span>\n      <span class=\"token comment\"># 以下が指定できます</span>\n      <span class=\"token comment\"># AMAZON_DYNAMODB ・・・DynamoDB</span>\n      <span class=\"token comment\"># AMAZON_ELASTICSEARCH ・・・Elasticsearch</span>\n      <span class=\"token comment\"># AWS_LAMBDA ・・・Lambda関数</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> AMAZON_DYNAMODB\n        <span class=\"token comment\"># データソース名を指定します</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dynamo_user\n        <span class=\"token comment\"># DynamoDBのテーブルの説明を指定します</span>\n        <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ユーザー情報テーブル'</span>\n        <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n          <span class=\"token comment\"># 参照するテーブル名を指定します</span>\n          <span class=\"token key atrule\">tableName</span><span class=\"token punctuation\">:</span> dynamo_user\n          <span class=\"token comment\"># データソースのロールARNを指定します</span>\n          <span class=\"token key atrule\">serviceRoleArn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>999999999999<span class=\"token punctuation\">:</span>role/sample_role_arn\n          <span class=\"token comment\"># データソースのリージョンを指定します</span>\n          <span class=\"token comment\"># デフォルトだとproviderのregionで指定した値になります</span>\n          <span class=\"token key atrule\">region</span><span class=\"token punctuation\">:</span> ap<span class=\"token punctuation\">-</span>northeast<span class=\"token punctuation\">-</span><span class=\"token number\">1</span></code></pre></div>\n<br/>\n<p>エンドポイントの画面を開き<code class=\"language-text\">Data Sources</code>を確認すると\nデータソースが一覧表示されるので、一覧から今回<code class=\"language-text\">serverless.yml</code>に定義したデータソースを選択すると、以下のように詳細が確認できます。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce7642343b110f652569cb878bcb890a/6b2fd/appsync-gui-datasource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 82.09269662921349%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAAClElEQVQ4y32Ub2/aMBDG8/WnfZhpmhia1OVF30xTqcSgGxBISMgoFJIQO84/fPbt7NAqZVstPVIM4fHvuTvj3N7evp/N5t+Wy9XXw+Hg7vd7N45jd+n77uin5z54K3e6WLqT+cpqOvdIS/fHzHO9le/6QeD6vn+zDsPvd6PRO4c2Lv5jSaVwl3HMihJZIVBUNZZ1g6C1lVQaFb2nSWcp7W82cXzjTCaTQd20yDhvGWOglLLKsgyCwIcw2kAYRhCsQ4g2G+BFAfQucBK7KGesNcZE+ckJA3+IWiKcWzpY25OAxJsGkzTD3X6Px+MRG9obkrqusabnnjR9ZhG32+3A8RaLYUsvKSnBuqUpKs9DMZuhoGcuBJZliQBgRfRWz3uSlgDWkHowcNabzRC7WoDlyzKEKEIRBJgT2VOS4Ikxa8yK4kUFHSI6afpOdizpwPlNhNi2qKMINHSQajzGcjpFTmZpnmNBZiZeQ7Vu2k7S0FKJiFaTrGGSJAMnvrsbou+jHo1AEwnS6crEXa3wdDjgkYhTEhX+Je5fkaXsGcbx68imhvM5CjokJ8MsZy+EFdXaNKZvbAjhUsPOMAg6w7oGTWS4WKAiOmPIqIaHJLVNMUb9prw27Eder2lsNOqqAr3bmVYhbLco4hhPRPtEhukpt3SmZmDivhnZGPYjX+awIINclHg8MTyQxIXyfD5fx75qynPkviGRmLFIcm4Hu27qrrNkJC/Re4vi6aumnE6ofv2S+uFB43is4f5ei+lUp/FWU5e1EIW+XhcyK7gQ0o2iOXx8/GLPqSpt5pEyId0vrDhHe8dFhS0ofGspk93eieyz+bf5aIrdnM+8lbI0qtu2TLKsTHNulTFeCiH+KxorbuoaRdGHP06Xvi0j2WSQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui datasource\"\n        title=\"\"\n        src=\"/static/ce7642343b110f652569cb878bcb890a/42603/appsync-gui-datasource.png\"\n        srcset=\"/static/ce7642343b110f652569cb878bcb890a/f931c/appsync-gui-datasource.png 200w,\n/static/ce7642343b110f652569cb878bcb890a/e8031/appsync-gui-datasource.png 400w,\n/static/ce7642343b110f652569cb878bcb890a/42603/appsync-gui-datasource.png 800w,\n/static/ce7642343b110f652569cb878bcb890a/5b8b9/appsync-gui-datasource.png 1200w,\n/static/ce7642343b110f652569cb878bcb890a/6b2fd/appsync-gui-datasource.png 1424w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h3 id=\"リゾルバー定義\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E5%AE%9A%E7%BE%A9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバー定義</h3>\n<div class=\"gatsby-code-title\">serverless.ymlからリゾルバー定義を抜粋</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token comment\"># リゾルバー定義を指定します</span>\n    <span class=\"token comment\"># ※ここではPipeline Resolverの例を示します</span>\n    <span class=\"token key atrule\">mappingTemplates</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># リゾルバーの方を指定します</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Query\n        <span class=\"token comment\"># リゾルバーを紐づけるスキーマ中のフィールド名を指定します</span>\n        <span class=\"token key atrule\">field</span><span class=\"token punctuation\">:</span> user\n        <span class=\"token comment\"># Pipeline Resolverを使い場合、以下を指定します</span>\n        <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PIPELINE\n        <span class=\"token comment\"># リクエストマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token comment\"># ファイルパスはmappingTemplatesLocationで指定したパスからの相対パスになります</span>\n        <span class=\"token key atrule\">request</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'start.vtl'</span>\n        <span class=\"token comment\"># レスポンスマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token key atrule\">response</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'end.vtl'</span>\n        <span class=\"token comment\"># リゾルバーで使う関数を実行順に指定します</span>\n        <span class=\"token key atrule\">functions</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> GetUser</code></pre></div>\n<br/>\n<p>リゾルバー定義は、エンドポイントの画面を開き<code class=\"language-text\">Schema</code>を確認します。\n今回は<code class=\"language-text\">user</code>というフィールド名のクエリに対してリゾルバーを割り当てているので、右側のペインで以下のように確認できます。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9433457c9ebfa1de9cb0d571d6625d1c/7d730/appsync-gui-resolver.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.11990950226244%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABcRAAAXEQHKJvM/AAACJUlEQVQ4y4WTyXLaQBRF+f9vyAdk50UW9tIsUsEuVXAqZZshoAEJEEIIoaFnvdxuBifErnTVlbpeN6dvP11634fDT4tF/HO9Xj/u93svyzIvXCy851ng/Qojb+RH3us88sZ+6PlB4EVYi5PEW8TxRVEUPSbL5dPg4eFzz/f9b3Q1hFQUxgnlRUE141S1nJiQqEuSSlPTMmpRl0oR48e3HZPp9LU3HY/uWVVSWR6kEMKgbvZlafwgNIs4MclyZdJsa/JdbtZparJtjnlhtnludkVhDlVlpSx0NB4Pe0EQ9E3X2QO0fXSYV3VNxW5HTVWQVoyM1nAnXB0HE4erPN9Rjj0KoJMR6/BHD/fvn0DawqwOVU2CASQho6m77gn2wB2lmw3VOERw/gZMkuQC/NNh2zQkOYNDTkY1rm7BZ6EtVOPghgtiWjvg1ALjOP4HaB02AApuQXB4ctnhqlRVZCDWtm6vzDLSq5UDznz/fYdoMoAtgBVgwllywCAgursjGgxoG0VU4wD18kL85sYQWjANgo+B9spKwI3mgB672IUh0e0tdYBW69RFSRpDZcOODmezD3oI4Dlb55pziK9NhwN1WHf9wy04Pl7D5RsQPbw//cgSkKDOZUtK6eZ/ya6fZHPIGDNtCzWNMzOZTJ6sw6/XqeBC0P+GUo6BWBmq0R475vP5s83hF8xrBDTVWmcKQiQyRCdrGXtXTdte1nGbDAHfwESJf0r/N4rd3ksu3UVVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui resolver\"\n        title=\"\"\n        src=\"/static/9433457c9ebfa1de9cb0d571d6625d1c/42603/appsync-gui-resolver.png\"\n        srcset=\"/static/9433457c9ebfa1de9cb0d571d6625d1c/f931c/appsync-gui-resolver.png 200w,\n/static/9433457c9ebfa1de9cb0d571d6625d1c/e8031/appsync-gui-resolver.png 400w,\n/static/9433457c9ebfa1de9cb0d571d6625d1c/42603/appsync-gui-resolver.png 800w,\n/static/9433457c9ebfa1de9cb0d571d6625d1c/5b8b9/appsync-gui-resolver.png 1200w,\n/static/9433457c9ebfa1de9cb0d571d6625d1c/c7ea5/appsync-gui-resolver.png 1600w,\n/static/9433457c9ebfa1de9cb0d571d6625d1c/7d730/appsync-gui-resolver.png 1768w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>上記画面の<code class=\"language-text\">Pipeline</code>のリンクを開くとリゾルバーの詳細が確認できます。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec96f8926f756713f045671cd3c5f466/8fd38/appsync-gui-resolver-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 62.8494623655914%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABcRAAAXEQHKJvM/AAACKUlEQVQ4y4WUbW+bMBSF8/9/w77sR0yapn5Zt7CNuFpWRdWaJiFA3iDhzRgDqe2za2BRulWbpaNDMDk89/omoyAIZnEcu3meM3LmhyH76QVsHW7Zwg/Zk79hT+uALQYtSSuffLViS89j4XY/CeOcBVE6+XBz83aEP1bbtvA3W/jhBrtDTL5FzkvUdF82DZrzGS2ppmvZ0jU/4XnloPVcMPfr3Ui1DQohzi2gKU8nnOunpad9P9B+EOi173cehBtSqKM41kma6iRJdHRKdbpdqvz7O539eK++OZ/GI2OxskyBMejpFNV8jrzg2O33nba7HdIsQ2PpiPLiJFtNc1aGYCAVjMvYl75kIZQ5HGCOR5RWQiBNUySDbCAvS1RSvlRVQVTCVPR8WXLjum4faOZzhft7mNkM4vERG8+j/kXg1LuCcxREnBcFFZJ34enwkqqSlthYUlnXxp1MhkBAWdfGdHQl0VgiSRQdWU/SXdv9mKo4JemwJ41tAxFfBRrTB2pN1dMX8hIH0pFXiIsKUS6QCdn1ra7rvn/DaROdsf6S8DqQaOwDSmsM9Jdl9y2hUup60syw93qgbbbtSWZ7RaKBt2/HP1YXqK4DqXet6e5pRQSKKBXnXBW8JC/ps1RU5utqeqeXPlPguB+bxQJ4eABoBkGzZ0l/n6yVHsr/35owNh1ReXc0R5+lEA6dpkMn6NCvwaGhdmioL36IIud4Ov2tY+/0PzD+eHv75hdnwtP/gHqLVwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui resolver 2\"\n        title=\"\"\n        src=\"/static/ec96f8926f756713f045671cd3c5f466/42603/appsync-gui-resolver-2.png\"\n        srcset=\"/static/ec96f8926f756713f045671cd3c5f466/f931c/appsync-gui-resolver-2.png 200w,\n/static/ec96f8926f756713f045671cd3c5f466/e8031/appsync-gui-resolver-2.png 400w,\n/static/ec96f8926f756713f045671cd3c5f466/42603/appsync-gui-resolver-2.png 800w,\n/static/ec96f8926f756713f045671cd3c5f466/5b8b9/appsync-gui-resolver-2.png 1200w,\n/static/ec96f8926f756713f045671cd3c5f466/c7ea5/appsync-gui-resolver-2.png 1600w,\n/static/ec96f8926f756713f045671cd3c5f466/8fd38/appsync-gui-resolver-2.png 1860w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h3 id=\"関数定義\"><a href=\"#%E9%96%A2%E6%95%B0%E5%AE%9A%E7%BE%A9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>関数定義</h3>\n<div class=\"gatsby-code-title\">serverless.ymlから関数定義を抜粋</div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">    <span class=\"token comment\"># 関数定義を指定します</span>\n    <span class=\"token key atrule\">functionConfigurations</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># ユーザー一覧取得</span>\n        <span class=\"token comment\"># 関数で扱うデータソース名を指定します</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">dataSource</span><span class=\"token punctuation\">:</span> dynamo_user\n        <span class=\"token comment\"># 関数名を指定します</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser'</span>\n        <span class=\"token comment\"># 関数のリクエストマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token comment\"># ファイルパスはmappingTemplatesLocationで指定したパスからの相対パスになります</span>\n        <span class=\"token key atrule\">request</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser.req.vtl'</span>\n        <span class=\"token comment\"># 関数のレスポンスマッピングテンプレートのファイルパスを指定します</span>\n        <span class=\"token key atrule\">response</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'GetUser.res.vtl'</span></code></pre></div>\n<br/>\n<p>関数定義は、エンドポイントの画面を開き<code class=\"language-text\">Functions</code>を確認します。\n関数が一覧表示されるので、一覧から今回<code class=\"language-text\">serverless.yml</code>に定義した関数を選択すると、以下のように詳細が確認できます。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/435d0863a69c0fbe6ef7d6fe1f99ab06/5ae41/appsync-gui-function.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 96.86520376175548%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABcRAAAXEQHKJvM/AAAC3klEQVQ4y31U23LTMBTM//8AL3wIPJBhmBZMYSgT2iZpEqeJHd/vF1myZR3Okd00U1w8s5FlxetzdleaGYbxfrczby3L/hZFkeE4jmHu98af9c5Yb03jYWMa9487Y7nZGSucr3C8W29xfQDdr5/sr09evPi5eHg3M03zBl5dnZRwtB1wPB9sx4U0L6ERLTDOQbQdcATTcwFN1wM7/AYIbuH4a349Wy6XX+q6hjzLW865RD6ZFYV83GwGbE15OFrSsm2NMIpkkqYyjmMZhKGMk0ym629tb16D+f3Dp9nBOl6B74K6+SFhsQB1fw/1agVJloEfBBDFCQghoG1brK7V9xwhRnDBoZFAhYDlhfPZfr+/ookSQiJANQ3UeQ4ZIk4SaHCulJpE3/fDfS81oes689nJtgdCGL5Cf6gYg6IsIS+Koao30KCmpDdCv4uGzmf2M2Hfy5EYyoZjqzF4vg9pmgGjqvEjpHVdsxeMz6q61u8ejscLQqowikChjuzxEQpsmcgaJO+6DqgIavENDBW67ivCqgJ1OgHzPIxKpg3J8gLQVShxjcygFiWSyHEc9Rw09LzplivUBttAogQwStCPBgy4MOXFoAnCZ1NIQyRpxzZ1qxcE2gRcI7QvUky0TMK6mEfHgdq2Uc4IMLg4xnqkTNJIrTM0g0CmFDjHNGjCp8PhgpAe3t2BQrDtFnBHnEloDCMkj6MxKt25SpIEU6AJkWu6ZdKQdkaps1jqiOgFBGk4cel3vTc1xNxRXAQeAIJ3ILAA3nQajNE2RO16eXZaTgbbdSVg/tR2A7VlQTC2SfCxbWqdZCD3z0Efd1Q2pWGfJBINUcrzVO37KvRD5Zx8FQSRCqNYJUmmMOiKc6FQuzMwm7j9sfRnDbHM61GHszgNii0YtlvTxscFOeA/V08/aN5nOmDnJAFvmkpwznjDWZqmLPAj5rsJi4KIpUmOz3JW1RWrqn+B5pVkIp70H/8CGYSmIXpWVBIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync gui function\"\n        title=\"\"\n        src=\"/static/435d0863a69c0fbe6ef7d6fe1f99ab06/42603/appsync-gui-function.png\"\n        srcset=\"/static/435d0863a69c0fbe6ef7d6fe1f99ab06/f931c/appsync-gui-function.png 200w,\n/static/435d0863a69c0fbe6ef7d6fe1f99ab06/e8031/appsync-gui-function.png 400w,\n/static/435d0863a69c0fbe6ef7d6fe1f99ab06/42603/appsync-gui-function.png 800w,\n/static/435d0863a69c0fbe6ef7d6fe1f99ab06/5b8b9/appsync-gui-function.png 1200w,\n/static/435d0863a69c0fbe6ef7d6fe1f99ab06/c7ea5/appsync-gui-function.png 1600w,\n/static/435d0863a69c0fbe6ef7d6fe1f99ab06/5ae41/appsync-gui-function.png 1914w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<br/>\n<p>設定ファイルの説明は以上です。次にリゾルバーとスキーマの定義について説明します。</p>\n<h2 id=\"4-リゾルバー作成\"><a href=\"#4-%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E4%BD%9C%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. リゾルバー作成</h2>\n<p><code class=\"language-text\">mapping-templates</code>フォルダを作成し、その中にリクエストマッピングテンプレートとレスポンスマッピングテンプレートを作成します。</p>\n<p>PipelineResolver用のマッピングテンプレート</p>\n<div class=\"gatsby-code-title\">mapping-templates/start.vtl</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\">{}</code></pre></div>\n<br/>\n<p>PipelineResolver用のマッピングテンプレート</p>\n<div class=\"gatsby-code-title\">mapping-templates/end.vtl</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\"><span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span></span></code></pre></div>\n<br/>\n<p>ユーザー1件取得用の関数ではDynamoDBのGetItemを呼び出します。</p>\n<div class=\"gatsby-code-title\">mapping-templates/GetUser.req.vtl</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\">{\n    \"version\": \"2018-05-29\",\n    \"operation\": \"GetItem\",\n    \"key\": {\n        \"id\": <span class=\"token variable\">$util<span class=\"token punctuation\">.</span>dynamodb<span class=\"token punctuation\">.</span><span class=\"token function\">toDynamoDBJson</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span></span>,\n    }\n}</code></pre></div>\n<br/>\n<p>取得情報をレスポンスにて返却します。</p>\n<div class=\"gatsby-code-title\">mapping-templates/GetUser.res.vtl</div>\n<div class=\"gatsby-highlight\" data-language=\"velocity\"><pre class=\"language-velocity\"><code class=\"language-velocity\"><span class=\"token directive\"><span class=\"token keyword\">#if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>error</span><span class=\"token punctuation\">)</span></span>\n  <span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>$ctx<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span></span>\n<span class=\"token directive\"><span class=\"token keyword\">#end</span></span>\n\n<span class=\"token directive\"><span class=\"token keyword\">#set</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$res</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$ctx<span class=\"token punctuation\">.</span>result</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token variable\">$util<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$res<span class=\"token punctuation\">)</span></span></code></pre></div>\n<br/>\n<h2 id=\"5-スキーマ作成\"><a href=\"#5-%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E4%BD%9C%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. スキーマ作成</h2>\n<p>ユーザー情報（ID、名前）を1件検索するだけのシンプルなスキーマ定義です。\n<code class=\"language-text\">serverless.yml</code>の<code class=\"language-text\">schema</code>で指定した通り、プロジェクトルートに<code class=\"language-text\">schema.graphql</code>ファイルを作成します。</p>\n<div class=\"gatsby-code-title\">schema.graphql</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">type User <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span>\n    <span class=\"token attr-name\">name</span><span class=\"token punctuation\">:</span> String\n<span class=\"token punctuation\">}</span>\n\ntype UserResponse <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">user</span><span class=\"token punctuation\">:</span> User\n<span class=\"token punctuation\">}</span>\n\ninput GetUserInput <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\"># ユーザー1件取得</span>\n</span><span class=\"gatsby-highlight-code-line\">type Query <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    user<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> UserResponse\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span>\n</span></code></pre></div>\n<h2 id=\"6-awsにデプロイ\"><a href=\"#6-aws%E3%81%AB%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. AWSにデプロイ</h2>\n<p>以下コマンドを実行します。とても簡単にデプロイできます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">serverless deploy -v</code></pre></div>\n<br/>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はAppSync + Serverless FrameworkによるAppSync資産の構成管理についてご紹介しました。\n複数人開発においてGUI操作の場合、意図せず変更が加えられてデグレするリスクがあるので、Serverless Frameworkを使って構成管理するのが得策です。\nまたServerless Frameworkの利点はなんといっても1コマンドでAWSにデプロイという手軽さです。\nAppSync資産だけでなく、Lambdaや他資産もServerless Frameworkで管理できるので、AWSでサーバーレスなアプリを開発するときは是非使ってみてください🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://foobar123.com/building-an-appsync-serverless-framework-backend-foobar-c383a840de0d\">Building an AppSync + Serverless Framework Backend | FooBar</a></li>\n</ul>","fields":{"slug":"/aws-appsync-and-serverless-framework","title":"AppSync + Serverless Frameworkによるソースコードの構成管理","date":"2019-03-04T07:50:00.000+09:00","excerpt":"なにこれAWSのGraphQLマネージドサービス「AppSync」はGUIで簡単に設定ができて便利ですが、本格的に開発を進めていくとGUIポチポチでソースコードを管理するのはつらくなってきます。Serverless Frameworkという...","tags":["AppSync","serverless","AWS","GraphQL"],"keywords":["AppSync"],"thumbnail":"thumbnail/2019/03/aws-appsync-and-serverless-framework.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AWSのGraphQLフルマネージドサービス<a href=\"https://aws.amazon.com/jp/appsync/\">「AppSync」</a>で複数のデータリソースを扱う場合は<strong>「Pipeline Resolver」</strong>という機能を使います。\nこれは、1つのデータリソースを扱うファンクションを定義し、それらを組み合わせるという仕組みです。\nファンクションではデータリソースのCRUD操作や操作結果の加工などを<a href=\"http://velocity.apache.org/engine/1.7/vtl-reference.html\"><strong>VTL（Apatch Verocity Template Language）</strong></a>で記述します。\n今回は、<strong>Pipeline Resolverを使って複数のデータリソース（DynamoDBの複数テーブル）から情報を取得する場合のVTLの書き方について以下2パターンをご紹介します。</strong></p>\n<ul>\n<li><a href=\"#1%E5%AF%BE1%E3%81%A7%E7%B4%90%E3%81%A5%E3%81%8F2%E3%81%A4%E3%81%AEdynamodb%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%891%E4%BB%B6%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88\">🔰 1対1で紐づく2つのDynamoDBのテーブルから1件情報を取得する場合</a></li>\n<li><a href=\"#1%E5%AF%BEn%E3%81%A7%E7%B4%90%E3%81%A5%E3%81%8F2%E3%81%A4%E3%81%AEdynamodb%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89%E8%A4%87%E6%95%B0%E4%BB%B6%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88\">💪 1対Nで紐づく2つのDynamoDBのテーブルから複数件情報を取得する場合</a></li>\n</ul>\n<p><small>※この記事ではあくまでもVTLの書き方に注力して説明します。GraphQLのスキーマ・リゾルバー、AppSyncのリクエストマッピングテンプレート・レスポンスマッピングテンプレートの概要については知っている前提です。</small></p>\n<h2 id=\"pipeline-resolverの概要\"><a href=\"#pipeline-resolver%E3%81%AE%E6%A6%82%E8%A6%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pipeline Resolverの概要</h2>\n<p>少しだけ説明します。\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4564cb92bd23969ee7df2b0be2b894f8/378ae/appsync-resolver.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 116.79558011049724%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABcRAAAXEQHKJvM/AAAECklEQVQ4y4VV/U+TVxTuP7KftuyHZUuGm9vU+cPcolN0xsy46aS1KrqIiHNLjGEOpmK2JcLGsmSBV8AVLOjko3wUaFFACsqXgsjb0tLWVipTka/R2t735dm5l5YJFLzJk/Pe3Hufe855zrmvpr6+/qDT6SyRZTnP4XBIg7IsBUb80vTEmDT57Ik0NfGUMPY/xp8KuFxOSZbtkt1uJyvnE0ex2WxO0fh8vlIsGgNDPkildTBUWFF4tWEBLl1rFIg3iKtGMzw8LPGJqqqhSIQx+mQZF/LZmxv2sISNWvbGR7tZwiYte3vjHF5du5O9sno7cz8YEXsVRWF09jnnIC6jxu12F/LJ7OwsY0wRN537rRB0GO9u1uOtj/di1af7kLBJh1WE19d/gdfW7YTXH0DUEX5WHCSuKwsI+SIf7V39yCuphLGyEX/9XYeC0moUllXDcM2M4vJ6sTY+OYXoueUJuZ2LGnj8ZAy3eu5BdrrReWcAdwccuEPouz80T8QdUAg87mUJo2u4YetGTr4RJeVm8tCES1drkVdcgYvGKvw7E4x5FtPj5YQ8R/U32mG92YnyuuuosdxEjbVNeBnL3UwwRKmogWSsUixtPXC5hpcSxoTp6ZexNzUD2rQfsetwOr46moHEpBPIIsEwqyIcDsPjG8Gabcn45MtURf/tT3AMOZcn7L1nh47IdGlnsPvIaexJ+QE7DpxEVm4RVIoiEongYWAUW3Xf4f2tB5Sk41mg4l4+ZP/IKKncgDKTBcVcXYKBFG+iFFDp0cUMk1PTkC5XIfdimWKydlDIrqWEMeVeHNNTk7SBzc9jCr8whBcejyc+IT/g8vjQ3N6Nts67qCUxLC230dTWJcpGXEqRcFFqm2wwNbQqvfddvFNWyCEXhYTQHiNRvp4TZUtMFMzOi/Je4n5s2JWi6E6cJ1GGVlZZeywT+m/OktqZSKLvz5NP4fzvRcI7Icqjf8QlqxP3K0lp51YWJTD6GFdIEGNFg2i9Iqo33n684FVVEaKMT0whJ8+Is78WKCWV1viixAh7+u24TGSNlLsKczPl0SasqbEVwdBzEfZiUeJ2Cov2stPtEyVjvt6OauqSOrIV5hbqno55pXk1RAWKTxjrTU7W0tEr2ox72nqrF7auPlHs3X0ymmlthvr5pa8Ni4b78x8GvLN5Hz7YdnDuXdyip7leWD6nxxcPHj5a9j0siC6EKVxereqZnAJ1zWfJ6rrth1QiUdfvOKyupe8PyRKhSq+26vEFxF4Km49IlLBM4/V6DYv/DSaLDYdO/oLjmblISc/GkfQL8zj6fTZST+dgcjq45J9CXOWawcHBbKqpiWAw6AmFQn6y/kg47FcYI0T8qsIWQOGgtdjeqPUSxzPi+vM/v3UMeAWNUVMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"appsync-resolver\"\n        title=\"\"\n        src=\"/static/4564cb92bd23969ee7df2b0be2b894f8/42603/appsync-resolver.png\"\n        srcset=\"/static/4564cb92bd23969ee7df2b0be2b894f8/f931c/appsync-resolver.png 200w,\n/static/4564cb92bd23969ee7df2b0be2b894f8/e8031/appsync-resolver.png 400w,\n/static/4564cb92bd23969ee7df2b0be2b894f8/42603/appsync-resolver.png 800w,\n/static/4564cb92bd23969ee7df2b0be2b894f8/378ae/appsync-resolver.png 905w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ul>\n<li>Pileline Resolverの中で、どのファンクションをどの順番で呼び出すか指定します。</li>\n<li>ファンクションは「データリソース、リクエストマッピングテンプレート、レスポンスマッピングテンプレート」のセットです。</li>\n<li>柔軟性が高く、処理の共通化なども可能です。</li>\n</ul>\n<h2 id=\"1対1で紐づく2つのdynamodbのテーブルから1件情報を取得する場合\"><a href=\"#1%E5%AF%BE1%E3%81%A7%E7%B4%90%E3%81%A5%E3%81%8F2%E3%81%A4%E3%81%AEdynamodb%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%891%E4%BB%B6%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1対1で紐づく2つのDynamoDBのテーブルから1件情報を取得する場合</h2>\n<h3 id=\"apiとデータリソースの仕様\"><a href=\"#api%E3%81%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E4%BB%95%E6%A7%98\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>APIとデータリソースの仕様</h3>\n<details><summary>コチラをクリックしたら見れます。リゾルバーとあわせてご覧ください。</summary><div>\n<br/>\n<p><code class=\"language-text\">{&quot;id&quot;:&quot;1000&quot;}</code>を引数にAPIを呼び出すと以下レスポンスが返ってくる想定です。</p>\n<div class=\"gatsby-code-title\">APIのレスポンス</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1000\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ギャッツビー太郎\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"departmentId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"9001\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"departmentName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"総務部\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"queryのスキーマ\"><a href=\"#query%E3%81%AE%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Queryのスキーマ</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">type Sample1 {\n    id: ID!\n    name: String!\n    departmentId: String!\n    departmentName: String\n}\n\nquery {\n    sample1(id: ID!): Sample1\n}</code></pre></div>\n<h4 id=\"取得対象データ\"><a href=\"#%E5%8F%96%E5%BE%97%E5%AF%BE%E8%B1%A1%E3%83%87%E3%83%BC%E3%82%BF\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>取得対象データ</h4>\n<div class=\"gatsby-code-title\">従業員テーブル（Employeeテーブル） ※簡単のため１件のみ</div>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">*</span> id: 100\n<span class=\"token list punctuation\">*</span> name: ギャッツビー太郎\n<span class=\"token list punctuation\">*</span> departmentId: 9001</code></pre></div>\n<div class=\"gatsby-code-title\">部署テーブル（Departmentテーブル） ※簡単のため１件のみ</div>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">*</span> id: 9001\n<span class=\"token list punctuation\">*</span> name: 総務部</code></pre></div>\n</div></details>\n<br/>\n<h3 id=\"リゾルバーの書き方\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーの書き方</h3>\n<p>「従業員情報 + 従業員に紐づく部署情報」を1件取得する場合、以下のようなVTLを作成します。</p>\n<h4 id=\"1-従業員テーブルに対するファンクション\"><a href=\"#1-%E5%BE%93%E6%A5%AD%E5%93%A1%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 従業員テーブルに対するファンクション</h4>\n<div class=\"gatsby-code-title\">リクエストマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\"># 従業員IDを指定してDynamoDBから1件情報を取得します。\n{\n    &quot;version&quot;: &quot;2017-02-28&quot;,\n    &quot;operation&quot;: &quot;GetItem&quot;,\n    &quot;key&quot;: {\n        &quot;id&quot;: $util.dynamodb.toDynamoDBJson($ctx.args.id),\n    },\n}</code></pre></div>\n<div class=\"gatsby-code-title\">レスポンスマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\"># 従業員情報をレスポンスに設定します。\n$util.toJson($context.result)</code></pre></div>\n<h4 id=\"2-部署テーブルに対するファンクション\"><a href=\"#2-%E9%83%A8%E7%BD%B2%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 部署テーブルに対するファンクション</h4>\n<div class=\"gatsby-code-title\">リクエストマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\"># 前ファンクションの結果（従業員情報）に紐づく部署情報を取得します。\n{\n    &quot;operation&quot;: &quot;GetItem&quot;,\n    &quot;key&quot;: {\n        # 前ファンクションの結果は $ctx.prev.resultで参照できます。\n        # 部署IDを指定してDynamoDBから1件情報を取得します。\n        &quot;id&quot;: $util.dynamodb.toDynamoDBJson($ctx.prev.result.departmentId),\n    }\n}</code></pre></div>\n<div class=\"gatsby-code-title\">レスポンスマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\">#if($ctx.error)\n        $util.error($ctx.error.message, $ctx.error.type)\n#end\n\n# 前ファンクションの結果（従業員情報）と今回の結果（部署情報）をマージします。\n# オブジェクトに新しくプロパティを追加する場合は putメソッドを使います。\n# putメソッドを使う場合は $util.qr で囲む必要があります。\n$util.qr($ctx.prev.result.put(&quot;departmentName&quot;, $ctx.result.name))\n\n# マージ結果をレスポンスに設定します。\n$util.toJson($ctx.prev.result)</code></pre></div>\n<h2 id=\"1対nで紐づく2つのdynamodbのテーブルから複数件情報を取得する場合\"><a href=\"#1%E5%AF%BEn%E3%81%A7%E7%B4%90%E3%81%A5%E3%81%8F2%E3%81%A4%E3%81%AEdynamodb%E3%81%AE%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%8B%E3%82%89%E8%A4%87%E6%95%B0%E4%BB%B6%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1対Nで紐づく2つのDynamoDBのテーブルから複数件情報を取得する場合</h2>\n<h3 id=\"apiとデータリソースの仕様-1\"><a href=\"#api%E3%81%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E3%81%AE%E4%BB%95%E6%A7%98-1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>APIとデータリソースの仕様</h3>\n<details><summary>コチラをクリックしたら見れます。リゾルバーとあわせてご覧ください。</summary><div>\n<br/>\n<p><code class=\"language-text\">{ &quot;contractor&quot;:&quot;ギャッツビー太郎&quot;}</code>を引数にAPIを呼び出すと以下のレスポンスが返ってくる想定です。</p>\n<div class=\"gatsby-code-title\">APIのレスポンス</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"contracts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"items\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n            \t<span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1000\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"〇〇〇案件\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"contractor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ギャッツビー太郎\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"productIds\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token string\">\"2001\"</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">\"2002\"</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"products\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2001\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"トマト\"</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2002\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ナス\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span>\n            \t<span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1001\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"△△△案件\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"contractor\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ギャッツビー太郎\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"productIds\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token string\">\"2002\"</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">\"2003\"</span>\n                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"products\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2002\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ナス\"</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">{</span>\n                        <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2003\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"キュウリ\"</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"queryのスキーマ-1\"><a href=\"#query%E3%81%AE%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E-1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Queryのスキーマ</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">type Contracts {\n    items: [Contract]\n}\n\ntype Contract {\n    id: ID!\n    name: String!\n    contractor: String!\n    productIds: [ID]\n    products: [Product]\n}\n\ntype Product {\n    id: ID!\n    name: String\n}\n\nquery {\n    getContracts(contractor: String!): Contracts\n}</code></pre></div>\n<h4 id=\"取得対象データ-1\"><a href=\"#%E5%8F%96%E5%BE%97%E5%AF%BE%E8%B1%A1%E3%83%87%E3%83%BC%E3%82%BF-1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>取得対象データ</h4>\n<div class=\"gatsby-code-title\">契約テーブル（Contractテーブル） 2件</div>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">*</span> id: 1000\n<span class=\"token list punctuation\">*</span> name: 〇〇〇案件\n<span class=\"token list punctuation\">*</span> contractor: ギャッツビー太郎\n<span class=\"token list punctuation\">*</span> productIds: [2001,2002]\n\n<span class=\"token list punctuation\">*</span> id: 1001\n<span class=\"token list punctuation\">*</span> name: △△△案件\n<span class=\"token list punctuation\">*</span> contractor: ギャッツビー太郎\n<span class=\"token list punctuation\">*</span> productIds: [2002,2003]</code></pre></div>\n<div class=\"gatsby-code-title\">商品テーブル（Productテーブル） 3件</div>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">*</span> id: 2001\n<span class=\"token list punctuation\">*</span> name: トマト\n\n<span class=\"token list punctuation\">*</span> id: 2002\n<span class=\"token list punctuation\">*</span> name: ナス\n\n<span class=\"token list punctuation\">*</span> id: 2003\n<span class=\"token list punctuation\">*</span> name: キュウリ</code></pre></div>\n</div></details>\n<br/>\n<h3 id=\"リゾルバーの書き方-1\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AE%E6%9B%B8%E3%81%8D%E6%96%B9-1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーの書き方</h3>\n<p>「契約情報 + 契約に紐づく商品情報」を複数件取得する場合、以下のようなVTLを作成します。</p>\n<h3 id=\"1-契約テーブルに対するファンクション\"><a href=\"#1-%E5%A5%91%E7%B4%84%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 契約テーブルに対するファンクション</h3>\n<div class=\"gatsby-code-title\">リクエストマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\">{\n    &quot;operation&quot; : &quot;Scan&quot;,\n    # 複数件検索ではfilterで検索条件を指定します。\n    &quot;filter&quot; : {\n        # 具体的な検索条件はexpressionで定義します。\n        # 今回は契約者名が一致することが条件です。\n        &quot;expression&quot;: &quot;contractor = :contractor&quot;,\n        # 検索条件で使う変数はあらかじめexpressionValuesで初期化します。\n        &quot;expressionValues&quot; : {\n            &quot;:contractor&quot; : $util.dynamodb.toDynamoDBJson($ctx.args.contractor)\n        }\n    }\n}</code></pre></div>\n<div class=\"gatsby-code-title\">レスポンスマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\"># 契約情報をレスポンスに設定します。\n$util.toJson($context.result)</code></pre></div>\n<h3 id=\"2-商品テーブルに対するファンクション\"><a href=\"#2-%E5%95%86%E5%93%81%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%83%B3%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 商品テーブルに対するファンクション</h3>\n<div class=\"gatsby-code-title\">リクエストマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\"># 前ファンクションで取得した契約情報から商品IDを抽出します。\n#set($productIds = [])\n#set($contracts = $ctx.prev.result.items)\n#foreach($c in $contracts)\n    #foreach( $id in $c.productIds )\n        #if(!$productIds.contains($id))\n            $util.qr($productIds.add($id))\n        #end\n    #end\n#end\n\n{\n    &quot;version&quot; : &quot;2017-02-28&quot;,\n    &quot;operation&quot; : &quot;Scan&quot;,\n    &quot;filter&quot; : {\n        # 「複数の値のどれかに一致する」という条件はcontains関数で実現します。\n        &quot;expression&quot;: &quot;contains(:ids, id)&quot;,\n        &quot;expressionValues&quot; : {\n            &quot;:ids&quot; : $util.dynamodb.toDynamoDBJson($productIds)\n        }\n    }\n}</code></pre></div>\n<div class=\"gatsby-code-title\">レスポンスマッピングテンプレート</div>\n<div class=\"gatsby-highlight\" data-language=\"vtl\"><pre class=\"language-vtl\"><code class=\"language-vtl\">#if($ctx.error)\n        $util.error($ctx.error.message, $ctx.error.type)\n#end\n\n# 前ファンクションの結果（契約情報）と今回の結果（商品情報）をマージします。\n#foreach($c in $ctx.prev.result.items)\n    #set($products = [])    \n    # 商品情報をイテレート\n    #foreach( $p in $ctx.result.items )\n        # 契約情報に含まれる商品が見つかったら\n        #if($c.productIds.contains($p.id))\n            # $productsにaddします。\n            $util.qr($products.add($p))\n        #end\n    #end\n        \n    # 商品情報を契約情報に追加します。\n    #set($temp = { &quot;items&quot;: $products })\n    $util.qr($contract.put(&quot;products&quot;, $temp))\n#end\n\n# マージした情報をレスポンスに設定します。\n$util.toJson($ctx.prev.result)</code></pre></div>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回、AppSyncで複数のデータリソースから情報を取得する場合のVTLの書き方についてを紹介しました。\nここで紹介した方法さえ覚えておけば、データリソースが3つ以上になった場合もファンクションを追加していけば良いだけです。\nまたデータリソースがDynamoDBではなくRDB、Lambdaの場合もデータ取得APIを置き換えれば良いだけです。</p>\n<p>それにしてもAppSyncのリゾルバー定義は、なぜVTL縛りなのでしょうか。Lambdaのように好きな言語で実装させてくれてもいいのに... いずれは、そうなることを期待しています🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://dev.classmethod.jp/cloud/aws/appsync-updates-11-21/\">AWS AppSyncの新機能！Pipeline Resolver、Aurora Serverless Data Source、Delta Syncがサポートされました！ ｜ DevelopersIO</a></li>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/tutorial-pipeline-resolvers.html\">チュートリアル: パイプラインリゾルバー - AWS AppSync</a></li>\n</ul>","fields":{"slug":"/aws-appsync-pipeline-resolver-with-multiple-dynamodb-tables","title":"AWS AppSyncのPipeline Resolverで複数データリソースを扱う場合のVTLの書き方","date":"2019-02-19T07:30:00.000+09:00","excerpt":"なにこれAWSのGraphQLフルマネージドサービス「AppSync」で複数のデータリソースを扱う場合は「Pipeline Resolver」という機能を使います。これは、1つのデータリソースを扱うファンクションを定義し、それらを組み合わせ...","tags":["AppSync","AWS","GraphQL","DynamoDB"],"keywords":["GraphQL"],"thumbnail":"thumbnail/2019/02/aws-appsync-pipeline-resolver-with-multiple-dynamodb-tables.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AppSync + Cognitoにおける認可制御について<a href=\"https://takumon.com/aws-appsync-auth-with-cognito\">以前の記事</a>で説明しました。\n今回は、ユーザーのカスタム属性を使った認可制御（AppSyncのリゾルバーでカスタム属性を取得する方法）についてご紹介します。</p>\n<h2 id=\"tldr\"><a href=\"#tldr\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<p>AppSyncとCognitoを連携済みであれば、3ステップで実現できます。</p>\n<ol>\n<li><a href=\"#1-cognito%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E5%B1%9E%E6%80%A7%E3%82%92readable%E3%81%AB%E8%A8%AD%E5%AE%9A\">サーバー側：Cognitoの設定でカスタム属性をReadableに設定</a></li>\n<li><a href=\"#2-appsync%E3%81%AE%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%A6ctxidentityclaimsgetcustomsamplecustomattr%E3%82%92%E8%A8%98%E8%BF%B0\">サーバー側：AppSyncのリゾルバーにて<code class=\"language-text\">$ctx.identity.claims.get(&quot;custom:sampleCustomAttr&quot;)</code>を記述</a></li>\n<li><a href=\"#3-amplify%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AEgetaccesstoken%E3%81%AE%E9%83%A8%E5%88%86%E3%82%92getidtoken%E3%81%AB%E7%BD%AE%E6%8F%9B\">クライアント側：Amplifyのライブラリの中身の<code class=\"language-text\">getAccessToken</code>の部分を<code class=\"language-text\">getIdToken</code>に置換</a></li>\n</ol>\n<p>以下で詳しく説明します。</p>\n<h2 id=\"1-cognitoの設定でカスタム属性をreadableに設定\"><a href=\"#1-cognito%E3%81%AE%E8%A8%AD%E5%AE%9A%E3%81%A7%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E5%B1%9E%E6%80%A7%E3%82%92readable%E3%81%AB%E8%A8%AD%E5%AE%9A\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Cognitoの設定でカスタム属性をReadableに設定</h2>\n<p>この方法は認証時にIDトークンを使うことが前提です。<br/>\nIDトークンを使えば、ユーザー情報がAppSyncのリゾルバー取得できます。<br/>\nただしカスタム属性はデフォルトだと取得できないので、AWSコンソールにて以下のように設定しましょう。</p>\n<ul>\n<li><code class=\"language-text\">AWSコンソール</code> > <code class=\"language-text\">Cognitoのユーザープール</code> > <code class=\"language-text\">全般設定</code> > <code class=\"language-text\">アプリクライアント</code> > <code class=\"language-text\">詳細を表示</code> を選択</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2fd3da2252daf17902b1c3691ab5a197/2cbfe/how-to-setting-in-cognito-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.743400859422955%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABcRAAAXEQHKJvM/AAABsklEQVQoz42Rz2/TMBTH8y9y4LKxaWKjRROF9oIQfwnSTlyQOAxYkcqvSBMTIKhgsoR2KDRrm1/rjyyN49iJk9iP50jjwAHtSR89+2v7a79n68bm7kG792i03e6e7rS7ZLvVJa3OQ7Jzt0e27jwgG7sdsrnXIbf27pON2/fIfu8xeX7YJy9fvyGHRwPyoj8g/cH704Onz8Y3t1pPrB9fhieQMmDrBEQhkQLSLEMpAy5yoJjjhCIJLKNLiCkFnud/YVxAkqZgwplMjq1v9skH5c6ALRYll1LliOf7auZ5KpzPlR+Gauq66nwyUT/PztRvx1Hn02mje0HQjFErGeeA+99ajjO2pZTmljoTAsyCwJtlWQKaNxQ4NpRVBYXRsAqTi6s1KSvzwpnnv7N+jcd2pRSsoqhOM9aUbMyajAcqNPmXuq4xX9FojaHrB8bQsc3sMmVVzLgWUmqRppquVjrnXNdK6bIsdVEU/6MxxBag4Wh0jAdhHoaQxGuoBId86kHizkEvlnCd0FihCT8IbGs0/Nqnw49V/Nles++fKEsSyi4WNLlYUhFFFPtzHWJsk8bPe/UHbaI/rXRpOa4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"how to setting in cognito 1\"\n        title=\"\"\n        src=\"/static/2fd3da2252daf17902b1c3691ab5a197/42603/how-to-setting-in-cognito-1.png\"\n        srcset=\"/static/2fd3da2252daf17902b1c3691ab5a197/f931c/how-to-setting-in-cognito-1.png 200w,\n/static/2fd3da2252daf17902b1c3691ab5a197/e8031/how-to-setting-in-cognito-1.png 400w,\n/static/2fd3da2252daf17902b1c3691ab5a197/42603/how-to-setting-in-cognito-1.png 800w,\n/static/2fd3da2252daf17902b1c3691ab5a197/5b8b9/how-to-setting-in-cognito-1.png 1200w,\n/static/2fd3da2252daf17902b1c3691ab5a197/c7ea5/how-to-setting-in-cognito-1.png 1600w,\n/static/2fd3da2252daf17902b1c3691ab5a197/2cbfe/how-to-setting-in-cognito-1.png 1629w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<ul>\n<li><code class=\"language-text\">属性の読み込みおよび書き込みアクセス権限を設定する</code> > <code class=\"language-text\">読み取り可能な属性</code>　にて取得したいカスタム属性にチェックを入れて<code class=\"language-text\">アプリクライアントの変更を保存</code></li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8ea7852e2cfc9a34840408ac5eabf86f/3ec6a/how-to-setting-in-cognito-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 119.22604422604424%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAABcRAAAXEQHKJvM/AAAD6klEQVQ4y41V247bVBTN//AERWpVqGYQ6oUiBPwQL32ooIJWoBF9QbzxAVUqI0bpAwWkgaqlnUxnEjt2kplJ4viSxNfY3vZm7ZNkko5UDZaWzsXnrLP23svHtXcuXfvmo5ufP7m89cnjK9u3tctbt7WtG19oV7Y/1d6/dkt79+p17b0PbmiXPryp+lc//kz76s7X2v0fHmr37u9o9x7saN99/+PjO3e/fbJ968uHtT/2nv2ZEbPt+uxNpsBMwfEmajz2fB6OXYWB7ah186Jgqiouykq1GcbytDumUdtrtndlkM7nGV5QURLZzphGtk2e79PYceh0OKTj0xNq6W3q9vvUPzmh3vGxmpdxx7JybzLh6Wz2b62l642ciCezGYVxwmEcQ50nY54FIU+D4Awy508lisnifRiu5imnkseu+6rWNgxFCBIKooiT+ZwLhJDnOecSGt4plCWXG6A3QRLlGWGFgYvw5FQhTNOUA6hLkkRtlgOyLF8cAmz2F+NMEUIUCPUFYZgkFCWpIoxBNJGcILwIqrHhIqwJOx29QbHN3qBFkdcDYaoU2rbNg8GAZ1C9uXmp6A3M5/M14YvXrUZR5CjAlOIkOlOIirHruhyG0RkJNipkGVqEneWFSgewJvx7/0gVxUelpGox1OWyGW2MikseQ8wHqGYIBFGMNSBFVcWHy2dN2LU6DTEn7EBiGVGYFCVHII0lfKhL0E/zjINk+R6EcqA6DDlO042Q/2ki5HJhmwgLEmzK+ifsty2eGV2gx0Gnp8aZ1VdyKggQlAK4AP014fPX7YYMcBJJuJK/0vc5GzuAu2wdzh2Px602wg8WMa68uSDdqLLZUYSRsk2iQsqwKEQrkNADySvWJAhb8ilFEiesqoy+InQ976Uy9iahqCzRInaejUY8Mk22LYsJBYEspU5IxuMxD4dDlceNopwjlJCR5BIL/W6X/V6Pp/0+hyCuQFDB7FIkqb5ATJ8vbpq3EIoHoURyKH2pvhhDUlCAAC5nOVTClkfUiS8vJKxAKMVZ+dGBwQsJGYQBiD3cRlJlx3E4APlGld9OKNeSmFny5SDUOcgWhAmPkBKp8gDtUu3FIduOCyW4naHo1LS4wJwQSg7l+xa7SBtepDASJVMoyhLkUP4NQw4MnefNJnwBX8J7K+XF8uo/T/ibIozjTEhTYNq2SH92QNZLnbp7++Q936dK16kKAnzBTEWeE7xIuBNIyIBsSfiiZpjmX3zu0Q+H/NOvBv/SMPnnXZNbBwP+Pw/+QUbt96dP71q93q7R6TwCed2wrHq/dVQfHTbrw6MD1R63Dusm5q1ut26ew3LuEX5Wu6+azZ3/AJ0c9RMhpwoOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"how to setting in cognito 2\"\n        title=\"\"\n        src=\"/static/8ea7852e2cfc9a34840408ac5eabf86f/42603/how-to-setting-in-cognito-2.png\"\n        srcset=\"/static/8ea7852e2cfc9a34840408ac5eabf86f/f931c/how-to-setting-in-cognito-2.png 200w,\n/static/8ea7852e2cfc9a34840408ac5eabf86f/e8031/how-to-setting-in-cognito-2.png 400w,\n/static/8ea7852e2cfc9a34840408ac5eabf86f/42603/how-to-setting-in-cognito-2.png 800w,\n/static/8ea7852e2cfc9a34840408ac5eabf86f/5b8b9/how-to-setting-in-cognito-2.png 1200w,\n/static/8ea7852e2cfc9a34840408ac5eabf86f/c7ea5/how-to-setting-in-cognito-2.png 1600w,\n/static/8ea7852e2cfc9a34840408ac5eabf86f/3ec6a/how-to-setting-in-cognito-2.png 1628w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h2 id=\"2-appsyncのリゾルバーにてctxidentityclaimsgetcustomsamplecustomattrを記述\"><a href=\"#2-appsync%E3%81%AE%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%A6ctxidentityclaimsgetcustomsamplecustomattr%E3%82%92%E8%A8%98%E8%BF%B0\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. AppSyncのリゾルバーにて$ctx.identity.claims.get(\"custom:sampleCustomAttr\")を記述</h2>\n<p>以下のようにして取得します。</p>\n<div class=\"gatsby-highlight\" data-language=\"verocity:appsyncのリゾルバー\"><pre class=\"language-verocity:appsyncのリゾルバー\"><code class=\"language-verocity:appsyncのリゾルバー\">  #set($sampleCustomAttr = $ctx.identity.claims.get(&quot;custom:sampleCustomAttr&quot;))</code></pre></div>\n<br/>\n<h2 id=\"3-amplifyのライブラリの中身のgetaccesstokenの部分をgetidtokenに置換\"><a href=\"#3-amplify%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E4%B8%AD%E8%BA%AB%E3%81%AEgetaccesstoken%E3%81%AE%E9%83%A8%E5%88%86%E3%82%92getidtoken%E3%81%AB%E7%BD%AE%E6%8F%9B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Amplifyのライブラリの中身のgetAccessTokenの部分をgetIdTokenに置換</h2>\n<p>手順2までを実施した場合、、AppSyncのQueryコンソール上では正常動作しますが、\nクライアント側からAmplify経由でクエリをたたいた場合は正常動作しません。</p>\n<p>なぜならAppSyncのQueryコンソールは認証時にIDトークンを使いますが、\nAmplify経由の場合はアクセストークンを使うからです。</p>\n<p>そのため、Amplify側の認証をIDトークンに切り替える必要があります。\n少し無理やりですが以下のようにAmplifyのライブラリを直接書き換えます。<br/>\nプロジェクトのnode_modules配下にて、以下のように修正します。</p>\n<div class=\"gatsby-code-title\">node_modules/@aws-amplify/api/dist/aws-amplify-api.js</div>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token deleted\">- Authorization: session.getAccessToken().getJwtToken() </span>\n<span class=\"token inserted\">+ Authorization: session.getIdToken().getJwtToken() </span></code></pre></div>\n<br/>\nこれでクエリが正常動作するようになります。<br/>\nただ直接依存ライブラリを書き換えるので、本番環境デプロイ時は、CIに忘れずに書き換え処理を追加しましょう。<br/>\n<p>※この方法は、Amplipy側のGraphQLスキーマ定義で<code class=\"language-text\">@auth</code>を使っている場合に一部機能が正常動作しなくなるので注意してください。</p>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はAppSync + Cognitoにおいて、AppSyncのリゾルバーでユーザーのカスタム情報を取得する方法をご紹介しました。\nAmplify側は直接ライブラリを書き換えるので、多少無理やりな対応ですが、一応これでできます。\nユーザーごとの認可情報をカスタム属性に持たせる場合は、この方法を試してみてください🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/resolver-context-reference.html#aws-appsync-resolver-context-reference-identity\">リゾルバーのマッピングテンプレートのコンテキストリファレンス - AWS AppSync</a></li>\n<li><a href=\"https://maketips.net/tip/175/include-custom-attributes-in-cognito-claims\">Include custom attributes in cognito claims</a></li>\n<li><a href=\"https://github.com/aws-amplify/amplify-js/issues/1772\">Aws Amplify appsync API graphql cognito custom attribute · Issue #1772 · aws-amplify/amplify-js</a></li>\n<li><a href=\"https://github.com/aws-amplify/amplify-cli/issues/456\">Clarify security implications of using ID Token vs. Access Token for AppSync authorization · Issue #456 · aws-amplify/amplify-cli</a></li>\n</ul>","fields":{"slug":"/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito","title":"Amplify + Cognito + AppSyncにおいてリゾルバーでユーザのカスタム属性を取得する方法","date":"2019-04-13T07:14:40.000+09:00","excerpt":"なにこれAppSync + Cognitoにおける認可制御について以前の記事で説明しました。今回は、ユーザーのカスタム属性を使った認可制御（AppSyncのリゾルバーでカスタム属性を取得する方法）についてご紹介します。TL;DRAppSyn...","tags":["Amplify","AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"thumbnail/2019/04/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>AppSyncはCognitoと連携して認可制御ができます。\n今回はそのやり方についてご紹介します。\nざっくりいうと以下のようなことが実現可能です。</p>\n<ul>\n<li><a href=\"#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E5%AE%9A%E7%BE%A9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bquery%E3%82%84mutation%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\">✨スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）</a></li>\n<li><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\">💎リゾルバーにおける項目ごとの認可制御（ユーザーグループ）</a></li>\n<li><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%B4%B0%E3%81%8B%E3%81%AA%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%80%81%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%90%8D%EF%BC%89\">🎊リゾルバーにおける細かな認可制御（ユーザーグループ、ユーザー名）</a></li>\n</ul>\n<h2 id=\"スキーマ定義におけるqueryやmutationごとの認可制御（ユーザーグループ）\"><a href=\"#%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E5%AE%9A%E7%BE%A9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8Bquery%E3%82%84mutation%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）</h2>\n<p><code class=\"language-text\">@aws_auth</code>アノテーションをQueryやMutationに付与します。\n以下の例ではCognitoのユーザーグループごとに</p>\n<ul>\n<li><code class=\"language-text\">管理者</code>は登録、参照、更新、削除</li>\n<li><code class=\"language-text\">営業</code>は登録、参照、更新</li>\n<li><code class=\"language-text\">一般メンバー</code>は参照</li>\n</ul>\n<p>のように認可制御しています。</p>\n<div class=\"gatsby-code-title\">スキーマ定義における@aws_authを使った認可制御の例</div>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\">type Mutation <span class=\"token punctuation\">{</span>\n  createTask<span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> CreateTaskInput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> CraeteTaskPayload\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</span>\tupdateTask<span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> UpdateTaskInput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> UpdateTaskPayload\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</span>  deleteTask<span class=\"token punctuation\">(</span><span class=\"token attr-name\">input</span><span class=\"token punctuation\">:</span> DeleteTaskInput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> DeleteTaskPayload\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</span><span class=\"token punctuation\">}</span>\n\ntype Query <span class=\"token punctuation\">{</span>\n  getTask<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> ID<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Task\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token directive function\">@aws_auth</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">cognito_groups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"sales\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token string\">\"member\"</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n</span><span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<h3 id=\"デフォルトの認可制御\"><a href=\"#%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デフォルトの認可制御</h3>\n<p>AppSyncではエンドポイントごとに<code class=\"language-text\">@aws_auth</code>未定義の場合の挙動を以下2つから選択できます。</p>\n<ul>\n<li>\n<p><strong>ALLOW</strong></p>\n<ul>\n<li>認証済ユーザーであれば、すべてのユーザーを許可する</li>\n</ul>\n</li>\n<li>\n<p><strong>DENY</strong></p>\n<ul>\n<li>認証済ユーザーであっても、すべてのユーザーを許可しない　※<code class=\"language-text\">@aws_auth</code>を定義しないとアクセスできない</li>\n</ul>\n</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/66615087c57f76bc681a0cebe9d816fd/765c2/default-setting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 73.24561403508771%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABcRAAAXEQHKJvM/AAACjUlEQVQ4y42U208TQRTG98+XPpi0JRESSfQBE6AY6YtKSpfgEqMh2GBrsFJwe9nupd3tXrrX2fk8s7QVIhAn+TJ7mfn2d+acs5Isy5V2p3PW6fw4MQxDMU1TGY/HitrvK79VVbm6ulJ+drtKt/tL6fWuleFwqAxIw/v6NBqNTlVVbUr9fv8Ej4ycc4RRBC8I4PoBkjTDUyPLGKRna2uHlUoF6+vVtFwus2q1ykqlEmtdXDAGsCQI2NyZMbE6jyK6n7M4jlmapoxzvhL5cXo2l1qtVsMwTOi6zmzbhtCU5Ds2vA/vMfhyht7pKc1fMT7/Bvv8HIFlIYxjsuBLOH5LmEVS7/q6kTEOxnJ2F5++Bl/TEE/JXDcwJxPu+wCJEztR0R62VGEYJwkZdi8byCLkeS7Qi4ViJEkCdz7H1HEwIVlErZOp7boIwhABvZsvRNc8ImLP9yNp2FcbBTPPi8/cNfSJxrEd2NMpLNOCQaQBJUesofBWomg4ASGiIQ0Gg4UhF3GsDAm/oJiQmWGaKxrP8wSJiAjLiPhiUyrO8J7hA4R7tRrKVAUbm5uFXmxs4OXWFmazGZnyYt0yKU8biqSQDhsNbG+/Qa22j4N6He8ODlCnWZCKhCRZ9p+Gngv/uAll/y3qr16jsbODo91dmnfR3NuDd3ODnJKUjTSq1owvKuNxw5g6JPh+gWQyQf5AVzCREDrHzDJB2fhrSK13WLRZnierqifFFE9AHaJedpnh+iyIU+aGMfPCpJC499Kc+ZrOEIbZqlNEUz/anHSG0dhE5PhIZsE/ikjc8e5tkdrt9nPK5mfHcY4oc7KQ67qyZVnyUNNkazqVTcuU6S90O9+VeDaxZN00m1RaxyNN+/gHAsxfCs2vzccAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"default setting\"\n        title=\"\"\n        src=\"/static/66615087c57f76bc681a0cebe9d816fd/42603/default-setting.png\"\n        srcset=\"/static/66615087c57f76bc681a0cebe9d816fd/f931c/default-setting.png 200w,\n/static/66615087c57f76bc681a0cebe9d816fd/e8031/default-setting.png 400w,\n/static/66615087c57f76bc681a0cebe9d816fd/42603/default-setting.png 800w,\n/static/66615087c57f76bc681a0cebe9d816fd/5b8b9/default-setting.png 1200w,\n/static/66615087c57f76bc681a0cebe9d816fd/765c2/default-setting.png 1596w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h2 id=\"リゾルバーにおける項目ごとの認可制御（ユーザーグループ）\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E9%A0%85%E7%9B%AE%E3%81%94%E3%81%A8%E3%81%AE%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%EF%BC%89\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーにおける項目ごとの認可制御（ユーザーグループ）</h2>\n<p>リゾルバー中でユーザーグループを参照できるので、それを使って項目ごとの認可制御ができます。\n以下の例では、<code class=\"language-text\">管理者</code>、<code class=\"language-text\">営業</code>、<code class=\"language-text\">一般ユーザー</code>のCognitoユーザーグループがある場合に、\nタスク情報の登録日と更新日については、<code class=\"language-text\">管理者</code>と<code class=\"language-text\">営業</code>のみが参照可能できるように制御しています。</p>\n<div class=\"gatsby-code-title\">ユーザーグループごとにレスポンス項目を制御する例</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">## 一般メンバーか判定\n<span class=\"gatsby-highlight-code-line\">#<span class=\"token function\">foreach</span><span class=\"token punctuation\">(</span>$group <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>claims<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cognito:groups\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span>    #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$group <span class=\"token operator\">==</span> <span class=\"token string\">\"member\"</span><span class=\"token punctuation\">)</span>\n        #<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$isMember <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    #end\n#end\n\n#<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$result<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"discription\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>discription<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"owner\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>owner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n## <span class=\"token function\">一般メンバーには返さない</span><span class=\"token punctuation\">(</span>管理者と営業のみ参照できる<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">#<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>$isMember<span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">  $util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"created\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>created<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">  $util<span class=\"token punctuation\">.</span><span class=\"token function\">qr</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">,</span> $ctx<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>updated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">#end\n</span>\n$util<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"リゾルバーにおける細かな認可制御（ユーザーグループ、ユーザー名）\"><a href=\"#%E3%83%AA%E3%82%BE%E3%83%AB%E3%83%90%E3%83%BC%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E7%B4%B0%E3%81%8B%E3%81%AA%E8%AA%8D%E5%8F%AF%E5%88%B6%E5%BE%A1%EF%BC%88%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%80%81%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E5%90%8D%EF%BC%89\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リゾルバーにおける細かな認可制御（ユーザーグループ、ユーザー名）</h2>\n<p>ユーザーグループだけではなくユーザー名でも認可制御が可能です。\n例えば「<code class=\"language-text\">一般ユーザー</code>は自分が登録した情報のみ参照でき、<code class=\"language-text\">管理者</code>はすべて参照できる」のような要件を実現する場合です。\nここではAppSync + Cognito + Dynamoの例を考えます。\nまずタスクテーブルに「owner」カラムを設けて、タスクを登録者のCognitoユーザー名を登録しておきます。</p>\n<p><strong>タスクテーブル</strong></p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>description</th>\n<th>owner</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>123</td>\n<td>今週のブログ書く</td>\n<td>takumon</td>\n</tr>\n<tr>\n<td>124</td>\n<td>CodeBuildとGitHubのプルリク連携を調べる</td>\n<td>takumon</td>\n</tr>\n<tr>\n<td>125</td>\n<td>今週のGoogle Cloud Platform Podcast聞く</td>\n<td>inoue</td>\n</tr>\n</tbody>\n</table>\n<br/>\n<p>そして更新用レスポンスマッピングテンプレートで以下のようにします。</p>\n<div class=\"gatsby-code-title\">ユーザーグループとユーザー名で認可制御する例</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">## 管理者か判定\n<span class=\"gatsby-highlight-code-line\">#<span class=\"token function\">foreach</span><span class=\"token punctuation\">(</span>$group <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>claims<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cognito:groups\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span>  #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$group <span class=\"token operator\">==</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">)</span>\n    #<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$isAdmin <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n  #end\n#end\n\n#<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n## 管理者はすべてのタスクを参照できる\n#<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$isAdmin<span class=\"token punctuation\">)</span>\n  #<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$result <span class=\"token operator\">=</span> $context<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span>\n#<span class=\"token keyword\">else</span>\n  ## 一般ユーザーは自分が登録したタスクのみ参照できる\n  #<span class=\"token function\">foreach</span><span class=\"token punctuation\">(</span>$item <span class=\"token keyword\">in</span> $context<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    #<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$item<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">==</span> $context<span class=\"token punctuation\">.</span>identity<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span>\n</span>      #<span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>$myResults<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>$item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    #end\n  #end\n#end\n$utils<span class=\"token punctuation\">.</span><span class=\"token function\">toJson</span><span class=\"token punctuation\">(</span>$results<span class=\"token punctuation\">)</span></code></pre></div>\n<br/>\n<p>これで<code class=\"language-text\">takumon</code>の場合は2件、<code class=\"language-text\">inoue</code>の場合は1件、<code class=\"language-text\">管理者</code>の場合は3件参照できるようになります。\nなお<code class=\"language-text\">$util.unauthorized()</code>を使えば認可エラーを返せます。\nリゾルバーの書き方しだいで複雑な要件も実現できるでしょう。</p>\n<h2 id=\"クライアント側\"><a href=\"#%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クライアント側</h2>\n<p>なおCognitoと連携する場合、クライアント側も対応が必要です。</p>\n<h3 id=\"vue--apmlifyの場合\"><a href=\"#vue--apmlify%E3%81%AE%E5%A0%B4%E5%90%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vue + Apmlifyの場合</h3>\n<p>Vue + Apmlifyの場合は以下のようにします。<a href=\"https://github.com/Takumon/vue-amplify-sample/blob/master/src/main.js\">参考ソースコード</a></p>\n<div class=\"gatsby-code-title\">Vue   Apmlifyの場合のCognito連携設定</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Amplify<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Auth <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'aws-amplify'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AmplifyPlugin <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'aws-amplify-vue'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 環境変数から読み込み</span>\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  aws_project_region<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_PROJECT_REGION</span><span class=\"token punctuation\">,</span>\n  aws_appsync_graphqlEndpoint<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_APPSYNC_GRAPHQLENDPOINT</span><span class=\"token punctuation\">,</span>\n  aws_appsync_region<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_APPSYNC_REGION</span><span class=\"token punctuation\">,</span>\n  aws_appsync_authenticationType<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_APPSYNC_AUTHENTICATIONT_TYPE</span><span class=\"token punctuation\">,</span>\n  Auth<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    identityPoolId<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_COGNIT_IDENTITY_POOL_ID</span><span class=\"token punctuation\">,</span>\n    region<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_COGNIT_REGION</span><span class=\"token punctuation\">,</span>\n    identityPoolRegion<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_COGNIT_IDENTITY_POOL_REGION</span><span class=\"token punctuation\">,</span>\n    userPoolId<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_COGNIT_USER_POOL_ID</span><span class=\"token punctuation\">,</span>\n    userPoolWebClientId<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VUE_APP_AWS_COGNIT_USER_POOL_WEB_CLIENT_ID</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nAmplify<span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>AmplifyPlugin<span class=\"token punctuation\">,</span> Amplify<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>次にログイン画面を作ります。\nAmplifyが用意している<code class=\"language-text\">&lt;amplify-authenticator&gt;</code>タグで簡単に実現できます。<a href=\"https://github.com/Takumon/vue-amplify-sample/blob/master/src/views/Home.vue#L3-L5\">参考ソースコード</a></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4aba593574476fd281b449a2c68fc6a0/2e17d/how-to-client-login-0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 91.44254278728607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB30lEQVQ4y61UTWvbQBDVpf+jkH/aXvoPkh56a9OzHUwDodAefHCupjWFOJGFEiLbkr3SytJqVzOdWa2NSCw7LRl4aD/fvn2aWW84HL4Pw/CH7/sDwrf/xIA4fo5Go3febDa7wlcKIr3yptNpjztaa5VJafJ8Y/LNxsg8N0opQ1MGAI5BMQeJ6zHhBXeKsjR/bm7x4THC8OERp36AyWptT6YNx6B5XRAEFzvCuq4NkWJZKrtoG+12V+wlVKoy88US58sYN0XBB1gYY46C1ml35ScKiShNU5RS4nq9tiBvO6/N4Uj3E/I4E1RVRYoVq7b9Q+p4fq9CIjEizTDNpCVqe3gInR4yYZys7J9ldS/1r9NDzqfGQ4FZlmGSJLiyHhqnAv/NQxo0jW/KesjQqkCjlUPVfKuyNVairtR+hUy4/cOsMJM5ajlHzO8R5D3llXief4fy0JVQK5lhd9VdRCPadUlF+90CuB1d05pGYdBWyHUrhEAhSGVGJSduSVmIkPoIlbT08PktwgcP4eMbhFOvaX85QaiNI/QtYX8rG1xYeTv3a3A6Ae96gL/OACefGnDb78NWIXnY9/gte2nNdgWnmHu+Bt54PP5KVy3iOI4Iy4NYLgjzJ1jwXEQc5WTy+/wvgXZYEkac9X0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"how to client login 0\"\n        title=\"\"\n        src=\"/static/4aba593574476fd281b449a2c68fc6a0/42603/how-to-client-login-0.png\"\n        srcset=\"/static/4aba593574476fd281b449a2c68fc6a0/f931c/how-to-client-login-0.png 200w,\n/static/4aba593574476fd281b449a2c68fc6a0/e8031/how-to-client-login-0.png 400w,\n/static/4aba593574476fd281b449a2c68fc6a0/42603/how-to-client-login-0.png 800w,\n/static/4aba593574476fd281b449a2c68fc6a0/2e17d/how-to-client-login-0.png 818w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<h3 id=\"awsコンソールの場合\"><a href=\"#aws%E3%82%B3%E3%83%B3%E3%82%BD%E3%83%BC%E3%83%AB%E3%81%AE%E5%A0%B4%E5%90%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWSコンソールの場合</h3>\n<p>手っ取り早く試すなら、AppSyncのQuery実行画面に認証機能があるので、そちらで試しましょう。</p>\n<ul>\n<li>Query実行画面の実行ボタン左側の<code class=\"language-text\">Login with User Pools</code>というボタンをクリックします。</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7341229eaff50b2d6dfb9de94d6314d3/68428/how-to-client-login-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 81.74825174825175%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAACp0lEQVQ4y6WT30/TUBTH+//oI5vCoiiRaIiLGhP5V+SF+KRG/wYNGBABhQFuA5X6YNgwEQgBgmTJxmzZxtqxtve2XdvbHs+92/wRfCB4kpNzTnvPp99z7610oefq876BZD55b3i1dyApX791X07cuCMPJoflwdsP5Hj/kJwYvCvHr9yUY5f65NjlBMaE3IN5T7xXjieu8fWfYv1D6xdj/c+k3b19GdAopdA1Qm2oN5qgaAYcFIrw5PFTGB19BCMPR2AhtQC63oDacR3qdQ3qmo65Bn4QwebW9qqUy61ltjY3IZ/Lebm1NVYqFRkymWEYbL9wyFStydTjY6ZUquxHtcZ0x2VOy2O27TCH5+g2tT0uRNf1tLSUTmcnXk/Bq4kJNjY2Bvl8XqhsmhSq3zeg9iUFJ1vboO/sQGN3D6xsBmitCnbLAwQBIRRMkwS85+iokpG0UikLrgNgWaw7MmMBENsF/0SBoPAVWsUS2IeH4JXL4G58A1vXwfV8cN0W2LjOtKgAVioILK+vZ6FYAO/ggAWeB2EYCrcsC4IQThmfDRWBicpsBDro1HF+AxVVzfICISzqNHEgHyUIfF5AFEUQhfgWo4+ARq0JVbUBRDOBGhSI+YdCRVEEEJsYb+wCLUIQKNa1gZ13LQQSg4DtuDiuI0am1Dk/0MNtoQjjo/4a2f4PoO/7Qp0AduKZgYyxU4dybiA/FMdxxB/EI1fLvcXv37kUWkTsVxcUitMOxbM2yP03sFwuZ9uXmQUsDCNsjHz8MQ3DxOhHXePPuaHCCAHCSSdapH1tVPUoI+m6ttLZngjOaPjhv2r+MR4No7ksvRyfTC1//Bwtpj8YmRWZYE5m5pbI5PQ8mX63KPKZ+SURu/WbtykyPbdIpmZTZBZrjEbq/TK8GJ+c+wlB44Hd5Xg1rQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"how to client login 1\"\n        title=\"\"\n        src=\"/static/7341229eaff50b2d6dfb9de94d6314d3/42603/how-to-client-login-1.png\"\n        srcset=\"/static/7341229eaff50b2d6dfb9de94d6314d3/f931c/how-to-client-login-1.png 200w,\n/static/7341229eaff50b2d6dfb9de94d6314d3/e8031/how-to-client-login-1.png 400w,\n/static/7341229eaff50b2d6dfb9de94d6314d3/42603/how-to-client-login-1.png 800w,\n/static/7341229eaff50b2d6dfb9de94d6314d3/5b8b9/how-to-client-login-1.png 1200w,\n/static/7341229eaff50b2d6dfb9de94d6314d3/68428/how-to-client-login-1.png 1430w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<ul>\n<li>ログインモーダルが出てきます。接続先のCognitのクライアントID、ユーザー名、パスワードを入力すればOKです。</li>\n</ul>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/51c151c89e8ba601da492acc018d707d/4e3fb/how-to-client-login-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 80.06849315068494%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAACI0lEQVQ4y32U227TQBCG/Zw8BC+C4AaJt6jEDWplUDGiSIDaoh5SJXF8aAiNT7G9PiW21zvMrO3IITWRPu3YO/v7353JKhcX394sl7+/m6Z1jmiGYWqmaWvG9EEz7q40Y6FrRve+nbM0y7IPoLW2/fjz8vLqlaLriy+Av6YRMPYT4v/UNZd5aOxcmU5nZ/QQhlHlOC73PJ+v1w6n2HU9OeZ5wXe7Hd9ut0cURcGTJC3JEDr9QIIqCUZRjIsd8H0fnp7W4LguoDjiAYqhi/qAqh+rSpAoaeD2T/eCZVVxZGTLYpR2WrSCpoWC9lKF2xtI5jP+xw+kQ3KH2wDOeesIRxkP6D9EQ9M0A4f6QsXVkAUB98MI8jyHsqxoK1JkjHFB+1GFyT3kxoL7cSzPCxPQRXdefHB2g3hccK6rUBTA/A1frT1gCTqsG9hV41Q4T/2CSrLfms5y5xDP8O4GopnOLTeFlcMgSGrwWQ3BM9D7JK//bdPjKjddpbqc52rdrUaHaKjEwvH7H8hXwc3JoMqDtqGO76u6j/e0xcBmhnUYgvPpM7C3LyF690KkJ69bQcM4VWazuRSMGeOMJRDHDOOkheIOmjug2ELsh8BWjoi9zfGWse94mmYCRwnFY8gclogEY5blgqVpvRdEhx/pARMb/M9CluUSisfoc7I0k+AHGtLAG+dMub7+9T4INiVeAhu8DCIcJRSP0ef04GUS4Pt6Mnk4+QteTLjEAbZcWwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"how to client login 2\"\n        title=\"\"\n        src=\"/static/51c151c89e8ba601da492acc018d707d/42603/how-to-client-login-2.png\"\n        srcset=\"/static/51c151c89e8ba601da492acc018d707d/f931c/how-to-client-login-2.png 200w,\n/static/51c151c89e8ba601da492acc018d707d/e8031/how-to-client-login-2.png 400w,\n/static/51c151c89e8ba601da492acc018d707d/42603/how-to-client-login-2.png 800w,\n/static/51c151c89e8ba601da492acc018d707d/5b8b9/how-to-client-login-2.png 1200w,\n/static/51c151c89e8ba601da492acc018d707d/4e3fb/how-to-client-login-2.png 1460w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n<br/></p>\n<ul>\n<li>あとは通常のAppSyncのQuery実行画面と同じようにQueryやMutaitonを発行すれば認可制御されたレスポンスが確認できます。</li>\n</ul>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回はAppSync + Cognitoによる認可制御について紹介しました。<br/>\nQueryとMutation単位の認可制御であれば<code class=\"language-text\">@aws_auth</code>を使い、\n項目単位の認可制御はリゾルバーに任せるのがポイントです。</p>\n<p>余談ですが、<code class=\"language-text\">@aws_auth</code>は今のところユーザーグループ単位の認可制御しかできません。\nただ構文的にはユーザーグループ以外でも認可制御ができそうなので将来的に機能が追加されるのかもしれませんね🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security.html#amazon-cognito-user-pools-authorization\">AWS公式ドキュメント > AppSync > セキュリティ</a></li>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security-authorization-use-cases.html\">AWS公式ドキュメント > AppSync > セキュリティ > 認証のユースケース</a></li>\n</ul>","fields":{"slug":"/aws-appsync-auth-with-cognito","title":"AppSync + Cognitoによる認可制御","date":"2019-03-17T17:45:00.000+09:00","excerpt":"なにこれAppSyncはCognitoと連携して認可制御ができます。今回はそのやり方についてご紹介します。ざっくりいうと以下のようなことが実現可能です。✨スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）💎...","tags":["AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"thumbnail/2019/03/aws-appsync-auth-with-cognito.png"}}],"latestPosts":[{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>自分専用のRSSリーダーを<a href=\"https://gatsbyjs.org\">Gatsby</a> + <a href=\"https://netlify.com\">Netlify</a> + <a href=\"https://zapier.com/\">Zapier</a>を使って作りました。Gatsbyビルド時にRSSとOGPを取得して、Webサイトに表示しています。\n今回はこのWebサイトのビルドの仕組みと、GatsbyビルドでRSS+OGPを取得する方法をご紹介します。</p>\n<p>サイトはコチラ↓</p>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"height: 140px; padding-bottom: 0;\"><a href=\"https://favorite-blogs.netlify.com//\" data-iframely-url=\"//cdn.iframe.ly/api/iframe?url=https%3A%2F%2Ffavorite-blogs.netlify.com&key=0658bf78be97cafcf2b0b9f96c1270ee\"></a></div></div>\n<br/>\n<p>ソースはコチラ↓</p>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"height: 140px; padding-bottom: 0;\"><a href=\"https://github.com/Takumon/blog-rss\" data-iframely-url=\"//cdn.iframe.ly/B8twzEh\"></a></div></div>\n<br/>\n<h2 id=\"ビルドの仕組み\"><a href=\"#%E3%83%93%E3%83%AB%E3%83%89%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ビルドの仕組み</h2>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 105.86881472957421%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAABcRAAAXEQHKJvM/AAADJElEQVQ4y6WVW3PTRhiG/dt70avedmhpO0Og0EIChCQOYAcfZNmSZVmWLB8U2zlgwKFTEgewSdI0+/TTyk5CJ1DaXnyzHu3q1fN+h3WKZoWrQgVlCC3eWhuMcmuMy1k+uEV5Zus9FZ+Lz/ztvdQnBX0TOg57dh7zl5/IL1zjlZmFrZCzeO8T76U+S9iymEQ9jF+zBGmb/fAlDELZMxPCfy3YsfjdjzBuuriLIVFuC3Y6mv6/CbYqTHs7mA+rrP6wzsvaSCy3/5/g22hANvOMhesL7FpD2P5SwlhgVjV1SfCwOyAMIqKwz7C6pwn5xxzOxS6Lxmvb5mgwoF3y2LV9oX0hRWl9JKhb6BJIKhZQbQfVqoqAc0EnceyVGHsW07AOu6GI+ahO7Xx/3glceielmvIgfw9Ky6icrF4hEd90mdaK9J6s0kk/4o35lH1pbuT8eWPLuUPrGUd1Q2CqM8LNBkoLPgTjPqpbg9W7qFvfg/x+H9aoLC3Sz6wwNDLQ80VUaDY9/XtnY4V9Oyf0TaF3RbAfcNxrspVd5TRqwLCHSi+iblwDITqql2gu/azJ4pS896siss5pp55QSp61ZRlToroIivLILfPozi2sOz/qKv7p5Dmr5UGsbKfvk/72G04kn9O6ySRwmDhFjtt1TgProihiX2lBIRx6Ntuj1+xUCsmsBhU9XrHlSdNhkHks+TR4XcqwXdzgg3zwpF3Tl4ee+Tjk0kgIRWDcDXjuuxw05VBfZrU5O9iymUiFh0aRUdlgr5znhSXUmTX262K364pVWwdSfSJPqiyJjCnpSf4GgbSQbAiBzonEgVeVvDn85li88+MPNpJWicVEIKZKwtO2U7pJGwZnckg9XoKb36GePkBJm9CpclDJMxG7Y6vAGyGcOIau8tnMqpqFth334fmkSB9RXIcHUtHl26jsMrh5Dqsmpw2TQ7vESaMiogVNwrwXPzvLkrO4EKrrJAkX668Ka9reQTXH2M5y0qoxKqxIaq4WvSCcr7GF+dr3mRpfy+rxh3+XY+eGvg8nxa90i3yZ4EeXg5B2hVQIiZLQhZCx1HN/xX/KX27fz4YdRTNFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"build flow\"\n        title=\"\"\n        src=\"/static/d3807cd064fa752ebfead37f471691c0/42603/build-flow.png\"\n        srcset=\"/static/d3807cd064fa752ebfead37f471691c0/f931c/build-flow.png 200w,\n/static/d3807cd064fa752ebfead37f471691c0/e8031/build-flow.png 400w,\n/static/d3807cd064fa752ebfead37f471691c0/42603/build-flow.png 800w,\n/static/d3807cd064fa752ebfead37f471691c0/5b8b9/build-flow.png 1200w,\n/static/d3807cd064fa752ebfead37f471691c0/c7ea5/build-flow.png 1600w,\n/static/d3807cd064fa752ebfead37f471691c0/bc63a/build-flow.png 2400w,\n/static/d3807cd064fa752ebfead37f471691c0/81c80/build-flow.png 2607w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>以下時系列で説明します。</p>\n<ul>\n<li>\n<p>Zapier</p>\n<ul>\n<li>ジョブで定義したRSSを監視</li>\n<li>RSSに更新があったらNetlifyビルドをトリガー</li>\n</ul>\n</li>\n<li>\n<p>Netlify</p>\n<ul>\n<li>ビルドでGitHubからGatsbyプロジェクトのリポジトリをフェッチ</li>\n<li>Gatsbyプロジェクトのビルドを実行</li>\n<li>Gatsbyプロジェクトのビルドの中で、設定ファイルに定義したRSSをフェッチ</li>\n<li>ビルドが終わったらCDNにホスティング</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"netlifyとgithubの連携\"><a href=\"#netlify%E3%81%A8github%E3%81%AE%E9%80%A3%E6%90%BA\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NetlifyとGitHubの連携</h3>\n<p>Netlify上でGitHubリポジトリをビルド＆ホストできるようにしておきます。\n連携はNelityのGUIで簡単にできます。</p>\n<h3 id=\"zapierとnetlifyの連携\"><a href=\"#zapier%E3%81%A8netlify%E3%81%AE%E9%80%A3%E6%90%BA\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ZapierとNetlifyの連携</h3>\n<p>RSSリーダーは「RSSが更新されたらビルドをトリガーする」ような仕組みが必要です。この仕組みはNetlifyとZapierで実現できます。\nZapierはいろんなサービスやアプリを連携させて自動化できるWebサービスで、Netlifyにも対応しています。\nZapierの画面上で、監視したいRSSをポチポチ登録すると「RSSが更新されたらNetlifyのビルドをトリガーする」が簡単に実現できます。</p>\n<h2 id=\"rss--ogp取得\"><a href=\"#rss--ogp%E5%8F%96%E5%BE%97\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RSS + OGP取得</h2>\n<p>さてビルドの仕組みを整えたので、次はGatsbyのビルドでRSSを取得する方法について説明します。</p>\n<p>どのRSSを引っ張ってくるかは、GitHubリポジトリに設定ファイルにて定義します（<a href=\"https://github.com/Takumon/blog-rss/blob/master/favorite-blog-rss.js\">実際の設定ファイル</a>）。\nただコレ、ZapierのジョブのRSS定義と二重管理になるのが難点です。Zapierのタスクがyamlで書けるようになったら一元管理できるかもですが...</p>\n<div class=\"gatsby-code-title\">gatsby-node.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> striptags <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'striptags'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> cheerio <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cheerio'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"crypto\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Parser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rss-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> parser <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Parser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'User-Agent'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'something different'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">INTERNAL_TYPE_BLOG</span> <span class=\"token operator\">=</span> <span class=\"token string\">'blog'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">INTERNAL_TYPE_BLOG_POST</span> <span class=\"token operator\">=</span> <span class=\"token string\">'blogPost'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// RSSのような外部リソースを</span>\n<span class=\"token comment\">// GatsbyでGraphQLのデータとして扱うためには</span>\n<span class=\"token comment\">// sorceNodeで処理する</span>\nexports<span class=\"token punctuation\">.</span>sourceNodes <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> actions<span class=\"token punctuation\">,</span> createNodeId<span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> cache <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> feeds <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// 設定ファイルかなにかしらの方法でRSSのURLを読み込む</span>\n  <span class=\"token keyword\">const</span> blogUrls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'rss-url-1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rss-url-2'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> blogUrl <span class=\"token keyword\">of</span> blogUrls<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \n    <span class=\"token comment\">// rss-parserでRSS情報を取得する</span>\n    <span class=\"token keyword\">const</span> feed <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> parser<span class=\"token punctuation\">.</span><span class=\"token function\">parseURL</span><span class=\"token punctuation\">(</span>blogUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>feed <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>feed<span class=\"token punctuation\">,</span>\n        items<span class=\"token punctuation\">:</span> feed<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>item <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          title<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n          excerpt<span class=\"token punctuation\">:</span> <span class=\"token function\">excerpt</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span> <span class=\"token number\">120</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          content<span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n          pubDate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>pubDate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          link <span class=\"token punctuation\">:</span> item<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    feeds<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>feed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n\n  <span class=\"token comment\">// ブログごとにノード生成</span>\n  feeds\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>feed <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      title<span class=\"token punctuation\">:</span> feed<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">,</span>\n      description<span class=\"token punctuation\">:</span> feed<span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">,</span>\n      link<span class=\"token punctuation\">:</span> feed<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">,</span>\n      lastBuildDate<span class=\"token punctuation\">:</span> feed<span class=\"token punctuation\">.</span>lastBuildDate<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> contentDigest <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`md5`</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      \n      actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>b<span class=\"token punctuation\">,</span>\n        id<span class=\"token punctuation\">:</span> <span class=\"token function\">createNodeId</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">INTERNAL_TYPE_BLOG</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>b<span class=\"token punctuation\">.</span>link<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        children<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        parent<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`__SOURCE__`</span></span><span class=\"token punctuation\">,</span>\n        internal<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          type<span class=\"token punctuation\">:</span> <span class=\"token constant\">INTERNAL_TYPE_BLOG</span><span class=\"token punctuation\">,</span>\n          contentDigest<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// RSSに加えて、OGPを取得</span>\n  <span class=\"token keyword\">const</span> rssPosts <span class=\"token operator\">=</span> feeds<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>feed <span class=\"token operator\">=></span> feed<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>a<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>b<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> rssPostsWithImageUrl <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Promise.allでやると503になるのでfor文を使う</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> p <span class=\"token keyword\">of</span> rssPosts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> pWithImageUrl <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'User-Agent'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'something different'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>res <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token comment\">// 取得したHTMLからOGPを取得</span>\n      <span class=\"token keyword\">const</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">let</span> imageUrl<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'head meta'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> el<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> property <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'property'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>property <span class=\"token operator\">===</span> <span class=\"token string\">'og:image'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          imageUrl <span class=\"token operator\">=</span> content\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 記事情報にOGPのURLを追加</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>p<span class=\"token punctuation\">,</span>\n        imageUrl<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    rssPostsWithImageUrl<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>pWithImageUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n\n  <span class=\"token comment\">// OGP画像のノードを生成</span>\n  <span class=\"token comment\">// 重複を考慮してユニークにしてから処理する</span>\n  <span class=\"token keyword\">const</span> imageUrls <span class=\"token operator\">=</span> <span class=\"token function\">_uniq</span><span class=\"token punctuation\">(</span>rssPostsWithImageUrl<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> p<span class=\"token punctuation\">.</span>imageUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> p<span class=\"token punctuation\">.</span>imageUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>imageUrls<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> imageUrl <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> fileNode <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createRemoteFileNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      url<span class=\"token punctuation\">:</span> imageUrl<span class=\"token punctuation\">,</span>\n      cache<span class=\"token punctuation\">,</span>\n      store<span class=\"token punctuation\">,</span>\n      createNode<span class=\"token punctuation\">:</span> actions<span class=\"token punctuation\">.</span>createNode<span class=\"token punctuation\">,</span>\n      createNodeId<span class=\"token punctuation\">:</span> createNodeId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'ThumbnailImage'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> imageUrl<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> fileNode<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token comment\">// ブログ記事ごとのノード生成</span>\n  rssPostsWithImageUrl<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> contentDigest <span class=\"token operator\">=</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHash</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`md5`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">const</span> excerpt <span class=\"token operator\">=</span> \n    actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>p<span class=\"token punctuation\">,</span>\n      id<span class=\"token punctuation\">:</span> <span class=\"token function\">createNodeId</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">INTERNAL_TYPE_BLOG_POST</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>p<span class=\"token punctuation\">.</span>link<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      children<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      parent<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`__SOURCE__`</span></span><span class=\"token punctuation\">,</span>\n      internal<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token punctuation\">:</span> <span class=\"token constant\">INTERNAL_TYPE_BLOG_POST</span><span class=\"token punctuation\">,</span>\n        contentDigest<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// 記事要約は記事本文から抽出</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">excerpt</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> maxLength<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> rowText <span class=\"token operator\">=</span> <span class=\"token function\">striptags</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;pre>'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/&lt;pre[\\s\\S]+?>[\\s\\S]+?&lt;\\/pre>/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/\\n/g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/ /g</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> rowText<span class=\"token punctuation\">.</span>length <span class=\"token operator\">>=</span> maxLength\n    <span class=\"token operator\">?</span> rowText<span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> maxLength<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'...'</span>\n    <span class=\"token punctuation\">:</span> rowText<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>OGP画像をGatsbyで扱う処理は今も参考にしてみてください。</p>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"padding-bottom: 52.5%; padding-top: 120px;\"><a href=\"https://takumon.com/gatsby-image-of-remote-in-building-by-using-create-remote-file-node\" data-iframely-url=\"//cdn.iframe.ly/r1GTW3Y\"></a></div></div>\n<h3 id=\"リソース取得は間隔を置かないと503になる\"><a href=\"#%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E5%8F%96%E5%BE%97%E3%81%AF%E9%96%93%E9%9A%94%E3%82%92%E7%BD%AE%E3%81%8B%E3%81%AA%E3%81%84%E3%81%A8503%E3%81%AB%E3%81%AA%E3%82%8B\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>リソース取得は間隔を置かないと503になる</h3>\n<p>ビルド時にRSSやらOGPやらを引っ張ってくるために、大量のリクエストを発行しますが、サイトによっては時間当たりのリクエスト上限に引っかかって503エラーになることがあります。\n対処法としては、<code class=\"language-text\">Promise.all</code>で一度にリクエストを投げずに、for文でリクエスト1つずつawaitしながら投げて、適度に間隔を開けるのが良いと思います。</p>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>RSSリーダーのようなものをSPAだけで作ろうとすると、フロント側の高負荷処理で画面描画が遅くなってしまいますが、\nGatsbyを使えばビルド時に重い処理を流せるので、パフォーマンスの向上が期待できます。\nまた今回のように、NetlifyやZapierなど他サービスと連携することで、作れる静的サイトの幅も広がります。\nSPA(Single Page Application)でこのような静的サイトを作っている方は一度Gatsbyを導入してみてはいかがでしょうか🍅</p>","fields":{"slug":"/gatsby-rss-reader-with-netlify-and-zapier","title":"Gatsby + Netlify + ZapierでRSSリーダーを作る","date":"2019-06-18T10:00:00.000-07:00","excerpt":"なにこれ自分専用のRSSリーダーをGatsby + Netlify + Zapierを使って作りました。Gatsbyビルド時にRSSとOGPを取得して、Webサイトに表示しています。今回はこのWebサイトのビルドの仕組みと、Gatsbyビル...","tags":["Gatsby","Netlify","Zapier","RSS","gatsby-plugin-feed"],"keywords":["Gatsby"],"thumbnail":"thumbnail/2019/06/gatsby-rss-reader-with-netlify-zapier.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p><a href=\"https://www.netlify.com/docs/form-handling/\">Netlify Forms</a>はNetlifyにホストしている静的サイトでお問い合わせフォームを作れる機能です。DBを用意しなくても、お問い合わせフォーム送信結果はNetlify側で保持しれくれます。Netlifyの管理画面からCSVダウンロードなども可能です。\nさらに<a href=\"https://zapier.com/\">Zapier</a>と連携すると、お問い合わフォームで入力したメールアドレス宛てに定型フォーマットのメールを送信できたりもします。\nそんな便利なNetlify Formsですが、ググっても、お問い合わせフォームを同期的に送信する簡単な方法しか実装サンプルを見つけられませんでした。そこで今回は以下のような実用的サンプルの実装方法をご紹介します。</p>\n<ul>\n<li>お問い合わせフォームにファイルアップロードを含む</li>\n<li>Reactを使う</li>\n<li>入力チェックに<a href=\"https://jaredpalmer.com/formik/\">Formik</a>を使う</li>\n<li><a href=\"https://github.com/axios/axios\">axios</a>で非同期にお問い合わせフォームを送信する</li>\n</ul>\n<h2 id=\"step1-ファイルアップロード--単純なhmlt--同期送信\"><a href=\"#step1-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89--%E5%8D%98%E7%B4%94%E3%81%AAhmlt--%E5%90%8C%E6%9C%9F%E9%80%81%E4%BF%A1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step.1 ファイルアップロード + 単純なHMLT + 同期送信</h2>\n<p>もっとも単純なパターン、こちら<a href=\"https://www.netlify.com/docs/form-handling/\">Netlifyの公式サイト</a>に書いてある情報を参考に実装します。</p>\n<div class=\"gatsby-code-title\">index.html</div>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- (中略) --></span>\n  <span class=\"token comment\">&lt;!-- name：Formの名前NetlifyのおけるFormの識別子となる --></span>\n  <span class=\"token comment\">&lt;!-- novalidate：Formikで入力チェックするためブラウザの入力チェックはオフ --></span>\n  <span class=\"token comment\">&lt;!-- data-netlify：NetlifyでFormを認識させるための属性 --></span>\n  <span class=\"token comment\">&lt;!-- netlify-honeypot：NetlifyでFormを認識させるための属性 --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span>\n    <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>POST<span class=\"token punctuation\">\"</span></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>contact<span class=\"token punctuation\">\"</span></span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token attr-name\">novalidate</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token attr-name\">data-netlify</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token attr-name\">netlify-honeypot</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>bot-field<span class=\"token punctuation\">\"</span></span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">></span></span>\n</span>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleText<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleFile<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    \n    <span class=\"token comment\">&lt;!-- 送信ボタン --></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n      SUBMIT\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span>\n<span class=\"token comment\">&lt;!-- (中略) --></span></code></pre></div>\n<br/>\n<h2 id=\"step2-ファイルアップロード--react--同期送信\"><a href=\"#step2-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89--react--%E5%90%8C%E6%9C%9F%E9%80%81%E4%BF%A1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step.2 ファイルアップロード + React + 同期送信</h2>\n<p>次にReactの場合です。Reactの場合はフォーム情報に<code class=\"language-text\">bot-field</code>と<code class=\"language-text\">form-name</code>を付与する必要があります。\nこれらは<code class=\"language-text\">&lt;input type=&quot;hidden&quot;&gt;</code>で実装します。</p>\n<div class=\"gatsby-code-title\">SampleForm.jsx</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>  <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>form\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"contact\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formの名前NetlifyのおけるFormの識別子となる */</span><span class=\"token punctuation\">}</span>\n    method<span class=\"token operator\">=</span><span class=\"token string\">\"POST\"</span>\n    novalidate<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formikで入力チェックするためブラウザの入力チェックはオフ */</span><span class=\"token punctuation\">}</span>\n    data<span class=\"token operator\">-</span>netlify<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>  <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n    netlify<span class=\"token operator\">-</span>honeypot<span class=\"token operator\">=</span><span class=\"token string\">\"bot-field\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyFormで必要な値 */</span><span class=\"token punctuation\">}</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>bot-field<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyFormで必要な値 */</span><span class=\"token punctuation\">}</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>form-name<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleText<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleFile<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    \n    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* 送信ボタン */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      SUBMIT</span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">);</span></code></pre></div>\n<br/>\n<h2 id=\"step3-ファイルアップロード--react--formik--同期送信\"><a href=\"#step3-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89--react--formik--%E5%90%8C%E6%9C%9F%E9%80%81%E4%BF%A1\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step.3 ファイルアップロード + React + Formik + 同期送信</h2>\n<p>Netlify Formsはサーバー側のバリデーション機能はないので、\n実際使うときはフロント側のバリデーションが必要です。\nここでは、Reactのバリデーションライブラリ<a href=\"https://jaredpalmer.com/formik/\">Fromik</a>を使ってバリデーションを追加します。</p>\n<p>入力チェックエラーメッセージ表示はコンポーネント化します。そのほうがすっきりするので。</p>\n<div class=\"gatsby-code-title\">ErrorMessage.jsx</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Field<span class=\"token punctuation\">,</span> getIn <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'formik'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Formikエラーメッセージ表示用コンポーネント</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Field</span>\n    <span class=\"token attr-name\">name</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">render</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> form <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> error <span class=\"token operator\">=</span> <span class=\"token function\">getIn</span><span class=\"token punctuation\">(</span>form<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> touch <span class=\"token operator\">=</span> <span class=\"token function\">getIn</span><span class=\"token punctuation\">(</span>form<span class=\"token punctuation\">.</span>touched<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      cosnt isShowError <span class=\"token operator\">=</span> touch <span class=\"token operator\">&amp;&amp;</span> error<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> isShowError\n        <span class=\"token operator\">?</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>error<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n  <span class=\"token punctuation\">/></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>入力フォームのコンポーネントはFormikの作法にしたがって以下を実装します。<br/></p>\n<ul>\n<li><code class=\"language-text\">initialValues</code>:入力フォーム初期値設定処理</li>\n<li><code class=\"language-text\">validate</code>: 入力チェック処理</li>\n<li><code class=\"language-text\">render</code>: 入力フォーム描画処理</li>\n</ul>\n<p>ただしファイルについてはFormikが用意している<code class=\"language-text\">Field</code>タグは<code class=\"language-text\">type=file</code>をサポートしていないので、HTMLの<code class=\"language-text\">input</code>タグでファイル変更時に手動でFormikにファイルを追加します。</p>\n<div class=\"gatsby-code-title\">SampleForm.jsx</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> navigate <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"gatsby\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Formik<span class=\"token punctuation\">,</span> Field <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'formik'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ErrorMessage <span class=\"token keyword\">from</span> <span class=\"token string\">'./ErrorMessage'</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// フォームの値を初期化</span>\n<span class=\"token keyword\">const</span> initialValues <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'form-name'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'contact'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// NetlifyFormで必要な値</span>\n  <span class=\"token string\">'bot-field'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// NetlifyFormで必要な値</span>\n  sampleText<span class=\"token punctuation\">]</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  sampleFile<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// 入力チェック</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleValidate</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> errors <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// sampleText</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>values<span class=\"token punctuation\">.</span>sampleText<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    errors<span class=\"token punctuation\">.</span>sampleText <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`テキストを記入してください`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// sampleFile</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>values<span class=\"token punctuation\">.</span>sampleFile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    errors<span class=\"token punctuation\">.</span>sampleFile <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`ファイルを添付してください`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">.</span>sampleFile<span class=\"token punctuation\">.</span>size <span class=\"token operator\">></span> <span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    errors<span class=\"token punctuation\">.</span>sampleFile <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`100MB以下のファイルを添付してください`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> errors<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">// Form描画処理</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">renderForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  dirty<span class=\"token punctuation\">,</span>\n  isSubmitting<span class=\"token punctuation\">,</span>\n  setFieldValue<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>form\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"contact\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formの名前NetlifyのおけるFormの識別子となる */</span><span class=\"token punctuation\">}</span>\n    method<span class=\"token operator\">=</span><span class=\"token string\">\"POST\"</span>\n    novalidate<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formikで入力チェックするためブラウザの入力チェックはオフ */</span><span class=\"token punctuation\">}</span>\n    data<span class=\"token operator\">-</span>netlify<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>  <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n    netlify<span class=\"token operator\">-</span>honeypot<span class=\"token operator\">=</span><span class=\"token string\">\"bot-field\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Field</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>bot-field<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyFormで必要な値 */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Field</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>form-name<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyFormで必要な値 */</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Field</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleText<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ErrorMessage</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleText<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n\n    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* FormikのFieldタグではなくHTMLのinputタグを使う */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span>input\n      id<span class=\"token operator\">=</span><span class=\"token string\">\"sampleFile\"</span>\n      name<span class=\"token operator\">=</span><span class=\"token string\">\"sampleFile\"</span>\n      type<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span>\n      <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ファイル変更時に、手動でFormikの値に設定 */</span><span class=\"token punctuation\">}</span>\n      onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>event <span class=\"token operator\">=></span> <span class=\"token function\">setFieldValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sampleFile\"</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>currentTarget<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ErrorMessage</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>sampleFile<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    \n    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* 送信ボタン */</span><span class=\"token punctuation\">}</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">disabled</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>isSubmitting<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span> isSubmitting <span class=\"token operator\">?</span> <span class=\"token string\">'SUBMITTING...'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'SUBMIT'</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n);\n\n\n// Form用Reactコンポーネント\nexport default () =>  (\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Formik</span>\n    <span class=\"token attr-name\">initialValues</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>initialValues<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">validate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleValidate<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">render</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>renderForm<span class=\"token punctuation\">}</span></span>\n  <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n);</span></code></pre></div>\n<br />\n<h2 id=\"step5-ファイルアップロード--react--formik--非同期送信axios\"><a href=\"#step5-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89--react--formik--%E9%9D%9E%E5%90%8C%E6%9C%9F%E9%80%81%E4%BF%A1axios\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step.5 ファイルアップロード + React + Formik + 非同期送信(Axios)</h2>\n<p>Reactを使っている場合、SPAなので同期通信は極力控えたほうが良いです。\nそのため入力フォームの送信も非同期でやるのが現実的でしょう。\nここでは、<code class=\"language-text\">Formik</code>の<code class=\"language-text\">onSubmit</code>でAxiosを使ってお問い合わせフォームを非同期送信する例を示します。<br/>\n<code class=\"language-text\">Formik</code>タグは<code class=\"language-text\">onSubmit</code>プロパティでサブミット処理を自分で定義できます。\nこの<code class=\"language-text\">onSubmit</code>にて、axiosを使うことで非同期処理が可能です。<br/></p>\n<p><small>大半は前セクションと同じなので差分にフォーカスして説明します</small></p>\n<p>エラーメッセージ用コンポーネントは前回と同じなので割愛します。</p>\n<p>以下フォーム用コンポーネントです。</p>\n<div class=\"gatsby-code-title\">SampleForm.jsx</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> navigate <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"gatsby\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Formik<span class=\"token punctuation\">,</span> Field <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'formik'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ErrorMessage <span class=\"token keyword\">from</span> <span class=\"token string\">'./ErrorMessage'</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">\"axios\"</span><span class=\"token punctuation\">;</span>\n</span>\n<span class=\"token comment\">// フォームの値を初期化</span>\n<span class=\"token comment\">/* (略) */</span>\n\n<span class=\"token comment\">// 入力チェック</span>\n<span class=\"token comment\">/* (略) */</span>\n\n<span class=\"token comment\">// サブミット処理</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleSubmit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">,</span> actions<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// FormData作成</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span>  params <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">  params<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'form-name'</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">[</span><span class=\"token string\">'form-name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// for Netlify Forms</span>\n</span><span class=\"gatsby-highlight-code-line\">  params<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bot-field'</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">[</span><span class=\"token string\">'bot-field'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// for Netlify Forms</span>\n</span><span class=\"gatsby-highlight-code-line\">  params<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sampleText'</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">[</span><span class=\"token string\">'sampleText'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  params<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sampleFile'</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">[</span><span class=\"token string\">'sampleFile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// Formikの送信中フラグをオンにする</span>\n</span><span class=\"gatsby-highlight-code-line\">  actions<span class=\"token punctuation\">.</span><span class=\"token function\">setSubmitting</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// axiosで非同期にお問い合わせフォームを送信</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    method<span class=\"token punctuation\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/x-www-form-urlencoded\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    data<span class=\"token punctuation\">:</span> params<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/\"</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>res <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// フォーム送信完了後</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// 他画面に遷移（同期遷移ではなくSPAとしての遷移）</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">navigate</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/application-complete'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// フォーム内容初期化</span>\n</span><span class=\"gatsby-highlight-code-line\">    actions<span class=\"token punctuation\">.</span><span class=\"token function\">resetForm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// 最後にFormikの送信中フラグをオフにする</span>\n</span><span class=\"gatsby-highlight-code-line\">    actions<span class=\"token punctuation\">.</span><span class=\"token function\">setSubmitting</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>err <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// なにかしらエラーハンドリング</span>\n</span><span class=\"gatsby-highlight-code-line\">    actions<span class=\"token punctuation\">.</span><span class=\"token function\">setSubmitting</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span>    <span class=\"token comment\">/* (中略) */</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">// Form描画処理</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">renderForm</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  handleSubmit<span class=\"token punctuation\">,</span>\n  dirty<span class=\"token punctuation\">,</span>\n  isSubmitting<span class=\"token punctuation\">,</span>\n  setFieldValue<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>form\n    name<span class=\"token operator\">=</span><span class=\"token string\">\"contact\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formの名前NetlifyのおけるFormの識別子となる */</span><span class=\"token punctuation\">}</span>\n    method<span class=\"token operator\">=</span><span class=\"token string\">\"POST\"</span>\n    novalidate<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* Formikで入力チェックするためブラウザの入力チェックはオフ */</span><span class=\"token punctuation\">}</span>\n    data<span class=\"token operator\">-</span>netlify<span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>  <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n    netlify<span class=\"token operator\">-</span>honeypot<span class=\"token operator\">=</span><span class=\"token string\">\"bot-field\"</span> <span class=\"token punctuation\">{</span><span class=\"token comment\">/* NetlifyでFormを認識させるための属性 */</span><span class=\"token punctuation\">}</span>\n    onSubmit<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>handleSubmit<span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">></span>\n    <span class=\"token punctuation\">{</span><span class=\"token comment\">/* (中略) */</span><span class=\"token punctuation\">}</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token comment\">// Form用Reactコンポーネント</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>  <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Formik</span>\n    <span class=\"token attr-name\">initialValues</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>initialValues<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">validate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleValidate<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">render</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>renderForm<span class=\"token punctuation\">}</span></span>\n    <span class=\"token attr-name\">onSubmit</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleSubmit<span class=\"token punctuation\">}</span></span>\n  <span class=\"token punctuation\">/></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br />\n<p>これでようやくNetlify FormsにおいてReactを使って非同期でファイルアップロードできるようになりました！</p>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>自分の復習も兼ねてステップごとに実装方法をご紹介しました。\nAngularとVueで実装する場合も今回紹介した実装と似たような感じになると思います。\n参考にしてみてください🍅</p>","fields":{"slug":"/async-file-upload-in-netlify-forms-with-react-formik-axios","title":"Netlify Formsでファイルを非同期アップロード with React + Formik + Axios","date":"2019-06-01T22:00:00.000-07:00","excerpt":"なにこれNetlify FormsはNetlifyにホストしている静的サイトでお問い合わせフォームを作れる機能です。DBを用意しなくても、お問い合わせフォーム送信結果はNetlify側で保持しれくれます。Netlifyの管理画面からCSVダ...","tags":["Netlify","NetlifyForms","React","Fromik","Axios"],"keywords":["Netlify"],"thumbnail":"thumbnail/2019/06/async-file-upload-in-netlify-forms-with-react-formik-axios.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>Gatsbyで画像を扱う場合<a href=\"https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-image\">gatsby-image</a>を使うとイイ感じに最適化してくれます。\nWebサイトのリポジトリ内の画像については<code class=\"language-text\">gatsby-config.js</code>で簡単に設定できますが、<strong>今回はビルド時に動的に取得する外部画像に対して設定する方法をご紹介します。</strong></p>\n<h2 id=\"実装方法\"><a href=\"#%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装方法</h2>\n<h3 id=\"step1-外部画像ファイルノード生成\"><a href=\"#step1-%E5%A4%96%E9%83%A8%E7%94%BB%E5%83%8F%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%83%8E%E3%83%BC%E3%83%89%E7%94%9F%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step1. 外部画像ファイルノード生成</h3>\n<p>Gatsbyの<a href=\"\">gatsby-source-filesystem</a>では、外部画像を扱うためのAPI(<code class=\"language-text\">createRemoteFileNode</code>)が用意されています。\nコチラを<code class=\"language-text\">gatsby-node.js</code>の<code class=\"language-text\">sourceNodes</code>で呼び出せば外部画像にgatsby-imageを適用できます。\nあと、ちょっとしたハックとして、Reactコンポーネント側で他ファイルノードと区別できるように、ノード生成時に識別子を付けましょう。これは後述する外部画像表示用コンポーネントで使うためのものです。</p>\n<div class=\"gatsby-code-title\">gatsby-node.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createRemoteFileNode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`gatsby-source-filesystem`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// sourceNodesにて外部画像のファイルノードを作成する</span>\nexports<span class=\"token punctuation\">.</span>sourceNodes <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> actions<span class=\"token punctuation\">,</span> createNodeId<span class=\"token punctuation\">,</span> cache<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* (中略) */</span>\n\n  <span class=\"token comment\">// ここでは外部画像のURLの配列を処理するサンプルを示す</span>\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>sampleImageUrls<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> sampleImageUrl <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// createRemoteFileNodeで外部の画像のファイルノードを作成する</span>\n    <span class=\"token keyword\">const</span> fileNode <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createRemoteFileNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      url<span class=\"token punctuation\">:</span> sampleImageUrl<span class=\"token punctuation\">,</span>\n      cache<span class=\"token punctuation\">,</span>\n      store<span class=\"token punctuation\">,</span>\n      createNode<span class=\"token punctuation\">:</span> actions<span class=\"token punctuation\">.</span>createNode<span class=\"token punctuation\">,</span>\n      createNodeId<span class=\"token punctuation\">:</span> createNodeId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 他ファイルノードと区別するための識別子を付与</span>\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'SampleImage'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// メタ情報として画像のURLを付与</span>\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> sampleImageUrl<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> fileNode<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/* (中略) */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<h3 id=\"step2-外部画像表示用reactコンポーネント作成\"><a href=\"#step2-%E5%A4%96%E9%83%A8%E7%94%BB%E5%83%8F%E8%A1%A8%E7%A4%BA%E7%94%A8react%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88%E4%BD%9C%E6%88%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step2. 外部画像表示用Reactコンポーネント作成</h3>\n<p>外部画像のファイルノードを生成できたら、\n今度はReactコンポーネント側で、それに<code class=\"language-text\">gatsby-iamge</code>を適用して表示します。\nGraphQLのクエリで、ファイルノードを生成時に付与した識別子を使い、すべてのファイルノードから外部画像だけを抽出するようにしましょう。</p>\n<div class=\"gatsby-code-title\">sample-image.jsx</div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> GatsbyImage <span class=\"token keyword\">from</span> <span class=\"token string\">'gatsby-image'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> StaticQuery<span class=\"token punctuation\">,</span> graphql <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'gatsby'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// OGP画像のURLを引数に取る</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n</span>  <span class=\"token operator\">&lt;</span>StaticQuery\n    query<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>graphql<span class=\"token template-string\"><span class=\"token string\">`\n      query {\n        allFile(\n          # Gatsby Buildで付与した識別子をもとに\n          # 全ファイルからOPG画像のみ抽出\n          filter: {fields: {SampleImage: {eq: \"true\"}}}\n        ){\n          edges {\n            node {\n              childImageSharp {\n                resolutions {\n                  ...GatsbyImageSharpResolutions\n                }\n              }\n              id\n              fields {\n                # 一応メタ情報も取得する\n                SampleImage\n                link\n              }\n            }\n          }\n        }\n      }\n    `</span></span><span class=\"token punctuation\">}</span>\n    render<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>data <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token comment\">// OGP画像リストの中から、コンポーネント引数で指定したURLの画像を抽出する</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> targetEdge <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>allFile<span class=\"token punctuation\">.</span>edges<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>edge <span class=\"token operator\">=></span> edge<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>link <span class=\"token operator\">===</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span>\n      <span class=\"token comment\">// 画像が取得できた場合のみgatsby-imageのコンポーネントを返す</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        targetEdge <span class=\"token operator\">&amp;&amp;</span> targetEdge<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>childImageSharp\n          <span class=\"token operator\">&amp;&amp;</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>GatsbyImage</span> <span class=\"token attr-name\">resolutions</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>targetEdge<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>childImageSharp<span class=\"token punctuation\">.</span>resolutions<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n          <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h3 id=\"step3-上記で作成したコンポーネントの呼び出し\"><a href=\"#step3-%E4%B8%8A%E8%A8%98%E3%81%A7%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9F%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step3. 上記で作成したコンポーネントの呼び出し</h3>\n<p>最後に上記コンポーネントの呼び出します。以下のように外部画像のURLを指定してあげましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>SampleImage</span> <span class=\"token attr-name\">url</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>SampleImageUrl<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<br/>\n<p>これで外部画像に<code class=\"language-text\">gatsby-image</code>を適用してイイ感じに表示できます！</p>\n<h2 id=\"例：webサイトurlからogp画像を取得する場合\"><a href=\"#%E4%BE%8B%EF%BC%9Aweb%E3%82%B5%E3%82%A4%E3%83%88url%E3%81%8B%E3%82%89ogp%E7%94%BB%E5%83%8F%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>例：WEBサイトURLからOGP画像を取得する場合</h2>\n<p>実用的な例として、複数のWebサイトのOGP画像を<code class=\"language-text\">gatsby-image</code>として扱う方法をご紹介します。</p>\n<div class=\"gatsby-code-title\">gatsby-node.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> cheerio <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cheerio'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createRemoteFileNode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`gatsby-source-filesystem`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// sourceNodesにて外部画像のファイルノードを作成する</span>\nexports<span class=\"token punctuation\">.</span>sourceNodes <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> actions<span class=\"token punctuation\">,</span> createNodeId<span class=\"token punctuation\">,</span> cache<span class=\"token punctuation\">,</span> store <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* (中略) */</span>\n\n\n  <span class=\"token comment\">// WEBサイトURLからHTMLを取得してOGPを抽出</span>\n  <span class=\"token keyword\">const</span> ogpImageUrls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Promise.allで処理するとリクエスト多可で503になるのでfor文で一件ずつ処理する</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> postUrl <span class=\"token keyword\">of</span> postUrls<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>postUrl<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'User-Agent'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'something different'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// cheerioを使ってHMTLからOGP画像URLを抽出</span>\n    <span class=\"token keyword\">let</span> ogpImageUrl<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'head meta'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> el<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> property <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'property'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> content <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>el<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'content'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>property <span class=\"token operator\">===</span> <span class=\"token string\">'og:image'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        ogpImageUrls<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>ogpImageUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 取得したOGP画像URLをもとにファイルノードを生成</span>\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>ogpImageUrls<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> imageUrl <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> fileNode <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">createRemoteFileNode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      url<span class=\"token punctuation\">:</span> imageUrl<span class=\"token punctuation\">,</span>\n      cache<span class=\"token punctuation\">,</span>\n      store<span class=\"token punctuation\">,</span>\n      createNode<span class=\"token punctuation\">:</span> actions<span class=\"token punctuation\">.</span>createNode<span class=\"token punctuation\">,</span>\n      createNodeId<span class=\"token punctuation\">:</span> createNodeId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 他ファイルノードと区別するための識別子を付与</span>\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'OgpImage'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// メタ情報として画像のURLを付与</span>\n    <span class=\"token keyword\">await</span> actions<span class=\"token punctuation\">.</span><span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">:</span> fileNode<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'link'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> imageUrl<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> fileNode<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>Reactのコンポーネントの定義、呼び出し側定義は<a href=\"#%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95\">実装方法</a>で紹介した内容とほぼ同じなので割愛します。</p>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>今回の方法を使えば、外部から画像をかき集めてリッチなWebサイトを構築する場合でも、Gatsby側でブラウザ表示を最適化してくれて、画面表示が遅くなる心配もありません。\n是非参考にしてみてください🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://www.wildsmithstudio.com/blog/remote-images-with-gatsby/\">Wrangling remote images with Gatsby</a></li>\n<li><a href=\"https://stackoverflow.com/questions/52612936/gatsby-fetching-remote-images-with-createremotefilenode\">graphql - Gatsby - fetching remote images with createRemoteFileNode - Stack Overflow</a></li>\n</ul>","fields":{"slug":"/gatsby-image-of-remote-in-building-by-using-create-remote-file-node","title":"Gatsbyにおける外部取得画像へのgatsby-image適用方法","date":"2019-06-01T21:30:00.000-07:00","excerpt":"なにこれGatsbyで画像を扱う場合gatsby-imageを使うとイイ感じに最適化してくれます。Webサイトのリポジトリ内の画像についてはgatsby-config.jsで簡単に設定できますが、今回はビルド時に動的に取得する外部画像に対し...","tags":["Gatsby","gatsby-image"],"keywords":["Gatsby"],"thumbnail":"thumbnail/2019/06/gatsby-image-of-remote-in-building-by-using-create-remote-file-node.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>GatsbyでWebサイトを作るときに、ブログや職種紹介など2種類以上のマークダウンファイルを管理する場合があると思います。通常だとMarkdownRemarkNodeの<code class=\"language-text\">fileAbsolutePath</code>でしか両者のマークダウンファイルを見分ける術がありませんが、ここではもっとスマートなやり方を紹介します。簡単に言うとFileNodeの<code class=\"language-text\">sourceInstanceName</code>をMarkdownRemarkNodeに引き継ぐことにより、GraphQLのfilterで簡単に区別できるという方法です。</p>\n<h2 id=\"実装方法\"><a href=\"#%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装方法</h2>\n<h3 id=\"step1-マークダウンファイルのflenodeでsourceinstancenameを定義\"><a href=\"#step1-%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AEflenode%E3%81%A7sourceinstancename%E3%82%92%E5%AE%9A%E7%BE%A9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step1. マークダウンファイルのFleNodeでsourceInstanceNameを定義</h3>\n<p>マークダウンファイルの読み込み設定はgatsby-config.jsで以下のようにします。\n<code class=\"language-text\">name</code>を付けることでマークダウンファイルのFileNodeにおいて<code class=\"language-text\">sourceInstanceName</code>が設定できます。</p>\n<div class=\"gatsby-code-title\">gatsby-config.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* (中略) */</span>\n\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">/* (中略) */</span>\n\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token punctuation\">:</span> <span class=\"token string\">'gatsby-source-filesystem'</span><span class=\"token punctuation\">,</span>\n      options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\">// オプションでname(FileNodeにおけるsourceInstanceName)を指定</span>\n</span><span class=\"gatsby-highlight-code-line\">        name<span class=\"token punctuation\">:</span> <span class=\"token string\">'posts'</span><span class=\"token punctuation\">,</span>\n</span>        path<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>__dirname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/content/posts`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      resolve<span class=\"token punctuation\">:</span> <span class=\"token string\">'gatsby-source-filesystem'</span><span class=\"token punctuation\">,</span>\n      options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\">// オプションでname(FileNodeにおけるsourceInstanceName)を指定</span>\n</span><span class=\"gatsby-highlight-code-line\">        name<span class=\"token punctuation\">:</span> <span class=\"token string\">'jobs'</span><span class=\"token punctuation\">,</span>\n</span>        path<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>__dirname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/content/jobs`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'gatsby-transformer-remark'</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/* (中略) */</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">/* (中略) */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h3 id=\"step2-filenodeのnameをmarkdownfilenodeに引継ぐ\"><a href=\"#step2-filenode%E3%81%AEname%E3%82%92markdownfilenode%E3%81%AB%E5%BC%95%E7%B6%99%E3%81%90\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step2. FileNodeのnameをMarkdownFileNodeに引継ぐ</h3>\n<p>何もしないとFileNodeの<code class=\"language-text\">sourceInstanceName</code>はMarkdownRemarkNodeに引き継がれません。\nそのため<code class=\"language-text\">gatsby-node.js</code>で引継ぎ処理を実装します。</p>\n<div class=\"gatsby-code-title\">gatsby-node.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateNode</span>  <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> node<span class=\"token punctuation\">,</span> boundActionCreators<span class=\"token punctuation\">,</span> getNode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createNodeField <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> boundActionCreators\n\n  <span class=\"token comment\">// MarkdownRemarkNodeの場合のみ処処</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>internal <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'MarkdownRemark'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// 親のFileNodeを取得して</span>\n    <span class=\"token keyword\">const</span> parent <span class=\"token operator\">=</span> <span class=\"token function\">getNode</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// gatsby-config.jsで設定したFileNodeのsourceInstanceNameを</span>\n    <span class=\"token comment\">// MarkdownRemarkのフィールドに引き継ぐ</span>\n    <span class=\"token comment\">// 名前はMarkdownRemarkの他プロパティとかぶらないようにcollectionとしている</span>\n    <span class=\"token function\">createNodeField</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      node<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> <span class=\"token string\">'collection'</span><span class=\"token punctuation\">,</span>\n      value<span class=\"token punctuation\">:</span> parent<span class=\"token punctuation\">.</span>sourceInstanceName<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h3 id=\"step3-graphqlでnameをもとにマークダウンを区別\"><a href=\"#step3-graphql%E3%81%A7name%E3%82%92%E3%82%82%E3%81%A8%E3%81%AB%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%82%92%E5%8C%BA%E5%88%A5\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step3. GraphQLでnameをもとにマークダウンを区別</h3>\n<p>GraphQLではcollectionフィールドで、それぞれを区別します。</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> <span class=\"token punctuation\">{</span>\n  allMarkdownRemark<span class=\"token punctuation\">(</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\"># collectionにて記事のNodeのみ抽出</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token attr-name\">filter</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">fields</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">collection</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">eq</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"posts\"</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n</span>  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      node <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># (中略)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>簡単ですがGatsbyで良く困る事例の1つを紹介しました。\nGatsbyは多くのフックポイントを設けているので、今回のよう、やろうと思えば結構いろんなことができます🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://github.com/gatsbyjs/gatsby/issues/1634\">Question: How do I query based on gatsby-source-filesystem name? · Issue #1634 · gatsbyjs/gatsby</a></li>\n</ul>","fields":{"slug":"/how-to-distinct-2-kinds-of-markdown-in-gatsby","title":"Gatsbyで2種類のマークダウンファイルの区別する方法","date":"2019-06-01T21:00:00.000-07:00","excerpt":"なにこれGatsbyでWebサイトを作るときに、ブログや職種紹介など2種類以上のマークダウンファイルを管理する場合があると思います。通常だとMarkdownRemarkNodeのfileAbsolutePathでしか両者のマークダウンファイ...","tags":["Gatsby"],"keywords":["Gatsby"],"thumbnail":"thumbnail/2019/06/how-to-distinct-2-kinds-of-markdown-in-gatsby.png"}},{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>Gatsbyでは、gatsby-node.jsのcreatePagesで以下のようにページを作成できます。\nただルートページ（index.jsのページ）はGatsby側で生成されるので通常はContextが設定できません。\nしかし場合によってはルートページにContextを設定したい時もあるでしょう。\nそこで今回は、ルートページにContextを設定する方法をご紹介します。</p>\n<div class=\"gatsby-code-title\">gatsby-node.jsでページにContextを設定する方法（ルートページでは使えない）</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">createPages</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> actions <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* (中略) */</span>\n\n  actions<span class=\"token punctuation\">.</span><span class=\"token function\">createPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>slug<span class=\"token punctuation\">,</span>\n    component<span class=\"token punctuation\">:</span> qiitaPost<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    context<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      slug<span class=\"token punctuation\">:</span> node<span class=\"token punctuation\">.</span>fields<span class=\"token punctuation\">.</span>slug<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      relatedPosts<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      latestPosts<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token operator\">...</span><span class=\"token function\">previouseAndNext</span><span class=\"token punctuation\">(</span>posts<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">/* (中略) */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"実装方法\"><a href=\"#%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装方法</h2>\n<p>gatsby-node.jsでは<a href=\"https://www.gatsbyjs.org/docs/node-apis/#onCreatePage\"><code class=\"language-text\">onCreatePage</code></a>というAPIが用意されており、ページ生成時の処理を定義できます。これを使って以下のような処理を実行します。</p>\n<div class=\"gatsby-code-title\">gatsby-node.js</div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreatePage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> page<span class=\"token punctuation\">,</span> actions <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createPage<span class=\"token punctuation\">,</span> deletePage <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> actions\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// ルートページの場合のみ処理継続</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">.</span>path <span class=\"token operator\">===</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span>\n</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// いったんルートページを削除</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">deletePage</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span>\n</span>\n  <span class=\"token comment\">// pageオブジェクトをもとにルートページを再生成</span>\n  <span class=\"token function\">createPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>page<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    context<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token operator\">...</span>page<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      house<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`Gryffindor`</span></span><span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n</span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br/>\n<p>やり方は原始的で、ルートページ生成されたときに一度削除して、ルートページを再生成します。\nこの時<code class=\"language-text\">createPage</code>の引数でContextを渡せば追加できます。</p>\n<p>ちなみに、<code class=\"language-text\">onCreatePage</code>で<code class=\"language-text\">craetePage</code>を呼び出すと無限ループになるのでは？と思うかもしれませんが、\n<code class=\"language-text\">onCratePage</code>はGatsby側で生成されたページの場合しか呼び出されないので、その心配はありません。<br/>\n以上です。🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://www.gatsbyjs.org/docs/creating-and-modifying-pages/#pass-context-to-pages\">Creating and Modifying Pages | GatsbyJS</a></li>\n</ul>","fields":{"slug":"/how-to-attach-context-to-root-page-in-gatsby","title":"GatsbyのルートページにContextを設定する方法","date":"2019-05-31T16:10:00.000+09:00","excerpt":"なにこれGatsbyでは、gatsby-node.jsのcreatePagesで以下のようにページを作成できます。ただルートページ（index.jsのページ）はGatsby側で生成されるので通常はContextが設定できません。しかし場合に...","tags":["Gatsby"],"keywords":["Gatsby"],"thumbnail":"thumbnail/2019/05/how-to-attach-context-to-root-page-in-gatsby.png"}}],"previous":{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p><a href=\"https://kazupon.github.io/vue-i18n/\"><strong>VueI18n</strong></a>はVue.jsの多言語対応ライブラリです。vueファイルのtemplateタグでは、<code class=\"language-text\">&lt;p&gt;{{$t(&#39;message.hello&#39;)}}&lt;/p&gt;</code>のように使います。ただ<strong>vueファイルのscriptタグや、他のJavaScriptファイルでの使い方</strong>は<a href=\"https://kazupon.github.io/vue-i18n/guide/formatting.html\">ガイド</a>に明記されていません。今回はそのやり方についてご紹介します。</p>\n<h2 id=\"使い方\"><a href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使い方</h2>\n<p><a href=\"https://github.com/kazupon/vue-i18n/issues/149\">GitHubのIssue</a>に答えが載っています。</p>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"height: 168px; padding-bottom: 0;\"><a href=\"https://github.com/kazupon/vue-i18n/issues/149\" data-iframely-url=\"//cdn.iframe.ly/GvV4JME\"></a></div></div>\n<br/>\n<p>まずVueI18nを以下のように定義します。</p>\n<div class=\"gatsby-code-title\">i18n.js</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Vue <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span>\n<span class=\"token keyword\">import</span> VueI18n <span class=\"token keyword\">from</span> <span class=\"token string\">'vue-i18n'</span>\n\n<span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  en<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      hello<span class=\"token punctuation\">:</span> <span class=\"token string\">'hello world'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  ja<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      hello<span class=\"token punctuation\">:</span> <span class=\"token string\">'こんにちは、世界'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueI18n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> i18n <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueI18n</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  locale<span class=\"token punctuation\">:</span> <span class=\"token string\">'ja'</span><span class=\"token punctuation\">,</span>\n  messages<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<p>vueファイルのscriptタグでは以下のようにします。\n<strong>VueI18nオブジェクトの<code class=\"language-text\">tc</code>メソッドを使います。</strong>\nこうすることでvueファイルのscriptやJavaScriptファイルなど、どこでも使えるようになります。</p>\n<div class=\"gatsby-code-title\">vueファイルのscriptタグ</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// i18nをインポートします</span>\n</span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> i18n <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'i18n.jsの相対パス'</span>\n</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* (中略) */</span>\n    methods<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">getHello</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">            <span class=\"token keyword\">return</span> i18n<span class=\"token punctuation\">.</span><span class=\"token function\">tc</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message.hello'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span>        <span class=\"token punctuation\">}</span>    \n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">/* (中略) */</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></code></pre></div>\n<br/>\n<p>以上です🍅</p>","fields":{"slug":"/vue-i18n-in-script-tag","title":"VueI18nをscriptタグやJSファイル内で使う方法","date":"2019-02-21T07:50:00.000+09:00","excerpt":"なにこれVueI18nはVue.jsの多言語対応ライブラリです。vueファイルのtemplateタグでは、&#x3C;p>{{$t('message.hello')}}&#x3C;/p>のように使います。ただvueファイルのscriptタグ...","tags":["Vue.js","VueI18n"],"keywords":["Vue.js"],"thumbnail":"thumbnail/2019/02/vue-i18n-in-script-tag.png"}},"next":{"html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p><a href=\"https://vuetifyjs.com/ja/\">Vuetify</a> + <a href=\"https://baianat.github.io/vee-validate/\">VeeValidate</a>で入力チェックする際に、<a href=\"https://kazupon.github.io/vue-i18n/\">VueI18n</a>を使ってエラーメッセージを多言語対応・共通化する方法について紹介します。</p>\n<h2 id=\"定義方法\"><a href=\"#%E5%AE%9A%E7%BE%A9%E6%96%B9%E6%B3%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>定義方法</h2>\n<h3 id=\"veevalidate\"><a href=\"#veevalidate\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VeeValidate</h3>\n<p>VeeValidateであらかじめ言語毎にエラーメッセージを用意しているので、そちらを使います。\n※<code class=\"language-text\">i18nRootKey</code>については後述の<a href=\"#vuei18n%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\">vuei18nのメッセージファイル</a>で詳細を説明します。</p>\n<div class=\"gatsby-code-title\">VeeValidateの定義</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Vue <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> VeeValidate <span class=\"token keyword\">from</span> <span class=\"token string\">'vee-validate'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// VeeValidateで用意されている日本語版入力チェックエラーメッセージを使う</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> ja <span class=\"token keyword\">from</span> <span class=\"token string\">'vee-validate/dist/locale/ja'</span><span class=\"token punctuation\">;</span>\n</span><span class=\"token comment\">// VeeValidateで用意されている英語語版入力チェックエラーメッセージを使う</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> en <span class=\"token keyword\">from</span> <span class=\"token string\">'vee-validate/dist/locale/en'</span><span class=\"token punctuation\">;</span>\n</span><span class=\"token comment\">// VueI18nオブジェクトをインポートする</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> i18n <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./i18n'</span><span class=\"token punctuation\">;</span>\n\nVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VeeValidate<span class=\"token punctuation\">,</span> \n  <span class=\"token comment\">// オプションでi18nを指定する</span>\n  <span class=\"token punctuation\">{</span>\n    i18n<span class=\"token punctuation\">,</span>\n    i18nRootKey<span class=\"token punctuation\">:</span> <span class=\"token string\">'validations'</span><span class=\"token punctuation\">,</span>\n    dictionary<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> ja<span class=\"token punctuation\">,</span> en <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h3 id=\"vuei18n\"><a href=\"#vuei18n\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VueI18n</h3>\n<p>こちらは以前<a href=\"vue-i18n-in-script-tag#%E4%BD%BF%E3%81%84%E6%96%B9\">「VueI18nをscriptタグやJSファイル内で使う方法」</a>で紹介したものと同様です。</p>\n<div class=\"gatsby-code-title\">VueI18nの定義</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Vue <span class=\"token keyword\">from</span> <span class=\"token string\">'vue'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> VueI18n <span class=\"token keyword\">from</span> <span class=\"token string\">'vue-i18n'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// メッセージ定義はjsonファイルから読み込む</span>\n<span class=\"token keyword\">const</span> messages <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./i18n.json'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nVue<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>VueI18n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ブラウザ言語を取得</span>\n<span class=\"token keyword\">const</span> language <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span>\n    window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>languages\n    <span class=\"token operator\">&amp;&amp;</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>languages<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>language\n  <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>userLanguage\n  <span class=\"token operator\">||</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>browserLanguage\n  <span class=\"token operator\">||</span> <span class=\"token string\">'ja'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> locale <span class=\"token operator\">=</span> language<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'ja'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'ja'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'en'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// VueI18nで使う言語はブラウザ言語とする</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> i18n <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VueI18n</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  locale<span class=\"token punctuation\">,</span>\n  messages<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br/>\n<h3 id=\"vuei18nのメッセージファイル\"><a href=\"#vuei18n%E3%81%AE%E3%83%A1%E3%83%83%E3%82%BB%E3%83%BC%E3%82%B8%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VueI18nのメッセージファイル</h3>\n<p>VeeValidateの定義で<code class=\"language-text\">i18nRootKey: &#39;validations&#39;,</code>と指定したので、\nメッセージファイルでは、言語別に<code class=\"language-text\">validations</code>というプロパティを定義します。\nその中の<code class=\"language-text\">attributes</code>でエラー項目名を指定できます。</p>\n<div class=\"gatsby-code-title\">VueI18nのメッセージファイル(JSONファイル)</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"ja\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"validations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token property\">\"attributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span>        <span class=\"token property\">\"contractName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"契約名\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"en\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token property\">\"validations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token property\">\"attributes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n</span>        <span class=\"token property\">\"contractName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ContractName\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"vueファイルでの使い方\"><a href=\"#vue%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%A7%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vueファイルでの使い方</h2>\n<p>Vuetifyの<code class=\"language-text\">v-text-field</code>タグの場合、以下のように実装します。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>template</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>v-text-field</span>\n    <span class=\"token attr-name\">v-model</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>editedItem.name<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token attr-name\">&lt;!--</span> <span class=\"token attr-name\">VeeValidateでの項目名を定義</span> <span class=\"token attr-name\">--</span><span class=\"token punctuation\">></span></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">&lt;!-- ※i18nのメッセージファイルで定義している項目名と合わせる --></span>\n</span><span class=\"gatsby-highlight-code-line\">    data-vv-name=\"contractName\"\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">&lt;!-- data-vv-nameで定義した名前でエラーメッセージを取得する --></span>\n</span><span class=\"gatsby-highlight-code-line\">    :error-messages=\"errors.collect('contractName')\"\n</span>    >\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>v-text-field</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">@click</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>validate<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>入力チェック<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>template</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script language-javascript\">\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      editedItem<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        name<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  methods<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">async</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> valid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$validator<span class=\"token punctuation\">.</span><span class=\"token function\">validateAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>valid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'入力チェックNGです！！！'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<br/>\n<p>以上です🍅</p>\n<h2 id=\"参考\"><a href=\"#%E5%8F%82%E8%80%83\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://baianat.github.io/vee-validate/guide/localization.html#vuei18n-integration\">Localization | VeeValidate</a></li>\n</ul>","fields":{"slug":"/vuetify-and-vee-validate-and-vue-i18n","title":"Vuetify + VeeValidate + VueI18nでエラーメッセージ共通化","date":"2019-03-02T12:30:00.000+09:00","excerpt":"なにこれVuetify + VeeValidateで入力チェックする際に、VueI18nを使ってエラーメッセージを多言語対応・共通化する方法について紹介します。定義方法VeeValidateVeeValidateであらかじめ言語毎にエラーメ...","tags":["Vue.js","Vuetify","VeeValidate","VueI18n"],"keywords":["Vue.js"],"thumbnail":"thumbnail/2019/03/vuetify-and-vee-validate-and-vue-i18n.png"}}}}