{"data":{"site":{"siteMetadata":{"title":"Takumon Blog","author":"Takuto Inoue"}},"markdownRemark":{"id":"725b9e2d-1d82-5fc4-96be-4b073911512a","html":"<h2 id=\"なにこれ\"><a href=\"#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なにこれ</h2>\n<p>自分のブログの目次をQiitaっぽくしたい…現在表示中の章をハイライトする目次を作りたい…ということで作りました。\nマークダウンをHTMLに変換するのに<a href=\"https://unified.js.org/\">unified</a>という構文解析ライブラリを使っています。<br>\nメモ用にReactサンプルアプリも作りました ⇒ <a href=\"https://github.com/Takumon/react-markdown-sync-toc\">ソース</a>と<a href=\"https://takumon.github.io/react-markdown-sync-toc/\">デモ</a></p>\n<p><img src=\"/scroll-sync-toc-1ab28e49a6d92fa569ec65b06994040c.gif\" alt=\"scroll\"></p>\n<h2 id=\"ポイント\"><a href=\"#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ポイント</h2>\n<ul>\n<li>マークダウンのHTML化と目次抽出には<a href=\"https://unified.js.org/\">unified</a>を使いました。</li>\n<li>\n<p>スクロールの度に現在表示中の章をチェックして目次ハイライトを更新します。</p>\n<ul>\n<li>スクロール処理は高負荷なので負荷軽減のために<a href=\"https://lodash.com/docs/4.17.10#throttle\">Lodashのthrottle</a>を使いました。</li>\n<li>表示中の章が切り替わるごとに再描画するためにReactのstateを使いました。</li>\n</ul>\n</li>\n</ul>\n<p>以下で詳細を説明していきます。</p>\n<h2 id=\"unified\"><a href=\"#unified\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>unified</h2>\n<p>アプリの実装を説明する前にマークダウンの構文解析に使っているunifiedについて説明します。<br>\nunified自体はただのインターフェースです。構文解析ロジックはもっておらず、構文木を使ってテキストを処理するフローを提供します。</p>\n<ol>\n<li><code class=\"language-text\">parse</code>: 文字列をパーサーで構文木に変換</li>\n<li><code class=\"language-text\">run</code>: 必要に応じて構文木をトランスフォーマーで変換</li>\n<li><code class=\"language-text\">stringfy</code>: 構文木をコンパイラーで文字列に出力</li>\n</ol>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/unified-process-4541b057bfb68d071f236a872378f2df-3c4d0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.17605004468275%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA+UlEQVQoz31RWWuGQAz0//85EcRbPNf7oajgvWkmVvke2g4Mm2Myrllj33f7uq4vZs8ctNYDzs/4OI6BdcNv/c8cNKZpqonBCfEgbdsmMQuJTaQ2z7MQdfTRe+J1XSVHDK0xjmNJN1hzaTbRHAsBnKg/tfM83xhaNnrrbK5hqLquoyzLdJ7nVFUV9X1PbdsKy7J8qZQiaJumkbOua8IMyPO0LMt9w6IoyPM87bouOY4jpmAYhhTHMZmmSbZtUxRFlCSJGKMfBAFhxvd9oRjyDtXPL2v6A5Zlidl/wE6xTxjKDvWN90FA3ovcCF/HbdM0ldrTf7QAHhCG3wZ0GQ6cX7ZHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"unifiedの処理の流れ\"\n        title=\"\"\n        src=\"/static/unified-process-4541b057bfb68d071f236a872378f2df-fb8a0.png\"\n        srcset=\"/static/unified-process-4541b057bfb68d071f236a872378f2df-1a291.png 148w,\n/static/unified-process-4541b057bfb68d071f236a872378f2df-2bc4a.png 295w,\n/static/unified-process-4541b057bfb68d071f236a872378f2df-fb8a0.png 590w,\n/static/unified-process-4541b057bfb68d071f236a872378f2df-526de.png 885w,\n/static/unified-process-4541b057bfb68d071f236a872378f2df-3c4d0.png 1119w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3 id=\"ライブラリ群\"><a href=\"#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%BE%A4\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ライブラリ群</h3>\n<p>unifiedが提供するインターフェースの実装（プロセッサー）は、マークダウン用、HTML用、テキスト用の3種類があります。\nプロセッサーごとに、構文定義、パーサー、コンパイラーが用意されています。\n構文定義の方法は3種類の間で統一されており、マークダウンからHTMLなど相互変換が可能です。</p>\n<table>\n<thead>\n<tr>\n<th>解析対象</th>\n<th>プロセッサー</th>\n<th>構文定義</th>\n<th>パーサー</th>\n<th>コンパイラー</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>マークダウン</td>\n<td><a href=\"https://github.com/remarkjs/remark\">remark</a></td>\n<td><a href=\"https://github.com/syntax-tree/mdast\">mdast</a></td>\n<td><a href=\"https://github.com/remarkjs/remark/tree/master/packages/remark-parse\">remark-parse</a></td>\n<td><a href=\"https://github.com/remarkjs/remark/tree/master/packages/remark-stringify\">remark-stringify</a></td>\n</tr>\n<tr>\n<td>HTML</td>\n<td><a href=\"https://github.com/rehypejs/rehype\">rehype</a></td>\n<td><a href=\"https://github.com/syntax-tree/hast\">hast</a></td>\n<td><a href=\"https://github.com/rehypejs/rehype/tree/master/packages/rehype-parse\">rehype-parse</a></td>\n<td><a href=\"https://github.com/rehypejs/rehype/tree/master/packages/rehype-stringify\">rehype-stringify</a></td>\n</tr>\n<tr>\n<td>テキスト</td>\n<td><a href=\"https://github.com/retextjs/retext\">retext</a></td>\n<td><a href=\"https://github.com/syntax-tree/nlcst\">nlcst</a></td>\n<td><a href=\"https://github.com/retextjs/retext/tree/master/packages/retext-latin\">retext-latin</a></td>\n<td><a href=\"https://github.com/retextjs/retext/tree/master/packages/retext-stringify\">retext-stringfy</a></td>\n</tr>\n</tbody>\n</table>\n<p>ライブラリごとにプラグインが山ほどあって、例えばHMTLをミニファイしたり、マークダウンをリントしたり、文章中の<code class=\"language-text\">a</code>と<code class=\"language-text\">an</code>を識別したり、いろんなことができます。\n汎用的なAPIで独自ロジック実装できる! といった拡張性の高さもポイントです。</p>\n<h3 id=\"使い方\"><a href=\"#%E4%BD%BF%E3%81%84%E6%96%B9\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>使い方</h3>\n<p>unifiedがパイプラインになっていて必要なライブラリをメソッドチェーンで順番に設定していきます。\nパーサーとコンパイラーは1個つずつ、トランスフォーマーは任意の個数を指定してください。\nパーサーとコンパイラー未指定だと実行時エラーになるので気をつけましょう。</p>\n<div class=\"gatsby-code-title\">実装例</div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> unified <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unified'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> markdown <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'remark-parse'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> remark2rehype <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'remark-rehype'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> doc <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rehype-document'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> format <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rehype-format'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rehype-stringify'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> report <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vfile-reporter'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">unified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>markdown<span class=\"token punctuation\">)</span>      <span class=\"token comment\">// パーサー（マークダウン文字列を構文木に変換）</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>remark2rehype<span class=\"token punctuation\">)</span> <span class=\"token comment\">// トランスフォーマー（マークダウンからHTMLに変換）</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>doc<span class=\"token punctuation\">)</span>           <span class=\"token comment\">// トランスフォーマー（HTMLタグなどでラップ）</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span>        <span class=\"token comment\">// トランスフォーマー（HTMLをフォーマット）</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span>          <span class=\"token comment\">// コンパイラー（rehypeの構文木を文字列に変換）</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span><span class=\"token string\">'# Hello world!'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">report</span><span class=\"token punctuation\">(</span>err <span class=\"token operator\">||</span> file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-code-title\">実行結果</div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">no issues found\n&lt;!DOCTYPE html&gt;\n&lt;html lang=&quot;en&quot;&gt;\n  &lt;head&gt;\n    &lt;meta charset=&quot;utf-8&quot;&gt;\n    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;\n  &lt;/head&gt;\n  &lt;body&gt;\n    &lt;h1&gt;Hello world!&lt;/h1&gt;\n  &lt;/body&gt;\n&lt;/html&gt;</code></pre></div>\n<h3 id=\"unified採用の経緯\"><a href=\"#unified%E6%8E%A1%E7%94%A8%E3%81%AE%E7%B5%8C%E7%B7%AF\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>unified採用の経緯</h3>\n<p>このブログ(Gatsby製)は<a href=\"https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-transformer-remark\">gatsby-trasform-remark</a>というプラグインでマークダウン情報を取得しています。ただ目次情報についてはHTML化した目次しか取得できません。\nQiitaっぽい目次作成には少々難ありです。<br>\nそんなこんなで悩んでいたところ<a href=\"https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby-transformer-remark/src/extend-node-type.js#L20\">プラグインのソース</a>を見てみたらマークダウン文字列解析にunifiedを使っていることに気づきました。\n幸いプラグインで生のマークダウン文字列を取得できたので、unidiedで目次情報を抽出して実現できそうだと考え、採用に至りました。</p>\n<h2 id=\"実装\"><a href=\"#%E5%AE%9F%E8%A3%85\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装</h2>\n<p>ポイントを載せていきます。詳細は<a href=\"https://github.com/Takumon/react-markdown-sync-toc\">ソースコード</a>を見てください。</p>\n<h3 id=\"マークダウンをhmtl化する\"><a href=\"#%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%82%92hmtl%E5%8C%96%E3%81%99%E3%82%8B\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>マークダウンをHMTL化する</h3>\n<p>マークダウン文字列を読み込んでHTML文字列に変換します。\n現在画面に表示中の章を判定するために<a href=\"https://github.com/remarkjs/remark-slug\">remark-slug</a>を使って章にidを付与しています。\nちなみにこの<a href=\"https://github.com/remarkjs/remark-slug\">remark-slug</a>は<a href=\"https://github.com/syntax-tree/mdast-util-to-string\">mdast-util-to-string</a>と<a href=\"https://github.com/Flet/github-slugger\">github-slugger</a>を使ってidを付与しています。<br></p>\n<p><em>※実際はReactコンポーネントですが簡単のためソースコードを一部省略しています。</em></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> unified <span class=\"token keyword\">from</span> <span class=\"token string\">'unified'</span>\n<span class=\"token keyword\">import</span> markdown <span class=\"token keyword\">from</span> <span class=\"token string\">'remark-parse'</span>       <span class=\"token comment\">// パーサー(文字列をremarkの構文木に変換)</span>\n<span class=\"token keyword\">import</span> slug <span class=\"token keyword\">from</span> <span class=\"token string\">'remark-slug'</span>            <span class=\"token comment\">// トランスフォーマー(章にidをつける)</span>\n<span class=\"token keyword\">import</span> remark2rehype <span class=\"token keyword\">from</span> <span class=\"token string\">'remark-rehype'</span> <span class=\"token comment\">// トランスフォーマー(マークダウンからHTMLに変換)</span>\n<span class=\"token keyword\">import</span> html <span class=\"token keyword\">from</span> <span class=\"token string\">'rehype-stringify'</span>       <span class=\"token comment\">// コンパイラー(HTML構文木を文字列に変換)</span>\n\n<span class=\"token keyword\">const</span> rawMarkdownBody <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`## なにこれ\nReactでMarkdownファイルを読み込んで表示するアプリ。\\n\n目次も表示します。特徴としては目次においてスクロールに応じて現在表示中のセクションがハイライトされます。\n\n## 大セクション その1`</span></span>\n･\n･\n･\n`<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> contents <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span>\n  <span class=\"token function\">unified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>markdown<span class=\"token punctuation\">)</span>        <span class=\"token comment\">// パーサー(文字列をremarkの構文木に変換)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>slug<span class=\"token punctuation\">)</span>            <span class=\"token comment\">// トランスフォーマー(章にidをつける)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>remark2rehype<span class=\"token punctuation\">)</span>   <span class=\"token comment\">// トランスフォーマー(マークダウンからHTMLに変換)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span>            <span class=\"token comment\">// コンパイラー(HTML構文木を文字列に変換)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">processSync</span><span class=\"token punctuation\">(</span>rawMarkdownBody<span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<div class=\"gatsby-code-title\">変換の流れ</div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">マークダウン文字列\n│\n│ ←　remark-parse(パーサー)\n↓\nmdast構文木\n│\n│ ←　remark-slug(トランスフォーマー)\n↓\n章にidをつけたmdast構文木\n│\n│ ← remark-rehype(トランスフォーマー)\n↓\nhast構文木\n│\n│ ← rehype-stringify(コンパイラー)\n↓\nHTML文字列</code></pre></div>\n<h3 id=\"マークダウンから目次情報を抽出する\"><a href=\"#%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%81%8B%E3%82%89%E7%9B%AE%E6%AC%A1%E6%83%85%E5%A0%B1%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>マークダウンから目次情報を抽出する</h3>\n<p>remarkのparseメソッドを使うと簡単にマークダウン構文木を取得できます。\nそして取得した構文木から独自ロジックで目次情報を抽出します。\n具体的には構文木を再帰的に捜査できるプラグイン<a href=\"https://github.com/syntax-tree/unist-util-visit\">unist-util-visit</a>を使って目次情報を抽出しました。<br>\nid付与のロジックはマークダウン生成時のロジック(remark-slugのロジック）とあわせています。<br></p>\n<p><em>※実際はReactコンポーネントですが簡単のためソースコードを一部省略しています。</em></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> remark <span class=\"token keyword\">from</span> <span class=\"token string\">'remark'</span>\n<span class=\"token keyword\">import</span> visit <span class=\"token keyword\">from</span> <span class=\"token string\">'unist-util-visit'</span>\n<span class=\"token keyword\">import</span> mdastToString <span class=\"token keyword\">from</span> <span class=\"token string\">'mdast-util-to-string'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> GithubSlugger <span class=\"token keyword\">from</span> <span class=\"token string\">'github-slugger'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> githubSlugger <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GithubSlugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// マークダウン文字列から目次情報を抽出する</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">_extractToc</span><span class=\"token punctuation\">(</span>rawMarkdownBody<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  githubSlugger<span class=\"token punctuation\">.</span><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> ast <span class=\"token operator\">=</span> <span class=\"token function\">remark</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>rawMarkdownBody<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> <span class=\"token string\">'heading'</span><span class=\"token punctuation\">,</span> child <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> githubSlugger<span class=\"token punctuation\">.</span><span class=\"token function\">slug</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">||</span> <span class=\"token function\">mdastToString</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> depth <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>depth\n</span><span class=\"gatsby-highlight-code-line\">    result<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      value<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      id<span class=\"token punctuation\">,</span>\n</span><span class=\"gatsby-highlight-code-line\">      depth\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</span>\n  <span class=\"token keyword\">return</span> result\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>この後さらに目次情報を加工していきますが説明が長くなるので省略します。詳細は<a href=\"https://github.com/Takumon/react-markdown-sync-toc/blob/master/src/scroll-sync-toc.js#L87-L169\">ソースコード</a>をご覧ください。</p>\n<h3 id=\"スクロール毎に表示中の章を判定する\"><a href=\"#%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%AF%8E%E3%81%AB%E8%A1%A8%E7%A4%BA%E4%B8%AD%E3%81%AE%E7%AB%A0%E3%82%92%E5%88%A4%E5%AE%9A%E3%81%99%E3%82%8B\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スクロール毎に表示中の章を判定する</h3>\n<p>Reactのコンポーネントで実装します。\nスクロールイベントは<code class=\"language-text\">componentDidMount</code>で購読を開始し<code class=\"language-text\">componentWillUnmount</code>で破棄します。<br>\n<strong>スクロール処理は高負荷なので<a href=\"https://lodash.com/docs/4.17.10#throttle\">Lodashのthrottle</a>で100ミリ秒ごとに間引いています。</strong>\n現在表示中の章の情報はsetStateでstateに格納しています。これにより表示中の章が切り替わった時にReactが再描画してくれます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> throttle <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'lodash'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Toc <span class=\"token keyword\">from</span> <span class=\"token string\">'./toc'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> githubSlugger <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GithubSlugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ScrollSyncToc</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>toc <span class=\"token operator\">=</span> <span class=\"token function\">_getToc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>rawMarkdownBody<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      activeItemIds<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      itemTopOffsets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>calculateItemTopOffsets <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>calculateItemTopOffsets<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleScroll <span class=\"token operator\">=</span> <span class=\"token function\">throttle</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleScroll<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 負荷軽減のため間引く</span>\n</span>  <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">componentDidMount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">calculateItemTopOffsets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">    window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`scroll`</span></span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleScroll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span>\n</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">componentWillUnmount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`scroll`</span></span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleScroll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span>\n</span>\n  <span class=\"token function\">calculateItemTopOffsets</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      itemTopOffsets<span class=\"token punctuation\">:</span> <span class=\"token function\">_getElementTopOffsetsById</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>toc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">handleScroll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> itemTopOffsets <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> item <span class=\"token operator\">=</span> itemTopOffsets<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> next <span class=\"token operator\">=</span> itemTopOffsets<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token comment\">// 自章よりもスクロールしている</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token comment\">// かつ 次章まではスクロールしていない 場合は</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token comment\">// 自章が表示されているとみなす</span>\n</span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> next\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">?</span> window<span class=\"token punctuation\">.</span>scrollY <span class=\"token operator\">>=</span> current<span class=\"token punctuation\">.</span>offsetTop <span class=\"token operator\">&amp;&amp;</span>\n</span><span class=\"gatsby-highlight-code-line\">            window<span class=\"token punctuation\">.</span>scrollY <span class=\"token operator\">&lt;</span> next<span class=\"token punctuation\">.</span>offsetTop\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">:</span> window<span class=\"token punctuation\">.</span>scrollY <span class=\"token operator\">>=</span> current<span class=\"token punctuation\">.</span>offsetTop<span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// Qiitaっぽく自章とあわせて親章をハイライトさせたいので</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// itemTopOffsetsでは親章の参照も持たせておき</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// ここでactiveItemIdsに格納しています。</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> activeItemIds <span class=\"token operator\">=</span>\n</span><span class=\"gatsby-highlight-code-line\">      item\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token operator\">?</span> item<span class=\"token punctuation\">.</span>parents\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span>item<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>item<span class=\"token punctuation\">.</span>parents<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=></span> i<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n</span><span class=\"gatsby-highlight-code-line\">          <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>item<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span>\n</span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// setStateを介してstateを変更することで</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">// 表示中の章に変更があった場合にのみ再描画が走ります。</span>\n</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>activeItemIds<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span>\n</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> activeItemIds <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>Toc activeItemIds<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>activeItemIds<span class=\"token punctuation\">}</span> toc<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>toc<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\n<p>実際の目次コンポーネントでは、\n<code class=\"language-text\">toc</code>(目次情報)と<code class=\"language-text\">activeItemIds</code>(現在表示中の章)をインプットに目次を描画します。\nこのとき表示中の章には<code class=\"language-text\">active</code>クラスをつけて描画しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> HashLink <span class=\"token keyword\">as</span> Link <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react-router-hash-link'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Toc</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> toc<span class=\"token punctuation\">,</span> activeItemIds <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> items <span class=\"token operator\">=</span> toc<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>item <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>li style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n          textAlign<span class=\"token punctuation\">:</span> <span class=\"token string\">'left'</span><span class=\"token punctuation\">,</span>\n          marginLeft<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>depth <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">px`</span></span><span class=\"token punctuation\">,</span>\n          listStyle<span class=\"token punctuation\">:</span> <span class=\"token string\">'none'</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>Link\n            key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span>\n            to<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token string\">`#</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>item<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\">            className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>activeItemIds<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">'active'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span><span class=\"token punctuation\">{</span>item<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Link<span class=\"token operator\">></span>\n</span>        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>li<span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token operator\">&lt;</span>ul style<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>padding<span class=\"token punctuation\">:</span> <span class=\"token string\">'12px'</span><span class=\"token punctuation\">,</span> background<span class=\"token punctuation\">:</span> <span class=\"token string\">'#eee'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n        <span class=\"token punctuation\">{</span>items<span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>ul<span class=\"token operator\">></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> Toc<span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"まとめ\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Qiitaっぽい目次を作れたことよりも<a href=\"https://unified.js.org/\">unified</a>の便利さに驚きました。\nこれを使えば解析ツールなども簡単に実装できそうなので踏み込んで調べてみたいです。</p>","excerpt":"なにこれ 自分のブログの目次をQiitaっぽくしたい…現在表示中の章をハイライトする目次を作りたい…ということで作りました。\nマークダウンをHTMLに変換するのに unified という構文解析ライブラリを使っています。 \nメモ用にReact…","rawMarkdownBody":"\n## なにこれ\n自分のブログの目次をQiitaっぽくしたい...現在表示中の章をハイライトする目次を作りたい...ということで作りました。\nマークダウンをHTMLに変換するのに[unified](https://unified.js.org/)という構文解析ライブラリを使っています。<br>\nメモ用にReactサンプルアプリも作りました ⇒ [ソース](https://github.com/Takumon/react-markdown-sync-toc)と[デモ](https://takumon.github.io/react-markdown-sync-toc/)\n\n![scroll](./scroll-sync-toc.gif)\n\n## ポイント\n* マークダウンのHTML化と目次抽出には[unified](https://unified.js.org/)を使いました。\n* スクロールの度に現在表示中の章をチェックして目次ハイライトを更新します。\n  * スクロール処理は高負荷なので負荷軽減のために[Lodashのthrottle](https://lodash.com/docs/4.17.10#throttle)を使いました。\n  * 表示中の章が切り替わるごとに再描画するためにReactのstateを使いました。\n\n以下で詳細を説明していきます。\n\n\n## unified\nアプリの実装を説明する前にマークダウンの構文解析に使っているunifiedについて説明します。<br>\nunified自体はただのインターフェースです。構文解析ロジックはもっておらず、構文木を使ってテキストを処理するフローを提供します。\n1. `parse`: 文字列をパーサーで構文木に変換\n2. `run`: 必要に応じて構文木をトランスフォーマーで変換\n3. `stringfy`: 構文木をコンパイラーで文字列に出力\n\n![unifiedの処理の流れ](./unified-process.png)\n\n\n### ライブラリ群\nunifiedが提供するインターフェースの実装（プロセッサー）は、マークダウン用、HTML用、テキスト用の3種類があります。\nプロセッサーごとに、構文定義、パーサー、コンパイラーが用意されています。\n構文定義の方法は3種類の間で統一されており、マークダウンからHTMLなど相互変換が可能です。\n\n|解析対象|プロセッサー|構文定義|パーサー|コンパイラー|\n|-|-|-|-|-|\n|マークダウン|[remark](https://github.com/remarkjs/remark)|[mdast](https://github.com/syntax-tree/mdast)|[remark-parse](https://github.com/remarkjs/remark/tree/master/packages/remark-parse)|[remark-stringify](https://github.com/remarkjs/remark/tree/master/packages/remark-stringify)|\n|HTML|[rehype](https://github.com/rehypejs/rehype)|[hast](https://github.com/syntax-tree/hast)|[rehype-parse](https://github.com/rehypejs/rehype/tree/master/packages/rehype-parse)|[rehype-stringify](https://github.com/rehypejs/rehype/tree/master/packages/rehype-stringify)\n|テキスト|[retext](https://github.com/retextjs/retext)|[nlcst](https://github.com/syntax-tree/nlcst)|[retext-latin](https://github.com/retextjs/retext/tree/master/packages/retext-latin)|[retext-stringfy](https://github.com/retextjs/retext/tree/master/packages/retext-stringify)\n\n\nライブラリごとにプラグインが山ほどあって、例えばHMTLをミニファイしたり、マークダウンをリントしたり、文章中の`a`と`an`を識別したり、いろんなことができます。\n汎用的なAPIで独自ロジック実装できる! といった拡張性の高さもポイントです。\n\n### 使い方\nunifiedがパイプラインになっていて必要なライブラリをメソッドチェーンで順番に設定していきます。\nパーサーとコンパイラーは1個つずつ、トランスフォーマーは任意の個数を指定してください。\nパーサーとコンパイラー未指定だと実行時エラーになるので気をつけましょう。\n\n\n\n```javascript:title=実装例\nvar unified = require('unified')\nvar markdown = require('remark-parse')\nvar remark2rehype = require('remark-rehype')\nvar doc = require('rehype-document')\nvar format = require('rehype-format')\nvar html = require('rehype-stringify')\nvar report = require('vfile-reporter')\n\nunified()\n  .use(markdown)      // パーサー（マークダウン文字列を構文木に変換）\n  .use(remark2rehype) // トランスフォーマー（マークダウンからHTMLに変換）\n  .use(doc)           // トランスフォーマー（HTMLタグなどでラップ）\n  .use(format)        // トランスフォーマー（HTMLをフォーマット）\n  .use(html)          // コンパイラー（rehypeの構文木を文字列に変換）\n  .process('# Hello world!', function(err, file) {\n    console.error(report(err || file))\n    console.log(String(file))\n  })\n```\n\n```text:title=実行結果\nno issues found\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  </head>\n  <body>\n    <h1>Hello world!</h1>\n  </body>\n</html>\n```\n\n### unified採用の経緯\nこのブログ(Gatsby製)は[gatsby-trasform-remark](https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-transformer-remark)というプラグインでマークダウン情報を取得しています。ただ目次情報についてはHTML化した目次しか取得できません。\nQiitaっぽい目次作成には少々難ありです。<br>\nそんなこんなで悩んでいたところ[プラグインのソース](https://github.com/gatsbyjs/gatsby/blob/master/packages/gatsby-transformer-remark/src/extend-node-type.js#L20)を見てみたらマークダウン文字列解析にunifiedを使っていることに気づきました。\n幸いプラグインで生のマークダウン文字列を取得できたので、unidiedで目次情報を抽出して実現できそうだと考え、採用に至りました。\n\n## 実装\nポイントを載せていきます。詳細は[ソースコード](https://github.com/Takumon/react-markdown-sync-toc)を見てください。\n\n### マークダウンをHMTL化する\n\nマークダウン文字列を読み込んでHTML文字列に変換します。\n現在画面に表示中の章を判定するために[remark-slug](https://github.com/remarkjs/remark-slug)を使って章にidを付与しています。\nちなみにこの[remark-slug](https://github.com/remarkjs/remark-slug)は[mdast-util-to-string](https://github.com/syntax-tree/mdast-util-to-string)と[github-slugger](https://github.com/Flet/github-slugger)を使ってidを付与しています。<br>\n\n*※実際はReactコンポーネントですが簡単のためソースコードを一部省略しています。*\n\n\n```javascript\nimport unified from 'unified'\nimport markdown from 'remark-parse'       // パーサー(文字列をremarkの構文木に変換)\nimport slug from 'remark-slug'            // トランスフォーマー(章にidをつける)\nimport remark2rehype from 'remark-rehype' // トランスフォーマー(マークダウンからHTMLに変換)\nimport html from 'rehype-stringify'       // コンパイラー(HTML構文木を文字列に変換)\n\nconst rawMarkdownBody = `## なにこれ\nReactでMarkdownファイルを読み込んで表示するアプリ。\\n\n目次も表示します。特徴としては目次においてスクロールに応じて現在表示中のセクションがハイライトされます。\n\n## 大セクション その1`\n･\n･\n･\n`;\n\nconst { contents } =\n  unified()\n    .use(markdown)        // パーサー(文字列をremarkの構文木に変換)\n    .use(slug)            // トランスフォーマー(章にidをつける)\n    .use(remark2rehype)   // トランスフォーマー(マークダウンからHTMLに変換)\n    .use(html)            // コンパイラー(HTML構文木を文字列に変換)\n    .processSync(rawMarkdownBody)\n```\n\n<br>\n\n\n```text:title=変換の流れ\nマークダウン文字列\n│\n│ ←　remark-parse(パーサー)\n↓\nmdast構文木\n│\n│ ←　remark-slug(トランスフォーマー)\n↓\n章にidをつけたmdast構文木\n│\n│ ← remark-rehype(トランスフォーマー)\n↓\nhast構文木\n│\n│ ← rehype-stringify(コンパイラー)\n↓\nHTML文字列\n```\n\n### マークダウンから目次情報を抽出する\nremarkのparseメソッドを使うと簡単にマークダウン構文木を取得できます。\nそして取得した構文木から独自ロジックで目次情報を抽出します。\n具体的には構文木を再帰的に捜査できるプラグイン[unist-util-visit](https://github.com/syntax-tree/unist-util-visit)を使って目次情報を抽出しました。<br>\nid付与のロジックはマークダウン生成時のロジック(remark-slugのロジック）とあわせています。<br>\n\n*※実際はReactコンポーネントですが簡単のためソースコードを一部省略しています。*\n\n\n```javascript{12-22}\nimport remark from 'remark'\nimport visit from 'unist-util-visit'\nimport mdastToString from 'mdast-util-to-string';\nimport GithubSlugger from 'github-slugger';\nconst githubSlugger = new GithubSlugger()\n\n// マークダウン文字列から目次情報を抽出する\nfunction _extractToc(rawMarkdownBody) {\n  githubSlugger.reset();\n\n  const result = []\n  const ast = remark().parse(rawMarkdownBody);\n  visit(ast, 'heading', child => {\n    const value = child.children[0].value\n    const id = githubSlugger.slug(value || mdastToString(child))\n    const depth = child.depth\n    result.push({\n      value,\n      id,\n      depth\n    })\n  })\n\n  return result\n}\n```\n\n\nこの後さらに目次情報を加工していきますが説明が長くなるので省略します。詳細は[ソースコード](https://github.com/Takumon/react-markdown-sync-toc/blob/master/src/scroll-sync-toc.js#L87-L169)をご覧ください。\n\n### スクロール毎に表示中の章を判定する\nReactのコンポーネントで実装します。\nスクロールイベントは`componentDidMount`で購読を開始し`componentWillUnmount`で破棄します。<br>\n**スクロール処理は高負荷なので[Lodashのthrottle](https://lodash.com/docs/4.17.10#throttle)で100ミリ秒ごとに間引いています。**\n現在表示中の章の情報はsetStateでstateに格納しています。これにより表示中の章が切り替わった時にReactが再描画してくれます。\n\n\n```javascript{20,23-26,28-30,38-66}\nimport React from 'react';\nimport { throttle } from 'lodash';\nimport Toc from './toc';\n\nconst githubSlugger = new GithubSlugger()\n\n\nclass ScrollSyncToc extends React.Component {\n  constructor(props, context) {\n    super(props, context);\n\n    this.toc = _getToc(this.props.rawMarkdownBody)\n\n    this.state = {\n      activeItemIds: [],\n      itemTopOffsets: [],\n    };\n\n    this.calculateItemTopOffsets = this.calculateItemTopOffsets.bind(this);\n    this.handleScroll = throttle(this.handleScroll.bind(this), 100) // 負荷軽減のため間引く\n  }\n\n  componentDidMount() {\n    this.calculateItemTopOffsets();\n    window.addEventListener(`scroll`, this.handleScroll);\n  }\n\n  componentWillUnmount() {\n    window.removeEventListener(`scroll`, this.handleScroll);\n  }\n\n  calculateItemTopOffsets() {\n    this.setState({\n      itemTopOffsets: _getElementTopOffsetsById(this.toc),\n    });\n  }\n\n  handleScroll() {\n    const { itemTopOffsets } = this.state;\n\n    const item = itemTopOffsets.find((current, i) => {\n      const next = itemTopOffsets[i + 1]\n\n      // 自章よりもスクロールしている\n      // かつ 次章まではスクロールしていない 場合は\n      // 自章が表示されているとみなす\n      return next\n        ? window.scrollY >= current.offsetTop &&\n            window.scrollY < next.offsetTop\n        : window.scrollY >= current.offsetTop;\n    })\n\n    // Qiitaっぽく自章とあわせて親章をハイライトさせたいので\n    // itemTopOffsetsでは親章の参照も持たせておき\n    // ここでactiveItemIdsに格納しています。\n    const activeItemIds =\n      item\n        ? item.parents\n          ? [item.id, ...item.parents.map(i => i.id)]\n          : [item.id]\n        : [];\n\n    // setStateを介してstateを変更することで\n    // 表示中の章に変更があった場合にのみ再描画が走ります。\n    this.setState({activeItemIds});\n  }\n\n  render() {\n    const { activeItemIds } = this.state;\n    return <Toc activeItemIds={activeItemIds} toc={this.toc} {...this.props} />;\n  }\n}\n\n```\n\n<br>\n\n実際の目次コンポーネントでは、\n`toc`(目次情報)と`activeItemIds`(現在表示中の章)をインプットに目次を描画します。\nこのとき表示中の章には`active`クラスをつけて描画しています。\n\n```javascript{17}\nimport React from 'react'\nimport { HashLink as Link } from 'react-router-hash-link';\n\nclass Toc extends React.Component {\n  render() {\n    const { toc, activeItemIds } = this.props;\n    const items = toc.map(item => {\n      return (\n        <li style={{\n          textAlign: 'left',\n          marginLeft: `${(item.depth - 2) * 24}px`,\n          listStyle: 'none'\n          }}>\n          <Link\n            key={item.id}\n            to={`#${item.id}`}\n            className={activeItemIds.includes(item.id) ? 'active' : ''}>{item.value}</Link>\n        </li>\n      )\n    })\n\n    return (\n      <ul style={{padding: '12px', background: '#eee'}}>\n        {items}\n      </ul>\n    );\n  }\n}\n\nexport default Toc;\n```\n\n\n## まとめ\nQiitaっぽい目次を作れたことよりも[unified](https://unified.js.org/)の便利さに驚きました。\nこれを使えば解析ツールなども簡単に実装できそうなので踏み込んで調べてみたいです。\n\n","tableOfContents":"<ul>\n<li><a href=\"/2018/10/28/#%E3%81%AA%E3%81%AB%E3%81%93%E3%82%8C\">なにこれ</a></li>\n<li><a href=\"/2018/10/28/#%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88\">ポイント</a></li>\n<li>\n<p><a href=\"/2018/10/28/#unified\">unified</a></p>\n<ul>\n<li><a href=\"/2018/10/28/#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E7%BE%A4\">ライブラリ群</a></li>\n<li><a href=\"/2018/10/28/#%E4%BD%BF%E3%81%84%E6%96%B9\">使い方</a></li>\n<li><a href=\"/2018/10/28/#unified%E6%8E%A1%E7%94%A8%E3%81%AE%E7%B5%8C%E7%B7%AF\">unified採用の経緯</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2018/10/28/#%E5%AE%9F%E8%A3%85\">実装</a></p>\n<ul>\n<li><a href=\"/2018/10/28/#%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%82%92hmtl%E5%8C%96%E3%81%99%E3%82%8B\">マークダウンをHMTL化する</a></li>\n<li><a href=\"/2018/10/28/#%E3%83%9E%E3%83%BC%E3%82%AF%E3%83%80%E3%82%A6%E3%83%B3%E3%81%8B%E3%82%89%E7%9B%AE%E6%AC%A1%E6%83%85%E5%A0%B1%E3%82%92%E6%8A%BD%E5%87%BA%E3%81%99%E3%82%8B\">マークダウンから目次情報を抽出する</a></li>\n<li><a href=\"/2018/10/28/#%E3%82%B9%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%AB%E6%AF%8E%E3%81%AB%E8%A1%A8%E7%A4%BA%E4%B8%AD%E3%81%AE%E7%AB%A0%E3%82%92%E5%88%A4%E5%AE%9A%E3%81%99%E3%82%8B\">スクロール毎に表示中の章を判定する</a></li>\n</ul>\n</li>\n<li><a href=\"/2018/10/28/#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n</ul>","frontmatter":{"date":"2018/10/28","title":"unifiedでMarkdownをHTMLに変換 & ReactでQiitaっぽい目次を作る","tags":["React","unified","remark","rehype"]}}},"pageContext":{"slug":"/2018/10/28/","previous":{"fields":{"slug":"/2018/10/21/"},"frontmatter":{"title":"Gatsbyプラグイン45選","tags":["Gatsby","GatsbyPlugin"]}},"next":null}}