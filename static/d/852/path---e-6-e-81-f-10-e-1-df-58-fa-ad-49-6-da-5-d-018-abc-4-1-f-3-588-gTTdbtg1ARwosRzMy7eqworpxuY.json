{"data":{"site":{"siteMetadata":{"title":"Takumon Blog","author":"Takuto Inoue"}},"qiitaPost":{"rendered_body":"<p>先日<a href=\"http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=5001&amp;get_params=p_exam_id:1Z0-809&amp;p_org_id=70\" rel=\"nofollow noopener\" target=\"_blank\">Java SE 8 Programmer II(Java SE8 Gold)</a>に合格しました。<br>\nそのために自分がやったことと受験した感想をメモします。</p>\n\n<p>▼試験結果<br>\n勉強期間　：3カ月<br>\n得点率　　： 73％（ボーダー65％）　結構ギリギリ(&gt;o&lt;)!</p>\n\n<h2>\n<span id=\"自分とjavaの関係\" class=\"fragment\"></span><a href=\"#%E8%87%AA%E5%88%86%E3%81%A8java%E3%81%AE%E9%96%A2%E4%BF%82\"><i class=\"fa fa-link\"></i></a>自分とJavaの関係</h2>\n\n<ul>\n<li>仕事でJava開発は5年</li>\n<li>保有資格は<a href=\"https://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=5001&amp;get_params=p_exam_id:1Z0-808&amp;p_org_id=70&amp;lang=JA\" rel=\"nofollow noopener\" target=\"_blank\">Java SE 8 Silver</a>と <a href=\"http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=458&amp;p_org_id=70&amp;lang=JA&amp;get_params=p_track_id:JEE5WCD\" rel=\"nofollow noopener\" target=\"_blank\">WebコンポーネントデベロッパEE 5</a>と <a href=\"http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=5001&amp;get_params=p_exam_id:1Z0-851&amp;p_org_id=70&amp;lang=JA\" rel=\"nofollow noopener\" target=\"_blank\">JavaプログラマSE 6</a>\n</li>\n</ul>\n\n<h2>\n<span id=\"きっかけ\" class=\"fragment\"></span><a href=\"#%E3%81%8D%E3%81%A3%E3%81%8B%E3%81%91\"><i class=\"fa fa-link\"></i></a>きっかけ</h2>\n\n<p>Java8で新機能が多く追加されたので、それらを習得するために受験しました。　<br>\n最初は<a href=\"http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=5001&amp;get_params=p_exam_id:1Z0-813&amp;p_org_id=70&amp;lang=JA\" rel=\"nofollow noopener\" target=\"_blank\">Upgrade to Java SE 8 OCP</a>の受験を考えていましたが、<br>\n参考書がないのと情報量が少なかったので、こちらを受けることにしました。</p>\n\n<h2>\n<span id=\"買った参考書と感想\" class=\"fragment\"></span><a href=\"#%E8%B2%B7%E3%81%A3%E3%81%9F%E5%8F%82%E8%80%83%E6%9B%B8%E3%81%A8%E6%84%9F%E6%83%B3\"><i class=\"fa fa-link\"></i></a>買った参考書と感想</h2>\n\n<p></p><dl>\n<dt>\n<a href=\"https://www.amazon.co.jp/%E5%BE%B9%E5%BA%95%E6%94%BB%E7%95%A5Java-SE-8-Gold%E5%95%8F%E9%A1%8C%E9%9B%86%EF%BC%BB1Z0-809%EF%BC%BD%E5%AF%BE%E5%BF%9C-%E5%BE%B9%E5%BA%95%E6%94%BB%E7%95%A5%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-ebook/dp/B01LXSG1G9/ref=pd_sim_351_1?_encoding=UTF8&amp;psc=1&amp;refRID=PC6MK9AHZB6JSXW5VM6F\" rel=\"nofollow noopener\" target=\"_blank\">徹底攻略Java SE 8 Gold問題集［1Z0-809］対応 徹底攻略シリーズ</a>（以後、黒本と記述）</dt>\n<br>\n<dd>定番の問題集なので購入しましたが、全体的に難易度が低めの門題が多いです。ただ本の最後の総仕上げ問題は本番試験と難易度が近く、本番でも同じ問題が多数出題されました。</dd>\n<br>\n<dt>\n<a href=\"https://www.amazon.co.jp/dp/B0191U2H8C/ref=dp-kindle-redirect?_encoding=UTF8&amp;btkr=1\" rel=\"nofollow noopener\" target=\"_blank\">OCP: Oracle Certified Professional Java SE 8 Programmer II Study Guide: Exam 1Z0-809</a>（以後、 Study Guideと記述）</dt>\n<br>\n<dd>上記の黒本だけでは不安になり購入しました。<a href=\"https://www.amazon.co.jp/dp/B01J1LPKJY/ref=dp-kindle-redirect?_encoding=UTF8&amp;btkr=1\" rel=\"nofollow noopener\" target=\"_blank\">紫本</a>と同じような構成で、参考書と問題集が１つになっています。紫本ではなくStudy Guideにしたのは英語力を身につけたかったからです。本の説明に「Complete, trusted preparation for the Java Programmer II exam」とある通り問題数も多くかなり充実した内容でした。難易度は本番よりも高めです。この本を２周して問題の正答率が90%に達していれば絶対合格できます。ただ量が多いので２周するのはかなり根気が必要です（自分は1周で断念しました）。<br>あと本がでかくて、電車の中では絶対読めません。Kindleで購入したほうがいいです。</dd>\n\n<h2>\n<span id=\"試験本番\" class=\"fragment\"></span><a href=\"#%E8%A9%A6%E9%A8%93%E6%9C%AC%E7%95%AA\"><i class=\"fa fa-link\"></i></a>試験本番</h2>\n\n<p>問題数は85問、試験時間は150分でしたが、時間が足りないということはなく、120分ほどで解き終わりました。<br>\n難易度は黒本の総仕上げ問題よりも少し高めです。<br>\nJavaプログラマSE 6の時のような重箱の隅をつつくような問題は少なく、<br>\nJava8の新規機能がメインで、ストリームAIP、ラムダ式、メソッド参照に関しては単体での出題 or 他と絡めての出題で１／４を占めていました。Study Guideではパラレルストリームの難しめの問題が多かったのですが、本番は簡単な問題が２問程度でした。OptionalとDateTimeAPIについては意外と少なく、１、２問程度でした。<br>\nJDBCは例外処理と絡めた問題もあり５～７問と意外と多めでした。<br>\nNew IOについては絶対パスと相対パスでの挙動の違いをしっかり理解する必要があります。</p>\n\n<h2>\n<span id=\"感想\" class=\"fragment\"></span><a href=\"#%E6%84%9F%E6%83%B3\"><i class=\"fa fa-link\"></i></a>感想</h2>\n\n<p>点数的にはギリギリ合格でした。。。<br>\n問題集に取り組むときに、正解を導き出せるだけでなく、一つ一つの選択肢に対して背景を理解する必要があったと感じています。しかしながらJava8の主要新な機能について一通り整理できました、業務で使う分には十分な理解だと思います。<br>\n試験対策は問題集のみでしたが、試験後に<a href=\"http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getpage?page_id=5001&amp;get_params=p_exam_id:1Z0-809&amp;p_org_id=70&amp;lang=JA\" rel=\"nofollow noopener\" target=\"_blank\">オラクルの公式サイト</a>を見てみると、試験内容＞チェックリスト＞【トピック】の１つ１つに対して漏れなく問題が出題されてたことが分かったので、試験前に見とけばよかったなぁと感じています。あと英語の勉強もかねて黒本とStudy Guideを選びましたが、他の方のブログを見た感じだと、黒本と紫本を買ってそれぞれ２周すれば合格できるような気がしました。</p>\n</dl>","headings":[{"id":"自分とjavaの関係","value":"自分とJavaの関係","depth":2,"parents":[]},{"id":"きっかけ","value":"きっかけ","depth":2,"parents":[]},{"id":"買った参考書と感想","value":"買った参考書と感想","depth":2,"parents":[]},{"id":"試験本番","value":"試験本番","depth":2,"parents":[]},{"id":"感想","value":"感想","depth":2,"parents":[]}],"fields":{"title":"Java SE8 Gold取りました。","excerpt":"先日Java SE 8 Programmer II(Java SE8 Gold)に合格しました。そのために自分がやったことと受験した感想をメモします。▼試験結果勉強期間　：3カ月得点率　　： 73％（ボーダー65％）　結構ギリギリ(&gt;...","date":"2017-03-12T17:52:21+09:00","tags":["Java","java8","資格","Qiita"]},"user":{"id":"Takumon","profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/49915/profile-images/1488080194","description":"JavaのSIer. 趣味はJavaScript. \r\n週1でブログ更新してます. https://takumon.com/\r\n最近はGatsbyJS,Nuxt.js,GraphQLなどなど."}}},"pageContext":{"slug":"/e6e81f10-e1df-58fa-ad49-6da5d018abc4/","relatedPosts":[{"fields":{"slug":"/4bf6ffd5-8640-508e-ab47-1a55df05d72e/","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","date":"2017-04-07T02:38:55+09:00","excerpt":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。Githubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイす...","tags":["Java","Jenkins","CI","gradle","Pipeline","Qiita"],"keywords":["Java"],"thumbnail":""},"id":"4bf6ffd5-8640-508e-ab47-1a55df05d72e","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","rendered_body":"<p>GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。<br>\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。</p>\n\n<h1>\n<span id=\"declarative-pipeline\" class=\"fragment\"></span><a href=\"#declarative-pipeline\"><i class=\"fa fa-link\"></i></a>Declarative Pipeline</h1>\n\n<p>いままではJenkinsfileを</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>node {\n  ....\n}\n</pre></div></div>\n\n<p>のように書いてましたが、<a href=\"https://jenkins.io/doc/book/pipeline/syntax/\" rel=\"nofollow noopener\" target=\"_blank\">Jenkinsの公式サイト</a>を見ると<br>\nこれはScripted Pipelinesの記法であり、<br>\nPipeline Pluginのバージョン2.5移行からは</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>pipeline {\n  ....  \n}\n</pre></div></div>\n\n<p>のように書くDeclarative Pipelineという記法が導入されて、<br>\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。<br>\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、<br>\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。</p>\n\n<h1>\n<span id=\"追加したプラグイン\" class=\"fragment\"></span><a href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\"><i class=\"fa fa-link\"></i></a>追加したプラグイン</h1>\n\n<p>Jenkins初期設定時のSuggested Pluginに入っていないもの</p>\n\n<ul>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F\" rel=\"nofollow noopener\" target=\"_blank\">Checkstyle Plugin</a>（v3.47） - Checkstyeの結果収集用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">FindBugs Plugin</a>（v4.69） - Findbugsのレポート生成用 </li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">PMD Plugin</a>（v3.46） - PMDのレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">DRY Plugin</a>（v2.46） - CPD(重複コードチェック)のレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Step Counter Plugin</a>（v2.0.0） - ソースコードのステップ数を集計してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Task Scanner Plugin</a>（v4.50） - ソースコード中のTODOとかを一覧化してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Javadoc Plugin</a>（v1.4） - JavaDoc生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Warnings Plugin</a>（v4.60） - ジョブ実行時の警告メッセージを収集してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">JaCoCo Plugin</a>（v2.2.0） - テストカバレッジのレポート生成用</li>\n</ul>\n\n<h1>\n<span id=\"jenkinsfile\" class=\"fragment\"></span><a href=\"#jenkinsfile\"><i class=\"fa fa-link\"></i></a>Jenkinsfile</h1>\n\n<p>GithubからWebhookでJenkinsのパイプラインジョブを実行する。<br>\nパイプラインジョブではGithubのJenkinsfileを使う。<br>\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。<br>\n<a href=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png\"></a></p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">Jenkinsfile</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">pipeline</span> <span class=\"o\">{</span>\n    <span class=\"n\">agent</span> <span class=\"n\">any</span>\n    <span class=\"c1\">// 定数や変数を定義する</span>\n    <span class=\"n\">environment</span> <span class=\"o\">{</span>\n        <span class=\"n\">reportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/reports'</span>\n        <span class=\"n\">javaDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/java'</span>\n        <span class=\"n\">resourcesDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/resources'</span>\n        <span class=\"n\">testReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/test-results/test'</span>\n        <span class=\"n\">jacocoReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/jacoco'</span> \n        <span class=\"n\">javadocDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/docs/javadoc'</span>\n        <span class=\"n\">libsDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/libs'</span>\n        <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n        <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロック中に一つ以上のstageを定義する</span>\n    <span class=\"n\">stages</span> <span class=\"o\">{</span>\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'事前準備'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 実際の処理はstepsブロック中に定義する</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n\n                <span class=\"c1\">// このJobをトリガーしてきたGithubのプロジェクトをチェックアウト</span>\n                <span class=\"n\">checkout</span> <span class=\"n\">scm</span>\n\n                <span class=\"c1\">// ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"Jenkinsfile\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"build.gradle\"</span>\n\n                <span class=\"c1\">// scriptブロックを使うと従来のScripted Pipelinesの記法も使える</span>\n                <span class=\"n\">script</span> <span class=\"o\">{</span>\n                    <span class=\"c1\">// Permission deniedで怒られないために実行権限を付与する</span>\n                    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n                        <span class=\"n\">sh</span> <span class=\"s1\">'chmod +x gradlew'</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">}</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'clean'</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'コンパイル'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'classes testClasses'</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"c1\">// postブロックでstepsブロックの後に実行される処理が定義できる</span>\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n\n                    <span class=\"c1\">// JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので</span>\n                    <span class=\"c1\">// Javaコンパイル時の警告はコンパイル直後に収集する</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n\n                        <span class=\"c1\">// プラグインを実行するときのクラス指定は完全修飾名でなくてもOK</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n\n                        <span class=\"c1\">// Job実行時のコンソールから警告を収集する場合はconsoleParsers、</span>\n                        <span class=\"c1\">// pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。</span>\n                        <span class=\"c1\">// なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要</span>\n                        <span class=\"c1\">// パーサ名は下記プロパティファイルに定義されているものを使う</span>\n                        <span class=\"c1\">// https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'Java Compiler (javac)'</span><span class=\"o\">],</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'静的コード解析'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 並列処理の場合はparallelメソッドを使う</span>\n                <span class=\"n\">parallel</span><span class=\"o\">(</span>\n                    <span class=\"s1\">'静的コード解析'</span> <span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'check -x test'</span>\n\n                        <span class=\"c1\">// dirメソッドでカレントディレクトリを指定できる</span>\n                        <span class=\"n\">dir</span><span class=\"o\">(</span><span class=\"n\">reportDir</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'CheckStylePublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'FindBugsPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'PmdPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'DryPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                        <span class=\"o\">}</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'ステップカウント'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"c1\">// レポート作成</span>\n                        <span class=\"c1\">// outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる</span>\n                        <span class=\"n\">stepcounter</span> <span class=\"nl\">outputFile:</span> <span class=\"s1\">'stepcount.xls'</span><span class=\"o\">,</span> <span class=\"nl\">outputFormat:</span> <span class=\"s1\">'excel'</span><span class=\"o\">,</span> <span class=\"nl\">settings:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'Java'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${javaDir}/**/*.java\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'SQL'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.sql\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'HTML'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.html\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'JS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.js\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'CSS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.css\"</span><span class=\"o\">]</span>\n                        <span class=\"o\">]</span>\n                        <span class=\"c1\">// 一応エクセルファイルも成果物として保存する</span>\n                        <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"stepcount.xls\"</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'タスクスキャン'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'TasksPublisher'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">pattern:</span> <span class=\"s1\">'./**'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 集計対象を検索するときに大文字小文字を区別するか</span>\n                            <span class=\"nl\">ignoreCase:</span> <span class=\"kc\">true</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 優先度別に集計対象の文字列を指定できる</span>\n                            <span class=\"c1\">// 複数指定する場合はカンマ区切りの文字列を指定する</span>\n                            <span class=\"nl\">high:</span> <span class=\"s1\">'System.out.System.err'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">normal:</span> <span class=\"s1\">'TODO,FIXME,XXX'</span><span class=\"o\">,</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'JavaDoc'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'javadoc -x classes'</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JavadocArchiver'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// Javadocのindex.htmlがあるフォルダのパスを指定する</span>\n                            <span class=\"nl\">javadocDir:</span> <span class=\"s2\">\"${javadocDir}\"</span><span class=\"o\">,</span>\n                            <span class=\"nl\">keepAll:</span> <span class=\"kc\">true</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">)</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n                   <span class=\"c1\">// JavaDocの警告を収集</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'JavaDoc Tool'</span><span class=\"o\">]</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'テスト'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'test jacocoTestReport -x classes -x testClasses'</span>\n\n                <span class=\"n\">junit</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n\n                <span class=\"c1\">// カバレッジレポートを生成（テストクラスを除外）</span>\n                <span class=\"n\">step</span><span class=\"o\">([</span>\n                    <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JacocoPublisher'</span><span class=\"o\">,</span>\n                    <span class=\"nl\">execPattern:</span> <span class=\"s2\">\"${jacocoReportDir}/*.exec\"</span><span class=\"o\">,</span>\n                    <span class=\"nl\">exclusionPattern:</span> <span class=\"s1\">'**/*Test.class'</span>\n                <span class=\"o\">])</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'デプロイ'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// whenブロックでstageを実行する条件を指定できる</span>\n            <span class=\"n\">when</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 静的コード解析とテスト失敗時はデプロイしない</span>\n                <span class=\"n\">expression</span> <span class=\"o\">{</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span> <span class=\"o\">==</span> <span class=\"s1\">'SUCCESS'</span><span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'jar'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.jar\"</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'war'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.war\"</span>\n                <span class=\"n\">deploy</span> <span class=\"nl\">warDir:</span> <span class=\"n\">libsDir</span><span class=\"o\">,</span> <span class=\"nl\">appName:</span> <span class=\"n\">appName</span><span class=\"o\">,</span> <span class=\"nl\">appVersion:</span> <span class=\"n\">appVersion</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロックと同じレベルにpostブロックを定義すると</span>\n    <span class=\"c1\">// 全てのstage処理が終わった後の処理の定義が可能    </span>\n    <span class=\"n\">post</span> <span class=\"o\">{</span>\n        <span class=\"n\">always</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 最後にワークスペースの中身を削除</span>\n            <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 連続で成功しているとき以外は自分宛にメールを送信</span>\n\n        <span class=\"c1\">// 結果が前回と変わった時</span>\n        <span class=\"n\">changed</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"s2\">\"${currentBuild.previousBuild.result} =&gt; ${currentBuild.currentResult}\"</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 失敗した時</span>\n        <span class=\"n\">failure</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 不安定な時（主にテスト失敗時）</span>\n        <span class=\"n\">unstable</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n\n<span class=\"c1\">// Gradlewコマンドを実行する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">gradlew</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n        <span class=\"n\">sh</span> <span class=\"s2\">\"./gradlew ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span> <span class=\"k\">else</span> <span class=\"o\">{</span>\n        <span class=\"n\">bat</span> <span class=\"s2\">\"./gradlew.bat ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// デプロイする</span>\n<span class=\"c1\">// args.warDir warの格納ディレクトリ </span>\n<span class=\"c1\">// args.appName アプリ名</span>\n<span class=\"c1\">// args.appVersion アプリのバージョン</span>\n<span class=\"kt\">def</span> <span class=\"nf\">deploy</span><span class=\"o\">(</span><span class=\"n\">Map</span> <span class=\"n\">args</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある</span>\n    <span class=\"kt\">def</span> <span class=\"n\">keyDir</span> <span class=\"o\">=</span> <span class=\"s1\">'/var/lib/jenkins/.ssh/xxx'</span>\n    <span class=\"c1\">// Tomcatサーバのアドレスとユーザ名</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerAddress</span> <span class=\"o\">=</span> <span class=\"s1\">'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerUser</span> <span class=\"o\">=</span> <span class=\"s1\">'hoge-user'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServer</span> <span class=\"o\">=</span> <span class=\"s2\">\"${webServerUser}@${webServerAddress}\"</span>\n\n    <span class=\"kt\">def</span> <span class=\"n\">srcWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}-${args.appVersion}.war\"</span>\n    <span class=\"kt\">def</span> <span class=\"n\">destWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}.war\"</span>\n\n    <span class=\"c1\">// ファイル転送してTomcatのwebappsにwarを配置する</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// メールをGmailに送信する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">sendMail</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">mail</span> <span class=\"nl\">to:</span> <span class=\"s2\">\"xxxxxxxx@gmail.com\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">subject:</span> <span class=\"s2\">\"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">body:</span> <span class=\"s2\">\"Build URL: ${env.BUILD_URL}.\\n\\n\"</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<h1>\n<span id=\"躓いたこと\" class=\"fragment\"></span><a href=\"#%E8%BA%93%E3%81%84%E3%81%9F%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>躓いたこと</h1>\n\n<ul>\n<li>各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。</li>\n<li>currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ &gt; 設定 &gt; Pipeline Syntax &gt; Global Variables Reference に詳しく載っていた。\n<a href=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png\"></a>\n</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png\"></a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png\"></a></p>\n\n<ul>\n<li>カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。</li>\n<li>JenkinsからGmailにメールする場合、Jenkins &gt; Jenkinsの管理 &gt; システムの設定 &gt; E-mail通知で下記のような設定が必要だった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png\"></a></p>\n\n<ul>\n<li>JenkinsからGmailにメールする場合、<a href=\"https://support.google.com/accounts/answer/6010255?hl=ja\" rel=\"nofollow noopener\" target=\"_blank\">安全性の低いアプリがアカウントにアクセスするのを許可する</a>の手順に従って許可を有効にする必要があった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png\"></a></p>\n\n<h1>\n<span id=\"buildgradle\" class=\"fragment\"></span><a href=\"#buildgradle\"><i class=\"fa fa-link\"></i></a>build.gradle</h1>\n\n<p>Jenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、<br>\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。<br>\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。</p>\n\n<ul>\n<li>checkstyle</li>\n<li>findbugs</li>\n<li>pmd</li>\n<li>cpd(重複コードチェック)</li>\n<li>test</li>\n<li>jacocoReport</li>\n<li>jar</li>\n<li>war</li>\n</ul>\n\n<p>例えばこんな</p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">build.gradle</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'java'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'war'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'checkstyle'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'findbugs'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'pmd'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'jacoco'</span>\n\n<span class=\"n\">ext</span> <span class=\"o\">{</span>\n    <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n    <span class=\"n\">javaVersion</span> <span class=\"o\">=</span> <span class=\"mf\">1.8</span>\n    <span class=\"n\">defaultEncoding</span> <span class=\"o\">=</span> <span class=\"s1\">'UTF-8'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">sourceCompatibility</span> <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">targetCompatibility</span>  <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">AbstractCompile</span><span class=\"o\">)*.</span><span class=\"na\">options</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">GroovyCompile</span><span class=\"o\">)*.</span><span class=\"na\">groovyOptions</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">mainClassName</span> <span class=\"o\">=</span> <span class=\"s1\">'jp.takumon.sapmleapp.App'</span>\n\n<span class=\"n\">repositories</span> <span class=\"o\">{</span>\n    <span class=\"n\">mavenCentral</span><span class=\"o\">()</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">dependencies</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 依存ライブラリを記載 </span>\n\n    <span class=\"n\">compile</span> <span class=\"nl\">group:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">name:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">version:</span> <span class=\"s1\">'4.12'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jar</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">war</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">checkstyle</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'7.6.1'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">findbugs</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s2\">\"3.0.1\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">pmd</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">Pmd</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// CPD（重複コードチェック処理）をCheckタスクに追加</span>\n<span class=\"n\">check</span><span class=\"o\">.</span><span class=\"na\">doLast</span> <span class=\"o\">{</span>\n    <span class=\"n\">File</span> <span class=\"n\">outputDir</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"s2\">\"$reportsDir/cpd/\"</span><span class=\"o\">)</span>\n    <span class=\"n\">outputDir</span><span class=\"o\">.</span><span class=\"na\">mkdirs</span><span class=\"o\">()</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">taskdef</span><span class=\"o\">(</span>\n        <span class=\"nl\">name:</span> <span class=\"s1\">'cpd'</span><span class=\"o\">,</span> \n        <span class=\"nl\">classname:</span> <span class=\"s1\">'net.sourceforge.pmd.cpd.CPDTask'</span><span class=\"o\">,</span>\n        <span class=\"nl\">classpath:</span> <span class=\"n\">configurations</span><span class=\"o\">.</span><span class=\"na\">pmd</span><span class=\"o\">.</span><span class=\"na\">asPath</span><span class=\"o\">)</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">cpd</span><span class=\"o\">(</span>\n        <span class=\"nl\">minimumTokenCount:</span> <span class=\"s1\">'100'</span><span class=\"o\">,</span>\n        <span class=\"nl\">format:</span> <span class=\"s1\">'xml'</span><span class=\"o\">,</span>\n        <span class=\"nl\">encoding:</span> <span class=\"n\">defaultEncoding</span><span class=\"o\">,</span>\n        <span class=\"nl\">outputFile:</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"n\">outputDir</span><span class=\"o\">,</span> <span class=\"s1\">'cpd.xml'</span><span class=\"o\">)</span>\n    <span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"n\">fileset</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"s2\">\"src/main/java\"</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">include</span><span class=\"o\">(</span><span class=\"nl\">name:</span> <span class=\"s1\">'**/*.java'</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">javadoc</span> <span class=\"o\">{</span>\n    <span class=\"n\">failOnError</span> <span class=\"o\">=</span> <span class=\"kc\">false</span>\n    <span class=\"c1\">// 好みのレベルで</span>\n    <span class=\"n\">options</span><span class=\"o\">.</span><span class=\"na\">memberLevel</span> <span class=\"o\">=</span> <span class=\"n\">JavadocMemberLevel</span><span class=\"o\">.</span><span class=\"na\">PRIVATE</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">test</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n        <span class=\"n\">junitXml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacoco</span> <span class=\"o\">{</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'0.7.5.201505241946'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacocoTestReport</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// カバレッジレポートからテストクラスを除外</span>\n    <span class=\"n\">afterEvaluate</span> <span class=\"o\">{</span> \n        <span class=\"n\">classDirectories</span> <span class=\"o\">=</span> <span class=\"n\">files</span><span class=\"o\">(</span><span class=\"n\">classDirectories</span><span class=\"o\">.</span><span class=\"na\">files</span><span class=\"o\">.</span><span class=\"na\">collect</span> <span class=\"o\">{</span>\n            <span class=\"n\">fileTree</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"n\">it</span><span class=\"o\">,</span> <span class=\"nl\">exclude:</span> <span class=\"o\">[</span><span class=\"s1\">'**/*Test.class'</span><span class=\"o\">])</span> \n        <span class=\"o\">})</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">task</span> <span class=\"nf\">wrapper</span> <span class=\"o\">(</span><span class=\"nl\">type:</span> <span class=\"n\">Wrapper</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">gradleVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'3.4.1'</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p>以上。</p>\n","body":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。\n\n# Declarative Pipeline\nいままではJenkinsfileを\n\n```\nnode {\n  ....\n}\n```\n\nのように書いてましたが、[Jenkinsの公式サイト](https://jenkins.io/doc/book/pipeline/syntax/)を見ると\nこれはScripted Pipelinesの記法であり、\nPipeline Pluginのバージョン2.5移行からは\n\n```\npipeline {\n  ....  \n}\n```\nのように書くDeclarative Pipelineという記法が導入されて、\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。\n\n# 追加したプラグイン\nJenkins初期設定時のSuggested Pluginに入っていないもの\n\n* [Checkstyle Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F)（v3.47） - Checkstyeの結果収集用\n* [FindBugs Plugin](https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin)（v4.69） - Findbugsのレポート生成用 \n* [PMD Plugin](https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin)（v3.46） - PMDのレポート生成用\n* [DRY Plugin](https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin)（v2.46） - CPD(重複コードチェック)のレポート生成用\n* [Step Counter Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin)（v2.0.0） - ソースコードのステップ数を集計してくれる\n* [Task Scanner Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin)（v4.50） - ソースコード中のTODOとかを一覧化してくれる\n* [Javadoc Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin)（v1.4） - JavaDoc生成用\n* [Warnings Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin)（v4.60） - ジョブ実行時の警告メッセージを収集してくれる\n* [JaCoCo Plugin](https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin)（v2.2.0） - テストカバレッジのレポート生成用\n\n\n\n# Jenkinsfile\nGithubからWebhookでJenkinsのパイプラインジョブを実行する。\nパイプラインジョブではGithubのJenkinsfileを使う。\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png)\n\n\n```groovy:Jenkinsfile\npipeline {\n    agent any\n    // 定数や変数を定義する\n    environment {\n        reportDir = 'build/reports'\n        javaDir = 'src/main/java'\n        resourcesDir = 'src/main/resources'\n        testReportDir = 'build/test-results/test'\n        jacocoReportDir = 'build/jacoco' \n        javadocDir = 'build/docs/javadoc'\n        libsDir = 'build/libs'\n        appName = 'SampleApp'\n        appVersion = '1.0.0'\n    }\n    \n    // stagesブロック中に一つ以上のstageを定義する\n    stages {\n        stage('事前準備') {\n            // 実際の処理はstepsブロック中に定義する\n            steps {\n                deleteDir()\n\n                // このJobをトリガーしてきたGithubのプロジェクトをチェックアウト\n                checkout scm\n\n                // ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する\n                archiveArtifacts \"Jenkinsfile\"\n                archiveArtifacts \"build.gradle\"\n\n                // scriptブロックを使うと従来のScripted Pipelinesの記法も使える\n                script {\n                    // Permission deniedで怒られないために実行権限を付与する\n                    if(isUnix()) {\n                        sh 'chmod +x gradlew'\n                    }\n                }\n                gradlew 'clean'\n            }\n        }\n        \n        stage('コンパイル') {\n            steps {\n                gradlew 'classes testClasses'\n            }\n            \n            // postブロックでstepsブロックの後に実行される処理が定義できる\n            post {\n                // alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される\n                always {\n\n                    // JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので\n                    // Javaコンパイル時の警告はコンパイル直後に収集する\n                    step([\n\n                        // プラグインを実行するときのクラス指定は完全修飾名でなくてもOK\n                        $class: 'WarningsPublisher',\n\n                        // Job実行時のコンソールから警告を収集する場合はconsoleParsers、\n                        // pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。\n                        // なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要\n                        // パーサ名は下記プロパティファイルに定義されているものを使う\n                        // https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties\n                        consoleParsers: [\n                            [parserName: 'Java Compiler (javac)'],\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n        stage('静的コード解析') {\n            steps {\n                // 並列処理の場合はparallelメソッドを使う\n                parallel(\n                    '静的コード解析' : {\n                        gradlew 'check -x test'\n\n                        // dirメソッドでカレントディレクトリを指定できる\n                        dir(reportDir) {\n                            step([\n                                $class: 'CheckStylePublisher',\n                                pattern: \"checkstyle/*.xml\"\n                            ])\n                            step([\n                                $class: 'FindBugsPublisher',\n                                pattern: \"findbugs/*.xml\"\n                            ])\n                            step([\n                                $class: 'PmdPublisher',\n                                pattern: \"pmd/*.xml\"\n                            ])\n                            step([\n                                $class: 'DryPublisher',\n                                pattern: \"cpd/*.xml\"\n                            ])\n                \n                            archiveArtifacts \"checkstyle/*.xml\"\n                            archiveArtifacts \"findbugs/*.xml\"\n                            archiveArtifacts \"pmd/*.xml\"\n                            archiveArtifacts \"cpd/*.xml\"\n                        }\n                    },\n                    'ステップカウント': {\n                        // レポート作成\n                        // outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる\n                        stepcounter outputFile: 'stepcount.xls', outputFormat: 'excel', settings: [\n                            [key:'Java', filePattern: \"${javaDir}/**/*.java\"],\n                            [key:'SQL', filePattern: \"${resourcesDir}/**/*.sql\"],\n                            [key:'HTML', filePattern: \"${resourcesDir}/**/*.html\"],\n                            [key:'JS', filePattern: \"${resourcesDir}/**/*.js\"],\n                            [key:'CSS', filePattern: \"${resourcesDir}/**/*.css\"]\n                        ]\n                        // 一応エクセルファイルも成果物として保存する\n                        archiveArtifacts \"stepcount.xls\"\n                    },\n                    'タスクスキャン': {\n                        step([\n                            $class: 'TasksPublisher',\n                            pattern: './**',\n                            // 集計対象を検索するときに大文字小文字を区別するか\n                            ignoreCase: true,\n                            // 優先度別に集計対象の文字列を指定できる\n                            // 複数指定する場合はカンマ区切りの文字列を指定する\n                            high: 'System.out.System.err',\n                            normal: 'TODO,FIXME,XXX',\n                        ])\n                    },\n                    'JavaDoc': {\n                        gradlew 'javadoc -x classes'\n                        step([\n                            $class: 'JavadocArchiver',\n                            // Javadocのindex.htmlがあるフォルダのパスを指定する\n                            javadocDir: \"${javadocDir}\",\n                            keepAll: true\n                        ])\n                    }\n                )\n            }\n            \n            post {\n                always {\n                   // JavaDocの警告を収集\n                    step([\n                        $class: 'WarningsPublisher',\n                        consoleParsers: [\n                            [parserName: 'JavaDoc Tool']\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n\n        stage('テスト') {\n            steps {\n                gradlew 'test jacocoTestReport -x classes -x testClasses'\n                \n                junit \"${testReportDir}/*.xml\"\n                archiveArtifacts \"${testReportDir}/*.xml\"\n\n                // カバレッジレポートを生成（テストクラスを除外）\n                step([\n                    $class: 'JacocoPublisher',\n                    execPattern: \"${jacocoReportDir}/*.exec\",\n                    exclusionPattern: '**/*Test.class'\n                ])\n            }\n        }\n        \n        stage('デプロイ') {\n            // whenブロックでstageを実行する条件を指定できる\n            when {\n                // 静的コード解析とテスト失敗時はデプロイしない\n                expression {currentBuild.currentResult == 'SUCCESS'}\n            }\n            \n            steps {\n                gradlew 'jar'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.jar\"\n                gradlew 'war'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.war\"\n                deploy warDir: libsDir, appName: appName, appVersion: appVersion\n            }\n        }\n    }\n    \n    // stagesブロックと同じレベルにpostブロックを定義すると\n    // 全てのstage処理が終わった後の処理の定義が可能    \n    post {\n        always {\n            // 最後にワークスペースの中身を削除\n            deleteDir()\n        }\n        // 連続で成功しているとき以外は自分宛にメールを送信\n\n        // 結果が前回と変わった時\n        changed {\n            sendMail(\"${currentBuild.previousBuild.result} => ${currentBuild.currentResult}\")\n        }\n        // 失敗した時\n        failure {\n            sendMail(currentBuild.currentResult)\n        }\n        // 不安定な時（主にテスト失敗時）\n        unstable {\n            sendMail(currentBuild.currentResult)\n        }\n    }\n}\n\n\n// Gradlewコマンドを実行する\ndef gradlew(command) {\n    if(isUnix()) {\n        sh \"./gradlew ${command} --stacktrace\"\n    } else {\n        bat \"./gradlew.bat ${command} --stacktrace\"\n    }\n}\n\n// デプロイする\n// args.warDir warの格納ディレクトリ \n// args.appName アプリ名\n// args.appVersion アプリのバージョン\ndef deploy(Map args) {\n    // 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある\n    def keyDir = '/var/lib/jenkins/.ssh/xxx'\n    // Tomcatサーバのアドレスとユーザ名\n    def webServerAddress = 'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'\n    def webServerUser = 'hoge-user'\n    def webServer = \"${webServerUser}@${webServerAddress}\"\n    \n    def srcWar = \"${args.appName}-${args.appVersion}.war\"\n    def destWar = \"${args.appName}.war\"\n    \n    // ファイル転送してTomcatのwebappsにwarを配置する\n    sh \"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"\n    sh \"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"\n}\n\n// メールをGmailに送信する\ndef sendMail(result) {\n    mail to: \"xxxxxxxx@gmail.com\",\n        subject: \"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\",\n        body: \"Build URL: ${env.BUILD_URL}.\\n\\n\"\n}\n```\n\n# 躓いたこと\n* 各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。\n* currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ > 設定 > Pipeline Syntax > Global Variables Reference に詳しく載っていた。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png)\n \n* カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。\n* JenkinsからGmailにメールする場合、Jenkins > Jenkinsの管理 > システムの設定 > E-mail通知で下記のような設定が必要だった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png)\n\n* JenkinsからGmailにメールする場合、[安全性の低いアプリがアカウントにアクセスするのを許可する](https://support.google.com/accounts/answer/6010255?hl=ja)の手順に従って許可を有効にする必要があった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png)\n\n# build.gradle\nJenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。\n\n * checkstyle\n * findbugs\n * pmd\n * cpd(重複コードチェック)\n * test\n * jacocoReport\n * jar\n * war\n\n例えばこんな\n\n```groovy:build.gradle\napply plugin: 'java'\napply plugin: 'war'\napply plugin: 'checkstyle'\napply plugin: 'findbugs'\napply plugin: 'pmd'\napply plugin: 'jacoco'\n\next {\n    appVersion = '1.0.0'\n    appName = 'SampleApp'\n    javaVersion = 1.8\n    defaultEncoding = 'UTF-8'\n}\n\nsourceCompatibility = javaVersion\ntargetCompatibility  = javaVersion\ntasks.withType(AbstractCompile)*.options*.encoding = defaultEncoding\ntasks.withType(GroovyCompile)*.groovyOptions*.encoding = defaultEncoding\nmainClassName = 'jp.takumon.sapmleapp.App'\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    // 依存ライブラリを記載 \n\n    compile group: 'junit', name: 'junit', version: '4.12'\n}\n\njar {\n    baseName = appName\n    version =  appVersion\n}\n\nwar {\n    baseName = appName\n    version =  appVersion\n}\n\ncheckstyle {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = '7.6.1'\n}\n\nfindbugs {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = \"3.0.1\"\n}\n\npmd {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n}\n\ntasks.withType(Pmd) {\n    reports {\n      xml.enabled = true\n    }\n}\n\n// CPD（重複コードチェック処理）をCheckタスクに追加\ncheck.doLast {\n    File outputDir = new File(\"$reportsDir/cpd/\")\n    outputDir.mkdirs()\n  \n    ant.taskdef(\n        name: 'cpd', \n        classname: 'net.sourceforge.pmd.cpd.CPDTask',\n        classpath: configurations.pmd.asPath)\n  \n    ant.cpd(\n        minimumTokenCount: '100',\n        format: 'xml',\n        encoding: defaultEncoding,\n        outputFile: new File(outputDir, 'cpd.xml')\n    ) {\n        fileset(dir: \"src/main/java\") {\n            include(name: '**/*.java')\n        }\n    }\n}\n\njavadoc {\n    failOnError = false\n    // 好みのレベルで\n    options.memberLevel = JavadocMemberLevel.PRIVATE\n}\n\ntest {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    reports {\n        junitXml.enabled = true\n    }\n}\n\njacoco {\n    toolVersion = '0.7.5.201505241946'\n}\n\njacocoTestReport {\n    reports {\n      xml.enabled = true\n    }\n    \n    // カバレッジレポートからテストクラスを除外\n    afterEvaluate { \n        classDirectories = files(classDirectories.files.collect {\n            fileTree(dir: it, exclude: ['**/*Test.class']) \n        })\n    }\n}\n\ntask wrapper (type: Wrapper) {\n    gradleVersion = '3.4.1'\n}\n```\n\n\n以上。\n","comments_count":0,"created_at":"2017-04-07T02:38:55+09:00","likes_count":57,"reactions_count":0},{"fields":{"slug":"/2018/12/16/","title":"JJUG CCC 2018 Fallに行ってきました","date":"2018-12-16T21:50:00.000+09:00","excerpt":"なにこれJava CCC 2018 Fallに参加してきました。見てきたセッションは以下の通りです。【JJUG基調講演】Javaの未来を考えよう セッション概要#ccc_e1マネーフォワードのアカウントアグリゲーションの現状と課題点について...","tags":["Java","Kotlin","JJUG CCC","イベントレポート"],"keywords":["Java"],"thumbnail":""}}],"latestPosts":[{"fields":{"slug":"/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito","title":"Amplify + Cognito + AppSyncにおいてリゾルバーでユーザのカスタム属性を取得する方法","date":"2019-04-13T07:14:40.000+09:00","excerpt":"なにこれAppSync + Cognitoにおける認可制御について以前の記事で説明しました。今回は、ユーザーのカスタム属性を使った認可制御（AppSyncのリゾルバーでカスタム属性を取得する方法）についてご紹介します。TL;DRAppSyn...","tags":["Amplify","AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"/thumbnail/2019/04/how-to-get-user-custom-attributes-in-resolver-with-amplify-appsync-cognito.png"}},{"fields":{"slug":"/vee-validate-custom-validation-locale-message","title":"Vuetify + VeeValidate + VueI18nでカスタムバリデーション作成時にロケールごとのエラーメッセージを設定する方法","date":"2019-04-07T14:10:00.000+09:00","excerpt":"なにこれVuetify + VeeValidateで入力チェックする際に、VueI18nを使ってエラーメッセージを多言語対応・共通化する場合に、カスタムバリデーションのエラーメッセージをロケールごとに設定する方法について紹介します。実装方法...","tags":["Vue.js","Vuetify","VeeValidate","VueI18n"],"keywords":["Vue.js"],"thumbnail":"/thumbnail/2019/04/vee-validate-custom-validation-locale-message.png"}},{"fields":{"slug":"/vuetify-select-tag","title":"VuetifyでSelectタグを使う時の注意点","date":"2019-03-24T23:55:00.000+09:00","excerpt":"なにこれ最近Vue.jsのマテリアルデザインのUIフレームワーク「Vuetify」を使っています。とても便利で、管理アプリのようにデザインにこだわる必要がなければ、CSSをほとんど書かずに済むくらいコンポーネントが充実しています。ただSel...","tags":["Vue.js","Vuetify"],"keywords":["Vue.js"],"thumbnail":"/thumbnail/2019/03/vuetify-select-tag.png"}},{"fields":{"slug":"/aws-appsync-auth-with-cognito","title":"AppSync + Cognitoによる認可制御","date":"2019-03-17T17:45:00.000+09:00","excerpt":"なにこれAppSyncはCognitoと連携して認可制御ができます。今回はそのやり方についてご紹介します。ざっくりいうと以下のようなことが実現可能です。✨スキーマ定義におけるQueryやMutationごとの認可制御（ユーザーグループ）💎...","tags":["AppSync","AWS","Cognito"],"keywords":["AWS"],"thumbnail":"/thumbnail/2019/03/aws-appsync-auth-with-cognito.png"}},{"fields":{"slug":"/aws-appsync-and-serverless-framework","title":"AppSync + Serverless Frameworkによるソースコードの構成管理","date":"2019-03-04T07:50:00.000+09:00","excerpt":"なにこれAWSのGraphQLマネージドサービス「AppSync」はGUIで簡単に設定ができて便利ですが、本格的に開発を進めていくとGUIポチポチでソースコードを管理するのはつらくなってきます。Serverless Frameworkという...","tags":["AppSync","serverless","AWS","GraphQL"],"keywords":["AppSync"],"thumbnail":"/thumbnail/2019/03/aws-appsync-and-serverless-framework.png"}}],"previous":null,"next":{"fields":{"slug":"/4bf6ffd5-8640-508e-ab47-1a55df05d72e/","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","date":"2017-04-07T02:38:55+09:00","excerpt":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。Githubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイす...","tags":["Java","Jenkins","CI","gradle","Pipeline","Qiita"],"keywords":["Java"],"thumbnail":""},"id":"4bf6ffd5-8640-508e-ab47-1a55df05d72e","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","rendered_body":"<p>GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。<br>\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。</p>\n\n<h1>\n<span id=\"declarative-pipeline\" class=\"fragment\"></span><a href=\"#declarative-pipeline\"><i class=\"fa fa-link\"></i></a>Declarative Pipeline</h1>\n\n<p>いままではJenkinsfileを</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>node {\n  ....\n}\n</pre></div></div>\n\n<p>のように書いてましたが、<a href=\"https://jenkins.io/doc/book/pipeline/syntax/\" rel=\"nofollow noopener\" target=\"_blank\">Jenkinsの公式サイト</a>を見ると<br>\nこれはScripted Pipelinesの記法であり、<br>\nPipeline Pluginのバージョン2.5移行からは</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>pipeline {\n  ....  \n}\n</pre></div></div>\n\n<p>のように書くDeclarative Pipelineという記法が導入されて、<br>\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。<br>\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、<br>\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。</p>\n\n<h1>\n<span id=\"追加したプラグイン\" class=\"fragment\"></span><a href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\"><i class=\"fa fa-link\"></i></a>追加したプラグイン</h1>\n\n<p>Jenkins初期設定時のSuggested Pluginに入っていないもの</p>\n\n<ul>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F\" rel=\"nofollow noopener\" target=\"_blank\">Checkstyle Plugin</a>（v3.47） - Checkstyeの結果収集用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">FindBugs Plugin</a>（v4.69） - Findbugsのレポート生成用 </li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">PMD Plugin</a>（v3.46） - PMDのレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">DRY Plugin</a>（v2.46） - CPD(重複コードチェック)のレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Step Counter Plugin</a>（v2.0.0） - ソースコードのステップ数を集計してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Task Scanner Plugin</a>（v4.50） - ソースコード中のTODOとかを一覧化してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Javadoc Plugin</a>（v1.4） - JavaDoc生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Warnings Plugin</a>（v4.60） - ジョブ実行時の警告メッセージを収集してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">JaCoCo Plugin</a>（v2.2.0） - テストカバレッジのレポート生成用</li>\n</ul>\n\n<h1>\n<span id=\"jenkinsfile\" class=\"fragment\"></span><a href=\"#jenkinsfile\"><i class=\"fa fa-link\"></i></a>Jenkinsfile</h1>\n\n<p>GithubからWebhookでJenkinsのパイプラインジョブを実行する。<br>\nパイプラインジョブではGithubのJenkinsfileを使う。<br>\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。<br>\n<a href=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png\"></a></p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">Jenkinsfile</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">pipeline</span> <span class=\"o\">{</span>\n    <span class=\"n\">agent</span> <span class=\"n\">any</span>\n    <span class=\"c1\">// 定数や変数を定義する</span>\n    <span class=\"n\">environment</span> <span class=\"o\">{</span>\n        <span class=\"n\">reportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/reports'</span>\n        <span class=\"n\">javaDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/java'</span>\n        <span class=\"n\">resourcesDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/resources'</span>\n        <span class=\"n\">testReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/test-results/test'</span>\n        <span class=\"n\">jacocoReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/jacoco'</span> \n        <span class=\"n\">javadocDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/docs/javadoc'</span>\n        <span class=\"n\">libsDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/libs'</span>\n        <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n        <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロック中に一つ以上のstageを定義する</span>\n    <span class=\"n\">stages</span> <span class=\"o\">{</span>\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'事前準備'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 実際の処理はstepsブロック中に定義する</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n\n                <span class=\"c1\">// このJobをトリガーしてきたGithubのプロジェクトをチェックアウト</span>\n                <span class=\"n\">checkout</span> <span class=\"n\">scm</span>\n\n                <span class=\"c1\">// ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"Jenkinsfile\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"build.gradle\"</span>\n\n                <span class=\"c1\">// scriptブロックを使うと従来のScripted Pipelinesの記法も使える</span>\n                <span class=\"n\">script</span> <span class=\"o\">{</span>\n                    <span class=\"c1\">// Permission deniedで怒られないために実行権限を付与する</span>\n                    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n                        <span class=\"n\">sh</span> <span class=\"s1\">'chmod +x gradlew'</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">}</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'clean'</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'コンパイル'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'classes testClasses'</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"c1\">// postブロックでstepsブロックの後に実行される処理が定義できる</span>\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n\n                    <span class=\"c1\">// JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので</span>\n                    <span class=\"c1\">// Javaコンパイル時の警告はコンパイル直後に収集する</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n\n                        <span class=\"c1\">// プラグインを実行するときのクラス指定は完全修飾名でなくてもOK</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n\n                        <span class=\"c1\">// Job実行時のコンソールから警告を収集する場合はconsoleParsers、</span>\n                        <span class=\"c1\">// pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。</span>\n                        <span class=\"c1\">// なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要</span>\n                        <span class=\"c1\">// パーサ名は下記プロパティファイルに定義されているものを使う</span>\n                        <span class=\"c1\">// https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'Java Compiler (javac)'</span><span class=\"o\">],</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'静的コード解析'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 並列処理の場合はparallelメソッドを使う</span>\n                <span class=\"n\">parallel</span><span class=\"o\">(</span>\n                    <span class=\"s1\">'静的コード解析'</span> <span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'check -x test'</span>\n\n                        <span class=\"c1\">// dirメソッドでカレントディレクトリを指定できる</span>\n                        <span class=\"n\">dir</span><span class=\"o\">(</span><span class=\"n\">reportDir</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'CheckStylePublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'FindBugsPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'PmdPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'DryPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                        <span class=\"o\">}</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'ステップカウント'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"c1\">// レポート作成</span>\n                        <span class=\"c1\">// outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる</span>\n                        <span class=\"n\">stepcounter</span> <span class=\"nl\">outputFile:</span> <span class=\"s1\">'stepcount.xls'</span><span class=\"o\">,</span> <span class=\"nl\">outputFormat:</span> <span class=\"s1\">'excel'</span><span class=\"o\">,</span> <span class=\"nl\">settings:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'Java'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${javaDir}/**/*.java\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'SQL'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.sql\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'HTML'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.html\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'JS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.js\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'CSS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.css\"</span><span class=\"o\">]</span>\n                        <span class=\"o\">]</span>\n                        <span class=\"c1\">// 一応エクセルファイルも成果物として保存する</span>\n                        <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"stepcount.xls\"</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'タスクスキャン'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'TasksPublisher'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">pattern:</span> <span class=\"s1\">'./**'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 集計対象を検索するときに大文字小文字を区別するか</span>\n                            <span class=\"nl\">ignoreCase:</span> <span class=\"kc\">true</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 優先度別に集計対象の文字列を指定できる</span>\n                            <span class=\"c1\">// 複数指定する場合はカンマ区切りの文字列を指定する</span>\n                            <span class=\"nl\">high:</span> <span class=\"s1\">'System.out.System.err'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">normal:</span> <span class=\"s1\">'TODO,FIXME,XXX'</span><span class=\"o\">,</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'JavaDoc'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'javadoc -x classes'</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JavadocArchiver'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// Javadocのindex.htmlがあるフォルダのパスを指定する</span>\n                            <span class=\"nl\">javadocDir:</span> <span class=\"s2\">\"${javadocDir}\"</span><span class=\"o\">,</span>\n                            <span class=\"nl\">keepAll:</span> <span class=\"kc\">true</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">)</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n                   <span class=\"c1\">// JavaDocの警告を収集</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'JavaDoc Tool'</span><span class=\"o\">]</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'テスト'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'test jacocoTestReport -x classes -x testClasses'</span>\n\n                <span class=\"n\">junit</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n\n                <span class=\"c1\">// カバレッジレポートを生成（テストクラスを除外）</span>\n                <span class=\"n\">step</span><span class=\"o\">([</span>\n                    <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JacocoPublisher'</span><span class=\"o\">,</span>\n                    <span class=\"nl\">execPattern:</span> <span class=\"s2\">\"${jacocoReportDir}/*.exec\"</span><span class=\"o\">,</span>\n                    <span class=\"nl\">exclusionPattern:</span> <span class=\"s1\">'**/*Test.class'</span>\n                <span class=\"o\">])</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'デプロイ'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// whenブロックでstageを実行する条件を指定できる</span>\n            <span class=\"n\">when</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 静的コード解析とテスト失敗時はデプロイしない</span>\n                <span class=\"n\">expression</span> <span class=\"o\">{</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span> <span class=\"o\">==</span> <span class=\"s1\">'SUCCESS'</span><span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'jar'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.jar\"</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'war'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.war\"</span>\n                <span class=\"n\">deploy</span> <span class=\"nl\">warDir:</span> <span class=\"n\">libsDir</span><span class=\"o\">,</span> <span class=\"nl\">appName:</span> <span class=\"n\">appName</span><span class=\"o\">,</span> <span class=\"nl\">appVersion:</span> <span class=\"n\">appVersion</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロックと同じレベルにpostブロックを定義すると</span>\n    <span class=\"c1\">// 全てのstage処理が終わった後の処理の定義が可能    </span>\n    <span class=\"n\">post</span> <span class=\"o\">{</span>\n        <span class=\"n\">always</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 最後にワークスペースの中身を削除</span>\n            <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 連続で成功しているとき以外は自分宛にメールを送信</span>\n\n        <span class=\"c1\">// 結果が前回と変わった時</span>\n        <span class=\"n\">changed</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"s2\">\"${currentBuild.previousBuild.result} =&gt; ${currentBuild.currentResult}\"</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 失敗した時</span>\n        <span class=\"n\">failure</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 不安定な時（主にテスト失敗時）</span>\n        <span class=\"n\">unstable</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n\n<span class=\"c1\">// Gradlewコマンドを実行する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">gradlew</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n        <span class=\"n\">sh</span> <span class=\"s2\">\"./gradlew ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span> <span class=\"k\">else</span> <span class=\"o\">{</span>\n        <span class=\"n\">bat</span> <span class=\"s2\">\"./gradlew.bat ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// デプロイする</span>\n<span class=\"c1\">// args.warDir warの格納ディレクトリ </span>\n<span class=\"c1\">// args.appName アプリ名</span>\n<span class=\"c1\">// args.appVersion アプリのバージョン</span>\n<span class=\"kt\">def</span> <span class=\"nf\">deploy</span><span class=\"o\">(</span><span class=\"n\">Map</span> <span class=\"n\">args</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある</span>\n    <span class=\"kt\">def</span> <span class=\"n\">keyDir</span> <span class=\"o\">=</span> <span class=\"s1\">'/var/lib/jenkins/.ssh/xxx'</span>\n    <span class=\"c1\">// Tomcatサーバのアドレスとユーザ名</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerAddress</span> <span class=\"o\">=</span> <span class=\"s1\">'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerUser</span> <span class=\"o\">=</span> <span class=\"s1\">'hoge-user'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServer</span> <span class=\"o\">=</span> <span class=\"s2\">\"${webServerUser}@${webServerAddress}\"</span>\n\n    <span class=\"kt\">def</span> <span class=\"n\">srcWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}-${args.appVersion}.war\"</span>\n    <span class=\"kt\">def</span> <span class=\"n\">destWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}.war\"</span>\n\n    <span class=\"c1\">// ファイル転送してTomcatのwebappsにwarを配置する</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// メールをGmailに送信する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">sendMail</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">mail</span> <span class=\"nl\">to:</span> <span class=\"s2\">\"xxxxxxxx@gmail.com\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">subject:</span> <span class=\"s2\">\"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">body:</span> <span class=\"s2\">\"Build URL: ${env.BUILD_URL}.\\n\\n\"</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<h1>\n<span id=\"躓いたこと\" class=\"fragment\"></span><a href=\"#%E8%BA%93%E3%81%84%E3%81%9F%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>躓いたこと</h1>\n\n<ul>\n<li>各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。</li>\n<li>currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ &gt; 設定 &gt; Pipeline Syntax &gt; Global Variables Reference に詳しく載っていた。\n<a href=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png\"></a>\n</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png\"></a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png\"></a></p>\n\n<ul>\n<li>カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。</li>\n<li>JenkinsからGmailにメールする場合、Jenkins &gt; Jenkinsの管理 &gt; システムの設定 &gt; E-mail通知で下記のような設定が必要だった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png\"></a></p>\n\n<ul>\n<li>JenkinsからGmailにメールする場合、<a href=\"https://support.google.com/accounts/answer/6010255?hl=ja\" rel=\"nofollow noopener\" target=\"_blank\">安全性の低いアプリがアカウントにアクセスするのを許可する</a>の手順に従って許可を有効にする必要があった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png\"></a></p>\n\n<h1>\n<span id=\"buildgradle\" class=\"fragment\"></span><a href=\"#buildgradle\"><i class=\"fa fa-link\"></i></a>build.gradle</h1>\n\n<p>Jenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、<br>\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。<br>\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。</p>\n\n<ul>\n<li>checkstyle</li>\n<li>findbugs</li>\n<li>pmd</li>\n<li>cpd(重複コードチェック)</li>\n<li>test</li>\n<li>jacocoReport</li>\n<li>jar</li>\n<li>war</li>\n</ul>\n\n<p>例えばこんな</p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">build.gradle</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'java'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'war'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'checkstyle'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'findbugs'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'pmd'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'jacoco'</span>\n\n<span class=\"n\">ext</span> <span class=\"o\">{</span>\n    <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n    <span class=\"n\">javaVersion</span> <span class=\"o\">=</span> <span class=\"mf\">1.8</span>\n    <span class=\"n\">defaultEncoding</span> <span class=\"o\">=</span> <span class=\"s1\">'UTF-8'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">sourceCompatibility</span> <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">targetCompatibility</span>  <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">AbstractCompile</span><span class=\"o\">)*.</span><span class=\"na\">options</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">GroovyCompile</span><span class=\"o\">)*.</span><span class=\"na\">groovyOptions</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">mainClassName</span> <span class=\"o\">=</span> <span class=\"s1\">'jp.takumon.sapmleapp.App'</span>\n\n<span class=\"n\">repositories</span> <span class=\"o\">{</span>\n    <span class=\"n\">mavenCentral</span><span class=\"o\">()</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">dependencies</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 依存ライブラリを記載 </span>\n\n    <span class=\"n\">compile</span> <span class=\"nl\">group:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">name:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">version:</span> <span class=\"s1\">'4.12'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jar</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">war</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">checkstyle</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'7.6.1'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">findbugs</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s2\">\"3.0.1\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">pmd</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">Pmd</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// CPD（重複コードチェック処理）をCheckタスクに追加</span>\n<span class=\"n\">check</span><span class=\"o\">.</span><span class=\"na\">doLast</span> <span class=\"o\">{</span>\n    <span class=\"n\">File</span> <span class=\"n\">outputDir</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"s2\">\"$reportsDir/cpd/\"</span><span class=\"o\">)</span>\n    <span class=\"n\">outputDir</span><span class=\"o\">.</span><span class=\"na\">mkdirs</span><span class=\"o\">()</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">taskdef</span><span class=\"o\">(</span>\n        <span class=\"nl\">name:</span> <span class=\"s1\">'cpd'</span><span class=\"o\">,</span> \n        <span class=\"nl\">classname:</span> <span class=\"s1\">'net.sourceforge.pmd.cpd.CPDTask'</span><span class=\"o\">,</span>\n        <span class=\"nl\">classpath:</span> <span class=\"n\">configurations</span><span class=\"o\">.</span><span class=\"na\">pmd</span><span class=\"o\">.</span><span class=\"na\">asPath</span><span class=\"o\">)</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">cpd</span><span class=\"o\">(</span>\n        <span class=\"nl\">minimumTokenCount:</span> <span class=\"s1\">'100'</span><span class=\"o\">,</span>\n        <span class=\"nl\">format:</span> <span class=\"s1\">'xml'</span><span class=\"o\">,</span>\n        <span class=\"nl\">encoding:</span> <span class=\"n\">defaultEncoding</span><span class=\"o\">,</span>\n        <span class=\"nl\">outputFile:</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"n\">outputDir</span><span class=\"o\">,</span> <span class=\"s1\">'cpd.xml'</span><span class=\"o\">)</span>\n    <span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"n\">fileset</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"s2\">\"src/main/java\"</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">include</span><span class=\"o\">(</span><span class=\"nl\">name:</span> <span class=\"s1\">'**/*.java'</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">javadoc</span> <span class=\"o\">{</span>\n    <span class=\"n\">failOnError</span> <span class=\"o\">=</span> <span class=\"kc\">false</span>\n    <span class=\"c1\">// 好みのレベルで</span>\n    <span class=\"n\">options</span><span class=\"o\">.</span><span class=\"na\">memberLevel</span> <span class=\"o\">=</span> <span class=\"n\">JavadocMemberLevel</span><span class=\"o\">.</span><span class=\"na\">PRIVATE</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">test</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n        <span class=\"n\">junitXml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacoco</span> <span class=\"o\">{</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'0.7.5.201505241946'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacocoTestReport</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// カバレッジレポートからテストクラスを除外</span>\n    <span class=\"n\">afterEvaluate</span> <span class=\"o\">{</span> \n        <span class=\"n\">classDirectories</span> <span class=\"o\">=</span> <span class=\"n\">files</span><span class=\"o\">(</span><span class=\"n\">classDirectories</span><span class=\"o\">.</span><span class=\"na\">files</span><span class=\"o\">.</span><span class=\"na\">collect</span> <span class=\"o\">{</span>\n            <span class=\"n\">fileTree</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"n\">it</span><span class=\"o\">,</span> <span class=\"nl\">exclude:</span> <span class=\"o\">[</span><span class=\"s1\">'**/*Test.class'</span><span class=\"o\">])</span> \n        <span class=\"o\">})</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">task</span> <span class=\"nf\">wrapper</span> <span class=\"o\">(</span><span class=\"nl\">type:</span> <span class=\"n\">Wrapper</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">gradleVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'3.4.1'</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p>以上。</p>\n","body":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。\n\n# Declarative Pipeline\nいままではJenkinsfileを\n\n```\nnode {\n  ....\n}\n```\n\nのように書いてましたが、[Jenkinsの公式サイト](https://jenkins.io/doc/book/pipeline/syntax/)を見ると\nこれはScripted Pipelinesの記法であり、\nPipeline Pluginのバージョン2.5移行からは\n\n```\npipeline {\n  ....  \n}\n```\nのように書くDeclarative Pipelineという記法が導入されて、\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。\n\n# 追加したプラグイン\nJenkins初期設定時のSuggested Pluginに入っていないもの\n\n* [Checkstyle Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F)（v3.47） - Checkstyeの結果収集用\n* [FindBugs Plugin](https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin)（v4.69） - Findbugsのレポート生成用 \n* [PMD Plugin](https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin)（v3.46） - PMDのレポート生成用\n* [DRY Plugin](https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin)（v2.46） - CPD(重複コードチェック)のレポート生成用\n* [Step Counter Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin)（v2.0.0） - ソースコードのステップ数を集計してくれる\n* [Task Scanner Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin)（v4.50） - ソースコード中のTODOとかを一覧化してくれる\n* [Javadoc Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin)（v1.4） - JavaDoc生成用\n* [Warnings Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin)（v4.60） - ジョブ実行時の警告メッセージを収集してくれる\n* [JaCoCo Plugin](https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin)（v2.2.0） - テストカバレッジのレポート生成用\n\n\n\n# Jenkinsfile\nGithubからWebhookでJenkinsのパイプラインジョブを実行する。\nパイプラインジョブではGithubのJenkinsfileを使う。\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png)\n\n\n```groovy:Jenkinsfile\npipeline {\n    agent any\n    // 定数や変数を定義する\n    environment {\n        reportDir = 'build/reports'\n        javaDir = 'src/main/java'\n        resourcesDir = 'src/main/resources'\n        testReportDir = 'build/test-results/test'\n        jacocoReportDir = 'build/jacoco' \n        javadocDir = 'build/docs/javadoc'\n        libsDir = 'build/libs'\n        appName = 'SampleApp'\n        appVersion = '1.0.0'\n    }\n    \n    // stagesブロック中に一つ以上のstageを定義する\n    stages {\n        stage('事前準備') {\n            // 実際の処理はstepsブロック中に定義する\n            steps {\n                deleteDir()\n\n                // このJobをトリガーしてきたGithubのプロジェクトをチェックアウト\n                checkout scm\n\n                // ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する\n                archiveArtifacts \"Jenkinsfile\"\n                archiveArtifacts \"build.gradle\"\n\n                // scriptブロックを使うと従来のScripted Pipelinesの記法も使える\n                script {\n                    // Permission deniedで怒られないために実行権限を付与する\n                    if(isUnix()) {\n                        sh 'chmod +x gradlew'\n                    }\n                }\n                gradlew 'clean'\n            }\n        }\n        \n        stage('コンパイル') {\n            steps {\n                gradlew 'classes testClasses'\n            }\n            \n            // postブロックでstepsブロックの後に実行される処理が定義できる\n            post {\n                // alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される\n                always {\n\n                    // JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので\n                    // Javaコンパイル時の警告はコンパイル直後に収集する\n                    step([\n\n                        // プラグインを実行するときのクラス指定は完全修飾名でなくてもOK\n                        $class: 'WarningsPublisher',\n\n                        // Job実行時のコンソールから警告を収集する場合はconsoleParsers、\n                        // pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。\n                        // なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要\n                        // パーサ名は下記プロパティファイルに定義されているものを使う\n                        // https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties\n                        consoleParsers: [\n                            [parserName: 'Java Compiler (javac)'],\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n        stage('静的コード解析') {\n            steps {\n                // 並列処理の場合はparallelメソッドを使う\n                parallel(\n                    '静的コード解析' : {\n                        gradlew 'check -x test'\n\n                        // dirメソッドでカレントディレクトリを指定できる\n                        dir(reportDir) {\n                            step([\n                                $class: 'CheckStylePublisher',\n                                pattern: \"checkstyle/*.xml\"\n                            ])\n                            step([\n                                $class: 'FindBugsPublisher',\n                                pattern: \"findbugs/*.xml\"\n                            ])\n                            step([\n                                $class: 'PmdPublisher',\n                                pattern: \"pmd/*.xml\"\n                            ])\n                            step([\n                                $class: 'DryPublisher',\n                                pattern: \"cpd/*.xml\"\n                            ])\n                \n                            archiveArtifacts \"checkstyle/*.xml\"\n                            archiveArtifacts \"findbugs/*.xml\"\n                            archiveArtifacts \"pmd/*.xml\"\n                            archiveArtifacts \"cpd/*.xml\"\n                        }\n                    },\n                    'ステップカウント': {\n                        // レポート作成\n                        // outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる\n                        stepcounter outputFile: 'stepcount.xls', outputFormat: 'excel', settings: [\n                            [key:'Java', filePattern: \"${javaDir}/**/*.java\"],\n                            [key:'SQL', filePattern: \"${resourcesDir}/**/*.sql\"],\n                            [key:'HTML', filePattern: \"${resourcesDir}/**/*.html\"],\n                            [key:'JS', filePattern: \"${resourcesDir}/**/*.js\"],\n                            [key:'CSS', filePattern: \"${resourcesDir}/**/*.css\"]\n                        ]\n                        // 一応エクセルファイルも成果物として保存する\n                        archiveArtifacts \"stepcount.xls\"\n                    },\n                    'タスクスキャン': {\n                        step([\n                            $class: 'TasksPublisher',\n                            pattern: './**',\n                            // 集計対象を検索するときに大文字小文字を区別するか\n                            ignoreCase: true,\n                            // 優先度別に集計対象の文字列を指定できる\n                            // 複数指定する場合はカンマ区切りの文字列を指定する\n                            high: 'System.out.System.err',\n                            normal: 'TODO,FIXME,XXX',\n                        ])\n                    },\n                    'JavaDoc': {\n                        gradlew 'javadoc -x classes'\n                        step([\n                            $class: 'JavadocArchiver',\n                            // Javadocのindex.htmlがあるフォルダのパスを指定する\n                            javadocDir: \"${javadocDir}\",\n                            keepAll: true\n                        ])\n                    }\n                )\n            }\n            \n            post {\n                always {\n                   // JavaDocの警告を収集\n                    step([\n                        $class: 'WarningsPublisher',\n                        consoleParsers: [\n                            [parserName: 'JavaDoc Tool']\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n\n        stage('テスト') {\n            steps {\n                gradlew 'test jacocoTestReport -x classes -x testClasses'\n                \n                junit \"${testReportDir}/*.xml\"\n                archiveArtifacts \"${testReportDir}/*.xml\"\n\n                // カバレッジレポートを生成（テストクラスを除外）\n                step([\n                    $class: 'JacocoPublisher',\n                    execPattern: \"${jacocoReportDir}/*.exec\",\n                    exclusionPattern: '**/*Test.class'\n                ])\n            }\n        }\n        \n        stage('デプロイ') {\n            // whenブロックでstageを実行する条件を指定できる\n            when {\n                // 静的コード解析とテスト失敗時はデプロイしない\n                expression {currentBuild.currentResult == 'SUCCESS'}\n            }\n            \n            steps {\n                gradlew 'jar'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.jar\"\n                gradlew 'war'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.war\"\n                deploy warDir: libsDir, appName: appName, appVersion: appVersion\n            }\n        }\n    }\n    \n    // stagesブロックと同じレベルにpostブロックを定義すると\n    // 全てのstage処理が終わった後の処理の定義が可能    \n    post {\n        always {\n            // 最後にワークスペースの中身を削除\n            deleteDir()\n        }\n        // 連続で成功しているとき以外は自分宛にメールを送信\n\n        // 結果が前回と変わった時\n        changed {\n            sendMail(\"${currentBuild.previousBuild.result} => ${currentBuild.currentResult}\")\n        }\n        // 失敗した時\n        failure {\n            sendMail(currentBuild.currentResult)\n        }\n        // 不安定な時（主にテスト失敗時）\n        unstable {\n            sendMail(currentBuild.currentResult)\n        }\n    }\n}\n\n\n// Gradlewコマンドを実行する\ndef gradlew(command) {\n    if(isUnix()) {\n        sh \"./gradlew ${command} --stacktrace\"\n    } else {\n        bat \"./gradlew.bat ${command} --stacktrace\"\n    }\n}\n\n// デプロイする\n// args.warDir warの格納ディレクトリ \n// args.appName アプリ名\n// args.appVersion アプリのバージョン\ndef deploy(Map args) {\n    // 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある\n    def keyDir = '/var/lib/jenkins/.ssh/xxx'\n    // Tomcatサーバのアドレスとユーザ名\n    def webServerAddress = 'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'\n    def webServerUser = 'hoge-user'\n    def webServer = \"${webServerUser}@${webServerAddress}\"\n    \n    def srcWar = \"${args.appName}-${args.appVersion}.war\"\n    def destWar = \"${args.appName}.war\"\n    \n    // ファイル転送してTomcatのwebappsにwarを配置する\n    sh \"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"\n    sh \"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"\n}\n\n// メールをGmailに送信する\ndef sendMail(result) {\n    mail to: \"xxxxxxxx@gmail.com\",\n        subject: \"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\",\n        body: \"Build URL: ${env.BUILD_URL}.\\n\\n\"\n}\n```\n\n# 躓いたこと\n* 各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。\n* currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ > 設定 > Pipeline Syntax > Global Variables Reference に詳しく載っていた。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png)\n \n* カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。\n* JenkinsからGmailにメールする場合、Jenkins > Jenkinsの管理 > システムの設定 > E-mail通知で下記のような設定が必要だった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png)\n\n* JenkinsからGmailにメールする場合、[安全性の低いアプリがアカウントにアクセスするのを許可する](https://support.google.com/accounts/answer/6010255?hl=ja)の手順に従って許可を有効にする必要があった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png)\n\n# build.gradle\nJenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。\n\n * checkstyle\n * findbugs\n * pmd\n * cpd(重複コードチェック)\n * test\n * jacocoReport\n * jar\n * war\n\n例えばこんな\n\n```groovy:build.gradle\napply plugin: 'java'\napply plugin: 'war'\napply plugin: 'checkstyle'\napply plugin: 'findbugs'\napply plugin: 'pmd'\napply plugin: 'jacoco'\n\next {\n    appVersion = '1.0.0'\n    appName = 'SampleApp'\n    javaVersion = 1.8\n    defaultEncoding = 'UTF-8'\n}\n\nsourceCompatibility = javaVersion\ntargetCompatibility  = javaVersion\ntasks.withType(AbstractCompile)*.options*.encoding = defaultEncoding\ntasks.withType(GroovyCompile)*.groovyOptions*.encoding = defaultEncoding\nmainClassName = 'jp.takumon.sapmleapp.App'\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    // 依存ライブラリを記載 \n\n    compile group: 'junit', name: 'junit', version: '4.12'\n}\n\njar {\n    baseName = appName\n    version =  appVersion\n}\n\nwar {\n    baseName = appName\n    version =  appVersion\n}\n\ncheckstyle {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = '7.6.1'\n}\n\nfindbugs {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = \"3.0.1\"\n}\n\npmd {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n}\n\ntasks.withType(Pmd) {\n    reports {\n      xml.enabled = true\n    }\n}\n\n// CPD（重複コードチェック処理）をCheckタスクに追加\ncheck.doLast {\n    File outputDir = new File(\"$reportsDir/cpd/\")\n    outputDir.mkdirs()\n  \n    ant.taskdef(\n        name: 'cpd', \n        classname: 'net.sourceforge.pmd.cpd.CPDTask',\n        classpath: configurations.pmd.asPath)\n  \n    ant.cpd(\n        minimumTokenCount: '100',\n        format: 'xml',\n        encoding: defaultEncoding,\n        outputFile: new File(outputDir, 'cpd.xml')\n    ) {\n        fileset(dir: \"src/main/java\") {\n            include(name: '**/*.java')\n        }\n    }\n}\n\njavadoc {\n    failOnError = false\n    // 好みのレベルで\n    options.memberLevel = JavadocMemberLevel.PRIVATE\n}\n\ntest {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    reports {\n        junitXml.enabled = true\n    }\n}\n\njacoco {\n    toolVersion = '0.7.5.201505241946'\n}\n\njacocoTestReport {\n    reports {\n      xml.enabled = true\n    }\n    \n    // カバレッジレポートからテストクラスを除外\n    afterEvaluate { \n        classDirectories = files(classDirectories.files.collect {\n            fileTree(dir: it, exclude: ['**/*Test.class']) \n        })\n    }\n}\n\ntask wrapper (type: Wrapper) {\n    gradleVersion = '3.4.1'\n}\n```\n\n\n以上。\n","comments_count":0,"created_at":"2017-04-07T02:38:55+09:00","likes_count":57,"reactions_count":0}}}