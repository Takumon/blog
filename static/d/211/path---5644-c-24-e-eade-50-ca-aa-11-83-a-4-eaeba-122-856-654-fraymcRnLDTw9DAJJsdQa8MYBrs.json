{"data":{"site":{"siteMetadata":{"title":"Takumon Blog","author":"Takuto Inoue"}},"qiitaPost":{"rendered_body":"\n<h2>\n<span id=\"やりたいこと\" class=\"fragment\"></span><a href=\"#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>やりたいこと</h2>\n\n<ul>\n<li>Angular CLI使って、MEANスタック(<strong>M</strong>ongoDB + <strong>E</strong>xpress + <strong>A</strong>ngular + <strong>N</strong>odeJS)のアプリを作りたい。どうせならサーバ側もTypeScriptで作りたい。</li>\n<li>フロント側とサーバ側の両方をwebpack、gulpなどは使わずにnpm scriptsだけでビルド、テストできるようにしたい。</li>\n<li>Dockerを使ってアプリを簡単に配布したい。</li>\n</ul>\n\n<p>これらを達成するための最小構成プロジェクトの作り方を３回に分けて紹介します。</p>\n\n<ul>\n<li><a href=\"http://qiita.com/Takumon/items/572438809384e2e11792\" id=\"reference-fc6741a6eda3b7ffd9f1\">その１. ビルド編</a></li>\n<li>その２. テスト編　⇦　今回はココ</li>\n<li>その３. Dockerビルド編</li>\n</ul>\n\n<h2>\n<span id=\"その２-テスト編\" class=\"fragment\"></span><a href=\"#%E3%81%9D%E3%81%AE%EF%BC%92-%E3%83%86%E3%82%B9%E3%83%88%E7%B7%A8\"><i class=\"fa fa-link\"></i></a>その２. テスト編</h2>\n\n<p><a href=\"http://qiita.com/Takumon/items/572438809384e2e11792\">その１. ビルド編</a>では、Angular CLIで作成したプロジェクトをベースに、<br>\nMongoDBに登録しているメッセージを画面に一覧で表示するアプリを作成しました。<br>\n今回は、クライアント側とサーバ側の<a href=\"https://jasmine.github.io/\" rel=\"nofollow noopener\" target=\"_blank\">Jasmine</a>を使った単体テスト、<a href=\"http://www.protractortest.org/#/\" rel=\"nofollow noopener\" target=\"_blank\">Protractor</a>を使ったE2Eテスト、それらを実行するnpm scriptsを作成します。<br>\n最終的には下記のように<code>npm test</code>コマンドで単体テストが実行できるようになります。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/7f33351fc11e7394a52bb31fa317136827ea0735/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36343161363631662d333632342d633466312d333733662d6362343331393330346530322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/7f33351fc11e7394a52bb31fa317136827ea0735/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36343161363631662d333632342d633466312d333733662d6362343331393330346530322e706e67\" alt=\"10_単体テスト実施イメージ.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/641a661f-3624-c4f1-373f-cb4319304e02.png\"></a></p>\n\n<p>またE2Eテストは<code>npm run e2e</code>コマンドで実施できるようになります。<br>\n<a href=\"https://camo.qiitausercontent.com/7ed95d4b7e245fbb593b4c8c2895d30013489715/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35616438346136612d306538652d613830622d633763352d3533386237306161393235392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/7ed95d4b7e245fbb593b4c8c2895d30013489715/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35616438346136612d306538652d613830622d633763352d3533386237306161393235392e706e67\" alt=\"20_E2Eテスト実施イメージ.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/5ad84a6a-0e8e-a80b-c7c5-538b70aa9259.png\"></a></p>\n\n<h3>\n<span id=\"プロジェクト構成\" class=\"fragment\"></span><a href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A7%8B%E6%88%90\"><i class=\"fa fa-link\"></i></a>プロジェクト構成</h3>\n\n<p>今回のチュートリアル終了すると下記のようなプロジェクトの構成になります。<br>\n<a href=\"http://qiita.com/Takumon/items/572438809384e2e11792\">その１. ビルド編</a>で作成したものをベースにテスト用の資産を追加します。詳細は<a href=\"https://github.com/Takumon/angular4-express4-typescritp2/tree/test\" rel=\"nofollow noopener\" target=\"_blank\">リポジトリ</a>を参照してください。</p>\n\n<div class=\"code-frame\" data-lang=\"\">\n<div class=\"code-lang\"><span class=\"bold\">プロジェクト構成（完成イメージ）</span></div>\n<div class=\"highlight\"><pre>.\n├── dist                              ・・・(1) コンパイル資産出力先\n│   ├── server\n│   │   ├── ...\n│   │   ...\n│   │ \n│   └── server_test                      ・・・(1-1)　コンパイルされたサーバ側テスト資産\n│       ├── app.spec.js\n│       ├── app.spec.js.map\n│       ├── test.server.conf.js\n│       ├── test.server.conf.js.map\n│       ├── test.server.js\n│       └── test.server.js.map\n├── e2e                                ・・・(2)　E2Eテスト資産\n│   ├── app.e2e-spec.ts\n│   ├── app.po.ts\n│   └── tsconfig.e2e.json\n├── node_modules\n│   ├── ...\n│   ...\n│\n├── server\n│   ├── ...\n│   ...\n│\n├── server_test                         ・・・(3)　サーバ側テスト資産\n│   ├── app.spec.ts\n│   ├── test.server.conf.ts\n│   ├── test.server.ts\n│   └── tsconfig.server_test.json\n├── src\n│   ├── app\n│   │   ├── app.component.css\n│   │   ├── app.component.html\n│   │   ├── app.component.spec.ts      ・・・(4)　クライアント側テスト資産\n│   │   ├── app.component.ts\n│   │   ├── app.module.ts\n│   │   └── message\n│   │       ├── message.service.spec.ts ・・・(4)　クライアント側テスト資産\n│   │       └── message.service.ts\n│   ...\n│\n├── package-lock.json\n├── package.json\n├── protractor.conf.js                   ・・・(5)　E2Eテスト設定ファイル\n├── proxy.conf.json\n├── karma.conf.js\n├── tsconfig.json\n├── tslint.json\n└── README.md\n</pre></div>\n</div>\n\n<h4>\n<span id=\"各資産について\" class=\"fragment\"></span><a href=\"#%E5%90%84%E8%B3%87%E7%94%A3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><i class=\"fa fa-link\"></i></a>各資産について</h4>\n\n<h5>\n<span id=\"1-dist\" class=\"fragment\"></span><a href=\"#1-dist\"><i class=\"fa fa-link\"></i></a>(1) dist</h5>\n\n<p>コンパイル資産出力先。</p>\n\n<h5>\n<span id=\"1-1-distserver_test\" class=\"fragment\"></span><a href=\"#1-1-distserver_test\"><i class=\"fa fa-link\"></i></a>(1-1) dist/server_test</h5>\n\n<p>コンパイルされたサーバ側テスト資産(JSファイル)の出力先。<br>\nデプロイを考慮して本資産(dist/server)とは別ディレクトリにしています。</p>\n\n<h5>\n<span id=\"2-server_test\" class=\"fragment\"></span><a href=\"#2-server_test\"><i class=\"fa fa-link\"></i></a>(2) server_test</h5>\n\n<p>サーバ側テスト資産のディレクトリ。<br>\nコンパイル用の設定ファイルとテスト用の設定ファイルもココに格納します。</p>\n\n<h5>\n<span id=\"3-e2e\" class=\"fragment\"></span><a href=\"#3-e2e\"><i class=\"fa fa-link\"></i></a>(3) e2e</h5>\n\n<p>E2Eテスト用資産のディレクトリ。</p>\n\n<h5>\n<span id=\"4-srcapp配下のspectsファイル\" class=\"fragment\"></span><a href=\"#4-srcapp%E9%85%8D%E4%B8%8B%E3%81%AEspects%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB\"><i class=\"fa fa-link\"></i></a>(4) src/app配下のspec.tsファイル</h5>\n\n<p>フロント側テスト資産。<br>\nコンパイルやテストは<code>ng</code>コマンドで実施します。</p>\n\n<h5>\n<span id=\"5-protractorconfjs\" class=\"fragment\"></span><a href=\"#5-protractorconfjs\"><i class=\"fa fa-link\"></i></a>(5) protractor.conf.js</h5>\n\n<p>E2Eテスト設定ファイル。<br>\n今回はAngular CLIでプロジェクトが作成するデフォルトから少しだけ修正します。</p>\n\n<h2>\n<span id=\"構築手順\" class=\"fragment\"></span><a href=\"#%E6%A7%8B%E7%AF%89%E6%89%8B%E9%A0%86\"><i class=\"fa fa-link\"></i></a>構築手順</h2>\n\n<h3>\n<span id=\"1-テストに必要なライブラリをインストール\" class=\"fragment\"></span><a href=\"#1-%E3%83%86%E3%82%B9%E3%83%88%E3%81%AB%E5%BF%85%E8%A6%81%E3%81%AA%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"><i class=\"fa fa-link\"></i></a>1. テストに必要なライブラリをインストール</h3>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ npm install --save zone.js@0.8.12\n$ npm install --save-dev @types/mongoose nodemon npm-run-all\n</pre></div></div>\n\n<ul>\n<li>\n<a href=\"https://www.npmjs.com/package/zone.js\" rel=\"nofollow noopener\" target=\"_blank\"><code>zone.js@0.8.12</code></a>\n\n<ul>\n<li>クライアント側のテストで使用します。Angular CLIでプロジェクトを作成した時点でインストールされていますが、テスト実行時に<code>Failed: Cannot create property '__creationTrace__' on string '__zone_symbol__optimizedZoneEventTask'</code>のようなエラーが出ます。<a href=\"https://github.com/angular/zone.js/issues/832\" rel=\"nofollow noopener\" target=\"_blank\">GitHubのissues</a>によるとv0.8.12はエラーが出ないそうなので、v0.8.12を再インストールします。</li>\n</ul>\n</li>\n<li>\n<a href=\"https://www.npmjs.com/package/supertest\" rel=\"nofollow noopener\" target=\"_blank\"><code>supertest</code></a>\n\n<ul>\n<li>サーバ側のテストで使用します。APIテストを簡単にしてくれます。</li>\n</ul>\n</li>\n</ul>\n\n<h3>\n<span id=\"2-クライアント側を作成\" class=\"fragment\"></span><a href=\"#2-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>2. クライアント側を作成</h3>\n\n<p>コンポーネント(app.component.ts)とサービス(message.service.ts)に対するテストコードを作成します。<br>\nクライアント側のテスト実行には<code>ng test</code>コマンドを使うので、ビルド周りの設定は不要です。</p>\n\n<h4>\n<span id=\"srcappappcomponentspects\" class=\"fragment\"></span><a href=\"#srcappappcomponentspects\"><i class=\"fa fa-link\"></i></a>src/app/app.component.spec.ts</h4>\n\n<p>コンポーネントは画面描画についてテストします。<br>\nコンポーネントで使うサービスは、<code>TestBed</code>の<code>overrideComponent</code>メソッドを使ってモック化します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.component.spec.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"k\">async</span><span class=\"p\">,</span> <span class=\"nx\">ComponentFixture</span><span class=\"p\">,</span> <span class=\"nx\">TestBed</span><span class=\"p\">,</span> <span class=\"nx\">inject</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core/testing'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">FormsModule</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/forms'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Observable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'rxjs/Rx'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"s1\">'rxjs/Rx'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">AppComponent</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./app.component'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MessageService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./message/message.service'</span><span class=\"p\">;</span>\n\n<span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'AppComponent'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// テスト対象のComponent</span>\n  <span class=\"kd\">let</span> <span class=\"na\">component</span><span class=\"p\">:</span> <span class=\"nx\">AppComponent</span><span class=\"p\">;</span>\n\n  <span class=\"c1\">// テスト対象のFixture</span>\n  <span class=\"kd\">let</span> <span class=\"na\">fixture</span><span class=\"p\">:</span> <span class=\"nx\">ComponentFixture</span><span class=\"o\">&lt;</span><span class=\"nx\">AppComponent</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n\n  <span class=\"c1\">// MessageServiceのモック</span>\n  <span class=\"kd\">class</span> <span class=\"nx\">MessageServiceMock</span> <span class=\"p\">{</span>\n    <span class=\"nx\">getAll</span><span class=\"p\">():</span> <span class=\"nx\">Observable</span><span class=\"o\">&lt;</span><span class=\"nx\">any</span><span class=\"o\">&gt;</span> <span class=\"p\">{</span>\n      <span class=\"kd\">const</span> <span class=\"nx\">response</span> <span class=\"o\">=</span>  <span class=\"p\">{</span> <span class=\"na\">messages</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ1'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ2'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ3'</span> <span class=\"p\">}</span>\n      <span class=\"p\">]};</span>\n\n      <span class=\"k\">return</span> <span class=\"nx\">Observable</span><span class=\"p\">.</span><span class=\"k\">from</span><span class=\"p\">([</span><span class=\"nx\">response</span><span class=\"p\">]);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">beforeEach</span><span class=\"p\">(</span><span class=\"k\">async</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">TestBed</span><span class=\"p\">.</span><span class=\"nx\">configureTestingModule</span><span class=\"p\">({</span>\n      <span class=\"na\">imports</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"nx\">FormsModule</span> <span class=\"p\">],</span>\n      <span class=\"na\">declarations</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n        <span class=\"nx\">AppComponent</span>\n      <span class=\"p\">],</span>\n    <span class=\"p\">})</span>\n<span class=\"err\">　　　　　　　　　</span><span class=\"c1\">// MessageServiceのモックを設定</span>\n    <span class=\"p\">.</span><span class=\"nx\">overrideComponent</span><span class=\"p\">(</span><span class=\"nx\">AppComponent</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n      <span class=\"na\">set</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n        <span class=\"na\">providers</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span> <span class=\"na\">provide</span><span class=\"p\">:</span> <span class=\"nx\">MessageService</span><span class=\"p\">,</span> <span class=\"na\">useClass</span><span class=\"p\">:</span> <span class=\"nx\">MessageServiceMock</span> <span class=\"p\">},</span>\n        <span class=\"p\">]</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">})</span>\n    <span class=\"p\">.</span><span class=\"nx\">compileComponents</span><span class=\"p\">();</span>\n\n    <span class=\"nx\">fixture</span> <span class=\"o\">=</span> <span class=\"nx\">TestBed</span><span class=\"p\">.</span><span class=\"nx\">createComponent</span><span class=\"p\">(</span><span class=\"nx\">AppComponent</span><span class=\"p\">);</span>\n    <span class=\"nx\">component</span> <span class=\"o\">=</span> <span class=\"nx\">fixture</span><span class=\"p\">.</span><span class=\"nx\">componentInstance</span><span class=\"p\">;</span>\n    <span class=\"nx\">fixture</span><span class=\"p\">.</span><span class=\"nx\">detectChanges</span><span class=\"p\">();</span>\n  <span class=\"p\">}));</span>\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'オブジェクトが生成されるか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"kd\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">fixture</span><span class=\"p\">.</span><span class=\"nx\">debugElement</span><span class=\"p\">.</span><span class=\"nx\">componentInstance</span><span class=\"p\">;</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">app</span><span class=\"p\">).</span><span class=\"nx\">toBeTruthy</span><span class=\"p\">();</span>\n  <span class=\"p\">}));</span>\n\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'メッセージを３件保持しているか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">component</span><span class=\"p\">.</span><span class=\"nx\">messages</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">([</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ1'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ2'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ3'</span> <span class=\"p\">}</span>\n    <span class=\"p\">]);</span>\n  <span class=\"p\">}));</span>\n\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'画面にメッセージが３件表示されているか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n    <span class=\"kd\">const</span> <span class=\"nx\">el</span> <span class=\"o\">=</span> <span class=\"nx\">fixture</span><span class=\"p\">.</span><span class=\"nx\">debugElement</span><span class=\"p\">.</span><span class=\"nx\">nativeElement</span><span class=\"p\">;</span>\n\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">el</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s1\">'li'</span><span class=\"p\">).</span><span class=\"nx\">length</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">);</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">el</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s1\">'li'</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">textContent</span><span class=\"p\">).</span><span class=\"nx\">toContain</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ1'</span><span class=\"p\">);</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">el</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s1\">'li'</span><span class=\"p\">)[</span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"nx\">textContent</span><span class=\"p\">).</span><span class=\"nx\">toContain</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ2'</span><span class=\"p\">);</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">el</span><span class=\"p\">.</span><span class=\"nx\">querySelectorAll</span><span class=\"p\">(</span><span class=\"s1\">'li'</span><span class=\"p\">)[</span><span class=\"mi\">2</span><span class=\"p\">].</span><span class=\"nx\">textContent</span><span class=\"p\">).</span><span class=\"nx\">toContain</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ3'</span><span class=\"p\">);</span>\n  <span class=\"p\">}));</span>\n<span class=\"p\">});</span>\n\n</pre></div>\n</div>\n\n<h4>\n<span id=\"srcappmessagemessageservicespects一部抜粋\" class=\"fragment\"></span><a href=\"#srcappmessagemessageservicespects%E4%B8%80%E9%83%A8%E6%8A%9C%E7%B2%8B\"><i class=\"fa fa-link\"></i></a>src/app/message/message.service.spec.ts(一部抜粋)</h4>\n\n<p>サービスのテストです。<br>\nサーバとのやりとり(HTTP通信)については<code>MockBackend</code>を使ってモック化しています。<br>\nなお<code>Error</code>は別途モックを作らなければなりません。<br>\n全て載せると冗長なので<code>register</code>メソッドのテストは割愛しています。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">message.service.spec.ts(一部抜粋)</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">TestBed</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">,</span> <span class=\"nx\">inject</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core/testing'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">HttpModule</span><span class=\"p\">,</span> <span class=\"nx\">BaseRequestOptions</span><span class=\"p\">,</span> <span class=\"nx\">Http</span><span class=\"p\">,</span> <span class=\"nx\">Response</span><span class=\"p\">,</span> <span class=\"nx\">ResponseOptions</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/http'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">MockConnection</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/http/testing'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">RequestMethod</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/http'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MessageService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./message.service'</span><span class=\"p\">;</span>\n\n\n<span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'MessageService'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n<span class=\"err\">　　　　</span><span class=\"c1\">// HTTP通信エラー用のモック</span>\n  <span class=\"kd\">class</span> <span class=\"nx\">MockError</span> <span class=\"kd\">extends</span> <span class=\"nx\">Response</span> <span class=\"kr\">implements</span> <span class=\"nb\">Error</span> <span class=\"p\">{</span>\n    <span class=\"na\">name</span><span class=\"p\">:</span> <span class=\"nx\">any</span><span class=\"p\">;</span>\n    <span class=\"nl\">message</span><span class=\"p\">:</span> <span class=\"nx\">any</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n<span class=\"err\">　　　　</span><span class=\"c1\">// HTTP通信はMockBackendでモック化</span>\n  <span class=\"nx\">beforeEach</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">TestBed</span><span class=\"p\">.</span><span class=\"nx\">configureTestingModule</span><span class=\"p\">({</span>\n      <span class=\"na\">imports</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">HttpModule</span><span class=\"p\">],</span>\n      <span class=\"na\">providers</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">MessageService</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n        <span class=\"na\">provide</span><span class=\"p\">:</span> <span class=\"nx\">Http</span><span class=\"p\">,</span>\n        <span class=\"na\">useFactory</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"nx\">backend</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nx\">Http</span><span class=\"p\">(</span><span class=\"nx\">backend</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">),</span>\n        <span class=\"na\">deps</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">BaseRequestOptions</span><span class=\"p\">]</span>\n      <span class=\"p\">},</span> <span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">BaseRequestOptions</span><span class=\"p\">]</span>\n    <span class=\"p\">});</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'オブジェクトが生成されるか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(</span><span class=\"nx\">inject</span><span class=\"p\">([</span><span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">MessageService</span><span class=\"p\">],</span> <span class=\"p\">(</span><span class=\"na\">backend</span><span class=\"p\">:</span> <span class=\"nx\">MockBackend</span> <span class=\"p\">,</span> <span class=\"na\">service</span><span class=\"p\">:</span> <span class=\"nx\">MessageService</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">service</span><span class=\"p\">).</span><span class=\"nx\">toBeTruthy</span><span class=\"p\">();</span>\n  <span class=\"p\">})));</span>\n\n\n  <span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'getAll'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n    <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'メッセージが取得できるか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(</span><span class=\"nx\">inject</span><span class=\"p\">([</span><span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">MessageService</span><span class=\"p\">],</span> <span class=\"p\">(</span><span class=\"na\">backend</span><span class=\"p\">:</span> <span class=\"nx\">MockBackend</span> <span class=\"p\">,</span> <span class=\"na\">service</span><span class=\"p\">:</span> <span class=\"nx\">MessageService</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// HTTP通信のモックで返す具体的な値の設定</span>\n      <span class=\"nx\">backend</span><span class=\"p\">.</span><span class=\"nx\">connections</span><span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">conn</span><span class=\"p\">:</span> <span class=\"nx\">MockConnection</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">body</span> <span class=\"o\">=</span>  <span class=\"p\">{</span> <span class=\"na\">messages</span> <span class=\"p\">:</span> <span class=\"p\">[</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ1'</span> <span class=\"p\">},</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ2'</span> <span class=\"p\">},</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ3'</span> <span class=\"p\">}</span>\n        <span class=\"p\">]};</span>\n\n        <span class=\"kd\">const</span> <span class=\"nx\">ops</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ResponseOptions</span><span class=\"p\">({</span>\n          <span class=\"na\">status</span><span class=\"p\">:</span> <span class=\"mi\">200</span><span class=\"p\">,</span>\n          <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">)</span>\n        <span class=\"p\">});</span>\n\n        <span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">mockRespond</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">Response</span><span class=\"p\">(</span><span class=\"nx\">ops</span><span class=\"p\">));</span>\n      <span class=\"p\">});</span>\n\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// リクエストの内容を検証</span>\n      <span class=\"nx\">backend</span><span class=\"p\">.</span><span class=\"nx\">connections</span><span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">conn</span><span class=\"p\">:</span> <span class=\"nx\">MockConnection</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">url</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">);</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">method</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"nx\">RequestMethod</span><span class=\"p\">.</span><span class=\"nx\">Get</span><span class=\"p\">);</span>\n      <span class=\"p\">});</span>\n\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// レスポンスの内容を検証</span>\n      <span class=\"nx\">service</span><span class=\"p\">.</span><span class=\"nx\">getAll</span><span class=\"p\">().</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">messages</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">);</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">messages</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">([</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ1'</span> <span class=\"p\">},</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ2'</span> <span class=\"p\">},</span>\n          <span class=\"p\">{</span> <span class=\"na\">message</span> <span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ3'</span> <span class=\"p\">}</span>\n        <span class=\"p\">]);</span>\n      <span class=\"p\">});</span>\n    <span class=\"p\">})));</span>\n\n\n    <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'異常時にエラーハンドリングされるか'</span><span class=\"p\">,</span> <span class=\"k\">async</span><span class=\"p\">(</span><span class=\"nx\">inject</span><span class=\"p\">([</span><span class=\"nx\">MockBackend</span><span class=\"p\">,</span> <span class=\"nx\">MessageService</span><span class=\"p\">],</span> <span class=\"p\">(</span><span class=\"na\">backend</span><span class=\"p\">:</span> <span class=\"nx\">MockBackend</span> <span class=\"p\">,</span> <span class=\"na\">service</span><span class=\"p\">:</span> <span class=\"nx\">MessageService</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// HTTP通信のモックで返す具体的な値の設定</span>\n      <span class=\"nx\">backend</span><span class=\"p\">.</span><span class=\"nx\">connections</span><span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">conn</span><span class=\"p\">:</span> <span class=\"nx\">MockConnection</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"kd\">const</span> <span class=\"nx\">body</span> <span class=\"o\">=</span>  <span class=\"p\">{</span>\n          <span class=\"na\">title</span> <span class=\"p\">:</span> <span class=\"s1\">'エラーが発生しました。'</span><span class=\"p\">,</span>\n          <span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"s1\">'エラー'</span>\n        <span class=\"p\">};</span>\n\n        <span class=\"kd\">const</span> <span class=\"nx\">ops</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ResponseOptions</span><span class=\"p\">({</span>\n          <span class=\"na\">status</span><span class=\"p\">:</span> <span class=\"mi\">500</span><span class=\"p\">,</span>\n          <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">)</span>\n        <span class=\"p\">});</span>\n\n        <span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">mockError</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">MockError</span><span class=\"p\">(</span><span class=\"nx\">ops</span><span class=\"p\">));</span>\n      <span class=\"p\">});</span>\n\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// リクエストの内容を検証</span>\n      <span class=\"nx\">backend</span><span class=\"p\">.</span><span class=\"nx\">connections</span><span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">conn</span><span class=\"p\">:</span> <span class=\"nx\">MockConnection</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">url</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">);</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">conn</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">method</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"nx\">RequestMethod</span><span class=\"p\">.</span><span class=\"nx\">Get</span><span class=\"p\">);</span>\n      <span class=\"p\">});</span>\n\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// レスポンスの内容を検証</span>\n      <span class=\"nx\">service</span><span class=\"p\">.</span><span class=\"nx\">getAll</span><span class=\"p\">().</span><span class=\"nx\">subscribe</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">fail</span><span class=\"p\">(</span><span class=\"s1\">'エラーハンドリングされなかった。'</span><span class=\"p\">);</span>\n      <span class=\"p\">},</span> <span class=\"nx\">res</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">({</span>\n          <span class=\"na\">title</span> <span class=\"p\">:</span> <span class=\"s1\">'エラーが発生しました。'</span><span class=\"p\">,</span>\n          <span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"s1\">'エラー'</span>\n        <span class=\"p\">});</span>\n      <span class=\"p\">});</span>\n    <span class=\"p\">})));</span>\n\n  <span class=\"p\">});</span>\n\n\n<span class=\"p\">});</span>\n</pre></div>\n</div>\n\n<h3>\n<span id=\"3-サーバ側を作成\" class=\"fragment\"></span><a href=\"#3-%E3%82%B5%E3%83%BC%E3%83%90%E5%81%B4%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>3. サーバ側を作成</h3>\n\n<p>プロジェクトの直下にserver_testディレクトリを作ってテストコードを書いていきます。<br>\nどちらかというと結合テストよりで、１つ１つの資産に対してではなくapp.tsに対して、実際にDBに接続しながらAPIテストを行います。規模が小さい場合はコレで充分だと思います。<br>\nまたExpressのテストフレームワークは<a href=\"https://mochajs.org/\" rel=\"nofollow noopener\" target=\"_blank\">Mocha</a>が一般的ですが、クライアント側と統一したいので、今回は<a href=\"https://jasmine.github.io/\" rel=\"nofollow noopener\" target=\"_blank\">Jasmine</a>を使うことにします。</p>\n\n<h4>\n<span id=\"server_testappspects一部抜粋\" class=\"fragment\"></span><a href=\"#server_testappspects%E4%B8%80%E9%83%A8%E6%8A%9C%E7%B2%8B\"><i class=\"fa fa-link\"></i></a>server_test/app.spec.ts(一部抜粋)</h4>\n\n<p>ポイントとしてはテスト実行前にMessageモデルを使ってDBを初期化していることです。<br>\nそれによりテストデータがテストメソッドごとに想定する形になるようにしています。<br>\n異常時のテストは、Messsageのfindメソッドでエラーが発生するようにJasmineの<code>spyOn</code>メソッドで処理を置き換えます。<br>\n全て載せると冗長なのでメッセージ登録のテストは割愛しています。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.spec.ts(一部抜粋)</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">supertest</span> <span class=\"k\">from</span> <span class=\"s1\">'supertest'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"nx\">app</span> <span class=\"k\">from</span> <span class=\"s1\">'../server/app'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Message</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'../server/models/message'</span><span class=\"p\">;</span>\n\n\n<span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nx\">supertest</span><span class=\"p\">(</span><span class=\"nx\">app</span><span class=\"p\">);</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">endpoint</span> <span class=\"o\">=</span> <span class=\"s1\">'/api/messages'</span><span class=\"p\">;</span>\n\n  <span class=\"kd\">const</span> <span class=\"nx\">messageAscending</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">m1</span><span class=\"p\">,</span> <span class=\"nx\">m2</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">m1</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">&gt;</span> <span class=\"nx\">m2</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">m1</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">&lt;</span> <span class=\"nx\">m2</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n  <span class=\"p\">};</span>\n\n  <span class=\"c1\">// テスト前にDBのmessagesを初期化する</span>\n  <span class=\"nx\">beforeEach</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">Message</span><span class=\"p\">.</span><span class=\"nx\">remove</span><span class=\"p\">({},</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{});</span>\n  <span class=\"p\">});</span>\n\n\n  <span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'Get'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n    <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'レスポンスがjson形式でステータスコードが200か'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n<span class=\"err\">　　　　　　　　　　　　　</span><span class=\"c1\">// リクエストを投げる</span>\n      <span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">endpoint</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nx\">expect</span><span class=\"p\">((</span><span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n<span class=\"err\">　　　　　　　　　　　　　　　　　　　　</span><span class=\"c1\">// 検証</span>\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">type</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'application/json'</span><span class=\"p\">);</span>\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">);</span>\n        <span class=\"p\">}).</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">);</span>\n    <span class=\"p\">});</span>\n\n\n    <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'メッセージ一覧が取得できるか'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n      <span class=\"kd\">const</span> <span class=\"nx\">testData</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ１'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ２'</span> <span class=\"p\">},</span>\n        <span class=\"p\">{</span> <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"s1\">'テスト用メッセージ３'</span> <span class=\"p\">},</span>\n      <span class=\"p\">];</span>\n<span class=\"err\">　　　　　　　　　　　　</span>\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// 事前準備（テストデータを作成）</span>\n      <span class=\"nx\">Message</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">testData</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">erro</span> <span class=\"p\">,</span> <span class=\"nx\">doc</span> <span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n<span class=\"err\">　　　　　　　　　　　　　　　　　</span><span class=\"c1\">// リクエストを投げる</span>\n        <span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">endpoint</span><span class=\"p\">)</span>\n          <span class=\"p\">.</span><span class=\"nx\">expect</span><span class=\"p\">((</span><span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n<span class=\"err\">　　　　　　　　　　　　　　　　　　　　　　　　</span>\n<span class=\"err\">　　　　　　　　　　　　　　　　　　　　　　　　</span><span class=\"c1\">// 検証</span>\n            <span class=\"kd\">const</span> <span class=\"nx\">sortedMessages</span> <span class=\"o\">=</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">messages</span><span class=\"p\">.</span><span class=\"nx\">sort</span><span class=\"p\">(</span><span class=\"nx\">messageAscending</span><span class=\"p\">);</span>\n\n            <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">sortedMessages</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">);</span>\n            <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">sortedMessages</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">message</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ１'</span><span class=\"p\">);</span>\n            <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">sortedMessages</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">].</span><span class=\"nx\">message</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ２'</span><span class=\"p\">);</span>\n            <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">sortedMessages</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">].</span><span class=\"nx\">message</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'テスト用メッセージ３'</span><span class=\"p\">);</span>\n          <span class=\"p\">})</span>\n          <span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">);</span>\n      <span class=\"p\">});</span>\n    <span class=\"p\">});</span>\n\n\n    <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'異常時にエラーハンドリングされるか'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n      <span class=\"c1\">// エラーとなるようにMessageのfindメソッドを置き換える</span>\n      <span class=\"nx\">spyOn</span><span class=\"p\">(</span><span class=\"nx\">Message</span><span class=\"p\">,</span> <span class=\"s1\">'find'</span><span class=\"p\">).</span><span class=\"nx\">and</span><span class=\"p\">.</span><span class=\"nx\">callFake</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">callback</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nx\">callback</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Error</span><span class=\"p\">(</span><span class=\"s1\">'エラー'</span><span class=\"p\">),</span> <span class=\"kc\">null</span><span class=\"p\">);</span>\n      <span class=\"p\">});</span>\n<span class=\"err\">　　　　　　　　　　　　　</span>\n<span class=\"err\">　　　　　　　　　　　　</span><span class=\"c1\">// リクエストを投げる</span>\n      <span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"nx\">endpoint</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nx\">expect</span><span class=\"p\">((</span><span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n\n          <span class=\"c1\">// 検証</span>\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">type</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'application/json'</span><span class=\"p\">);</span>\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"mi\">500</span><span class=\"p\">);</span>\n\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">title</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'エラーが発生しました。'</span><span class=\"p\">);</span>\n          <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'エラー'</span><span class=\"p\">);</span>\n        <span class=\"p\">})</span>\n        <span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">done</span><span class=\"p\">);</span>\n    <span class=\"p\">});</span>\n\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n</pre></div>\n</div>\n\n<h3>\n<span id=\"4-単体テスト周りの環境を整備\" class=\"fragment\"></span><a href=\"#4-%E5%8D%98%E4%BD%93%E3%83%86%E3%82%B9%E3%83%88%E5%91%A8%E3%82%8A%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E5%82%99\"><i class=\"fa fa-link\"></i></a>4. 単体テスト周りの環境を整備</h3>\n\n<p>E2Eの説明に入る前に、いったん単体テスト周りの環境を整備します。</p>\n\n<h4>\n<span id=\"packagejson\" class=\"fragment\"></span><a href=\"#packagejson\"><i class=\"fa fa-link\"></i></a>package.json</h4>\n\n<p><a href=\"http://qiita.com/Takumon/items/572438809384e2e11792#pakcagejson\" id=\"reference-fc6741a6eda3b7ffd9f1\">前回</a>作成したものをベースに単体テストのスクリプトを追加してください。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">package.json</span></div>\n<div class=\"highlight\"><pre><span class=\"w\"> </span><span class=\"s2\">\"scripts\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n    </span><span class=\"s2\">\"test\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"run-p test:*\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"test:client\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"ng test\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"test:server\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"npm-run-all -s build:server_test -p watch:server_test  boot:server_test\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"watch:server_test\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"tsc -w -p ./server_test/tsconfig.server_test.json\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"boot:server_test\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"nodemon ./dist/server_test/test.server.js\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"build:server_test\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"tsc -p ./server/tsconfig.server.json\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n  </span><span class=\"p\">},</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<ul>\n<li>\n<strong>test</strong>でクライアント側とサーバ側のテストを実行します。</li>\n<li>\n<strong>test:client</strong>でクライアント側のテストを実行します。Angular CLIのngコマンドにお任せしています。</li>\n<li>\n<strong>watch:server_test</strong>でサーバ側テスト資産をウォッチして変更があればコンパイルするようにします。</li>\n<li>\n<strong>boot:server_test</strong>でコンパイルしたサーバ側テスト資産を起動します。nodeではなくnodemonを使うことで資産に更新があった場合でも即座に反映するようにしています。</li>\n<li>\n<strong>build:server_test</strong>でサーバ側テスト資産をコンパイルします。コンパイル時の設定は下で触れるserver_test/test.server.conf.tsを使います。</li>\n</ul>\n\n<h4>\n<span id=\"server_testtestserverts\" class=\"fragment\"></span><a href=\"#server_testtestserverts\"><i class=\"fa fa-link\"></i></a>server_test/test.server.ts</h4>\n\n<p>サーバ側テストの起動処理を書きます。<br>\nレポーターには<a href=\"https://www.npmjs.com/package/jasmine-spec-reporter\" rel=\"nofollow noopener\" target=\"_blank\">jasmine-spec-reporter</a>を使いましょう。このライブラリはAngular CLIで作ったプロジェクトにはデフォルトでインストール済みです。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">test.server.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">SpecReporter</span><span class=\"p\">,</span> <span class=\"nx\">DisplayProcessor</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'jasmine-spec-reporter'</span><span class=\"p\">;</span>\n<span class=\"kd\">const</span> <span class=\"nx\">Jasmine</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'jasmine'</span><span class=\"p\">);</span>\n<span class=\"k\">import</span> <span class=\"nx\">SuiteInfo</span> <span class=\"o\">=</span> <span class=\"nx\">jasmine</span><span class=\"p\">.</span><span class=\"nx\">SuiteInfo</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">config</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./test.server.conf'</span><span class=\"p\">;</span>\n\n\n<span class=\"kd\">class</span> <span class=\"nx\">CustomProcessor</span> <span class=\"kd\">extends</span> <span class=\"nx\">DisplayProcessor</span> <span class=\"p\">{</span>\n    <span class=\"kr\">public</span> <span class=\"nx\">displayJasmineStarted</span><span class=\"p\">(</span><span class=\"nx\">info</span><span class=\"p\">:</span> <span class=\"nx\">SuiteInfo</span><span class=\"p\">,</span> <span class=\"nx\">log</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">):</span> <span class=\"nx\">string</span> <span class=\"p\">{</span>\n        <span class=\"k\">return</span> <span class=\"s2\">`TypeScript </span><span class=\"p\">${</span><span class=\"nx\">log</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">runner</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Jasmine</span><span class=\"p\">();</span>\n<span class=\"nx\">runner</span><span class=\"p\">.</span><span class=\"nx\">loadConfig</span><span class=\"p\">(</span><span class=\"nx\">config</span><span class=\"p\">);</span>\n<span class=\"nx\">runner</span><span class=\"p\">.</span><span class=\"nx\">addReporter</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">SpecReporter</span><span class=\"p\">({</span>\n    <span class=\"na\">customProcessors</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">CustomProcessor</span><span class=\"p\">],</span>\n<span class=\"p\">}));</span>\n<span class=\"nx\">runner</span><span class=\"p\">.</span><span class=\"nx\">onComplete</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">passed</span><span class=\"p\">){</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span> <span class=\"nx\">passed</span> <span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">'Success'</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"s1\">'Failed'</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">runner</span><span class=\"p\">.</span><span class=\"nx\">execute</span><span class=\"p\">();</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"server_testtestserverconfts\" class=\"fragment\"></span><a href=\"#server_testtestserverconfts\"><i class=\"fa fa-link\"></i></a>server_test/test.server.conf.ts</h4>\n\n<p>サーバ側テスト起動時の設定です。<br>\n注意点として<code>spec_files</code>に指定する相対パスはプロジェクト直下が起点になります。そのため<code>__dirname</code>を使って指定してください。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">test.server.conf.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">config</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"na\">spec_dir</span><span class=\"p\">:</span> <span class=\"s1\">'.'</span><span class=\"p\">,</span>\n  <span class=\"na\">spec_files</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"s2\">`</span><span class=\"p\">${</span><span class=\"nx\">__dirname</span><span class=\"p\">}</span><span class=\"s2\">/*spec.js`</span>\n  <span class=\"p\">],</span>\n  <span class=\"s1\">'stopSpecOnExpectationFailure'</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n  <span class=\"s1\">'random'</span><span class=\"p\">:</span> <span class=\"kc\">false</span>\n<span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"server_testtsconfigserver_testjson\" class=\"fragment\"></span><a href=\"#server_testtsconfigserver_testjson\"><i class=\"fa fa-link\"></i></a>server_test/tsconfig.server_test.json</h4>\n\n<p>サーバ側テスト資産をコンパイルする時の設定ファイルです。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">tsconfig.server_test.json</span></div>\n<div class=\"highlight\"><pre><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"s2\">\"extends\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../tsconfig.json\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"compilerOptions\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"s2\">\"preserveConstEnums\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"outDir\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../dist\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"mapRoot\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../dist\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"module\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"commonjs\"</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"include\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n    </span><span class=\"s2\">\"**/*.spec.ts\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"./test.server.ts\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"./test.server.conf.ts\"</span><span class=\"w\">\n  </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<p><code>outDir</code>が<code>../dist/server_test</code>ではなく<code>../dist</code>であることに注意してください。<br>\nテスト資産は<code>server</code>ディレクトリ配下の資産に依存しているため、<code>../dist/server_test</code>を指定するとコンパイルした時に下記のように出力されてしまいます。</p>\n\n<div class=\"code-frame\" data-lang=\"\">\n<div class=\"code-lang\"><span class=\"bold\">（悪い例）outDirに\"../dist/server_test\"を指定したときのコンパイル結果</span></div>\n<div class=\"highlight\"><pre>.\n└── dist\n    └── server_test\n        ├── server\n        └── server_test \n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"\">\n<div class=\"code-lang\"><span class=\"bold\">（良い例）outDirに\"../dist\"を指定したときのコンパイル結果</span></div>\n<div class=\"highlight\"><pre>.\n└── dist\n    ├── server\n    └── server_test \n</pre></div>\n</div>\n\n<h3>\n<span id=\"5-e2eテストを作成\" class=\"fragment\"></span><a href=\"#5-e2e%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>5. E2Eテストを作成</h3>\n\n<p>単体テストを作成したので次はE2Eテストを作りましょう。<br>\nAngular CLIで作成したプロジェクトにデフォルトで用意されている<a href=\"http://www.protractortest.org/#/\" rel=\"nofollow noopener\" target=\"_blank\">Protractor</a>を使ったテストコードを作成します。</p>\n\n<h4>\n<span id=\"e2eappe2e-spects\" class=\"fragment\"></span><a href=\"#e2eappe2e-spects\"><i class=\"fa fa-link\"></i></a>e2e/app.e2e-spec.ts</h4>\n\n<p>基本的にelementメソッドで要素を取得して、sendKeysメソッドやclickメソッドで操作を行います。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.e2e-spec.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Angular4Express4Typescritp2Page</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./app.po'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">browser</span><span class=\"p\">,</span> <span class=\"nx\">element</span><span class=\"p\">,</span> <span class=\"nx\">by</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'protractor'</span><span class=\"p\">;</span>\n\n\n<span class=\"nx\">describe</span><span class=\"p\">(</span><span class=\"s1\">'E2Eテスト'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"kd\">let</span> <span class=\"na\">page</span><span class=\"p\">:</span> <span class=\"nx\">Angular4Express4Typescritp2Page</span><span class=\"p\">;</span>\n\n  <span class=\"nx\">beforeEach</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">page</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Angular4Express4Typescritp2Page</span><span class=\"p\">();</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'画面タイトルが正しいか'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nx\">navigateTo</span><span class=\"p\">();</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nx\">getParagraphText</span><span class=\"p\">()).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">'メッセージ一覧'</span><span class=\"p\">);</span>\n  <span class=\"p\">});</span>\n\n\n  <span class=\"nx\">it</span><span class=\"p\">(</span><span class=\"s1\">'メッセージが登録できるか'</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nx\">navigateTo</span><span class=\"p\">();</span>\n    <span class=\"kd\">const</span> <span class=\"nx\">newMessage</span> <span class=\"o\">=</span> <span class=\"s2\">`サンプルメッセージ </span><span class=\"p\">${</span><span class=\"k\">new</span> <span class=\"nb\">Date</span><span class=\"p\">().</span><span class=\"nx\">toString</span><span class=\"p\">()}</span><span class=\"s2\">`</span><span class=\"p\">;</span>\n    <span class=\"nx\">element</span><span class=\"p\">(</span><span class=\"nx\">by</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">(</span><span class=\"s1\">'registerMessage'</span><span class=\"p\">)).</span><span class=\"nx\">sendKeys</span><span class=\"p\">(</span><span class=\"nx\">newMessage</span><span class=\"p\">);</span>\n\n    <span class=\"nx\">element</span><span class=\"p\">(</span><span class=\"nx\">by</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">(</span><span class=\"s1\">'registerMessageButton'</span><span class=\"p\">)).</span><span class=\"nx\">click</span><span class=\"p\">();</span>\n\n    <span class=\"c1\">// 登録後メッセージ入力項目が初期化されているか</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">element</span><span class=\"p\">(</span><span class=\"nx\">by</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">(</span><span class=\"s1\">'registerMessage'</span><span class=\"p\">)).</span><span class=\"nx\">getText</span><span class=\"p\">()).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">);</span>\n\n    <span class=\"c1\">// 登録後一覧に登録したメッセージが含まれているか</span>\n    <span class=\"kd\">const</span> <span class=\"nx\">messages</span> <span class=\"o\">=</span> <span class=\"nx\">element</span><span class=\"p\">(</span><span class=\"nx\">by</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">(</span><span class=\"s1\">'messageList'</span><span class=\"p\">)).</span><span class=\"nx\">all</span><span class=\"p\">(</span><span class=\"nx\">by</span><span class=\"p\">.</span><span class=\"nx\">tagName</span><span class=\"p\">(</span><span class=\"s1\">'li'</span><span class=\"p\">));</span>\n    <span class=\"nx\">expect</span><span class=\"p\">(</span><span class=\"nx\">messages</span><span class=\"p\">.</span><span class=\"nx\">last</span><span class=\"p\">().</span><span class=\"nx\">getText</span><span class=\"p\">()).</span><span class=\"nx\">toEqual</span><span class=\"p\">(</span><span class=\"nx\">newMessage</span><span class=\"p\">);</span>\n  <span class=\"p\">});</span>\n\n<span class=\"p\">});</span>\n</pre></div>\n</div>\n\n<h3>\n<span id=\"6-e2eテスト周りの環境を整備\" class=\"fragment\"></span><a href=\"#6-e2e%E3%83%86%E3%82%B9%E3%83%88%E5%91%A8%E3%82%8A%E3%81%AE%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E5%82%99\"><i class=\"fa fa-link\"></i></a>6. E2Eテスト周りの環境を整備</h3>\n\n<h4>\n<span id=\"packagejson-1\" class=\"fragment\"></span><a href=\"#packagejson-1\"><i class=\"fa fa-link\"></i></a>package.json</h4>\n\n<p>Angular CILプロジェクトデフォルトの\"e2e\"コマンドは削除して、スクリプトに下記を追加してください。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">package.json</span></div>\n<div class=\"highlight\"><pre><span class=\"w\"> </span><span class=\"s2\">\"scripts\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n    </span><span class=\"s2\">\"e2e\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"npm-run-all -s  webdriver:update -p webdriver:start protractor\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"webdriver:update\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"webdriver-manager update\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"webdriver:start\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"webdriver-manager start\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"protractor\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"protractor protractor.conf.js\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n  </span><span class=\"p\">},</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<ul>\n<li>\n<strong>e2e</strong>でE2Eテストを実行します。Angular CILプロジェクトデフォルトの<code>e2e</code>コマンド(= <code>ng e2e</code>コマンド)は使いません。<code>ng　e2e</code>はクライアント資産だけコンパイルして起動する処理が入っているからです。今回はビルドしたアプリ(クライアントとサーバが１つにまとまったアプリ)に対してテストします。</li>\n<li>\n<strong>webdriver:update</strong>でE2Eテストに必要なWebDriverをインストールまたは更新します。</li>\n<li>\n<strong>webdriver:start</strong>でWebDriverを起動します。Protractorのテストは事前にWebDriverを起動しておく必要があります。</li>\n<li>\n<strong>protractor</strong>でE2Eテストを実行します。起動時の設定は下で触れるprotractor.conf.jsを使います。</li>\n</ul>\n\n<h4>\n<span id=\"protractorconfjs\" class=\"fragment\"></span><a href=\"#protractorconfjs\"><i class=\"fa fa-link\"></i></a>protractor.conf.js</h4>\n\n<p>デフォルトでbaseUrlのポートは4200になっていますが、今回はビルドしたアプリに対してテストするので3000を指定します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">protractor.conf.js</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">exports</span><span class=\"p\">.</span><span class=\"nx\">config</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"p\">...</span>\n  <span class=\"na\">baseUrl</span><span class=\"p\">:</span> <span class=\"s1\">'http://localhost:3000/'</span><span class=\"p\">,</span>\n  <span class=\"p\">...</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<h3>\n<span id=\"7-試してみる\" class=\"fragment\"></span><a href=\"#7-%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>7. 試してみる</h3>\n\n<h4>\n<span id=\"単体テストを実行してみる\" class=\"fragment\"></span><a href=\"#%E5%8D%98%E4%BD%93%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>単体テストを実行してみる</h4>\n\n<ul>\n<li>\n<p>MongoDBをローカルで立ち上げる</p>\n\n<ul>\n<li>具体的な方法について触れませんが、Dockerでもなんでもいいのでローカルにポート27017でMongoDBを立ち上げておいてください。DB、テーブルの作成などは不要です。</li>\n</ul>\n</li>\n<li><p>プロジェクト直下で<code>npm test</code>コマンドを実行するとテストが実行されます。クライアント側のテスト結果はブラウザに、サーバ側はターミナル（またはコンソール）に表示されます。資産はウォッチしているので、テストコードを修正すると、コンパイルされ再度テストが実行されるでしょう。</p></li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/7f33351fc11e7394a52bb31fa317136827ea0735/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36343161363631662d333632342d633466312d333733662d6362343331393330346530322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/7f33351fc11e7394a52bb31fa317136827ea0735/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36343161363631662d333632342d633466312d333733662d6362343331393330346530322e706e67\" alt=\"10_単体テスト実施イメージ.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/641a661f-3624-c4f1-373f-cb4319304e02.png\"></a></p>\n\n<h4>\n<span id=\"e2eテストを実行してみる\" class=\"fragment\"></span><a href=\"#e2e%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>E2Eテストを実行してみる</h4>\n\n<ul>\n<li>\n<p>MongoDBをローカルで立ち上げる</p>\n\n<ul>\n<li>これも単体テストと同じでDBを事前に起動しておいてください。</li>\n</ul>\n</li>\n<li>\n<p>ビルドしたアプリを起動する</p>\n\n<ul>\n<li>プロジェクト直下で<code>npm run buildRun</code>を実行し、ビルド資産を起動します。</li>\n</ul>\n</li>\n<li>\n<p><code>npm run e2e</code>する</p>\n\n<ul>\n<li>別ターミナル（またはコマンドプロンプト）を開き、プロジェクト直下で<code>npm run e2e</code>コマンドを実行します。するとブラウザが立ち上がりテストが実行されます。\n<a href=\"https://camo.qiitausercontent.com/7ed95d4b7e245fbb593b4c8c2895d30013489715/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35616438346136612d306538652d613830622d633763352d3533386237306161393235392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/7ed95d4b7e245fbb593b4c8c2895d30013489715/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35616438346136612d306538652d613830622d633763352d3533386237306161393235392e706e67\" alt=\"20_E2Eテスト実施イメージ.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/5ad84a6a-0e8e-a80b-c7c5-538b70aa9259.png\"></a>\n</li>\n</ul>\n</li>\n</ul>\n\n<h2>\n<span id=\"終わりに\" class=\"fragment\"></span><a href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"><i class=\"fa fa-link\"></i></a>終わりに</h2>\n\n<p>今回はMEANスタックアプリの単体テスト、E2Eテストについて紹介しました。<br>\nこれでビルドとテストができるようになったので、次回「その3. Dockerデプロイ編」では、Dockerでアプリを起動する方法とDockerでアプリのイメージを作ってデプロイする方法ついて紹介します。</p>\n","headings":[{"id":"やりたいこと","value":"やりたいこと","depth":2,"parents":[]},{"id":"その２-テスト編","value":"その２. テスト編","depth":2,"parents":[]},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3,"parents":[{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"各資産について","value":"各資産について","depth":4,"parents":[{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"1-dist","value":"(1) dist","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"1-1-distserver_test","value":"(1-1) dist/server_test","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"2-server_test","value":"(2) server_test","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"3-e2e","value":"(3) e2e","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"4-srcapp配下のspectsファイル","value":"(4) src/app配下のspec.tsファイル","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"5-protractorconfjs","value":"(5) protractor.conf.js","depth":5,"parents":[{"id":"各資産について","value":"各資産について","depth":4},{"id":"プロジェクト構成","value":"プロジェクト構成","depth":3},{"id":"その２-テスト編","value":"その２. テスト編","depth":2}]},{"id":"構築手順","value":"構築手順","depth":2,"parents":[]},{"id":"1-テストに必要なライブラリをインストール","value":"1. テストに必要なライブラリをインストール","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"2-クライアント側を作成","value":"2. クライアント側を作成","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"srcappappcomponentspects","value":"src/app/app.component.spec.ts","depth":4,"parents":[{"id":"2-クライアント側を作成","value":"2. クライアント側を作成","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"srcappmessagemessageservicespects一部抜粋","value":"src/app/message/message.service.spec.ts(一部抜粋)","depth":4,"parents":[{"id":"2-クライアント側を作成","value":"2. クライアント側を作成","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"3-サーバ側を作成","value":"3. サーバ側を作成","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"server_testappspects一部抜粋","value":"server_test/app.spec.ts(一部抜粋)","depth":4,"parents":[{"id":"3-サーバ側を作成","value":"3. サーバ側を作成","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"4-単体テスト周りの環境を整備","value":"4. 単体テスト周りの環境を整備","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"packagejson","value":"package.json","depth":4,"parents":[{"id":"4-単体テスト周りの環境を整備","value":"4. 単体テスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"server_testtestserverts","value":"server_test/test.server.ts","depth":4,"parents":[{"id":"4-単体テスト周りの環境を整備","value":"4. 単体テスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"server_testtestserverconfts","value":"server_test/test.server.conf.ts","depth":4,"parents":[{"id":"4-単体テスト周りの環境を整備","value":"4. 単体テスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"server_testtsconfigserver_testjson","value":"server_test/tsconfig.server_test.json","depth":4,"parents":[{"id":"4-単体テスト周りの環境を整備","value":"4. 単体テスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"5-e2eテストを作成","value":"5. E2Eテストを作成","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"e2eappe2e-spects","value":"e2e/app.e2e-spec.ts","depth":4,"parents":[{"id":"5-e2eテストを作成","value":"5. E2Eテストを作成","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"6-e2eテスト周りの環境を整備","value":"6. E2Eテスト周りの環境を整備","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"packagejson-1","value":"package.json","depth":4,"parents":[{"id":"6-e2eテスト周りの環境を整備","value":"6. E2Eテスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"protractorconfjs","value":"protractor.conf.js","depth":4,"parents":[{"id":"6-e2eテスト周りの環境を整備","value":"6. E2Eテスト周りの環境を整備","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"7-試してみる","value":"7. 試してみる","depth":3,"parents":[{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"単体テストを実行してみる","value":"単体テストを実行してみる","depth":4,"parents":[{"id":"7-試してみる","value":"7. 試してみる","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"e2eテストを実行してみる","value":"E2Eテストを実行してみる","depth":4,"parents":[{"id":"7-試してみる","value":"7. 試してみる","depth":3},{"id":"構築手順","value":"構築手順","depth":2}]},{"id":"終わりに","value":"終わりに","depth":2,"parents":[]}],"fields":{"title":"Angular4 + Express4 + MongoDB3 + TypeScript2 の最小構成プロジェクトをAngular CLIベースで構築する。(ビルド、テスト、Dockerデプロイまで)　その２. テスト編","excerpt":"やりたいことAngular CLI使って、MEANスタック(MongoDB + Express + Angular + NodeJS)のアプリを作りたい。どうせならサーバ側もTypeScriptで作りたい。フロント側とサーバ側の両方をweb...","date":"2017-07-24T07:12:10+09:00","tags":["JavaScript","jasmine","TypeScript","AngularJS","Protractor","Qiita"]},"user":{"id":"Takumon","profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/49915/profile-images/1488080194","description":"JavaのSIer. 趣味はJavaScript. \r\n週1でブログ更新してます. https://takumon.com/\r\n最近はGatsbyJS,Nuxt.js,GraphQLなどなど."}}},"pageContext":{"slug":"/5644c24e-eade-50ca-aa11-83a4eaeba122/","previous":{"fields":{"slug":"/bb5bc899-9dfd-5e67-bc4c-bc422ba8d176/","title":"Angular4 + Express4 + MongoDB3 + TypeScript2 の最小構成プロジェクトをAngular CLIベースで構築する。(ビルド、テスト、Dockerデプロイまで)　その１. ビルド編","date":"2017-07-19T02:06:59+09:00","excerpt":"やりたいことAngular CLI使って、MEANスタック(MongoDB + Express + Angular + NodeJS)のアプリを作りたい。どうせならサーバ側もTypeScriptで作りたい。フロント側とサーバ側の両方をweb...","tags":["JavaScript","MongoDB","Express","TypeScript","AngularJS","Qiita"]},"id":"bb5bc899-9dfd-5e67-bc4c-bc422ba8d176","title":"Angular4 + Express4 + MongoDB3 + TypeScript2 の最小構成プロジェクトをAngular CLIベースで構築する。(ビルド、テスト、Dockerデプロイまで)　その１. ビルド編","rendered_body":"\n<h2>\n<span id=\"やりたいこと\" class=\"fragment\"></span><a href=\"#%E3%82%84%E3%82%8A%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>やりたいこと</h2>\n\n<ul>\n<li>Angular CLI使って、MEANスタック(<strong>M</strong>ongoDB + <strong>E</strong>xpress + <strong>A</strong>ngular + <strong>N</strong>odeJS)のアプリを作りたい。どうせならサーバ側もTypeScriptで作りたい。</li>\n<li>フロント側とサーバ側の両方をwebpack、gulpなどは使わずにnpm scriptsだけでビルド、テストできるようにしたい。</li>\n<li>Dockerを使ってアプリを簡単に配布したい。</li>\n</ul>\n\n<p>これらを達成するための最小構成プロジェクトの作り方を３回に分けて紹介します。</p>\n\n<ul>\n<li>その１. ビルド編　⇦　今回はココ</li>\n<li><a href=\"http://qiita.com/Takumon/items/b4211fcabad740baa551\" id=\"reference-b35cd1a7f8ba1daaecd8\">その２. テスト編</a></li>\n<li>その３. Dockerビルド編</li>\n</ul>\n\n<h2>\n<span id=\"その１-ビルド編\" class=\"fragment\"></span><a href=\"#%E3%81%9D%E3%81%AE%EF%BC%91-%E3%83%93%E3%83%AB%E3%83%89%E7%B7%A8\"><i class=\"fa fa-link\"></i></a>その１. ビルド編</h2>\n\n<p>Angular CLIで作成したプロジェクトをベースに、<br>\nMongoDBに登録したメッセージを画面に一覧で表示するアプリを作成していきます。<br>\nメッセージを登録すると一覧に追加されていくようなアプリです。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/69f548fea654db9cdc39f80b3ff36129a4e0be22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33303138373561362d313131362d363066332d313161392d6466366562353566353463322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/69f548fea654db9cdc39f80b3ff36129a4e0be22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33303138373561362d313131362d363066332d313161392d6466366562353566353463322e706e67\" alt=\"アプリ概要.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/301875a6-1116-60f3-11a9-df6eb55f54c2.png\"></a></p>\n\n<h3>\n<span id=\"プロジェクト構成\" class=\"fragment\"></span><a href=\"#%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E6%A7%8B%E6%88%90\"><i class=\"fa fa-link\"></i></a>プロジェクト構成</h3>\n\n<p>今回のチュートリアル終了すると下記のようなプロジェクトの構成になります。<br>\n<a href=\"https://github.com/Takumon/angular4-express4-typescritp2/tree/build\" rel=\"nofollow noopener\" target=\"_blank\">リポジトリ</a>も用意しているので詳細はそちらを参照してください。</p>\n\n<div class=\"code-frame\" data-lang=\"\">\n<div class=\"code-lang\"><span class=\"bold\">プロジェクトの構成（完成イメージ）</span></div>\n<div class=\"highlight\"><pre>.\n├── dist                ・・・(1) コンパイル資産出力先\n│   └── server　　　　　　　　      ・・・(1-1)　コンパイルされたサーバ資産\n│       ├── app.js\n│       ├── app.js.map\n│       ├── bin\n│       │   ├── www.js\n│       │   └── www.js.map\n│       ├── config.js\n│       ├── config.js.map\n│       ├── models\n│       │   ├── message.js\n│       │   └── message.js.map\n│       ├── public      ・・・(1-2) コンパイルされたクライアント資産\n│       │   ├── favicon.ico\n│       │   ├── index.html\n│       │   ├── inline.bundle.js\n│       │   ├── inline.bundle.js.map\n│       │   ├── main.bundle.js\n│       │   ├── main.bundle.js.map\n│       │   ├── polyfills.bundle.js\n│       │   ├── polyfills.bundle.js.map\n│       │   ├── styles.bundle.js\n│       │   ├── styles.bundle.js.map\n│       │   ├── vendor.bundle.js\n│       │   └── vendor.bundle.js.map\n│       └── routes\n│           ├── message.js\n│           └── message.js.map\n├── node_modules\n│   ├── ...\n│   ...\n│\n├── e2e\n│   ├── app.e2e-spec.ts\n│   ├── app.po.ts\n│   └── tsconfig.e2e.json\n├── server               ・・・(2)　サーバ資産\n│   ├── app.ts\n│   ├── bin\n│   │   └── www.ts\n│   ├── config.ts\n│   ├── models\n│   │   └── message.ts\n│   ├── routes\n│   │   └── message.ts\n│   └── tsconfig.server.json\n├── src                   ・・・(3)　クライアント資産\n│   ├── app\n│   │   ├── app.component.css\n│   │   ├── app.component.html\n│   │   ├── app.component.spec.ts\n│   │   ├── app.component.ts\n│   │   ├── app.module.ts\n│   │   └── message\n│   │       └── message.service.ts\n│   ├── assets\n│   ├── environments\n│   │   ├── environment.prod.ts\n│   │   └── environment.ts\n│   ├── favicon.ico\n│   ├── index.html\n│   ├── main.ts\n│   ├── polyfills.ts\n│   ├── styles.css\n│   ├── test.ts\n│   ├── tsconfig.app.json\n│   ├── tsconfig.spec.json\n│   └── typings.d.ts\n├── karma.conf.js\n├── package-lock.json\n├── package.json\n├── protractor.conf.js\n├── proxy.conf.json    ・・・(4) \n├── tsconfig.json\n├── tslint.json\n└── README.md\n</pre></div>\n</div>\n\n<h4>\n<span id=\"各資産について\" class=\"fragment\"></span><a href=\"#%E5%90%84%E8%B3%87%E7%94%A3%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><i class=\"fa fa-link\"></i></a>各資産について</h4>\n\n<h5>\n<span id=\"1-dist\" class=\"fragment\"></span><a href=\"#1-dist\"><i class=\"fa fa-link\"></i></a>(1) dist</h5>\n\n<p>コンパイルした資産の出力先フォルダ</p>\n\n<h5>\n<span id=\"1-1-distserver\" class=\"fragment\"></span><a href=\"#1-1-distserver\"><i class=\"fa fa-link\"></i></a>(1-1) dist/server</h5>\n\n<p>ここにサーバ側のコンパイルされたjsファイルが出力されます。<br>\nserverフォルダを設けているのは本資産とテスト資産を分離したかったからです。<br>\nその２. テスト編で説明しますが、サーバ側テスト用jsファイルはdist配下のserver_testフォルダに出力されるようにしています。</p>\n\n<h5>\n<span id=\"1-2-distserverpublic\" class=\"fragment\"></span><a href=\"#1-2-distserverpublic\"><i class=\"fa fa-link\"></i></a>(1-2) dist/server/public</h5>\n\n<p>コンパイルされたクライアント資産。<br>\nサーバ側アプリの資産の一部としてコンパイルされるようにしています。<br>\nExpressのアプリでは静的資産をpublicフォルダに置くのが一般的なのでこうしました。</p>\n\n<h5>\n<span id=\"2-server\" class=\"fragment\"></span><a href=\"#2-server\"><i class=\"fa fa-link\"></i></a>(2) server</h5>\n\n<p>サーバ資産を格納するためのディレクトリ。<br>\nいろいろ悩みましたが、TypeScript資産をコンパイルすることとテストすることを考慮してこのような構成にしました。</p>\n\n<h5>\n<span id=\"3-src\" class=\"fragment\"></span><a href=\"#3-src\"><i class=\"fa fa-link\"></i></a>(3) src</h5>\n\n<p>フロントの実行資産とテスト資産を格納するためのディレクリ。<br>\nAngular CLIでプロジェクトを作成するとデフォルトで作成されます。<br>\nビルドやアプリ起動は<code>ng</code>コマンドで実施します。</p>\n\n<h5>\n<span id=\"4-proxyconfjson\" class=\"fragment\"></span><a href=\"#4-proxyconfjson\"><i class=\"fa fa-link\"></i></a>(4) proxy.conf.json</h5>\n\n<p><code>npm start</code>でフロント側とサーバ側を同時に起動した時に、クライアント側からサーバ側へのリクエストを送れるようにするためのプロキシ設定です。</p>\n\n<h2>\n<span id=\"構築手順\" class=\"fragment\"></span><a href=\"#%E6%A7%8B%E7%AF%89%E6%89%8B%E9%A0%86\"><i class=\"fa fa-link\"></i></a>構築手順</h2>\n\n<h3>\n<span id=\"1-プロジェクト作成\" class=\"fragment\"></span><a href=\"#1-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>1. プロジェクト作成</h3>\n\n<ul>\n<li>\n<p>Angular CLIをインストール</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ npm install -g @angular/cli\n</pre></div></div>\n</li>\n<li>\n<p>プロジェクトを生成、Angular CLIであらかじめ定義している依存ライブラリをインストール</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ ng new sample\n$ cd sample\n$ npm install\n</pre></div></div>\n</li>\n<li>\n<p>Angular CLIであらかじめ定義している依存ライブラリの他に必要なものををインストール<br>\n</p>\n<dd>\n<br>\n</dd>\n<dt>\n<a href=\"https://www.npmjs.com/package/express\" rel=\"nofollow noopener\" target=\"_blank\"><code>express</code></a><br>\n    </dt>\n<dd>Webアプリケーションフレームワーク<br>\n</dd>\n<dt>\n<a href=\"https://www.npmjs.com/package/body-parser\" rel=\"nofollow noopener\" target=\"_blank\"><code>body-parser</code></a><br>\n    </dt>\n<dd>リクエストボディのパーサー<br>\n</dd>\n<dt>\n<a href=\"https://www.npmjs.com/package/mongoose\" rel=\"nofollow noopener\" target=\"_blank\"><code>mongoose</code></a><br>\n    </dt>\n<dd>MongoDBへのアクセスを簡単にしてくれるAPI<br>\n</dd>\n<dt>\n<a href=\"https://www.npmjs.com/package/nodemon\" rel=\"nofollow noopener\" target=\"_blank\"><code>nodemon</code></a><br>\n    </dt>\n<dd>node実行時にソースの変更を自動反映してくれるツール<br>\n</dd>\n<dt>\n<a href=\"https://www.npmjs.com/package/npm-run-all\" rel=\"nofollow noopener\" target=\"_blank\"><code>npm-run-all</code></a><br>\n    </dt>\n<dd>npm-scripts の連結実行を管理するためのパッケージ<br>\n</dd>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ npm install --save express body-parser mongoose\n$ npm install --save-dev @types/mongoose nodemon npm-run-all\n</pre></div></div>\n</li>\n</ul>\n\n<h3>\n<span id=\"2-サーバ側を作成\" class=\"fragment\"></span><a href=\"#2-%E3%82%B5%E3%83%BC%E3%83%90%E5%81%B4%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>2. サーバ側を作成</h3>\n\n<p>Angular CLIで作ったプロジェクトの直下に<code>server</code>フォルダを作って、その中にサーバ側の処理を書いていきます。</p>\n\n<h4>\n<span id=\"servermodelsmessagets\" class=\"fragment\"></span><a href=\"#servermodelsmessagets\"><i class=\"fa fa-link\"></i></a>server/models/message.ts</h4>\n\n<p>MongoDBにアクセスするためのモデルを定義します。<br>\nDBアクセスにはmangoosを使います。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">message.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">mongoose</span> <span class=\"k\">from</span> <span class=\"s1\">'mongoose'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">Message</span> <span class=\"o\">=</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">model</span><span class=\"p\">(</span><span class=\"s1\">'messages'</span><span class=\"p\">,</span> <span class=\"k\">new</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">({</span>\n  <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"nb\">String</span><span class=\"p\">}</span>\n<span class=\"p\">}));</span>\n\n<span class=\"k\">export</span> <span class=\"p\">{</span> <span class=\"nx\">Message</span> <span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"serverroutesmessagets\" class=\"fragment\"></span><a href=\"#serverroutesmessagets\"><i class=\"fa fa-link\"></i></a>server/routes/message.ts</h4>\n\n<p>エンドポイントごとの処理を記述するルータを定義します。<br>\nメッセージの取得と登録には<code>server/models/message.ts</code>を使います。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">message.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">http</span> <span class=\"k\">from</span> <span class=\"s1\">'http'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Router</span><span class=\"p\">,</span> <span class=\"nx\">Response</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'express'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Message</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'../models/message'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">messageRouter</span><span class=\"p\">:</span> <span class=\"nx\">Router</span> <span class=\"o\">=</span> <span class=\"nx\">Router</span><span class=\"p\">();</span>\n\n<span class=\"c1\">// 全てのメッセージを取得する</span>\n<span class=\"nx\">messageRouter</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"s1\">'/'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">Message</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">,</span> <span class=\"nx\">doc</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">(</span><span class=\"mi\">500</span><span class=\"p\">).</span><span class=\"nx\">json</span><span class=\"p\">({</span>\n          <span class=\"na\">title</span><span class=\"p\">:</span> <span class=\"s1\">'エラーが発生しました。'</span><span class=\"p\">,</span>\n          <span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span>\n      <span class=\"p\">});</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">).</span><span class=\"nx\">json</span><span class=\"p\">({</span><span class=\"na\">messages</span><span class=\"p\">:</span> <span class=\"nx\">doc</span><span class=\"p\">});</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// メッセージを登録する</span>\n<span class=\"nx\">messageRouter</span><span class=\"p\">.</span><span class=\"nx\">post</span><span class=\"p\">(</span><span class=\"s1\">'/'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">message</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Message</span><span class=\"p\">({</span>\n    <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">message</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"nx\">message</span><span class=\"p\">.</span><span class=\"nx\">save</span><span class=\"p\">((</span><span class=\"nx\">err</span><span class=\"p\">,</span> <span class=\"nx\">result</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">(</span><span class=\"mi\">500</span><span class=\"p\">).</span><span class=\"nx\">json</span><span class=\"p\">({</span>\n          <span class=\"na\">title</span><span class=\"p\">:</span> <span class=\"s1\">'エラーが発生しました。'</span><span class=\"p\">,</span>\n          <span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span>\n      <span class=\"p\">});</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">return</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">).</span><span class=\"nx\">json</span><span class=\"p\">({</span>\n      <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"s1\">'メッセージを登録しました。'</span><span class=\"p\">,</span>\n      <span class=\"na\">obj</span><span class=\"p\">:</span> <span class=\"nx\">result</span>\n    <span class=\"p\">});</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n<span class=\"k\">export</span> <span class=\"p\">{</span> <span class=\"nx\">messageRouter</span> <span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"serverappts\" class=\"fragment\"></span><a href=\"#serverappts\"><i class=\"fa fa-link\"></i></a>server/app.ts</h4>\n\n<p>Expressで使用するルータと依存モジュールを定義するためのファイルを作成します。<br>\nメッセージAPIのエンドポイントは<code>/api/messages</code>に設定し、<br>\nmongooseを使ってMongoDBへの接続設定をしています。<br>\nクライアント資産はビルドするとpublicフォルダ配下に出力されるようにしているので、<br>\n静的資産へのルーティングはpublicフォルダを指定しています。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">express</span> <span class=\"k\">from</span> <span class=\"s1\">'express'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">path</span> <span class=\"k\">from</span> <span class=\"s1\">'path'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">bodyParser</span> <span class=\"k\">from</span> <span class=\"s1\">'body-parser'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">mongoose</span> <span class=\"k\">from</span> <span class=\"s1\">'mongoose'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">messageRouter</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./routes/message'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MONGO_URL</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./config'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">class</span> <span class=\"nx\">App</span> <span class=\"p\">{</span>\n  <span class=\"kr\">public</span> <span class=\"nx\">express</span><span class=\"p\">:</span> <span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">Application</span><span class=\"p\">;</span>\n\n  <span class=\"kd\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span> <span class=\"o\">=</span> <span class=\"nx\">express</span><span class=\"p\">();</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">middleware</span><span class=\"p\">();</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">routes</span><span class=\"p\">();</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"kr\">private</span> <span class=\"nx\">middleware</span><span class=\"p\">():</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">bodyParser</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">());</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">bodyParser</span><span class=\"p\">.</span><span class=\"nx\">urlencoded</span><span class=\"p\">({</span> <span class=\"na\">extended</span><span class=\"p\">:</span> <span class=\"kc\">false</span> <span class=\"p\">}));</span>\n    <span class=\"c1\">// 接続する MongoDB の設定</span>\n    <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nb\">Promise</span> <span class=\"o\">=</span> <span class=\"nb\">global</span><span class=\"p\">.</span><span class=\"nb\">Promise</span><span class=\"p\">;</span>\n    <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">connect</span><span class=\"p\">(</span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">MONGO_URL</span> <span class=\"o\">||</span> <span class=\"nx\">MONGO_URL</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n      <span class=\"na\">useMongoClient</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"p\">});</span>\n    <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'SIGINT'</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">disconnect</span><span class=\"p\">();</span> <span class=\"p\">});</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"kr\">private</span> <span class=\"nx\">routes</span><span class=\"p\">():</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// 静的資産へのルーティング</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"kr\">static</span><span class=\"p\">(</span><span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">'public'</span><span class=\"p\">)));</span>\n\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">,</span> <span class=\"nx\">messageRouter</span><span class=\"p\">);</span>\n\n    <span class=\"c1\">// その他のリクエストはindexファイルにルーティング</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"s1\">'*'</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n      <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">sendFile</span><span class=\"p\">(</span><span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">'public/index.html'</span><span class=\"p\">));</span>\n    <span class=\"p\">});</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">export</span> <span class=\"k\">default</span> <span class=\"k\">new</span> <span class=\"nx\">App</span><span class=\"p\">().</span><span class=\"nx\">express</span><span class=\"p\">;</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"serverbinwwwts\" class=\"fragment\"></span><a href=\"#serverbinwwwts\"><i class=\"fa fa-link\"></i></a>server/bin/www.ts</h4>\n\n<p>Node.js でサーバを起動するための設定ファイルを作成します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">www.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">http</span> <span class=\"k\">from</span> <span class=\"s1\">'http'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">SERVER_PORT</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'../config'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"nx\">app</span> <span class=\"k\">from</span> <span class=\"s1\">'../app'</span><span class=\"p\">;</span>\n\n\n\n<span class=\"c1\">// ポートの設定.</span>\n<span class=\"kd\">const</span> <span class=\"nx\">port</span> <span class=\"o\">=</span> <span class=\"nx\">normalizePort</span><span class=\"p\">(</span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">PORT</span> <span class=\"o\">||</span> <span class=\"nx\">SERVER_PORT</span><span class=\"p\">);</span>\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"kd\">set</span><span class=\"p\">(</span><span class=\"s1\">'port'</span><span class=\"p\">,</span> <span class=\"nx\">port</span><span class=\"p\">);</span>\n\n\n<span class=\"c1\">// HTTPサーバ生成.</span>\n<span class=\"kd\">const</span> <span class=\"nx\">server</span> <span class=\"o\">=</span> <span class=\"nx\">http</span><span class=\"p\">.</span><span class=\"nx\">createServer</span><span class=\"p\">(</span><span class=\"nx\">app</span><span class=\"p\">);</span>\n<span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"nx\">port</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s2\">`API running on localhost:</span><span class=\"p\">${</span><span class=\"nx\">port</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">));</span>\n<span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'error'</span><span class=\"p\">,</span> <span class=\"nx\">onError</span><span class=\"p\">);</span>\n<span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'listening'</span><span class=\"p\">,</span> <span class=\"nx\">onListening</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// ポートを正規化.</span>\n<span class=\"kd\">function</span> <span class=\"nx\">normalizePort</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">):</span> <span class=\"nx\">number</span><span class=\"o\">|</span><span class=\"nx\">string</span><span class=\"o\">|</span><span class=\"kr\">boolean</span>  <span class=\"p\">{</span>\n\n  <span class=\"kd\">const</span> <span class=\"nx\">normalizedPort</span><span class=\"p\">:</span> <span class=\"nx\">number</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">val</span> <span class=\"o\">===</span> <span class=\"s1\">'string'</span><span class=\"p\">)</span>\n    <span class=\"p\">?</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">)</span>\n    <span class=\"p\">:</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">isNaN</span><span class=\"p\">(</span><span class=\"nx\">normalizedPort</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">normalizedPort</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"nx\">normalizedPort</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">return</span> <span class=\"kc\">false</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// エラーハンドラー.</span>\n<span class=\"kd\">function</span> <span class=\"nx\">onError</span><span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">):</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">.</span><span class=\"nx\">syscall</span> <span class=\"o\">!==</span> <span class=\"s1\">'listen'</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">throw</span> <span class=\"nx\">error</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"kd\">const</span> <span class=\"nx\">bind</span> <span class=\"o\">=</span> <span class=\"k\">typeof</span> <span class=\"nx\">port</span> <span class=\"o\">===</span> <span class=\"s1\">'string'</span>\n    <span class=\"p\">?</span> <span class=\"s1\">'Pipe '</span> <span class=\"o\">+</span> <span class=\"nx\">port</span>\n    <span class=\"p\">:</span> <span class=\"s1\">'Port '</span> <span class=\"o\">+</span> <span class=\"nx\">port</span><span class=\"p\">;</span>\n\n  <span class=\"k\">switch</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">.</span><span class=\"nx\">code</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">case</span> <span class=\"s1\">'EACCES'</span><span class=\"p\">:</span>\n      <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"nx\">bind</span> <span class=\"o\">+</span> <span class=\"s1\">' requires elevated privileges'</span><span class=\"p\">);</span>\n      <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n      <span class=\"k\">break</span><span class=\"p\">;</span>\n    <span class=\"k\">case</span> <span class=\"s1\">'EADDRINUSE'</span><span class=\"p\">:</span>\n      <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"nx\">bind</span> <span class=\"o\">+</span> <span class=\"s1\">' is already in use'</span><span class=\"p\">);</span>\n      <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n      <span class=\"k\">break</span><span class=\"p\">;</span>\n    <span class=\"nl\">default</span><span class=\"p\">:</span>\n      <span class=\"k\">throw</span> <span class=\"nx\">error</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// サーバ起動時のリスナー.</span>\n<span class=\"kd\">function</span> <span class=\"nx\">onListening</span><span class=\"p\">():</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">addr</span> <span class=\"o\">=</span> <span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">address</span><span class=\"p\">();</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">bind</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">addr</span> <span class=\"o\">===</span> <span class=\"s1\">'string'</span><span class=\"p\">)</span>\n    <span class=\"p\">?</span> <span class=\"s2\">`pipe </span><span class=\"p\">${</span><span class=\"nx\">addr</span><span class=\"p\">}</span><span class=\"s2\">`</span>\n    <span class=\"p\">:</span> <span class=\"s2\">`port </span><span class=\"p\">${</span><span class=\"nx\">addr</span><span class=\"p\">.</span><span class=\"nx\">port</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"serverconfigts\" class=\"fragment\"></span><a href=\"#serverconfigts\"><i class=\"fa fa-link\"></i></a>server/config.ts</h4>\n\n<p>サーバ側の設定ファイルを作成します。<br>\nポートとMongoDBのURLを定義しています。<br>\n今回MongoDBはローカルにポート27017で立てる想定です。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">config.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">SERVER_PORT</span> <span class=\"o\">=</span> <span class=\"mi\">3000</span><span class=\"p\">;</span>\n<span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">MONGO_URL</span> <span class=\"o\">=</span> <span class=\"s1\">'mongodb://localhost:27017/test'</span><span class=\"p\">;</span>\n</pre></div>\n</div>\n\n<h3>\n<span id=\"3-クライアント側を作成\" class=\"fragment\"></span><a href=\"#3-%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E5%81%B4%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>3. クライアント側を作成</h3>\n\n<p>Angular CLIでプロジェクトを作成すると最低限のクライアント資産が生成されるので、<br>\nここでは修正が必要なファイル、新規作成するファイルのみ紹介します。</p>\n\n<h4>\n<span id=\"srcappmessagemessageservicets\" class=\"fragment\"></span><a href=\"#srcappmessagemessageservicets\"><i class=\"fa fa-link\"></i></a>src/app/message/message.service.ts</h4>\n\n<p>サーバ側からメッセージを取得するためのサービスを新規作成します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">message.service.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Injectable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Http</span><span class=\"p\">,</span> <span class=\"nx\">Response</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/http'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Observable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'rxjs/Rx'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"s1\">'rxjs/Rx'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Injectable</span><span class=\"p\">()</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">MessageService</span> <span class=\"p\">{</span>\n\n  <span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"kr\">private</span> <span class=\"nx\">http</span><span class=\"p\">:</span> <span class=\"nx\">Http</span><span class=\"p\">)</span> <span class=\"p\">{}</span>\n\n  <span class=\"nx\">getAll</span><span class=\"p\">():</span> <span class=\"nx\">Observable</span><span class=\"o\">&lt;</span><span class=\"nx\">any</span><span class=\"o\">&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">http</span>\n        <span class=\"p\">.</span><span class=\"kd\">get</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">)</span>\n        <span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"na\">response</span><span class=\"p\">:</span> <span class=\"nx\">Response</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n            <span class=\"kd\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">();</span>\n            <span class=\"k\">return</span> <span class=\"nx\">result</span><span class=\"p\">;</span>\n        <span class=\"p\">})</span>\n        <span class=\"p\">.</span><span class=\"k\">catch</span><span class=\"p\">((</span><span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"nx\">Response</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">Observable</span><span class=\"p\">.</span><span class=\"k\">throw</span><span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">()));</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">regist</span><span class=\"p\">(</span><span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">):</span> <span class=\"nx\">Observable</span><span class=\"o\">&lt;</span><span class=\"nx\">any</span><span class=\"o\">&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">http</span>\n      <span class=\"p\">.</span><span class=\"nx\">post</span><span class=\"p\">(</span><span class=\"s1\">'/api/messages'</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"nx\">message</span><span class=\"p\">})</span>\n      <span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"na\">response</span><span class=\"p\">:</span> <span class=\"nx\">Response</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n            <span class=\"kd\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">();</span>\n            <span class=\"k\">return</span> <span class=\"nx\">result</span><span class=\"p\">;</span>\n      <span class=\"p\">})</span>\n      <span class=\"p\">.</span><span class=\"k\">catch</span><span class=\"p\">((</span><span class=\"na\">error</span><span class=\"p\">:</span> <span class=\"nx\">Response</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">Observable</span><span class=\"p\">.</span><span class=\"k\">throw</span><span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">()));</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"srcappappcomponentts\" class=\"fragment\"></span><a href=\"#srcappappcomponentts\"><i class=\"fa fa-link\"></i></a>src/app/app.component.ts</h4>\n\n<p>既存のファイルを修正して、messagesを保持するようにします。<br>\nMessageServiceを使ってメッセージを取得します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.component.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Component</span><span class=\"p\">,</span> <span class=\"nx\">OnInit</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MessageService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./message/message.service'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Component</span><span class=\"p\">({</span>\n  <span class=\"na\">selector</span><span class=\"p\">:</span> <span class=\"s1\">'app-root'</span><span class=\"p\">,</span>\n  <span class=\"na\">templateUrl</span><span class=\"p\">:</span> <span class=\"s1\">'./app.component.html'</span><span class=\"p\">,</span>\n  <span class=\"na\">styleUrls</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s1\">'./app.component.css'</span><span class=\"p\">],</span>\n  <span class=\"na\">providers</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"nx\">MessageService</span> <span class=\"p\">]</span>\n<span class=\"p\">})</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">AppComponent</span> <span class=\"p\">{</span>\n  <span class=\"nl\">messages</span><span class=\"p\">:</span> <span class=\"nb\">Array</span><span class=\"o\">&lt;</span><span class=\"nx\">any</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n  <span class=\"nl\">message</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">;</span>\n\n  <span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"kr\">private</span> <span class=\"nx\">messageService</span><span class=\"p\">:</span> <span class=\"nx\">MessageService</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">getMessages</span><span class=\"p\">();</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">getMessages</span><span class=\"p\">():</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">messageService</span>\n      <span class=\"p\">.</span><span class=\"nx\">getAll</span><span class=\"p\">()</span>\n      <span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">res</span><span class=\"p\">:</span> <span class=\"nx\">any</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">messages</span> <span class=\"o\">=</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">messages</span><span class=\"p\">;</span>\n      <span class=\"p\">});</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">registerMessage</span><span class=\"p\">():</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">messageService</span>\n      <span class=\"p\">.</span><span class=\"nx\">register</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span>\n      <span class=\"p\">.</span><span class=\"nx\">subscribe</span><span class=\"p\">((</span><span class=\"na\">res</span><span class=\"p\">:</span> <span class=\"nx\">any</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">=</span> <span class=\"s1\">''</span><span class=\"p\">;</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">getMessages</span><span class=\"p\">();</span>\n      <span class=\"p\">});</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"srcappappcomponenthtml\" class=\"fragment\"></span><a href=\"#srcappappcomponenthtml\"><i class=\"fa fa-link\"></i></a>src/app/app.component.html</h4>\n\n<p>既存のファイルの修正して、メッセージ一覧と登録のUIに書き換えます。</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">app.component.html</span></div>\n<div class=\"highlight\"><pre><span class=\"nt\">&lt;div&gt;</span>\n  <span class=\"nt\">&lt;div&gt;</span>\n    <span class=\"nt\">&lt;h1&gt;</span>メッセージ一覧<span class=\"nt\">&lt;/h1&gt;</span>\n    <span class=\"nt\">&lt;button</span> <span class=\"na\">id=</span><span class=\"s\">\"getMessagesButton\"</span> <span class=\"err\">(</span><span class=\"na\">click</span><span class=\"err\">)=\"</span><span class=\"na\">getMessages</span><span class=\"err\">()\"</span><span class=\"nt\">&gt;</span>メッセージ一覧を最新化<span class=\"nt\">&lt;/button&gt;</span>\n    <span class=\"nt\">&lt;ul</span> <span class=\"na\">id=</span><span class=\"s\">\"messageList\"</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;li</span> <span class=\"err\">*</span><span class=\"na\">ngFor=</span><span class=\"s\">\"let item of messages\"</span><span class=\"nt\">&gt;</span>\n        {{item.message}}\n      <span class=\"nt\">&lt;/li&gt;</span>\n    <span class=\"nt\">&lt;/ul&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n  <span class=\"nt\">&lt;div&gt;</span>\n    <span class=\"nt\">&lt;h1&gt;</span>メッセージ登録<span class=\"nt\">&lt;/h1&gt;</span>\n    <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">\"text\"</span> <span class=\"na\">id=</span><span class=\"s\">\"registerMessage\"</span> <span class=\"err\">[(</span><span class=\"na\">ngModel</span><span class=\"err\">)]=\"</span><span class=\"na\">message</span><span class=\"err\">\"</span> <span class=\"na\">placeholder=</span><span class=\"s\">\"登録するメッセージを入力してください。\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;button</span> <span class=\"na\">type=</span><span class=\"s\">\"submit\"</span> <span class=\"na\">id=</span><span class=\"s\">\"registerMessageButton\"</span> <span class=\"err\">(</span><span class=\"na\">click</span><span class=\"err\">)='</span><span class=\"na\">registerMessage</span><span class=\"err\">()'</span><span class=\"nt\">&gt;</span>登録<span class=\"nt\">&lt;/button&gt;</span>\n  <span class=\"nt\">&lt;/div&gt;</span>\n<span class=\"nt\">&lt;/div&gt;</span>\n</pre></div>\n</div>\n\n<h4>\n<span id=\"srcappappmodulets\" class=\"fragment\"></span><a href=\"#srcappappmodulets\"><i class=\"fa fa-link\"></i></a>src/app/app.module.ts</h4>\n\n<p>HttpModule、FormsModule、MessageServiceを追加します。</p>\n\n<div class=\"code-frame\" data-lang=\"js\">\n<div class=\"code-lang\"><span class=\"bold\">app.module.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">BrowserModule</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/platform-browser'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">NgModule</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">HttpModule</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/http'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">FormsModule</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/forms'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">AppComponent</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./app.component'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MessageService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./message/message.service'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">NgModule</span><span class=\"p\">({</span>\n  <span class=\"na\">declarations</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"nx\">AppComponent</span>\n  <span class=\"p\">],</span>\n  <span class=\"na\">imports</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"nx\">BrowserModule</span><span class=\"p\">,</span>\n    <span class=\"nx\">HttpModule</span><span class=\"p\">,</span>\n    <span class=\"nx\">FormsModule</span>\n  <span class=\"p\">],</span>\n  <span class=\"na\">providers</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">MessageService</span><span class=\"p\">],</span>\n  <span class=\"na\">bootstrap</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"nx\">AppComponent</span><span class=\"p\">]</span>\n<span class=\"p\">})</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">AppModule</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n\n\n</pre></div>\n</div>\n\n<h3>\n<span id=\"4-ビルドまわり環境を整備\" class=\"fragment\"></span><a href=\"#4-%E3%83%93%E3%83%AB%E3%83%89%E3%81%BE%E3%82%8F%E3%82%8A%E7%92%B0%E5%A2%83%E3%82%92%E6%95%B4%E5%82%99\"><i class=\"fa fa-link\"></i></a>4. ビルドまわり環境を整備</h3>\n\n<h4>\n<span id=\"pakcagejson\" class=\"fragment\"></span><a href=\"#pakcagejson\"><i class=\"fa fa-link\"></i></a>pakcage.json</h4>\n\n<p>スクリプトを下記のように修正します。<br>\n(npm scriptsは便利ですが、コメントが記述できないのが残念だなーと思いました。)</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">package.json</span></div>\n<div class=\"highlight\"><pre><span class=\"w\">\n  </span><span class=\"s2\">\"scripts\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n    </span><span class=\"s2\">\"start\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"npm-run-all -s build:server -p start:*\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"start:client\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"ng serve --aot=true --progress=false --proxy-config proxy.conf.json\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"start:server\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"run-p watch:server boot:server\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"watch:server\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"tsc -w -p ./server/tsconfig.server.json\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"boot:server\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"nodemon ./dist/server/bin/www.js\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"build\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"run-s build:server build:client\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"build:client\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"ng build --output-path=./dist/server/public\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"build:server\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"tsc -p ./server/tsconfig.server.json\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"buildRun\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"run-s build boot:server\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"err\">...</span><span class=\"w\">\n  </span><span class=\"p\">},</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<ul>\n<li>\n<strong>start</strong>でクライアント資産とサーバ資産の両方を起動します。</li>\n<li>\n<strong>start:client</strong>でクライアント資産をコンパイルして起動します。Angular CLIのngコマンドにお任せしています。なおstartではクライアント資産とサーバ資産で二つのサーバを起動するので、クライアントからサーバへ（リクエストを送れるようにプロキシ設定を行っています。プロキシ設定ファイルについては下で触れます。</li>\n<li>\n<strong>start:server</strong>でサーバ資産をコンパイルしてExpressを起動します。</li>\n<li>\n<strong>watch:server</strong>でサーバ側のTypeScriptをウォッチして変更があればコンパイルするようにします。</li>\n<li>\n<strong>boot:server</strong>でコンパイルしたサーバ側資産を起動します。nodeではなくnodemonを使うことでコンパイルしたサーバ資産に更新があった場合でも即座に更新を反映するようにしています。</li>\n<li>\n<strong>build</strong>クライアント資産とサーバ資産の両方をコンパイルします。</li>\n<li>\n<strong>build:server</strong>でサーバ資産をコンパイルしています。コンパイル時の設定は下で触れる<code>/server/tsconfig.server.json</code>を使います。</li>\n<li>\n<strong>build:client</strong>でクライアント資産をコンパイルしています。出力先はサーバ側資産の静的ファイル格納フォルダ（<code>dist/server/public</code>）を指定しています。</li>\n<li>\n<strong>buildRun</strong>でクライアント資産とサーバ資産の両方をコンパイルしサーバ資産を起動します。とりあえずデプロイするアプリを起動したい時の便利コマンドです。</li>\n</ul>\n\n<h4>\n<span id=\"servertsconfigserverjson\" class=\"fragment\"></span><a href=\"#servertsconfigserverjson\"><i class=\"fa fa-link\"></i></a>server/tsconfig.server.json</h4>\n\n<p>サーバ資産コンパイルときの設定ファイルを作成します。<br>\n<code>outDir</code>で出力先をdist/serverに指定しています。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">tsconfig.server.json</span></div>\n<div class=\"highlight\"><pre><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"s2\">\"extends\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../tsconfig.json\"</span><span class=\"p\">,</span><span class=\"w\">\n  </span><span class=\"s2\">\"compilerOptions\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"s2\">\"preserveConstEnums\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"outDir\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../dist/server\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"mapRoot\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"../dist/server\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"module\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"commonjs\"</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<h4>\n<span id=\"proxyconfjson\" class=\"fragment\"></span><a href=\"#proxyconfjson\"><i class=\"fa fa-link\"></i></a>proxy.conf.json</h4>\n\n<p><code>start</code>でクライアントとサーバの２つを起動した時に、クラ<br>\nイアントからサーバへのリクエストを送れるようにするためのプロキシ設定ファイルを作成します。<br>\n<code>/api</code>始まるリクエストをサーバへのリクエストとみなしてプロキシ設定を行います。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">proxy.conf.json</span></div>\n<div class=\"highlight\"><pre><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"s2\">\"/api\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    </span><span class=\"s2\">\"target\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"http://localhost:3000\"</span><span class=\"p\">,</span><span class=\"w\">\n    </span><span class=\"s2\">\"secure\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<h4>\n<span id=\"mongodbをローカルで立ち上げる\" class=\"fragment\"></span><a href=\"#mongodb%E3%82%92%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%A7%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E3%82%8B\"><i class=\"fa fa-link\"></i></a>MongoDBをローカルで立ち上げる</h4>\n\n<p>具体的な方法について触れませんが、Dockerでもなんでもいいのでローカルにポート27017でMongoDBを立ち上げておいてください。DB、テーブルの作成などは不要です。</p>\n\n<h3>\n<span id=\"5-試してみる\" class=\"fragment\"></span><a href=\"#5-%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>5. 試してみる</h3>\n\n<h4>\n<span id=\"アプリを起動してみる\" class=\"fragment\"></span><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>アプリを起動してみる</h4>\n\n<ul>\n<li>\n<p>プロジェクト直下で下記コマンドを実行するとアプリが起動します。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ npm start \n</pre></div></div>\n</li>\n<li><p>起動したら<code>http://localhost:4200</code>にアクセスしてみます。すると下記のようにメッセージ一覧画面が表示され、メッセージを登録すると適宜一覧に追加されていきます。</p></li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/69f548fea654db9cdc39f80b3ff36129a4e0be22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33303138373561362d313131362d363066332d313161392d6466366562353566353463322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/69f548fea654db9cdc39f80b3ff36129a4e0be22/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33303138373561362d313131362d363066332d313161392d6466366562353566353463322e706e67\" alt=\"アプリ概要.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/301875a6-1116-60f3-11a9-df6eb55f54c2.png\"></a></p>\n\n<ul>\n<li>試しにクライアント資産かサーバ資産を修正してみると、コンンパイルされてアプリに変更がリアルタイムに反映されることがわかります。</li>\n</ul>\n\n<h4>\n<span id=\"アプリをビルドしてみる\" class=\"fragment\"></span><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>アプリをビルドしてみる</h4>\n\n<ul>\n<li>\n<p>プロジェクト直下で下記コマンドを実行するとアプリがビルドされdistフォルダ配下に出力されます。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ npm run build\n</pre></div></div>\n</li>\n</ul>\n\n<h4>\n<span id=\"アプリをビルドして起動してみる\" class=\"fragment\"></span><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%82%92%E3%83%93%E3%83%AB%E3%83%89%E3%81%97%E3%81%A6%E8%B5%B7%E5%8B%95%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"></i></a>アプリをビルドして起動してみる</h4>\n\n<ul>\n<li>プロジェクト直下で下記コマンドを実行するとアプリがビルドされdistフォルダ配下に出力された後に起動されます。\nビルドしたアプリは<code>http://localhost:3000</code>でアクセスできます。\n<code>\n$ npm run buildRun\n</code>\n</li>\n</ul>\n\n<h2>\n<span id=\"終わりに\" class=\"fragment\"></span><a href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"><i class=\"fa fa-link\"></i></a>終わりに</h2>\n\n<p>今回はAngular CLIベースのプロジェクトをベースにしてMEANスタックの最小構成プロジェクトを構築する方法を紹介しました。プロジェクトを起動、ビルドすることはできるようになったので、次回「<a href=\"http://qiita.com/Takumon/items/b4211fcabad740baa551\">その２. テスト編</a>」ではテストコードの作成とテスト実施環境の構築について紹介しようと思います。</p>\n","body":"## やりたいこと\n* Angular CLI使って、MEANスタック(**M**ongoDB + **E**xpress + **A**ngular + **N**odeJS)のアプリを作りたい。どうせならサーバ側もTypeScriptで作りたい。\n* フロント側とサーバ側の両方をwebpack、gulpなどは使わずにnpm scriptsだけでビルド、テストできるようにしたい。\n* Dockerを使ってアプリを簡単に配布したい。\n\nこれらを達成するための最小構成プロジェクトの作り方を３回に分けて紹介します。\n\n* その１. ビルド編　⇦　今回はココ\n* [その２. テスト編](http://qiita.com/Takumon/items/b4211fcabad740baa551)\n* その３. Dockerビルド編\n\n\n\n## その１. ビルド編\nAngular CLIで作成したプロジェクトをベースに、\nMongoDBに登録したメッセージを画面に一覧で表示するアプリを作成していきます。\nメッセージを登録すると一覧に追加されていくようなアプリです。\n\n![アプリ概要.png](https://qiita-image-store.s3.amazonaws.com/0/49915/301875a6-1116-60f3-11a9-df6eb55f54c2.png)\n\n\n\n\n### プロジェクト構成\n今回のチュートリアル終了すると下記のようなプロジェクトの構成になります。\n[リポジトリ](https://github.com/Takumon/angular4-express4-typescritp2/tree/build)も用意しているので詳細はそちらを参照してください。\n\n```:プロジェクトの構成（完成イメージ）\n.\n├── dist                ・・・(1) コンパイル資産出力先\n│   └── server　　　　　　　　      ・・・\u001c(1-1)　コンパイルされたサーバ資産\n│       ├── app.js\n│       ├── app.js.map\n│       ├── bin\n│       │   ├── www.js\n│       │   └── www.js.map\n│       ├── config.js\n│       ├── config.js.map\n│       ├── models\n│       │   ├── message.js\n│       │   └── message.js.map\n│       ├── public      ・・・(1-2) コンパイルされたクライアント資産\n│       │   ├── favicon.ico\n│       │   ├── index.html\n│       │   ├── inline.bundle.js\n│       │   ├── inline.bundle.js.map\n│       │   ├── main.bundle.js\n│       │   ├── main.bundle.js.map\n│       │   ├── polyfills.bundle.js\n│       │   ├── polyfills.bundle.js.map\n│       │   ├── styles.bundle.js\n│       │   ├── styles.bundle.js.map\n│       │   ├── vendor.bundle.js\n│       │   └── vendor.bundle.js.map\n│       └── routes\n│           ├── message.js\n│           └── message.js.map\n├── node_modules\n│   ├── ...\n│   ...\n│\n├── e2e\n│   ├── app.e2e-spec.ts\n│   ├── app.po.ts\n│   └── tsconfig.e2e.json\n├── server               ・・・(2)　サーバ資産\n│   ├── app.ts\n│   ├── bin\n│   │   └── www.ts\n│   ├── config.ts\n│   ├── models\n│   │   └── message.ts\n│   ├── routes\n│   │   └── message.ts\n│   └── tsconfig.server.json\n├── src                   ・・・(3)　クライアント資産\n│   ├── app\n│   │   ├── app.component.css\n│   │   ├── app.component.html\n│   │   ├── app.component.spec.ts\n│   │   ├── app.component.ts\n│   │   ├── app.module.ts\n│   │   └── message\n│   │       └── message.service.ts\n│   ├── assets\n│   ├── environments\n│   │   ├── environment.prod.ts\n│   │   └── environment.ts\n│   ├── favicon.ico\n│   ├── index.html\n│   ├── main.ts\n│   ├── polyfills.ts\n│   ├── styles.css\n│   ├── test.ts\n│   ├── tsconfig.app.json\n│   ├── tsconfig.spec.json\n│   └── typings.d.ts\n├── karma.conf.js\n├── package-lock.json\n├── package.json\n├── protractor.conf.js\n├── proxy.conf.json    ・・・(4) \n├── tsconfig.json\n├── tslint.json\n└── README.md\n```\n#### 各資産について\n##### (1) dist\nコンパイルした資産の出力先フォルダ\n\n##### (1-1) dist/server\nここにサーバ側のコンパイルされたjsファイルが出力されます。\nserverフォルダを設けているのは本資産とテスト資産を分離したかったからです。\nその２. テスト編で説明しますが、サーバ側テスト用jsファイルはdist配下のserver_testフォルダに出力されるようにしています。\n\n##### (1-2) dist/server/public\nコンパイルされたクライアント資産。\nサーバ側アプリの資産の一部としてコンパイルされるようにしています。\nExpressのアプリでは静的資産をpublicフォルダに置くのが一般的なのでこうしました。\n\n##### (2) server\nサーバ資産を格納するためのディレクトリ。\nいろいろ悩みましたが、TypeScript資産をコンパイルすることとテストすることを考慮してこのような構成にしました。\n\n##### (3) src\nフロントの実行資産とテスト資産を格納するためのディレクリ。\nAngular CLIでプロジェクトを作成するとデフォルトで作成されます。\nビルドやアプリ起動は`ng`コマンドで実施します。\n\n##### (4) proxy.conf.json\n`npm start`でフロント側とサーバ側を同時に起動した時に、クライアント側からサーバ側へのリクエストを送れるようにするためのプロキシ設定です。\n\n\n\n\n## 構築手順\n\n### 1. プロジェクト作成\n* Angular CLIをインストール\n\n\t```\n\t$ npm install -g @angular/cli\n\t```\n\n* プロジェクトを生成、Angular CLIであらかじめ定義している依存ライブラリをインストール\n\n\t```\n\t$ ng new sample\n\t$ cd sample\n\t$ npm install\n\t```\n\n* Angular CLIであらかじめ定義している依存ライブラリの他に必要なものををインストール\n<dd>\n    <dt>[`express`](https://www.npmjs.com/package/express)\n        <dd>Webアプリケーションフレームワーク\n    <dt>[`body-parser`](https://www.npmjs.com/package/body-parser)\n        <dd>リクエストボディのパーサー\n    <dt>[`mongoose`](https://www.npmjs.com/package/mongoose)\n        <dd>MongoDBへのアクセスを簡単にしてくれるAPI\n    <dt>[`nodemon`](https://www.npmjs.com/package/nodemon)\n        <dd>node実行時にソースの変更を自動反映してくれるツール\n    <dt>[`npm-run-all`](https://www.npmjs.com/package/npm-run-all)\n        <dd>npm-scripts の連結実行を管理するためのパッケージ\n</dd>\n\n\t```\n\t$ npm install --save express body-parser mongoose\n\t$ npm install --save-dev @types/mongoose nodemon npm-run-all\n\t```\n\n\n\n### 2. サーバ側を作成\nAngular CLIで作ったプロジェクトの直下に`server`フォルダを作って、その中にサーバ側の処理を書いていきます。\n#### server/models/message.ts\nMongoDBにアクセスするためのモデルを定義します。\nDBアクセスにはmangoosを使います。\n\n```js:message.ts\nimport * as mongoose from 'mongoose';\n\nconst Message = mongoose.model('messages', new mongoose.Schema({\n  message: {type: String}\n}));\n\nexport { Message };\n```\n\n\n\n#### server/routes/message.ts\nエンドポイントごとの処理を記述するルータを定義します。\nメッセージの取得と登録には`server/models/message.ts`を使います。\n\n```js:message.ts\nimport * as http from 'http';\nimport { Router, Response } from 'express';\nimport { Message } from '../models/message';\n\nconst messageRouter: Router = Router();\n\n// 全てのメッセージを取得する\nmessageRouter.get('/', (req, res, next) => {\n  Message.find(function(err, doc) {\n    if (err) {\n      return res.status(500).json({\n          title: 'エラーが発生しました。',\n          error: err.message\n      });\n    }\n\n    return res.status(200).json({messages: doc});\n  });\n});\n\n// メッセージを登録する\nmessageRouter.post('/', (req, res, next) => {\n  const message = new Message({\n    message: req.body.message\n  });\n\n  message.save((err, result) => {\n    if (err) {\n      return res.status(500).json({\n          title: 'エラーが発生しました。',\n          error: err.message\n      });\n    }\n\n    return res.status(200).json({\n      message: 'メッセージを登録しました。',\n      obj: result\n    });\n  });\n});\n\nexport { messageRouter };\n```\n\n\n#### server/app.ts\nExpressで使用するルータと依存モジュールを定義するためのファイルを作成します。\nメッセージAPIのエンドポイントは`/api/messages`に設定し、\nmongooseを使ってMongoDBへの接続設定をしています。\nクライアント資産はビルドするとpublicフォルダ配下に出力されるようにしているので、\n静的資産へのルーティングはpublicフォルダを指定しています。\n\n```js:app.ts\nimport * as express from 'express';\nimport * as path from 'path';\nimport * as bodyParser from 'body-parser';\nimport * as mongoose from 'mongoose';\n\nimport { messageRouter } from './routes/message';\nimport { MONGO_URL } from './config';\n\nclass App {\n  public express: express.Application;\n\n  constructor() {\n    this.express = express();\n    this.middleware();\n    this.routes();\n  }\n\n  private middleware(): void {\n    this.express.use(bodyParser.json());\n    this.express.use(bodyParser.urlencoded({ extended: false }));\n    // 接続する MongoDB の設定\n    mongoose.Promise = global.Promise;\n    mongoose.connect(process.env.MONGO_URL || MONGO_URL, {\n      useMongoClient: true,\n    });\n    process.on('SIGINT', function() { mongoose.disconnect(); });\n  }\n\n  private routes(): void {\n    // 静的資産へのルーティング\n    this.express.use(express.static(path.join(__dirname, 'public')));\n\n    this.express.use('/api/messages', messageRouter);\n\n    // その他のリクエストはindexファイルにルーティング\n    this.express.get('*', (req, res) => {\n      res.sendFile(path.join(__dirname, 'public/index.html'));\n    });\n  }\n}\n\nexport default new App().express;\n```\n\n\n#### server/bin/www\\.ts\nNode.js でサーバを起動するための設定ファイルを作成します。\n\n```js:www.ts\nimport * as http from 'http';\nimport { SERVER_PORT } from '../config';\nimport app from '../app';\n\n\n\n// ポートの設定.\nconst port = normalizePort(process.env.PORT || SERVER_PORT);\napp.set('port', port);\n\n\n// HTTPサーバ生成.\nconst server = http.createServer(app);\nserver.listen(port, () => console.log(`API running on localhost:${port}`));\nserver.on('error', onError);\nserver.on('listening', onListening);\n\n// ポートを正規化.\nfunction normalizePort(val): number|string|boolean  {\n\n  const normalizedPort: number = (typeof val === 'string')\n    ? parseInt(val, 10)\n    : val;\n\n  if (isNaN(normalizedPort)) {\n    return val;\n  }\n\n  if (normalizedPort >= 0) {\n    return normalizedPort;\n  }\n\n  return false;\n}\n\n// エラーハンドラー.\nfunction onError(error): void {\n  if (error.syscall !== 'listen') {\n    throw error;\n  }\n\n  const bind = typeof port === 'string'\n    ? 'Pipe ' + port\n    : 'Port ' + port;\n\n  switch (error.code) {\n    case 'EACCES':\n      console.error(bind + ' requires elevated privileges');\n      process.exit(1);\n      break;\n    case 'EADDRINUSE':\n      console.error(bind + ' is already in use');\n      process.exit(1);\n      break;\n    default:\n      throw error;\n  }\n}\n\n// サーバ起動時のリスナー.\nfunction onListening(): void {\n  const addr = server.address();\n  const bind = (typeof addr === 'string')\n    ? `pipe ${addr}`\n    : `port ${addr.port}`;\n}\n```\n\n#### server/config.ts\nサーバ側の設定ファイルを作成します。\nポートとMongoDBのURLを定義しています。\n今回MongoDBはローカルにポート27017で立てる想定です。\n\n```js:config.ts\nexport const SERVER_PORT = 3000;\nexport const MONGO_URL = 'mongodb://localhost:27017/test';\n```\n\n\n\n### 3. クライアント側を作成\nAngular CLIでプロジェクトを作成すると最低限のクライアント資産が生成されるので、\nここでは修正が必要なファイル、新規作成するファイルのみ紹介します。\n\n\n#### src/app/message/message.service.ts\nサーバ側からメッセージを取得するためのサービスを新規作成します。\n\n```js:message.service.ts\nimport { Injectable } from '@angular/core';\nimport { Http, Response } from '@angular/http';\nimport { Observable } from 'rxjs/Rx';\nimport 'rxjs/Rx';\n\n@Injectable()\nexport class MessageService {\n\n  constructor(private http: Http) {}\n\n  getAll(): Observable<any> {\n    return this.http\n        .get('/api/messages')\n        .map((response: Response) => {\n            const result = response.json();\n            return result;\n        })\n        .catch((error: Response) => Observable.throw(error.json()));\n  }\n\n  regist(message: string): Observable<any> {\n    return this.http\n      .post('/api/messages', {message: message})\n      .map((response: Response) => {\n            const result = response.json();\n            return result;\n      })\n      .catch((error: Response) => Observable.throw(error.json()));\n  }\n}\n```\n\n\n\n\n\n#### src/app/app.component.ts\n既存のファイルを修正して、messagesを保持するようにします。\nMessageServiceを使ってメッセージを取得します。\n\n```js:app.component.ts\nimport { Component, OnInit } from '@angular/core';\nimport { MessageService } from './message/message.service';\n\n@Component({\n  selector: 'app-root',\n  templateUrl: './app.component.html',\n  styleUrls: ['./app.component.css'],\n  providers: [ MessageService ]\n})\nexport class AppComponent {\n  messages: Array<any>;\n  message: string;\n\n  constructor(private messageService: MessageService) {\n    this.getMessages();\n  }\n\n  getMessages(): void {\n    this.messageService\n      .getAll()\n      .subscribe((res: any) => {\n        this.messages = res.messages;\n      });\n  }\n\n  registerMessage(): void {\n    if (!this.message) {\n      return;\n    }\n\n    this.messageService\n      .register(this.message)\n      .subscribe((res: any) => {\n        this.message = '';\n        this.getMessages();\n      });\n  }\n}\n```\n\n\n#### src/app/app.component.html\n既存のファイルの修正して、メッセージ一覧と登録のUIに書き換えます。\n\n```html:app.component.html\n<div>\n  <div>\n    <h1>メッセージ一覧</h1>\n    <button id=\"getMessagesButton\" (click)=\"getMessages()\">メッセージ一覧を最新化</button>\n    <ul id=\"messageList\">\n      <li *ngFor=\"let item of messages\">\n        {{item.message}}\n      </li>\n    </ul>\n  </div>\n  <div>\n    <h1>メッセージ登録</h1>\n    <input type=\"text\" id=\"registerMessage\" [(ngModel)]=\"message\" placeholder=\"登録するメッセージを入力してください。\">\n    <button type=\"submit\" id=\"registerMessageButton\" (click)='registerMessage()'>登録</button>\n  </div>\n</div>\n```\n#### src/app/app.module.ts\nHttpModule、FormsModule、MessageServiceを追加します。\n\n\n```js:app.module.ts\nimport { BrowserModule } from '@angular/platform-browser';\nimport { NgModule } from '@angular/core';\nimport { HttpModule } from '@angular/http';\nimport { FormsModule } from '@angular/forms';\n\nimport { AppComponent } from './app.component';\nimport { MessageService } from './message/message.service';\n\n@NgModule({\n  declarations: [\n    AppComponent\n  ],\n  imports: [\n    BrowserModule,\n    HttpModule,\n    FormsModule\n  ],\n  providers: [MessageService],\n  bootstrap: [AppComponent]\n})\nexport class AppModule { }\n\n\n```\n\n\n### 4. ビルドまわり環境を整備\n\n#### pakcage.json\nスクリプトを下記のように修正します。\n(npm scriptsは便利ですが、コメントが記述できないのが残念だなーと思いました。)\n\n```json:package.json\n\n  \"scripts\": {\n    ...\n    \"start\": \"npm-run-all -s build:server -p start:*\",\n    \"start:client\": \"ng serve --aot=true --progress=false --proxy-config proxy.conf.json\",\n    \"start:server\": \"run-p watch:server boot:server\",\n    \"watch:server\": \"tsc -w -p ./server/tsconfig.server.json\",\n    \"boot:server\": \"nodemon ./dist/server/bin/www.js\",\n    \"build\": \"run-s build:server build:client\",\n    \"build:client\": \"ng build --output-path=./dist/server/public\",\n    \"build:server\": \"tsc -p ./server/tsconfig.server.json\",\n    \"buildRun\": \"run-s build boot:server\",\n    ...\n  },\n```\n\n* **start**でクライアント資産とサーバ資産の両方を起動します。\n* **start:client**でクライアント資産をコンパイルして起動します。Angular CLIのngコマンドにお任せしています。なおstartではクライアント資産とサーバ資産で二つのサーバを起動するので、クライアントからサーバへ（リクエストを送れるようにプロキシ設定を行っています。プロキシ設定ファイルについては下で触れます。\n* **start:server**でサーバ資産をコンパイルしてExpressを起動します。\n* **watch:server**でサーバ側のTypeScriptをウォッチして変更があればコンパイルするようにします。\n* **boot:server**でコンパイルしたサーバ側資産を起動します。nodeではなくnodemonを使うことでコンパイルしたサーバ資産に更新があった場合でも即座に更新を反映するようにしています。\n* **build**クライアント資産とサーバ資産の両方をコンパイルします。\n* **build:server**でサーバ資産をコンパイルしています。コンパイル時の設定は下で触れる`/server/tsconfig.server.json`を使います。\n* **build:client**でクライアント資産をコンパイルしています。出力先はサーバ側資産の静的ファイル格納フォルダ（`dist/server/public`）を指定しています。\n* **buildRun**でクライアント資産とサーバ資産の両方をコンパイルしサーバ資産を起動します。とりあえずデプロイするアプリを起動したい時の便利コマンドです。\n\n\n\n#### server/tsconfig.server.json\nサーバ資産コンパイルときの設定ファイルを作成します。\n`outDir`で出力先をdist/serverに指定しています。\n\n```json:tsconfig.server.json\n{\n  \"extends\": \"../tsconfig.json\",\n  \"compilerOptions\": {\n    \"preserveConstEnums\": true,\n    \"outDir\": \"../dist/server\",\n    \"mapRoot\": \"../dist/server\",\n    \"module\": \"commonjs\"\n  }\n}\n```\n\n#### proxy.conf.json\n`start`でクライアントとサーバの２つを起動した時に、クラ\nイアントからサーバへのリクエストを送れるようにするためのプロキシ設定ファイルを作成します。\n`/api`始まるリクエストをサーバへのリクエストとみなしてプロキシ設定を行います。\n\n```json:proxy.conf.json\n{\n  \"/api\": {\n    \"target\": \"http://localhost:3000\",\n    \"secure\": false\n  }\n}\n```\n\n#### MongoDBをローカルで立ち上げる\n具体的な方法について触れませんが、Dockerでもなんでもいいのでローカルにポート27017でMongoDBを立ち上げておいてください。DB、テーブルの作成などは不要です。\n\n\n\n### 5. 試してみる\n#### アプリを起動してみる\n* プロジェクト直下で下記コマンドを実行するとアプリが起動します。\n\n\t```\n\t$ npm start \n\t```\n\n* 起動したら`http://localhost:4200`にアクセスしてみます。すると下記のようにメッセージ一覧画面が表示され、メッセージを登録すると適宜一覧に追加されていきます。\n\n![アプリ概要.png](https://qiita-image-store.s3.amazonaws.com/0/49915/301875a6-1116-60f3-11a9-df6eb55f54c2.png)\n\n* 試しにクライアント資産かサーバ資産を修正してみると、コンンパイルされてアプリに変更がリアルタイムに反映されることがわかります。\n\n#### アプリをビルドしてみる\n* プロジェクト直下で下記コマンドを実行するとアプリがビルドされdistフォルダ配下に出力されます。\n\n\t```\n\t$ npm run build\n\t```\n\n#### アプリをビルドして起動してみる\n* プロジェクト直下で下記コマンドを実行するとアプリがビルドされdistフォルダ配下に出力された後に起動されます。\nビルドしたアプリは`http://localhost:3000`でアクセスできます。\n\t```\n\t$ npm run buildRun\n\t```\n\n## 終わりに\n今回はAngular CLIベースのプロジェクトをベースにしてMEANスタックの最小構成プロジェクトを構築する方法を紹介しました。プロジェクトを起動、ビルドすることはできるようになったので、次回「[その２. テスト編](http://qiita.com/Takumon/items/b4211fcabad740baa551)」ではテストコードの作成とテスト実施環境の構築について紹介しようと思います。\n\n\n","comments_count":0,"created_at":"2017-07-19T02:06:59+09:00","likes_count":26,"reactions_count":0},"next":{"fields":{"slug":"/e0ec0869-f368-5083-bdc2-cdba9d59427a/","title":"フロントエンド初心者がMEANスタック(MongoDB+Express+Angular+Node.js)でアプリを作ってみて躓いたこと","date":"2017-12-12T03:19:11+09:00","excerpt":"FUJITSU Advent Calendar 2017 12日目の記事です。リッチでイマドキなデザインのアプリが作りたくて、ここ４ヶ月ほどMEANスタック(MongoDB+Express+Angular+Node.js)でブログアプリを作...","tags":["JavaScript","Node.js","Express","mongoose","angular","Qiita"]},"id":"e0ec0869-f368-5083-bdc2-cdba9d59427a","title":"フロントエンド初心者がMEANスタック(MongoDB+Express+Angular+Node.js)でアプリを作ってみて躓いたこと","rendered_body":"<p><a href=\"https://qiita.com/advent-calendar/2017/fujitsu\">FUJITSU Advent Calendar 2017</a> 12日目の記事です。</p>\n\n<p>リッチでイマドキなデザインのアプリが作りたくて、<br>\nここ４ヶ月ほど<strong>MEAN</strong>スタック(<strong>M</strong>ongoDB+<strong>E</strong>xpress+<strong>A</strong>ngular+<strong>N</strong>ode.js)でブログアプリを作っています。<br>\n知識ゼロからのスタートでしたが、多くの方々がブログやStackOverFlowに情報を載せてくれているので、躓きながらもなんとかアプリ開発を進めることができました。</p>\n\n<p>この記事では、フロントエンド初心者の自分がMEANスタックでアプリを作る時に躓いたことや、こういう機能を実現するにはどうすればいいか?などをまとめています。<br>\nこれからをAngularを学ぼうとしている方、ExpressやMongoDBなどサーバーサイドJavaScriptを学ぼうとしている方の参考になればうれしいです。</p>\n\n<h2>\n<span id=\"アプリの紹介\" class=\"fragment\"></span><a href=\"#%E3%82%A2%E3%83%97%E3%83%AA%E3%81%AE%E7%B4%B9%E4%BB%8B\"><i class=\"fa fa-link\"></i></a>アプリの紹介</h2>\n\n<p>本線から脱線しますが、イントラでの使用を想定したQiitaのようなブログアプリです。デモ環境もあるのでよければ触ってみてください(モバイルには未対応ですが。。。)</p>\n\n<ul>\n<li><a href=\"https://github.com/Takumon/mean-blog\" rel=\"nofollow noopener\" target=\"_blank\">Github</a></li>\n<li><a href=\"https://hub.docker.com/r/takumon/mean-blog_auto/\" rel=\"nofollow noopener\" target=\"_blank\">Dockerhub</a></li>\n<li>\n<a href=\"https://material-blog-demo.herokuapp.com/\" rel=\"nofollow noopener\" target=\"_blank\">デモ環境</a> (ユーザID/パスは DemoUser / DemoUser1234# です)</li>\n</ul>\n\n<p>アプリキャプチャ その１ (記事詳細)<br>\n<a href=\"https://camo.qiitausercontent.com/4d64d8bd315bcf330d1ac6de1cfe8bb53f280992/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f62383133333331372d666163322d626239622d386632642d3133646238393662656366352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/4d64d8bd315bcf330d1ac6de1cfe8bb53f280992/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f62383133333331372d666163322d626239622d386632642d3133646238393662656366352e706e67\" alt=\"appdemo_detail.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/b8133317-fac2-bb9b-8f2d-13db896becf5.png\"></a></p>\n\n<p>アプリキャプチャ その２ (記事一覧)<br>\n<a href=\"https://camo.qiitausercontent.com/96927cda50e8df84b0c5415e996246c6d720b607/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39353064313036322d316261342d363366362d666535332d6366653664343634333061342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/96927cda50e8df84b0c5415e996246c6d720b607/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39353064313036322d316261342d363366362d666535332d6366653664343634333061342e706e67\" alt=\"アプリ_スクリーンキャプチャ_記事一覧.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/950d1062-1ba4-63f6-fe53-cfe6d46430a4.png\"></a></p>\n\n<p>アプリキャプチャ その３ (プロフィール)<br>\n<a href=\"https://camo.qiitausercontent.com/46aab6c2add74ca826b1dbe730d1a82eb481e295/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33323563373934382d636531362d396330382d306236362d6433383932653034366165642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/46aab6c2add74ca826b1dbe730d1a82eb481e295/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33323563373934382d636531362d396330382d306236362d6433383932653034366165642e706e67\" alt=\"アプリ_スクリーンキャプチャ_ ユーザ画面.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/325c7948-ce16-9c08-0b66-d3892e046aed.png\"></a></p>\n\n<h1>\n<span id=\"1-フロント側angularまわり\" class=\"fragment\"></span><a href=\"#1-%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E5%81%B4angular%E3%81%BE%E3%82%8F%E3%82%8A\"><i class=\"fa fa-link\"></i></a>1. フロント側Angularまわり</h1>\n\n<h2>\n<span id=\"angularについて調べる時に古い情報を除外したい\" class=\"fragment\"></span><a href=\"#angular%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E8%AA%BF%E3%81%B9%E3%82%8B%E6%99%82%E3%81%AB%E5%8F%A4%E3%81%84%E6%83%85%E5%A0%B1%E3%82%92%E9%99%A4%E5%A4%96%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>Angularについて調べる時に古い情報を除外したい</h2>\n\n<p>1系は<code>AngularJS</code>、2系以降は<code>Angular</code>と呼ばれており、1系と2系以降では大きく仕様が異なります。<br>\nそのため検索する時は<code>Angualr2</code>などバージョンを指定したり、1系を除外するため<code>--AngularJS</code>をつけたりすると検索しやすいです。</p>\n\n<h2>\n<span id=\"htmlのdom要素を別のdom要素またはcomponentから扱いたい\" class=\"fragment\"></span><a href=\"#html%E3%81%AEdom%E8%A6%81%E7%B4%A0%E3%82%92%E5%88%A5%E3%81%AEdom%E8%A6%81%E7%B4%A0%E3%81%BE%E3%81%9F%E3%81%AFcomponent%E3%81%8B%E3%82%89%E6%89%B1%E3%81%84%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>HTMLのDOM要素を、別のDOM要素またはComponentから扱いたい</h2>\n\n<p>要素に<code>#xxxxx</code>のように<code>#</code>始まりの名前をつけると、別のDOM要素から参照できます</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">HTML</span></div>\n<div class=\"highlight\"><pre><span class=\"nt\">&lt;input</span> <span class=\"err\">#</span><span class=\"na\">phone</span> <span class=\"na\">placeholder=</span><span class=\"s\">\"電話番号\"</span><span class=\"nt\">/&gt;</span>\n<span class=\"c\">&lt;!--  他のDOM要素からphonという変数名でDOM要素を参照できるようになる --&gt;</span>\n<span class=\"nt\">&lt;button</span> <span class=\"nt\">&gt;</span>(click)=\"callPhone(phone.value)\"&gt;\n</pre></div>\n</div>\n\n<p>Componentから参照する場合は<code>@ViewChild</code>を使います</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">Component</span></div>\n<div class=\"highlight\"><pre>  <span class=\"c1\">// ViewChildの引数に名前を文字列で指定します</span>\n  <span class=\"p\">@</span><span class=\"nd\">ViewChild</span><span class=\"p\">(</span><span class=\"s1\">'phone'</span><span class=\"p\">)</span> <span class=\"nx\">phoneElement</span><span class=\"p\">:</span> <span class=\"nx\">phoneElement</span><span class=\"p\">;</span>\n\n  <span class=\"nx\">showPhoneValue</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">phoneElement</span><span class=\"p\">.</span><span class=\"nx\">value</span><span class=\"p\">);</span>\n    <span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://angular.io/guide/template-syntax#ref-vars\" rel=\"nofollow noopener\" target=\"_blank\">Angular公式サイト</a></li>\n<li><a href=\"https://stackoverflow.com/questions/32693061/how-can-i-select-an-element-in-a-component-template\" rel=\"nofollow noopener\" target=\"_blank\">StackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"routing時の認証を非同期で行いたい\" class=\"fragment\"></span><a href=\"#routing%E6%99%82%E3%81%AE%E8%AA%8D%E8%A8%BC%E3%82%92%E9%9D%9E%E5%90%8C%E6%9C%9F%E3%81%A7%E8%A1%8C%E3%81%84%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>Routing時の認証を非同期で行いたい</h2>\n\n<p>URLごとの認証は<code>CanActivate</code>インターフェースを実装すればできますが、<br>\nサーバから認証情報を取得して非同期で認証したい場合もあると思います。<br>\nそのような時は、<strong><code>CanActivate#canActivate</code>で</strong>booleanの代わりに<strong>Observableを戻り値に指定する</strong>ことで実現できます。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">SampleAuthGuard</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Injectable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Router</span><span class=\"p\">,</span> <span class=\"nx\">CanActivate</span><span class=\"p\">,</span> <span class=\"nx\">ActivatedRouteSnapshot</span><span class=\"p\">,</span> <span class=\"nx\">RouterStateSnapshot</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/router'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Observable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'rxjs/Rx'</span><span class=\"p\">;</span>\n\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">AuthenticationService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./authentication.service'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Injectable</span><span class=\"p\">()</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">SampleAuthGuard</span> <span class=\"kr\">implements</span> <span class=\"nx\">CanActivate</span> <span class=\"p\">{</span>\n\n  <span class=\"kd\">constructor</span><span class=\"p\">(</span>\n    <span class=\"kr\">private</span> <span class=\"nx\">auth</span><span class=\"p\">:</span> <span class=\"nx\">AuthenticationService</span><span class=\"p\">,</span>\n  <span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"p\">}</span>\n\n  <span class=\"c1\">// booleanではなくObservable&lt;boolean&gt;を戻り値で返す</span>\n  <span class=\"nx\">canActivate</span><span class=\"p\">(</span><span class=\"nx\">route</span><span class=\"p\">:</span> <span class=\"nx\">ActivatedRouteSnapshot</span><span class=\"p\">,</span> <span class=\"nx\">state</span><span class=\"p\">:</span> <span class=\"nx\">RouterStateSnapshot</span><span class=\"p\">):</span> <span class=\"nx\">Observable</span><span class=\"o\">&lt;</span><span class=\"kr\">boolean</span><span class=\"o\">&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">auth</span><span class=\"p\">.</span><span class=\"nx\">checkState</span><span class=\"p\">()</span>\n      <span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">(</span><span class=\"nx\">res</span> <span class=\"o\">=&gt;</span> <span class=\"kc\">true</span><span class=\"p\">)</span>\n      <span class=\"p\">.</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">err</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">Observable</span><span class=\"p\">.</span><span class=\"k\">of</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">))</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/38425461/angular2-canactivate-calling-async-function\" rel=\"nofollow noopener\" target=\"_blank\">StackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"formarrayの値を初期化したい\" class=\"fragment\"></span><a href=\"#formarray%E3%81%AE%E5%80%A4%E3%82%92%E5%88%9D%E6%9C%9F%E5%8C%96%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>FormArrayの値を初期化したい</h2>\n\n<p>FormControlはpatchValueで初期値を設定できますが、<br>\nFormArrayの場合patchValueで配列の値を設定しようとしても設定できません。<br>\nこういう場合は、<strong>配列1つ１つの値をもとにFormControlを生成してFormArrayにpush</strong>します。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">ダメな例</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">ngOnInit</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// Form生成</span>\n  <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">form</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">formBuilder</span><span class=\"p\">.</span><span class=\"nx\">group</span><span class=\"p\">({</span>\n    <span class=\"na\">schoolName</span><span class=\"p\">:</span> <span class=\"s1\">''</span><span class=\"p\">,</span>\n    <span class=\"na\">students</span><span class=\"p\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">formBuilder</span><span class=\"p\">.</span><span class=\"nx\">array</span><span class=\"p\">([])</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"c1\">// Formに初期値を設定</span>\n  <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">form</span><span class=\"p\">.</span><span class=\"nx\">pathValue</span><span class=\"p\">({</span>\n    <span class=\"na\">schooleName</span><span class=\"p\">:</span> <span class=\"s1\">'SampleSchoolName'</span> <span class=\"c1\">// FormControlの値の初期化はpatchValueで可能</span>\n    <span class=\"na\">students</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s1\">'taro'</span><span class=\"p\">,</span> <span class=\"s1\">'jiro'</span><span class=\"p\">,</span> <span class=\"s1\">'saburo'</span><span class=\"p\">];</span> <span class=\"c1\">// FormArrayに要素を追加する場合patchValueでは不可能</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">良い例</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">ngOnInit</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// Formを生成</span>\n  <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">form</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">formBuilder</span><span class=\"p\">.</span><span class=\"nx\">group</span><span class=\"p\">({</span>\n    <span class=\"na\">schoolName</span><span class=\"p\">:</span> <span class=\"s1\">''</span><span class=\"p\">,</span>\n    <span class=\"na\">students</span><span class=\"p\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">formBuilder</span><span class=\"p\">.</span><span class=\"nx\">array</span><span class=\"p\">([])</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"c1\">// Formに初期値を設定</span>\n  <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">form</span><span class=\"p\">.</span><span class=\"nx\">pathValue</span><span class=\"p\">({</span>\n    <span class=\"na\">schooleName</span><span class=\"p\">:</span> <span class=\"s1\">'SampleSchoolName'</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"c1\">// データからFormControlを生成し１件１件FormArrayにpushする</span>\n  <span class=\"p\">[</span><span class=\"s1\">'taro'</span><span class=\"p\">,</span> <span class=\"s1\">'jiro'</span><span class=\"p\">,</span> <span class=\"s1\">'saburo'</span><span class=\"p\">].</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">student</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">form</span><span class=\"p\">.</span><span class=\"nx\">controls</span><span class=\"p\">[</span><span class=\"s1\">'students'</span><span class=\"p\">].</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">FormControll</span><span class=\"p\">(</span><span class=\"nx\">student</span><span class=\"p\">));</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/40916084/angular2-patchvalue-push-value-into-array\" rel=\"nofollow noopener\" target=\"_blank\">StackOvereFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"error-error-no-provider-for-templaterefというエラー\" class=\"fragment\"></span><a href=\"#error-error-no-provider-for-templateref%E3%81%A8%E3%81%84%E3%81%86%E3%82%A8%E3%83%A9%E3%83%BC\"><i class=\"fa fa-link\"></i></a>「ERROR Error: No provider for TemplateRef!」というエラー</h2>\n\n<p>最初このエラーが出た時は、何が原因なのかわからずに困りました。。。<br>\n大抵の場合は、<strong><code>*ngIf</code>や<code>*ngForm</code>の<code>*</code>が抜けてることが原因</strong>です(要するにただのタイポです。。。)<br>\n<code>*</code>が抜けると、Angularは<code>ngIf</code>をディレクティブとして解釈しようとしますが、<br>\nそんなディレクティブは存在しないので<code>No provider for TemplateRef!</code>と言われてしまうそうです。</p>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/35932074/angular2-no-provider-for-templateref-ngif-templateref\" rel=\"nofollow noopener\" target=\"_blank\">StackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"textareaにおいてtabキーでインデントしたい\" class=\"fragment\"></span><a href=\"#textarea%E3%81%AB%E3%81%8A%E3%81%84%E3%81%A6tab%E3%82%AD%E3%83%BC%E3%81%A7%E3%82%A4%E3%83%B3%E3%83%87%E3%83%B3%E3%83%88%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>textareaにおいてTabキーでインデントしたい</h2>\n\n<p>文書を入力するようなテキストエリアの場合に、Tabキーでのインデントしたい場合は、<br>\nkyedownイベント発生時にテキストエリアの値とキャレットの位置を操作することで実現可能です。</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">HTML</span></div>\n<div class=\"highlight\"><pre><span class=\"nt\">&lt;textarea</span> <span class=\"err\">#</span><span class=\"na\">sampletextarea</span>\n  <span class=\"err\">(</span><span class=\"na\">keydown</span><span class=\"err\">)=\"</span><span class=\"na\">indent</span><span class=\"err\">($</span><span class=\"na\">event</span><span class=\"err\">,</span> <span class=\"na\">sampletextarea</span><span class=\"err\">)\"</span> <span class=\"nt\">&gt;&lt;/textarea&gt;</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">Component</span></div>\n<div class=\"highlight\"><pre>  <span class=\"nx\">indent</span><span class=\"p\">(</span><span class=\"nx\">$event</span><span class=\"p\">,</span> <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// Tabキー押下時</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">$event</span><span class=\"p\">.</span><span class=\"nx\">keyCode</span> <span class=\"o\">===</span> <span class=\"mi\">9</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"c1\">// 次の要素にフォーカスが移らないようにする</span>\n      <span class=\"nx\">$event</span><span class=\"p\">.</span><span class=\"nx\">preventDefault</span><span class=\"p\">();</span>\n\n      <span class=\"c1\">// 現在のキャレット位置を取得</span>\n      <span class=\"kd\">const</span> <span class=\"nx\">caretStart</span> <span class=\"o\">=</span> <span class=\"nx\">textareaElement</span><span class=\"p\">.</span><span class=\"nx\">selectionStart</span><span class=\"p\">;</span>\n      <span class=\"kd\">const</span> <span class=\"nx\">caretEnd</span> <span class=\"o\">=</span> <span class=\"nx\">textareaElement</span><span class=\"p\">.</span><span class=\"nx\">selectionEnd</span><span class=\"p\">;</span>\n\n      <span class=\"c1\">// テキストエリアの値を取得し、キャレット位置にTabを挿入</span>\n      <span class=\"kd\">const</span> <span class=\"nx\">TAB</span> <span class=\"o\">=</span> <span class=\"s1\">'¥t'</span><span class=\"p\">;</span>\n      <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">.</span><span class=\"nx\">value</span> <span class=\"o\">=</span> <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">.</span><span class=\"nx\">value</span><span class=\"p\">.</span><span class=\"nx\">substring</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"nx\">caretStart</span><span class=\"p\">)</span>\n                     <span class=\"o\">+</span> <span class=\"nx\">TAB</span> <span class=\"o\">+</span> <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">.</span><span class=\"nx\">value</span><span class=\"p\">.</span><span class=\"nx\">substring</span><span class=\"p\">(</span><span class=\"nx\">caretStart</span><span class=\"p\">,</span> <span class=\"nx\">value</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n\n      <span class=\"c1\">// キャレット位置をTab分ずらす</span>\n      <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">.</span><span class=\"nx\">focus</span><span class=\"p\">();</span>\n      <span class=\"nx\">sampleTextAreaElement</span><span class=\"p\">.</span><span class=\"nx\">setSelectionRange</span><span class=\"p\">(</span><span class=\"nx\">caretStart</span> <span class=\"o\">+</span> <span class=\"nx\">TAB</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">,</span> <span class=\"nx\">caretEnd</span> <span class=\"o\">+</span> <span class=\"nx\">TAB</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n\n      <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n</pre></div>\n</div>\n\n<h2>\n<span id=\"markdownプレビューを表示したいソースコードはシンタックスハイライトさせたい\" class=\"fragment\"></span><a href=\"#markdown%E3%83%97%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%82%92%E8%A1%A8%E7%A4%BA%E3%81%97%E3%81%9F%E3%81%84%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AF%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%E3%81%95%E3%81%9B%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>Markdownプレビューを表示したい、ソースコードはシンタックスハイライトさせたい</h2>\n\n<p><a href=\"https://github.com/chjj/marked\" rel=\"nofollow noopener\" target=\"_blank\">marked</a>と<a href=\"https://github.com/isagalaev/highlight.js\" rel=\"nofollow noopener\" target=\"_blank\">highlight.js</a>を組み合わせて使います。<br>\n<a href=\"https://github.com/chjj/marked\" rel=\"nofollow noopener\" target=\"_blank\">marked</a>のReadmeを見ればなんとなくわかりますが、Angularの仕組みに乗せる必要があるのでPipeやらServiceやらを作ります。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">markdown-parse.service.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Injectable</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"nx\">marked</span> <span class=\"k\">from</span> <span class=\"s1\">'marked'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"nx\">hljs</span> <span class=\"k\">from</span> <span class=\"s1\">'highlight.js'</span><span class=\"p\">;</span>\n\n\n<span class=\"p\">@</span><span class=\"nd\">Injectable</span><span class=\"p\">()</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">MarkdownParseService</span> <span class=\"p\">{</span>\n\n  <span class=\"kd\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"nx\">marked</span><span class=\"p\">.</span><span class=\"nx\">setOptions</span><span class=\"p\">({</span>\n      <span class=\"na\">highlight</span><span class=\"p\">:</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">code</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">return</span> <span class=\"nx\">hljs</span><span class=\"p\">.</span><span class=\"nx\">highlightAuto</span><span class=\"p\">(</span><span class=\"nx\">code</span><span class=\"p\">).</span><span class=\"nx\">value</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">});</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">parse</span><span class=\"p\">(</span><span class=\"na\">rawText</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"nx\">marked</span><span class=\"p\">(</span><span class=\"nx\">rawText</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">markdown.pipe.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"nx\">marked</span> <span class=\"k\">from</span> <span class=\"s1\">'marked'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Pipe</span><span class=\"p\">,</span> <span class=\"nx\">PipeTransform</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">MarkdownParseService</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./markdown-parse.service'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Pipe</span><span class=\"p\">({</span> <span class=\"na\">name</span><span class=\"p\">:</span> <span class=\"s1\">'toMarkdown'</span> <span class=\"p\">})</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">MarkdownParsePipe</span> <span class=\"kr\">implements</span> <span class=\"nx\">PipeTransform</span> <span class=\"p\">{</span>\n  <span class=\"kd\">constructor</span><span class=\"p\">(</span><span class=\"nx\">markdownParseService</span><span class=\"p\">:</span> <span class=\"nx\">MarkdownParseService</span><span class=\"p\">)</span> <span class=\"p\">{}</span>\n\n  <span class=\"nx\">transform</span><span class=\"p\">(</span><span class=\"nx\">value</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">):</span> <span class=\"nx\">any</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">markdownParseService</span><span class=\"p\">.</span><span class=\"nx\">parse</span><span class=\"p\">(</span><span class=\"nx\">value</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<p>HTMLで下記のように指定します。<code>{{}}</code>だとサニタイズされてしまうので<code>innerHTML</code>属性を指定します。</p>\n\n<div class=\"code-frame\" data-lang=\"html\"><div class=\"highlight\"><pre><span class=\"nt\">&lt;div</span> <span class=\"err\">[</span><span class=\"na\">innerHTML</span><span class=\"err\">]=\"</span><span class=\"na\">md</span> <span class=\"err\">|</span> <span class=\"na\">toMarkdown</span><span class=\"err\">\"</span><span class=\"nt\">&gt;&lt;/div&gt;</span>\n</pre></div></div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://qiita.com/daikiojm/items/e02e2aeb0231b3620a0b\" id=\"reference-9001a931765f8f52acaf\">Qiita AngularでMarkdownをHTMLとして表示するカスタムpipeを作成する</a></li>\n<li>Github <a href=\"https://github.com/chjj/marked\" rel=\"nofollow noopener\" target=\"_blank\">chjj/marked</a>\n</li>\n</ul>\n\n<h2>\n<span id=\"絞り込み条件付きリストにおいてリストの要素が変更追加削除された時に絞り込み結果をリフレッシュしたい\" class=\"fragment\"></span><a href=\"#%E7%B5%9E%E3%82%8A%E8%BE%BC%E3%81%BF%E6%9D%A1%E4%BB%B6%E4%BB%98%E3%81%8D%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AB%E3%81%8A%E3%81%84%E3%81%A6%E3%83%AA%E3%82%B9%E3%83%88%E3%81%AE%E8%A6%81%E7%B4%A0%E3%81%8C%E5%A4%89%E6%9B%B4%E8%BF%BD%E5%8A%A0%E5%89%8A%E9%99%A4%E3%81%95%E3%82%8C%E3%81%9F%E6%99%82%E3%81%AB%E7%B5%9E%E3%82%8A%E8%BE%BC%E3%81%BF%E7%B5%90%E6%9E%9C%E3%82%92%E3%83%AA%E3%83%95%E3%83%AC%E3%83%83%E3%82%B7%E3%83%A5%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>絞り込み条件付きリストにおいて、リストの要素が変更、追加、削除された時に絞り込み結果をリフレッシュしたい</h2>\n\n<p>リストの絞り込みはPipeで実現しますが、通常Pipeはリストの要素が変更されても再び絞り込みが実施されることはありません。<br>\nこのような場合はPipeアノテーションにて<strong>pureオプションをfalseに設定</strong>ましょう。</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">HTML</span></div>\n<div class=\"highlight\"><pre><span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">\"text\"</span> <span class=\"err\">#</span><span class=\"na\">searchUserName</span><span class=\"nt\">&gt;</span>\n<span class=\"nt\">&lt;ul&gt;</span>\n  <span class=\"nt\">&lt;li</span> <span class=\"err\">*</span><span class=\"na\">ngFor=</span><span class=\"s\">\"let user of (userList | searchUserFilter: searchUserName.value);\"</span> <span class=\"nt\">&gt;</span>{{user.name}}<span class=\"nt\">&lt;/li&gt;</span>\n<span class=\"nt\">&lt;ul&gt;</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">search-user.pipe.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">Pipe</span><span class=\"p\">,</span> <span class=\"nx\">PipeTransform</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'@angular/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span> <span class=\"nx\">User</span> <span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./user'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Pipe</span><span class=\"p\">({</span>\n  <span class=\"na\">name</span><span class=\"p\">:</span> <span class=\"s1\">'searchUserFilter'</span><span class=\"p\">,</span>\n  <span class=\"na\">pure</span><span class=\"p\">:</span> <span class=\"kc\">false</span> <span class=\"c1\">// pureをfalseにすることでユーザが変更、追加、削除された時にリフレッシュできる</span>\n<span class=\"p\">})</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">SearchFilterPipe</span> <span class=\"kr\">implements</span> <span class=\"nx\">PipeTransform</span> <span class=\"p\">{</span>\n  <span class=\"nx\">transform</span><span class=\"p\">(</span><span class=\"nx\">items</span><span class=\"p\">:</span> <span class=\"nb\">Array</span><span class=\"o\">&lt;</span><span class=\"nx\">User</span><span class=\"o\">&gt;</span><span class=\"p\">,</span> <span class=\"nx\">searchUserName</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">):</span> <span class=\"nx\">any</span><span class=\"p\">[]</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">searchUserName</span><span class=\"p\">)</span> <span class=\"k\">return</span> <span class=\"nx\">items</span><span class=\"p\">;</span>\n\n    <span class=\"nx\">searchUserName</span> <span class=\"o\">=</span> <span class=\"nx\">searchUserName</span><span class=\"p\">.</span><span class=\"nx\">toLowerCase</span><span class=\"p\">();</span>\n    <span class=\"k\">return</span> <span class=\"nx\">items</span><span class=\"p\">.</span><span class=\"nx\">filter</span><span class=\"p\">(</span> <span class=\"nx\">item</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">user</span><span class=\"p\">.</span><span class=\"nx\">userId</span><span class=\"p\">.</span><span class=\"nx\">toLowerCase</span><span class=\"p\">().</span><span class=\"nx\">includes</span><span class=\"p\">(</span><span class=\"nx\">searchUserName</span><span class=\"p\">));</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://angular.io/guide/pipes#pure-and-impure-pipes\" rel=\"nofollow noopener\" target=\"_blank\">Angular公式サイト</a></li>\n</ul>\n\n<h2>\n<span id=\"グローバル定数を定義したい\" class=\"fragment\"></span><a href=\"#%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%AE%9A%E6%95%B0%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>グローバル定数を定義したい</h2>\n\n<p>いろんなクラスで使う定数を共通化する時は、単純に<strong>クラスを作ってstaticなメンバとして定数を定義</strong>します。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">app-settings.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">AppSettings</span> <span class=\"p\">{</span>\n   <span class=\"kr\">public</span> <span class=\"kr\">static</span> <span class=\"nx\">API_ENDPOINT</span><span class=\"o\">=</span><span class=\"s1\">'http://127.0.0.1:6666/api/'</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">SampleService</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">Injectable</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'angular2/core'</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"p\">{</span><span class=\"nx\">AppSettings</span><span class=\"p\">}</span> <span class=\"k\">from</span> <span class=\"s1\">'./app-settings'</span><span class=\"p\">;</span>\n\n<span class=\"p\">@</span><span class=\"nd\">Injectable</span><span class=\"p\">()</span>\n<span class=\"k\">export</span> <span class=\"kd\">class</span> <span class=\"nx\">SampleService</span> <span class=\"p\">{</span>\n    <span class=\"nx\">sampleMethod</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n      <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">AppSettings</span><span class=\"p\">.</span><span class=\"nx\">API_ENDPOINT</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>\n</div>\n\n<p><strong>参考</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/34986922/define-global-constants-in-angular-2\" rel=\"nofollow noopener\" target=\"_blank\">StackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"画像が多い画面の初期表示を早くしたい\" class=\"fragment\"></span><a href=\"#%E7%94%BB%E5%83%8F%E3%81%8C%E5%A4%9A%E3%81%84%E7%94%BB%E9%9D%A2%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A1%A8%E7%A4%BA%E3%82%92%E6%97%A9%E3%81%8F%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>画像が多い画面の初期表示を早くしたい</h2>\n\n<p><a href=\"https://github.com/tjoskar/ng-lazyload-image\" rel=\"nofollow noopener\" target=\"_blank\">ng-lazyload-image</a>を使えば画像の遅延ロードを実現できます。<br>\n使い方もとても簡単でimgタグにディレクティブを指定するだけです。</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">HTML</span></div>\n<div class=\"highlight\"><pre> <span class=\"nt\">&lt;img</span>\n  <span class=\"err\">[</span><span class=\"na\">defaultImage</span><span class=\"err\">]=\"</span><span class=\"na\">https:</span><span class=\"err\">//</span><span class=\"na\">images</span><span class=\"err\">.</span><span class=\"na\">sample</span><span class=\"err\">.</span><span class=\"na\">com</span><span class=\"err\">/</span><span class=\"na\">photo</span><span class=\"err\">/</span><span class=\"na\">defaultimage</span><span class=\"err\">\"</span> \n  <span class=\"err\">[</span><span class=\"na\">lazyLoad</span><span class=\"err\">]=\"</span><span class=\"na\">https:</span><span class=\"err\">//</span><span class=\"na\">images</span><span class=\"err\">.</span><span class=\"na\">sample</span><span class=\"err\">.</span><span class=\"na\">com</span><span class=\"err\">/</span><span class=\"na\">photo</span><span class=\"err\">/</span><span class=\"na\">sampleimage</span><span class=\"err\">\"</span>\n  <span class=\"err\">[</span><span class=\"na\">offset</span><span class=\"err\">]=\"</span><span class=\"na\">30</span><span class=\"err\">\"</span>\n <span class=\"nt\">&gt;</span>\n</pre></div>\n</div>\n\n<p><em>defaultImage</em><br>\n　即時ロードされる画像のURL、遅延ロードする画像を読み込む間、表示される<br>\n<em>lazyLoad</em><br>\n　遅延ロードする画像のURL<br>\n<em>offset</em><br>\n　スクロールが発生する場合に画面下部の何ピクセル下に来た時にロードを開始するか<br>\n<em>errorImage</em><br>\n　遅延ロード失敗時に表示する画像URL</p>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://github.com/tjoskar/ng-lazyload-image\" rel=\"nofollow noopener\" target=\"_blank\">ng-lazyload-image</a></li>\n</ul>\n\n<h2>\n<span id=\"angular-cliのng-serveコマンドでdistフォルダを一旦削除したくない\" class=\"fragment\"></span><a href=\"#angular-cli%E3%81%AEng-serve%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%A7dist%E3%83%95%E3%82%A9%E3%83%AB%E3%83%80%E3%82%92%E4%B8%80%E6%97%A6%E5%89%8A%E9%99%A4%E3%81%97%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"></i></a>Angular Cliの<code>ng serve</code>コマンドでdistフォルダを一旦削除したくない</h2>\n\n<p><code>ng serve</code>コマンドは<code>dist</code>フォルダを削除してからtsファイルをトランスコンパイルします。<br>\nそれを防ぐためには、<strong>delete-output-pathオプションをfalse</strong>に指定します。</p>\n\n<div class=\"code-frame\" data-lang=\"json\">\n<div class=\"code-lang\"><span class=\"bold\">package.json　ビルドスクリプト</span></div>\n<div class=\"highlight\"><pre><span class=\"s2\">\"script\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"s2\">\"build\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"cp ./resource/* dist &amp;&amp; ng serve --delete-output-path=false\"</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://github.com/angular/angular-cli/issues/4366\" rel=\"nofollow noopener\" target=\"_blank\">angular-cli github issue #4366</a></li>\n</ul>\n\n<h2>\n<span id=\"aotコンパイルが遅いのでなんとかしたい\" class=\"fragment\"></span><a href=\"#aot%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB%E3%81%8C%E9%81%85%E3%81%84%E3%81%AE%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>AOTコンパイルが遅いのでなんとかしたい</h2>\n\n<p>なんとかできませんでした。。。(もしかしたら方法があるのかもしれません。誰か教えてください!!!)<br>\nAOTコンパイルはJITコンパイルが検出してくれないHTMLのエラーを警告してくれますが、その反面遅いです。特に<a href=\"https://material.angular.io/\" rel=\"nofollow noopener\" target=\"_blank\">Angular Material</a>を使う場合は顕著です。<br>\nそのため、自分の場合は基本的にJITビルドを使い、issueのプルリクをする前など区切りのいいタイミングでAOTビルドしてエラーがないか確認するというように使い分けてました。</p>\n\n<h1>\n<span id=\"2-フロント側angularでのテスト周り\" class=\"fragment\"></span><a href=\"#2-%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E5%81%B4angular%E3%81%A7%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E5%91%A8%E3%82%8A\"><i class=\"fa fa-link\"></i></a>2. フロント側Angularでのテスト周り</h1>\n\n<h2>\n<span id=\"ci環境などでテストが終わらずにタイムアウトしてしまう\" class=\"fragment\"></span><a href=\"#ci%E7%92%B0%E5%A2%83%E3%81%AA%E3%81%A9%E3%81%A7%E3%83%86%E3%82%B9%E3%83%88%E3%81%8C%E7%B5%82%E3%82%8F%E3%82%89%E3%81%9A%E3%81%AB%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%A2%E3%82%A6%E3%83%88%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%86\"><i class=\"fa fa-link\"></i></a>CI環境などでテストが終わらずにタイムアウトしてしまう</h2>\n\n<p>CirleCiなどでテストを実行する場合<code>ng test</code>コマンドだとプロセスが終了しないためタイムアウトで失敗してしまいます。<br>\nこのような場合は<strong>watchオプションをfalseに設定</strong>します。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>ng test --wtach=false\n</pre></div></div>\n\n<p><strong>参考サイト</strong><br>\n<a href=\"https://github.com/angular/angular-cli/issues/362\" rel=\"nofollow noopener\" target=\"_blank\">Github isssue</a></p>\n\n<h2>\n<span id=\"テスト時にerror-timeout---async-callback-was-not-invoked-within-timeout-specified-by-jasminedefault_timeout_intervalやfailed-to-execute-send-on-xmlhttprequestのエラー\" class=\"fragment\"></span><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E6%99%82%E3%81%ABerror-timeout---async-callback-was-not-invoked-within-timeout-specified-by-jasminedefault_timeout_interval%E3%82%84failed-to-execute-send-on-xmlhttprequest%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC\"><i class=\"fa fa-link\"></i></a>テスト時に「Error: Timeout - Async callback was not invoked within timeout specified by jasmine.DEFAULT_TIMEOUT_INTERVAL.」や「Failed to execute 'send' on 'XMLHttpRequest'」のエラー</h2>\n\n<p>このような場合は、一時的に<code>ng test</code>コマンドのオプションに<strong><code>-sm=false</code>を追加</strong>してテストし直すと根本原因エラーメッセージで出力されるようになります。<br>\n大抵の場合は自作したモッククラスに必要なメソッドがないことが原因です。</p>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/45399079/angular-tests-failing-with-failed-to-execute-send-on-xmlhttprequest\" rel=\"nofollow noopener\" target=\"_blank\">stackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"テスト用に子コンポーネントをモック化したい\" class=\"fragment\"></span><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E7%94%A8%E3%81%AB%E5%AD%90%E3%82%B3%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%8D%E3%83%B3%E3%83%88%E3%82%92%E3%83%A2%E3%83%83%E3%82%AF%E5%8C%96%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>テスト用に子コンポーネントをモック化したい</h2>\n\n<p>意外と簡単で、TestBed#configureTestingModuleで<br>\ndeclarationsに自作したモックの子コンポーネントを追加するだけです。<br>\ninput,outputがあれば必要に応じてメンバ定義します。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\"><div class=\"highlight\"><pre><span class=\"c1\">// ※import文は省略</span>\n\n<span class=\"c1\">// モックの子コンポーネントを定義</span>\n<span class=\"p\">@</span><span class=\"nd\">Component</span><span class=\"p\">({</span>\n  <span class=\"na\">selector</span><span class=\"p\">:</span> <span class=\"s1\">'app-child'</span><span class=\"p\">,</span> <span class=\"c1\">// 子コンポーネントと同じものを定義</span>\n  <span class=\"na\">template</span><span class=\"p\">:</span> <span class=\"s1\">'&lt;p&gt;Mock Child Component&lt;/p&gt;'</span>\n<span class=\"p\">})</span>\n<span class=\"kd\">class</span> <span class=\"nx\">MockClildComponent</span> <span class=\"p\">{</span>\n  <span class=\"p\">@</span><span class=\"nd\">Input</span><span class=\"p\">()</span> <span class=\"nx\">childInput</span><span class=\"p\">:</span> <span class=\"nx\">string</span><span class=\"p\">;</span>\n  <span class=\"p\">@</span><span class=\"nd\">Output</span><span class=\"p\">()</span> <span class=\"nx\">childOutput</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">EventEmitter</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ...</span>\n\n<span class=\"nx\">beforeEach</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">TestBed</span><span class=\"p\">.</span><span class=\"nx\">configureTestingModule</span><span class=\"p\">({</span>\n    <span class=\"na\">declarations</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"c1\">// テスト時のdeclarationsにモックの定義を追加</span>\n      <span class=\"nx\">MockProductSettingsComponent</span><span class=\"p\">,</span>\n      <span class=\"c1\">// ...</span>\n    <span class=\"p\">],</span>\n    <span class=\"c1\">// ...</span>\n  <span class=\"p\">});</span>\n  <span class=\"c1\">// ...</span>\n<span class=\"p\">});</span>\n</pre></div></div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/41240163/mocking-child-components-angular-2\" rel=\"nofollow noopener\" target=\"_blank\">stackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"テスト結果にangular-materilaのスタイルが反映されない\" class=\"fragment\"></span><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E7%B5%90%E6%9E%9C%E3%81%ABangular-materila%E3%81%AE%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%8C%E5%8F%8D%E6%98%A0%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"></i></a>テスト結果にAngular Materilaのスタイルが反映されない</h2>\n\n<p>UIフレームワークで<a href=\"https://material.angular.io/\" rel=\"nofollow noopener\" target=\"_blank\">Angular Material</a>を使っている場合、<br>\n<code>karma.config.js</code>でAngular Materilaのcssを直接読み込んであげる必要あります。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\">\n<div class=\"code-lang\"><span class=\"bold\">karma.conf.js</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">files</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n      <span class=\"err\">・・・</span>\n      <span class=\"c1\">// Angular Materialのスタイルをテスト開始時に読み込んでおく</span>\n      <span class=\"p\">{</span><span class=\"nl\">pattern</span><span class=\"p\">:</span> <span class=\"s1\">'./node_modules/@angular/material/prebuilt-themes/indigo-pink.css'</span><span class=\"p\">,</span> <span class=\"nx\">included</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"nx\">watched</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">},</span>\n<span class=\"p\">],</span>\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://github.com/angular/material2/issues/4056\" rel=\"nofollow noopener\" target=\"_blank\">stackoverflow</a></li>\n</ul>\n\n<h2>\n<span id=\"テスト結果にstylesscssアプリ共通のスタイル定義のスタイルが反映されない\" class=\"fragment\"></span><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E7%B5%90%E6%9E%9C%E3%81%ABstylesscss%E3%82%A2%E3%83%97%E3%83%AA%E5%85%B1%E9%80%9A%E3%81%AE%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E5%AE%9A%E7%BE%A9%E3%81%AE%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB%E3%81%8C%E5%8F%8D%E6%98%A0%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"></i></a>テスト結果にstyles.scss(アプリ共通のスタイル定義)のスタイルが反映されない</h2>\n\n<p>アプリ共通スタイルをSASS形式にしている場合<br>\n開発用ライブライに<code>karma-scss-preprocessor</code>と<code>node-sass</code>を追加して<code>karma.conf.js</code>を下記のように設定します。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\">\n<div class=\"code-lang\"><span class=\"bold\">karma.conf.js</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">plugins</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n  <span class=\"err\">・・・</span>\n<span class=\"err\">　</span> <span class=\"c1\">// プラグインに`karma-scss-preprocessor`を追加</span>\n  <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'karma-scss-preprocessor'</span><span class=\"p\">)</span>\n<span class=\"p\">],</span>\n\n\n<span class=\"nx\">files</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n  <span class=\"err\">・・・</span>\n  <span class=\"c1\">// filesにアプリ共通スタイルを追加</span>\n  <span class=\"p\">{</span> <span class=\"nl\">pattern</span><span class=\"p\">:</span> <span class=\"s1\">'./src/styles.scss'</span><span class=\"p\">,</span> <span class=\"nx\">watched</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>  <span class=\"nx\">included</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span> <span class=\"nx\">served</span><span class=\"p\">:</span> <span class=\"kc\">true</span> <span class=\"p\">}</span>\n<span class=\"p\">],</span>\n\n<span class=\"c1\">// preprocessorsを追加</span>\n<span class=\"nx\">preprocessors</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n <span class=\"s1\">'./src/test.ts'</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s1\">'@angular/cli'</span><span class=\"p\">],</span>\n <span class=\"s1\">'./src/styles.scss'</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"s1\">'scss'</span><span class=\"p\">]</span>\n<span class=\"p\">},</span>\n</pre></div>\n</div>\n\n<p><strong>参考サイト</strong>:</p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/44460733/how-to-configure-karma-to-include-global-scss-files-for-an-angular-cli-project/44498689#44498689\" rel=\"nofollow noopener\" target=\"_blank\">stackOverFlow</a></li>\n<li><a href=\"https://github.com/karma-runner/karma/issues/2700\" rel=\"nofollow noopener\" target=\"_blank\">Github karma/issue/2700</a></li>\n</ul>\n\n<h1>\n<span id=\"3-バックエンド側-expressmongodb周り\" class=\"fragment\"></span><a href=\"#3-%E3%83%90%E3%83%83%E3%82%AF%E3%82%A8%E3%83%B3%E3%83%89%E5%81%B4-expressmongodb%E5%91%A8%E3%82%8A\"><i class=\"fa fa-link\"></i></a>3. バックエンド側 Express、MongoDB周り</h1>\n\n<p>※MongDBをNode.jsで扱う場合は<a href=\"https://github.com/Automattic/mongoose\" rel=\"nofollow noopener\" target=\"_blank\">mongoose</a>という便利なライブラリがあるのでそれを使う前提のお話です。</p>\n\n<h2>\n<span id=\"mongooseのvirtualメソッドを使う\" class=\"fragment\"></span><a href=\"#mongoose%E3%81%AEvirtual%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%82%92%E4%BD%BF%E3%81%86\"><i class=\"fa fa-link\"></i></a>mongooseのvirtualメソッドを使う</h2>\n\n<p>例えば<code>記事</code>,<code>コメント</code>,<code>リプライ</code>などのモデルを定義する場合、<br>\n３つのモデルのライフサイクルは、記事追加 =&gt; 記事に対するコメント追加 =&gt; コメントに対するリプライ追加　のようになります。<br>\nこのような場合は、コメントが記事の参照を持ち、リプライがコメントの参照を持つモデル構造が望ましいです。コメントやリプライ追加時に１つのモデルの更新だけですむからです。<br>\n<a href=\"https://camo.qiitausercontent.com/129a84bd908d87c7fcbda29704ad50ac10529129/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66393361633065362d333137652d316364662d626662612d3133353331653234353562612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/129a84bd908d87c7fcbda29704ad50ac10529129/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66393361633065362d333137652d316364662d626662612d3133353331653234353562612e706e67\" alt=\"db構造_良.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/f93ac0e6-317e-1cdf-bfba-13531e2455ba.png\"></a></p>\n\n<p>ただ記事の検索は少し工夫が必要で、<strong>mongooseのvirtualを使います</strong>。これによって記事からコメントへの参照、コメントからリプライへの参照を擬似的に定義できるため、<br>\n検索時に擬似要素をpopulateするだけで、記事に紐付くコメントとリプライを取得できるようになります。<br>\n<a href=\"https://camo.qiitausercontent.com/bd8d4eedcb08eeaca13290e8dc91b8b2e10c5dae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34616162376633382d316631392d653030622d623335642d3233626162663336613735622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/bd8d4eedcb08eeaca13290e8dc91b8b2e10c5dae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34616162376633382d316631392d653030622d623335642d3233626162663336613735622e706e67\" alt=\"mongoose virtualのイメージ.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/4aab7f38-1f19-e00b-b35d-23babf36a75b.png\"></a></p>\n\n<p>具体的なソースコードを示します。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">article.model.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">mongoose</span> <span class=\"k\">from</span> <span class=\"s1\">'mongoose'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">ArticleSchema</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">({</span>\n  <span class=\"na\">content</span><span class=\"p\">:</span> <span class=\"nb\">String</span>\n<span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"na\">toJSON</span><span class=\"p\">:</span> <span class=\"p\">{</span> <span class=\"na\">virtuals</span><span class=\"p\">:</span> <span class=\"kc\">true</span> <span class=\"p\">}</span> <span class=\"p\">});</span>\n\n\n<span class=\"c1\">// 記事に紐付くコメントモデルの配列をcommentsという擬似要素で定義する</span>\n<span class=\"nx\">ArticleSchema</span><span class=\"p\">.</span><span class=\"nx\">virtual</span><span class=\"p\">(</span><span class=\"s1\">'comments'</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"na\">ref</span><span class=\"p\">:</span> <span class=\"s1\">'Comment'</span><span class=\"p\">,</span>\n  <span class=\"na\">localField</span><span class=\"p\">:</span> <span class=\"s1\">'_id'</span><span class=\"p\">,</span>\n  <span class=\"na\">foreignField</span><span class=\"p\">:</span> <span class=\"s1\">'articleId'</span><span class=\"p\">,</span>\n  <span class=\"na\">justOne</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n<span class=\"p\">});</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">Article</span> <span class=\"o\">=</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">model</span><span class=\"p\">(</span><span class=\"s1\">'Article'</span><span class=\"p\">,</span> <span class=\"nx\">ArticleSchema</span><span class=\"p\">);</span>\n\n<span class=\"k\">export</span> <span class=\"p\">{</span> <span class=\"nx\">Article</span> <span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">comment.model.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">mongoose</span> <span class=\"k\">from</span> <span class=\"s1\">'mongoose'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">CommentSchema</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">({</span>\n  <span class=\"na\">articleId</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">.</span><span class=\"nx\">Types</span><span class=\"p\">.</span><span class=\"nx\">ObjectId</span><span class=\"p\">,</span>\n    <span class=\"na\">ref</span><span class=\"p\">:</span> <span class=\"s1\">'Article'</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"na\">comment</span><span class=\"p\">:</span> <span class=\"nb\">String</span><span class=\"p\">;</span>\n<span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"na\">toJSON</span><span class=\"p\">:</span> <span class=\"p\">{</span> <span class=\"na\">virtuals</span><span class=\"p\">:</span> <span class=\"kc\">true</span> <span class=\"p\">}</span> <span class=\"p\">});</span>\n\n<span class=\"c1\">// コメントに紐付くリプライモデルの配列をrepliesという擬似要素で定義する</span>\n<span class=\"nx\">CommentSchema</span><span class=\"p\">.</span><span class=\"nx\">virtual</span><span class=\"p\">(</span><span class=\"s1\">'replies'</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"na\">ref</span><span class=\"p\">:</span> <span class=\"s1\">'Reply'</span><span class=\"p\">,</span>\n  <span class=\"na\">localField</span><span class=\"p\">:</span> <span class=\"s1\">'_id'</span><span class=\"p\">,</span>\n  <span class=\"na\">foreignField</span><span class=\"p\">:</span> <span class=\"s1\">'commentId'</span><span class=\"p\">,</span>\n  <span class=\"na\">justOne</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n<span class=\"p\">});</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">Comment</span> <span class=\"o\">=</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">model</span><span class=\"p\">(</span><span class=\"s1\">'Comment'</span><span class=\"p\">,</span> <span class=\"nx\">CommentSchema</span><span class=\"p\">);</span>\n\n<span class=\"k\">export</span> <span class=\"p\">{</span> <span class=\"nx\">Comment</span> <span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">reply.model.ts</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">import</span> <span class=\"o\">*</span> <span class=\"k\">as</span> <span class=\"nx\">mongoose</span> <span class=\"k\">from</span> <span class=\"s1\">'mongoose'</span><span class=\"p\">;</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">ReplySchema</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">({</span>\n  <span class=\"na\">commentId</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">Schema</span><span class=\"p\">.</span><span class=\"nx\">Types</span><span class=\"p\">.</span><span class=\"nx\">ObjectId</span><span class=\"p\">,</span>\n    <span class=\"na\">ref</span><span class=\"p\">:</span> <span class=\"s1\">'Comment'</span>\n  <span class=\"p\">},</span>\n  <span class=\"na\">reply</span><span class=\"p\">:</span> <span class=\"nb\">String</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"kd\">const</span> <span class=\"nx\">Reply</span> <span class=\"o\">=</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">model</span><span class=\"p\">(</span><span class=\"s1\">'Reply'</span><span class=\"p\">,</span> <span class=\"nx\">ReplySchema</span><span class=\"p\">);</span>\n\n<span class=\"k\">export</span> <span class=\"p\">{</span> <span class=\"nx\">Reply</span> <span class=\"p\">};</span>\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">検索処理</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">Article</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">()</span>\n<span class=\"p\">.</span><span class=\"nx\">populate</span><span class=\"p\">({</span>\n  <span class=\"na\">path</span><span class=\"p\">:</span> <span class=\"s1\">'comments'</span><span class=\"p\">,</span> <span class=\"c1\">// Articleモデルで定義した擬似要素commentsをpopulateする</span>\n  <span class=\"na\">populate</span><span class=\"p\">:</span> <span class=\"p\">[{</span>\n    <span class=\"na\">path</span><span class=\"p\">:</span> <span class=\"s1\">'replies'</span><span class=\"p\">,</span> <span class=\"c1\">// Commentモデルで定義した擬似要素repliesをpopulateする</span>\n  <span class=\"p\">}],</span>\n<span class=\"p\">});</span>\n</pre></div>\n</div>\n\n<h2>\n<span id=\"リクエストレスポンスのログ出力したい\" class=\"fragment\"></span><a href=\"#%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%81%AE%E3%83%AD%E3%82%B0%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>リクエスト、レスポンスのログ出力したい</h2>\n\n<p>Expressのuseにて実現します。<br>\nレスポンスオブジェクトのfinishイベントを監視することで、レスポンス時にログを出力しています。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\">\n<div class=\"code-lang\"><span class=\"bold\">リクエストとレスポンスのログ出力　※ここでは簡単のためコンソールに出力しています</span></div>\n<div class=\"highlight\"><pre><span class=\"kd\">const</span> <span class=\"nx\">express</span> <span class=\"o\">=</span> <span class=\"nx\">express</span><span class=\"p\">();</span>\n<span class=\"nx\">express</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kd\">function</span> <span class=\"nx\">accessLogHandler</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">start</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nb\">Date</span><span class=\"p\">();</span>\n  <span class=\"c1\">// リクエスト時のログ　</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">([</span>\n    <span class=\"s1\">'start'</span><span class=\"p\">,</span>\n    <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"s1\">'x-forwarded-for'</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">connection</span><span class=\"p\">.</span><span class=\"nx\">remoteAddress</span><span class=\"p\">,</span>\n    <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">method</span><span class=\"p\">,</span>\n    <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">url</span><span class=\"p\">,</span>\n    <span class=\"s1\">'-'</span><span class=\"p\">,</span>\n    <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">.</span><span class=\"nx\">referer</span> <span class=\"o\">||</span> <span class=\"s1\">'-'</span><span class=\"p\">,</span>\n    <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"s1\">'user-agent'</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"s1\">'-'</span><span class=\"p\">,</span>\n    <span class=\"s1\">'--ms--'</span>\n  <span class=\"p\">].</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"s1\">',</span><span class=\"err\">\\</span><span class=\"s1\">t'</span><span class=\"p\">));</span>\n\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">once</span><span class=\"p\">(</span><span class=\"s1\">'finish'</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n<span class=\"err\">　　</span> <span class=\"c1\">// レスポンス時のログ</span>\n    <span class=\"nx\">accessLogger</span><span class=\"p\">.</span><span class=\"nx\">info</span><span class=\"p\">([</span>\n      <span class=\"s1\">'end'</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"s1\">'x-forwarded-for'</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">connection</span><span class=\"p\">.</span><span class=\"nx\">remoteAddress</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">method</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">url</span><span class=\"p\">,</span>\n      <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">.</span><span class=\"nx\">referer</span> <span class=\"o\">||</span> <span class=\"s1\">'-'</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">[</span><span class=\"s1\">'user-agent'</span><span class=\"p\">]</span> <span class=\"o\">||</span> <span class=\"s1\">'-'</span><span class=\"p\">,</span>\n      <span class=\"s1\">'--'</span> <span class=\"o\">+</span> <span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Date</span><span class=\"p\">().</span><span class=\"nx\">getMilliseconds</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"nx\">start</span><span class=\"p\">.</span><span class=\"nx\">getMilliseconds</span><span class=\"p\">())</span> <span class=\"o\">+</span> <span class=\"s1\">'ms--'</span>\n    <span class=\"p\">].</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"s1\">',</span><span class=\"err\">\\</span><span class=\"s1\">t'</span><span class=\"p\">));</span>\n  <span class=\"p\">});</span>\n\n  <span class=\"nx\">next</span><span class=\"p\">();</span>\n<span class=\"p\">});</span>\n</pre></div>\n</div>\n\n<p>実際のログはこんな感じで出力されます。</p>\n\n<div class=\"code-frame\" data-lang=\"py3\"><div class=\"highlight\"><pre><span class=\"n\">start</span><span class=\"p\">,</span>  <span class=\"p\">::</span><span class=\"n\">ffff</span><span class=\"p\">:</span><span class=\"mf\">127.0</span><span class=\"o\">.</span><span class=\"mf\">0.1</span><span class=\"p\">,</span> <span class=\"n\">GET</span><span class=\"p\">,</span> <span class=\"o\">/</span><span class=\"n\">api</span><span class=\"o\">/</span><span class=\"n\">authenticate</span><span class=\"o\">/</span><span class=\"n\">check</span><span class=\"o\">-</span><span class=\"n\">state</span><span class=\"p\">,</span>   <span class=\"o\">-</span><span class=\"p\">,</span> <span class=\"n\">http</span><span class=\"p\">:</span><span class=\"o\">//</span><span class=\"n\">localhost</span><span class=\"p\">:</span><span class=\"mi\">4200</span><span class=\"o\">/</span><span class=\"p\">,</span> <span class=\"n\">Mozilla</span><span class=\"o\">/</span><span class=\"mf\">5.0</span> <span class=\"p\">(</span><span class=\"n\">Macintosh</span><span class=\"p\">;</span> <span class=\"n\">Intel</span> <span class=\"n\">Mac</span> <span class=\"n\">OS</span> <span class=\"n\">X</span> <span class=\"mi\">10</span><span class=\"n\">_12_6</span><span class=\"p\">)</span> <span class=\"n\">AppleWebKit</span><span class=\"o\">/</span><span class=\"mf\">537.36</span> <span class=\"p\">(</span><span class=\"n\">KHTML</span><span class=\"p\">,</span> <span class=\"n\">like</span> <span class=\"n\">Gecko</span><span class=\"p\">)</span> <span class=\"n\">Chrome</span><span class=\"o\">/</span><span class=\"mf\">62.0</span><span class=\"o\">.</span><span class=\"mf\">3202.94</span> <span class=\"n\">Safari</span><span class=\"o\">/</span><span class=\"mf\">537.36</span><span class=\"p\">,</span> <span class=\"o\">--</span><span class=\"n\">ms</span><span class=\"o\">--</span>\n<span class=\"n\">end</span><span class=\"p\">,</span>    <span class=\"p\">::</span><span class=\"n\">ffff</span><span class=\"p\">:</span><span class=\"mf\">127.0</span><span class=\"o\">.</span><span class=\"mf\">0.1</span><span class=\"p\">,</span> <span class=\"n\">GET</span><span class=\"p\">,</span> <span class=\"o\">/</span><span class=\"n\">check</span><span class=\"o\">-</span><span class=\"n\">state</span><span class=\"p\">,</span>                  <span class=\"mi\">403</span><span class=\"p\">,</span> <span class=\"n\">http</span><span class=\"p\">:</span><span class=\"o\">//</span><span class=\"n\">localhost</span><span class=\"p\">:</span><span class=\"mi\">4200</span><span class=\"o\">/</span><span class=\"p\">,</span> <span class=\"n\">Mozilla</span><span class=\"o\">/</span><span class=\"mf\">5.0</span> <span class=\"p\">(</span><span class=\"n\">Macintosh</span><span class=\"p\">;</span> <span class=\"n\">Intel</span> <span class=\"n\">Mac</span> <span class=\"n\">OS</span> <span class=\"n\">X</span> <span class=\"mi\">10</span><span class=\"n\">_12_6</span><span class=\"p\">)</span> <span class=\"n\">AppleWebKit</span><span class=\"o\">/</span><span class=\"mf\">537.36</span> <span class=\"p\">(</span><span class=\"n\">KHTML</span><span class=\"p\">,</span> <span class=\"n\">like</span> <span class=\"n\">Gecko</span><span class=\"p\">)</span> <span class=\"n\">Chrome</span><span class=\"o\">/</span><span class=\"mf\">62.0</span><span class=\"o\">.</span><span class=\"mf\">3202.94</span> <span class=\"n\">Safari</span><span class=\"o\">/</span><span class=\"mf\">537.36</span><span class=\"p\">,</span>  <span class=\"o\">--</span><span class=\"mi\">47</span><span class=\"n\">ms</span><span class=\"o\">--</span>\n</pre></div></div>\n\n<h2>\n<span id=\"ログ出力でオブジェクトの全プロパティを出力したい\" class=\"fragment\"></span><a href=\"#%E3%83%AD%E3%82%B0%E5%87%BA%E5%8A%9B%E3%81%A7%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E5%85%A8%E3%83%97%E3%83%AD%E3%83%91%E3%83%86%E3%82%A3%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>ログ出力でオブジェクトの全プロパティを出力したい</h2>\n\n<p>オブジェクトの中身をログで確認する時はNode.jsの<code>util.inspect()</code>を使います。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\"><div class=\"highlight\"><pre><span class=\"kd\">const</span> <span class=\"nx\">util</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">'util'</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"nx\">myObject</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n   <span class=\"s2\">\"a\"</span><span class=\"p\">:</span><span class=\"s2\">\"a\"</span><span class=\"p\">,</span>\n   <span class=\"s2\">\"b\"</span><span class=\"p\">:{</span>\n      <span class=\"s2\">\"c\"</span><span class=\"p\">:</span><span class=\"s2\">\"c\"</span><span class=\"p\">,</span>\n      <span class=\"s2\">\"d\"</span><span class=\"p\">:{</span>\n         <span class=\"s2\">\"e\"</span><span class=\"p\">:</span><span class=\"s2\">\"e\"</span><span class=\"p\">,</span>\n         <span class=\"s2\">\"f\"</span><span class=\"p\">:{</span>\n            <span class=\"s2\">\"g\"</span><span class=\"p\">:</span><span class=\"s2\">\"g\"</span><span class=\"p\">,</span>\n            <span class=\"s2\">\"h\"</span><span class=\"p\">:{</span>\n               <span class=\"s2\">\"i\"</span><span class=\"p\">:</span><span class=\"s2\">\"i\"</span>\n            <span class=\"p\">}</span>\n         <span class=\"p\">}</span>\n      <span class=\"p\">}</span>\n   <span class=\"p\">}</span>\n<span class=\"p\">};</span> \n\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">util</span><span class=\"p\">.</span><span class=\"nx\">inspect</span><span class=\"p\">(</span><span class=\"nx\">myObject</span><span class=\"p\">,</span> <span class=\"kc\">false</span><span class=\"p\">,</span> <span class=\"kc\">null</span><span class=\"p\">));</span>\n</pre></div></div>\n\n<p>このようなログが出力されます</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>{ a: 'a', b: { c: 'c', d: { e: 'e', f: [Object] } } }\n</pre></div></div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/10729276/how-can-i-get-the-full-object-in-node-jss-console-log-rather-than-object\" rel=\"nofollow noopener\" target=\"_blank\">StackOverFlow</a></li>\n</ul>\n\n<h2>\n<span id=\"環境変数で上書きできる定数を定義したい\" class=\"fragment\"></span><a href=\"#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%81%A7%E4%B8%8A%E6%9B%B8%E3%81%8D%E3%81%A7%E3%81%8D%E3%82%8B%E5%AE%9A%E6%95%B0%E3%82%92%E5%AE%9A%E7%BE%A9%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"></i></a>環境変数で上書きできる定数を定義したい</h2>\n\n<p>例えばサーバのポートなど環境個別に設定したくなるようなものは<br>\n環境変数で上書きできる定数にしておくと便利です。<br>\nNode.jsではprocess.env.変数名で環境変数が参照できるので下記のようにします。</p>\n\n<div class=\"code-frame\" data-lang=\"typescript\">\n<div class=\"code-lang\"><span class=\"bold\">定数定義</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">SERVER_PORT</span><span class=\"p\">:</span> <span class=\"nx\">string</span> <span class=\"o\">=</span> <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">SERVER_PORT</span> <span class=\"o\">||</span> <span class=\"s1\">'3000'</span><span class=\"p\">;</span><span class=\"err\">　</span><span class=\"c1\">// 環境変数SERVER_PORTが未指定の場合は3000となる</span>\n<span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">SERVER_HOST</span><span class=\"p\">:</span> <span class=\"nx\">string</span> <span class=\"o\">=</span> <span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">SERVER_HOST</span> <span class=\"o\">||</span> <span class=\"s1\">'localhost'</span><span class=\"p\">;</span> <span class=\"c1\">// 環境変数SERVER_HOSTが未指定の場合はlocalhostとなる</span>\n</pre></div>\n</div>\n\n<h2>\n<span id=\"db初回アクセスに失敗した場合にリトライされない\" class=\"fragment\"></span><a href=\"#db%E5%88%9D%E5%9B%9E%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%AB%E5%A4%B1%E6%95%97%E3%81%97%E3%81%9F%E5%A0%B4%E5%90%88%E3%81%AB%E3%83%AA%E3%83%88%E3%83%A9%E3%82%A4%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"></i></a>DB初回アクセスに失敗した場合にリトライされない</h2>\n\n<p>mongooseを使っていると、DB初回接続時にエラーが起きた時に、なぜか再接続処理してくれません。<br>\nDockerでアプリを配布する場合、アプリとMongoDBをdocker-composeで同時に立ち上げることがあると思いますが、まだMongoDBが起動しきってない状態でアプリからDBに接続しようとすると、アプリが異常終了してしまいます。これを防ぐには自力で再接続処理を実装する必要があります。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\"><div class=\"highlight\"><pre><span class=\"kd\">function</span> <span class=\"nx\">createConnection</span> <span class=\"p\">(</span><span class=\"nx\">dbURL</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">db</span> <span class=\"o\">=</span> <span class=\"nx\">mongoose</span><span class=\"p\">.</span><span class=\"nx\">createConnection</span><span class=\"p\">(</span><span class=\"nx\">dbURL</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">);</span>\n\n    <span class=\"nx\">db</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">'error'</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">.</span><span class=\"nx\">match</span><span class=\"p\">(</span><span class=\"sr\">/failed to connect to server .* on first connect/</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n            <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Date</span><span class=\"p\">(),</span> <span class=\"nb\">String</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">));</span>\n\n            <span class=\"nx\">setTimeout</span><span class=\"p\">(</span><span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n                <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s2\">\"Retrying first connect...\"</span><span class=\"p\">);</span>\n                <span class=\"nx\">db</span><span class=\"p\">.</span><span class=\"nx\">openUri</span><span class=\"p\">(</span><span class=\"nx\">dbURL</span><span class=\"p\">).</span><span class=\"k\">catch</span><span class=\"p\">(()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{});</span>\n            <span class=\"c1\">// 20秒後に再接続する</span>\n            <span class=\"p\">},</span> <span class=\"mi\">20</span> <span class=\"o\">*</span> <span class=\"mi\">1000</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n            <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Date</span><span class=\"p\">(),</span> <span class=\"nb\">String</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">));</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">});</span>\n\n    <span class=\"nx\">db</span><span class=\"p\">.</span><span class=\"nx\">once</span><span class=\"p\">(</span><span class=\"s1\">'open'</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s2\">\"Connection to db established.\"</span><span class=\"p\">);</span>\n    <span class=\"p\">});</span>\n\n    <span class=\"k\">return</span> <span class=\"nx\">db</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</pre></div></div>\n\n<p><strong>参考サイト</strong></p>\n\n<ul>\n<li><a href=\"https://github.com/Automattic/mongoose/issues/5169\" rel=\"nofollow noopener\" target=\"_blank\">Github mongooseのissue5169</a></li>\n</ul>\n","body":"[FUJITSU Advent Calendar 2017](https://qiita.com/advent-calendar/2017/fujitsu) 12日目の記事です。\n\nリッチでイマドキなデザインのアプリが作りたくて、\nここ４ヶ月ほど**MEAN**スタック(**M**ongoDB+**E**xpress+**A**ngular+**N**ode.js)でブログアプリを作っています。\n知識ゼロからのスタートでしたが、多くの方々がブログやStackOverFlowに情報を載せてくれているので、躓きながらもなんとかアプリ開発を進めることができました。\n\nこの記事では、フロントエンド初心者の自分がMEANスタックでアプリを作る時に躓いたことや、こういう機能を実現するにはどうすればいいか?などをまとめています。\nこれからをAngularを学ぼうとしている方、ExpressやMongoDBなどサーバーサイドJavaScriptを学ぼうとしている方の参考になればうれしいです。\n\n## アプリの紹介\n本線から脱線しますが、イントラでの使用を想定したQiitaのようなブログアプリです。デモ環境もあるのでよければ触ってみてください(モバイルには未対応ですが。。。)\n\n* [Github](https://github.com/Takumon/mean-blog)\n* [Dockerhub](https://hub.docker.com/r/takumon/mean-blog_auto/)\n* [デモ環境](https://material-blog-demo.herokuapp.com/) (ユーザID/パスは DemoUser / DemoUser1234# です)\n\nアプリキャプチャ その１ (記事詳細)\n![appdemo_detail.png](https://qiita-image-store.s3.amazonaws.com/0/49915/b8133317-fac2-bb9b-8f2d-13db896becf5.png)\n\nアプリキャプチャ その２ (記事一覧)\n![アプリ_スクリーンキャプチャ_記事一覧.png](https://qiita-image-store.s3.amazonaws.com/0/49915/950d1062-1ba4-63f6-fe53-cfe6d46430a4.png)\n\nアプリキャプチャ その３ (プロフィール)\n![アプリ_スクリーンキャプチャ_ ユーザ画面.png](https://qiita-image-store.s3.amazonaws.com/0/49915/325c7948-ce16-9c08-0b66-d3892e046aed.png)\n\n# 1. フロント側Angularまわり\n## Angularについて調べる時に古い情報を除外したい\n1系は`AngularJS`、2系以降は`Angular`と呼ばれており、1系と2系以降では大きく仕様が異なります。\nそのため検索する時は`Angualr2`などバージョンを指定したり、1系を除外するため\u001e`--AngularJS`をつけたり\u001dすると検索しやすいです。\n\n## HTMLのDOM\b要素を、別のDOM要素またはComponentから扱いたい\n要素に`#xxxxx`\bのように`#`始まりの名前をつけると、別の\bDOM要素から参照できます\n\n```html:HTML\n<input #phone placeholder=\"電話番号\"/>\n<!--  他のDOM要素からphonという変数名でDOM要素を参照できるようになる -->\n<button >(click)=\"callPhone\b(phone.value)\">\n```\n\n\bComponentから参照する場合は`@ViewChild`を使います\n\n```typescript:Component\n  // \bViewChildの引数に\b\b名前を文字列で指定します\n  @ViewChild('phone') phoneElement: phoneElement;\n\n  showPhoneValue() {\n    console.log(this.phoneElement.value);\n    )\n  }\n```\n\n\b**参考サイト**\n\n* [Angular公式サイト](https://angular.io/guide/template-syntax#ref-vars)\n* [StackOverFlow](https://stackoverflow.com/questions/32693061/how-can-i-select-an-element-in-a-component-template)\n\n\n\n## Routing時の認証を非同期で行いたい\nURLごとの認証は`CanActivate`インターフェースを実装すればできますが、\nサーバから認証情報を取得して非同期で認証したい場合もあると思います。\nそのような時は、**`CanActivate#canActivate`で**booleanの代わりに**Observable<boolean>を戻り値に指定する**ことで実現できます。\n\n\n```typescript:SampleAuthGuard\nimport { Injectable } from '@angular/core';\nimport { Router, CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot } from '@angular/router';\nimport { Observable } from 'rxjs/Rx';\n\nimport { AuthenticationService } from './authentication.service';\n\n@Injectable()\nexport class SampleAuthGuard implements CanActivate {\n\n  constructor(\n    private auth: AuthenticationService,\n  ) { }\n\n  // booleanではなくObservable<boolean>を戻り値で返す\n  canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable<boolean> {\n    return this.auth.checkState()\n      .map(res => true)\n      .catch(err => Observable.of(false))\n  }\n}\n\n```\n\n\b**参考サイト**\n\n* [StackOverFlow](https://stackoverflow.com/questions/38425461/angular2-canactivate-calling-async-function)\n\n## FormArrayの値を初期化したい\nFormControlはpatchValueで初期値を設定できますが、\nFormArrayの場合patch\bValueで配列の値を設定しようと\bしても設定できません。\n\bこういう場合は、**\b\b配列1つ１つの値をもとにFormControlを生成してFormArrayにpush**します。\n\n```typescript:ダメな例\nngOnInit() {\n  // Form生成\n  this.form = this.formBuilder.group({\n    schoolName: '',\n    students: this.formBuilder.array([])\n  });\n\n  // Formに初期値を設定\n  this.form.pathValue({\n    schooleName: 'SampleSchoolName' // FormControlの値の初期化はpatchValueで可能\n    students: ['taro', 'jiro', 'saburo']; // FormArrayに要素を追加する場合patchValueでは不可能\n  });\n}\n```\n\n```typescript:\b良い例\nngOnInit() {\n  // Formを生成\n  this.form = this.formBuilder.group({\n    schoolName: '',\n    students: this.formBuilder.array([])\n  });\n\n  // Formに初期値を設定\n  this.form.pathValue({\n    schooleName: 'SampleSchoolName'\n  });\n\n  // データからFormControlを生成し１件１件FormArrayにpushする\n  ['taro', 'jiro', 'saburo'].forEach(student -> {\n    this.form.controls['students'].push(new FormControll(student));\n  });\n}\n```\n\n\b**参考サイト**\n\n* [StackOvereFlow](https://stackoverflow.com/questions/40916084/angular2-patchvalue-push-value-into-array)\n\n## 「ERROR Error: No provider for TemplateRef!」というエラー\n最初このエラーが出た時は、何が原因なのかわからずに困りました。。。\n大抵の場合は、**`*ngIf`や`*ngForm`の`*`が抜けてることが原因**です(要するにただのタイポです。。。)\n`*`が抜けると、Angularは`ngIf`をディレクティブとして解釈しようとしますが、\n\bそんな\b\bディレクティブは存在しないので`No provider for TemplateRef!`と言われてしまうそうです。\n\n\b**参考サイト**\n\n* [StackOverFlow](https://stackoverflow.com/questions/35932074/angular2-no-provider-for-templateref-ngif-templateref)\n\n\n## textareaにおいてTabキーでインデントしたい\n文書を入力するようなテキストエリアの場合に、\u001dTabキーでのインデントしたい場合は、\n\bkyedownイベント発生時に\bテキストエリアの値とキャレットの位置を操作することで実現可能です。\n\n```html:HTML\n<textarea #sampletextarea\n  (keydown)=\"indent($event, sampletextarea)\" ></textarea>\n```\n\n```typescript:Component\n  indent($event, sampleTextAreaElement) {\n    // Tabキー押下時\n    if ($event.keyCode === 9) {\n      \b// 次の要素に\bフォーカスが移らないようにする\n      $event.preventDefault();\n\n      // 現在のキャレット位置を取得\n      \bconst caretStart = textareaElement.selectionStart;\n      const caretEnd = textareaElement.selectionEnd;\n\n      // テキストエリアの値を\b取得し、キャレット位置にTabを挿入\n      const TAB = '¥t';\n      sampleTextAreaElement.value = sampleTextAreaElement.value.substring(0, caretStart)\n                     + TAB + sampleTextAreaElement.value.substring(caretStart, value.length);\n\n      // キャレット位置をTab分ずらす\n      sampleTextAreaElement.focus();\n      sampleTextAreaElement.setSelectionRange(caretStart + TAB.length, caretEnd + TAB.length);\n\n      return;\n    }\n  }\n\n```\n\n\n\n## \bMarkdownプレビューを\b表示したい、ソースコードはシンタックスハイライトさせたい\n[marked](https://github.com/chjj/marked)と[highlight.js](https://github.com/isagalaev/highlight.js)を組み合わせて使います。\n[marked](https://github.com/chjj/marked)のReadmeを見ればなんとなくわかりますが、Angularの仕組みに乗せる必要があるのでPipeやらServiceやらを作ります。\n\n```typescript:markdown-parse.service.ts\nimport { Injectable } from '@angular/core';\nimport marked from 'marked';\nimport hljs from 'highlight.js';\n\n\n@Injectable()\nexport class MarkdownParseService {\n\n  constructor() {\n    marked.setOptions({\n      highlight: function (code) {\n        return hljs.highlightAuto(code).value;\n      }\n    });\n  }\n\n  parse(rawText: string) {\n    return marked(rawText);\n  }\n}\n```\n\n\n```typescript:markdown.pipe.ts\nimport marked from 'marked';\nimport { Pipe, PipeTransform } from '@angular/core';\nimport { MarkdownParseService } from './markdown-parse.service';\n\n@Pipe({ name: 'toMarkdown' })\nexport class MarkdownParsePipe implements PipeTransform {\n  constructor(markdownParseService: MarkdownParseService) {}\n\n  transform(value: string): any {\n    return this.markdownParseService.parse(value);\n  }\n}\n```\n\nHTMLで下記のように指定します。`{{}}`だと\bサニタイズされてしまうので\b`innerHTML`属性を指定します。\n\n```html\n<div [innerHTML]=\"md | toMarkdown\"></div>\n```\n\n\n\b**参考サイト**\n\n* [Qiita AngularでMarkdownをHTMLとして表示するカスタムpipeを作成する](https://qiita.com/daikiojm/items/e02e2aeb0231b3620a0b)\n* Github [chjj/marked](https://github.com/chjj/marked)\n\n\n\n\n## 絞り込み条件付きリストにおいて、リストの要素が\b変更、追加\b、削除された時に絞り込み結果をリフレッシュしたい\nリストの絞り込みはPipeで実現しますが、通常Pipeはリストの要素が変更されても再び絞り込みが実施されることはありません。\nこのような場合はPipeアノテーションにて**pureオプションをfalseに設定**ましょう。\n\n```html:HTML\n<input type=\"text\" #searchUserName>\n<ul>\n  <li *ngFor=\"let user of (userList | searchUserFilter: searchUserName.value);\" >{{user.name}}</li>\n<ul>\n```\n\n```typescript:search-user.pipe.ts\nimport { Pipe, PipeTransform } from '@angular/core';\nimport { User } from './user';\n\n@Pipe({\n  name: 'searchUserFilter',\n  pure: false // pureをfalseにすることでユーザが変更、追加、削除された時にリフレッシュできる\n})\nexport class SearchFilterPipe implements PipeTransform {\n  transform(items: Array<User>, searchUserName: string): any[] {\n    if (!searchUserName) return items;\n\n    searchUserName = searchUserName.toLowerCase();\n    return items.filter( item => item.user.userId.toLowerCase().includes(searchUserName));\n  }\n}\n```\n\n\b**参考サイト**\n\n* [Angular公式サイト](https://angular.io/guide/pipes#pure-and-impure-pipes)\n\n\n\n\n## グローバル定数を定義したい\nいろんなクラスで使う定数を\b共通\b化する時は、単純に**クラスを作ってstaticなメンバとして定数を定義**します。\n\n```typescript:app-settings.ts\nexport class AppSettings {\n   public static API_ENDPOINT='http://127.0.0.1:6666/api/';\n}\n```\n\n```typescript:SampleService\nimport {Injectable} from 'angular2/core';\nimport {AppSettings} from './app-settings';\n\n@Injectable()\nexport class SampleService {\n    \bsampleMethod() {\n      console.log(AppSettings.API_ENDPOINT);\n    }\n}\n```\n\n**参考**\n\n* [StackOverFlow](https://stackoverflow.com/questions/34986922/define-global-constants-in-angular-2)\n\n\n## 画像が多い画面の初期表示を早くしたい\n[ng-lazyload-image](https://github.com/tjoskar/ng-lazyload-image)を使えば画像の遅延ロードを実現できます。\n使い方もとても簡単でimgタグにディレクティブを指定するだけです。\n\n```html:HTML\n <img\n  [defaultImage]=\"https://images.sample.com/photo/defaultimage\" \n  [lazyLoad]=\"https://images.sample.com/photo/sampleimage\"\n  [offset]=\"30\"\n >\n```\n\n*defaultImage*\n　即時ロードされる画像のURL、遅延ロードする画像を読み込む間、表示される\n*lazyLoad*\n　遅延ロードする画像のURL\n*offset*\n　スクロールが発生する場合に画面下部の何ピクセル下に来た時にロードを開始するか\n*errorImage*\n　遅延ロード失敗時に表示する画像URL\n\n**参考サイト**\n\n* [ng-lazyload-image](https://github.com/tjoskar/ng-lazyload-image)\n\n\n## Angular Cliの`ng serve`コマンドでdistフォルダを一旦削除したくない\n`ng serve`コマンドは`dist`フォルダを削除してからtsファイルをトランスコンパイルします。\nそれを防ぐためには、**delete-output-pathオプションをfalse**に指定します。\n\n```json:package.json　ビルドスクリプト\n\"script\": {\n  \"build\": \"cp ./resource/* dist && ng serve --delete-output-path=false\"\n}\n```\n\n\b**参考サイト**\n\n* [angular-cli github issue #4366](https://github.com/angular/angular-cli/issues/4366)\n\n\n## AOTコンパイルが遅いのでなんとかしたい\nなんとかできませんでした。。。(もしかしたら方法があるのかもしれません。誰か教えてください!!!)\nAOTコンパイルはJITコンパイルが検出してくれないHTMLのエラーを警告してくれますが、その反面遅いです。特に[Angular Material](https://material.angular.io/)を使う場合は顕著です。\nそのため、自分の場合は基本的にJITビルドを使い、issueのプルリクをする前など区切りのいいタイミングでAOTビルドしてエラーがないか確認するというように使い分けてました。\n\n\n# 2. フロント側Angularでのテスト周り\n## CI環境などでテストが終わらずにタイムアウトしてしまう\nCirleCiなどでテストを実行する場合`ng test`コマンドだとプロセスが終了しないためタイムアウトで失敗してしまいます。\nこのような場合は**watchオプションをfalseに設定**します。\n\n```\nng test --wtach=false\n```\n\n**参考サイト**\n[Github isssue](https://github.com/angular/angular-cli/issues/362)\n\n## テスト時に「Error: Timeout - Async callback was not invoked within timeout specified by jasmine.DEFAULT_TIMEOUT_INTERVAL.」や「Failed to execute 'send' on 'XMLHttpRequest'」のエラー\nこのような場合は、一時的に`ng test`コマンドのオプションに**`-sm=false`を追加**してテストし直すと根本原因エラーメッセージで出力されるようになります。\n大抵の場合は自作したモッククラスに必要なメソッドがないことが原因です。\n\n\b**参考サイト**\n\n* [stackOverFlow](https://stackoverflow.com/questions/45399079/angular-tests-failing-with-failed-to-execute-send-on-xmlhttprequest)\n\n\n## テスト用に子コンポーネントをモック化したい\n意外と簡単で、TestBed#configureTestingModuleで\ndeclarationsに自作したモックの子コンポーネントを追加するだけです。\ninput,outputがあれば必要に応じてメンバ定義します。\n\n\n```typescript\n// ※import文は省略\n\n// モックの子コンポーネントを定義\n@Component({\n  selector: 'app-child', // 子コンポーネントと同じものを定義\n  template: '<p>Mock Child Component</p>'\n})\nclass MockClildComponent {\n  @Input() childInput: string;\n  @Output() childOutput = new EventEmitter();\n}\n\n// ...\n\nbeforeEach(() => {\n  TestBed.configureTestingModule({\n    declarations: [\n      // テスト時のdeclarationsにモックの定義を追加\n      MockProductSettingsComponent,\n      // ...\n    ],\n    // ...\n  });\n  // ...\n});\n```\n\n\b**参考サイト**\n\n* [stackOverFlow](https://stackoverflow.com/questions/41240163/mocking-child-components-angular-2)\n\n\n## テスト結果にAngular Materilaのスタイルが反映されない\nUIフレームワークで[Angular Material](https://material.angular.io/)を使っている場合、\n`karma.config.js`でAngular Materilaのcssを直接読み込んであげる必要あります。\n\n```javascript:karma.conf.js\nfiles: [\n      ・・・\n      // Angular Materialのスタイルをテスト開始時に読み込んでおく\n      {pattern: './node_modules/@angular/material/prebuilt-themes/indigo-pink.css', included: true, watched: false},\n],\n```\n\n**参考サイト**\n\n* [stackoverflow](https://github.com/angular/material2/issues/4056)\n\n\n## テスト結果にstyles.scss(アプリ共通のスタイル定義)のスタイルが反映されない\nアプリ共通スタイルをSASS形式にしている場合\n開発用ライブライに`karma-scss-preprocessor`と`node-sass`を追加して`karma.conf.js`を下記のように設定します。\n\n```javascript:karma.conf.js\nplugins: [\n  ・・・\n　 // プラグインに`karma-scss-preprocessor`を追加\n  require('karma-scss-preprocessor')\n],\n\n\nfiles: [\n  ・・・\n  // filesにアプリ共通スタイルを追加\n  { pattern: './src/styles.scss', watched: false,  included: true, served: true }\n],\n\n// preprocessorsを追加\npreprocessors: {\n './src/test.ts': ['@angular/cli'],\n './src/styles.scss': ['scss']\n},\n```\n\n\b**参考サイト**:\n\n* [stackOverFlow](https://stackoverflow.com/questions/44460733/how-to-configure-karma-to-include-global-scss-files-for-an-angular-cli-project/44498689#44498689)\n* [Github karma/issue/2700](https://github.com/karma-runner/karma/issues/2700)\n\n\n\n\n# 3. バックエンド側 Express、MongoDB周り\n※MongDBをNode.jsで扱う場合は[mongoose](https://github.com/Automattic/mongoose)という便利なライブラリがあるのでそれを使う前提のお話です。\n\n## mongooseのvirtualメソッドを使う\n例えば`記事`,`コメント`,`リプライ`などのモデルを定義する場合、\n３つのモデルのライフサイクルは、記事追加 => 記事に対するコメント追加 => コメントに対するリプライ追加　のようになります。\nこのような場合は、コメントが記事の参照を持ち、リプライがコメントの参照を持つモデル構造が望ましいです。コメントやリプライ追加時に１つのモデルの更新だけですむからです。\n![db構造_良.png](https://qiita-image-store.s3.amazonaws.com/0/49915/f93ac0e6-317e-1cdf-bfba-13531e2455ba.png)\n\nただ記事の検索は少し工夫が必要で、**mongooseのvirtualを使います**。これによって記事からコメントへの参照、コメントからリプライへの参照を擬似的に定義できるため、\n検索時に擬似要素をpopulateするだけで、記事に紐付くコメントとリプライを取得できるようになります。\n![mongoose virtualのイメージ.png](https://qiita-image-store.s3.amazonaws.com/0/49915/4aab7f38-1f19-e00b-b35d-23babf36a75b.png)\n\n具体的なソースコードを示します。\n\n```typescript:article.model.ts\nimport * as mongoose from 'mongoose';\n\nconst ArticleSchema = new mongoose.Schema({\n  content: String\n}, { toJSON: { virtuals: true } });\n\n\n// 記事に紐付くコメントモデルの配列をcommentsという擬似要素で定義する\nArticleSchema.virtual('comments', {\n  ref: 'Comment',\n  localField: '_id',\n  foreignField: 'articleId',\n  justOne: false,\n});\n\nconst Article = mongoose.model('Article', ArticleSchema);\n\nexport { Article };\n```\n\n\n```typescript:comment.model.ts\nimport * as mongoose from 'mongoose';\n\nconst CommentSchema = new mongoose.Schema({\n  articleId: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Article',\n  },\n  comment: String;\n}, { toJSON: { virtuals: true } });\n\n// コメントに紐付くリプライモデルの配列をrepliesという擬似要素で定義する\nCommentSchema.virtual('replies', {\n  ref: 'Reply',\n  localField: '_id',\n  foreignField: 'commentId',\n  justOne: false,\n});\n\nconst Comment = mongoose.model('Comment', CommentSchema);\n\nexport { Comment };\n```\n\n```typescript:reply.model.ts\nimport * as mongoose from 'mongoose';\n\nconst ReplySchema = new mongoose.Schema({\n  commentId: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Comment'\n  },\n  reply: String;\n});\n\nconst Reply = mongoose.model('Reply', ReplySchema);\n\nexport { Reply };\n```\n\n```typescript:検索処理\nArticle.find()\n.populate({\n  path: 'comments', // Articleモデルで定義した擬似要素commentsをpopulateする\n  populate: [{\n    path: 'replies', // Commentモデルで定義した擬似要素repliesをpopulateする\n  }],\n});\n```\n\n\n## リクエスト、レスポンスのログ出力したい\nExpressのuseにて実現します。\nレスポンスオブジェクトのfinishイベントを監視することで、レスポンス時にログを出力しています。\n\n\n```javascript:リクエストとレスポンスのログ出力　※ここでは簡単のためコンソールに出力しています\nconst express = express();\nexpress.use(function accessLogHandler (req, res, next) {\n  const start = new Date();\n  // リクエスト時のログ　\n  console.log([\n    'start',\n    req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n    req.method,\n    req.url,\n    '-',\n    req.headers.referer || '-',\n    req.headers['user-agent'] || '-',\n    '--ms--'\n  ].join(',\\t'));\n\n  res.once('finish', function() {\n　　 // レスポンス時のログ\n    accessLogger.info([\n      'end',\n      req.headers['x-forwarded-for'] || req.connection.remoteAddress,\n      req.method,\n      req.url,\n      res.statusCode,\n      req.headers.referer || '-',\n      req.headers['user-agent'] || '-',\n      '--' + (new Date().getMilliseconds() - start.getMilliseconds()) + 'ms--'\n    ].join(',\\t'));\n  });\n\n  next();\n});\n```\n\n実際のログはこんな感じで出力されます。\n\n```py3\nstart,  ::ffff:127.0.0.1, GET, /api/authenticate/check-state,   -, http://localhost:4200/, Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36, --ms--\nend,    ::ffff:127.0.0.1, GET, /check-state,                  403, http://localhost:4200/, Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36,  --47ms--\n```\n\n\n\n## ログ出力でオブジェクトの全プロパティを出力したい\nオブジェクトの中身をログで確認する時はNode.jsの`util.inspect()`を使います。\n\n\n```javascript\nconst util = require('util');\nconst myObject = {\n   \"a\":\"a\",\n   \"b\":{\n      \"c\":\"c\",\n      \"d\":{\n         \"e\":\"e\",\n         \"f\":{\n            \"g\":\"g\",\n            \"h\":{\n               \"i\":\"i\"\n            }\n         }\n      }\n   }\n}; \n\nconsole.log(util.inspect(myObject, false, null));\n```\n\nこのようなログが出力されます\n\n```\n{ a: 'a', b: { c: 'c', d: { e: 'e', f: [Object] } } }\n```\n\n**参考サイト**\n\n* [StackOverFlow](https://stackoverflow.com/questions/10729276/how-can-i-get-the-full-object-in-node-jss-console-log-rather-than-object)\n\n\n## 環境変数で上書きできる定数を定義したい\n例えばサーバのポートなど環境個別に設定したくなるようなものは\n環境変数で上書きできる定数にしておくと便利です。\nNode.jsではprocess.env.変数名で環境変数が参照できるので下記のようにします。\n\n```typescript:定数定義\nexport const SERVER_PORT: string = process.env.SERVER_PORT || '3000';　// 環境変数SERVER_PORTが未指定の場合は3000となる\nexport const SERVER_HOST: string = process.env.SERVER_HOST || 'localhost'; // 環境変数SERVER_HOSTが未指定の場合はlocalhostとなる\n```\n\n\n## DB初回アクセスに失敗した場合にリトライされない\nmongooseを使っていると、DB初回接続時にエラーが起きた時に、なぜか再接続処理してくれません。\nDockerでアプリを配布する場合、アプリとMongoDBをdocker-composeで同時に立ち上げることがあると思いますが、まだMongoDBが起動しきってない状態でアプリからDBに接続しようとすると、アプリが異常終了してしまいます。これを防ぐには自力で再接続処理を実装する必要があります。\n\n```javascript\nfunction createConnection (dbURL, options) {\n    var db = mongoose.createConnection(dbURL, options);\n\n    db.on('error', function (err) {\n        if (err.message && err.message.match(/failed to connect to server .* on first connect/)) {\n            console.log(new Date(), String(err));\n\n            setTimeout(function () {\n                console.log(\"Retrying first connect...\");\n                db.openUri(dbURL).catch(() => {});\n            // 20秒後に再接続する\n            }, 20 * 1000);\n        } else {\n            console.error(new Date(), String(err));\n        }\n    });\n\n    db.once('open', function () {\n        console.log(\"Connection to db established.\");\n    });\n\n    return db;\n}\n```\n\n**参考サイト**\n\n* [Github mongooseのissue5169](https://github.com/Automattic/mongoose/issues/5169)\n\n","comments_count":0,"created_at":"2017-12-12T03:19:11+09:00","likes_count":43,"reactions_count":0}}}