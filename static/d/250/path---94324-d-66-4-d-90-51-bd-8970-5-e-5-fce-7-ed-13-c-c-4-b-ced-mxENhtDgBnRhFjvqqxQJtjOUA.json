{"data":{"site":{"siteMetadata":{"title":"Takumon Blog","author":"Takuto Inoue"}},"qiitaPost":{"rendered_body":"<p>Jenkins PipelineのJenkinsfileを作っていて、設定ファイル(Gradleでいう、gradle.propertiesのような感じ)が欲しいと思う時があります。今回はYamlファイルをJnekinsfileから読み込んで設定ファイルとして使う方法をご紹介します。</p>\n\n<h1>\n<span id=\"1-pipeline-utility-steps-pluginをインストール\" class=\"fragment\"></span><a href=\"#1-pipeline-utility-steps-plugin%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"><i class=\"fa fa-link\"></i></a>1. <a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Utility+Steps+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Pipeline Utility Steps Plugin</a>をインストール</h1>\n\n<p>Jenkinsで様々な形式のファイルが簡単に読み込めるようになるプラグインです。Yamlファイルの読み込みに使います。Jenkins初期設定時のSuggested Pluginには入っていないので、自分でインストールしましょう。</p>\n\n<h1>\n<span id=\"2-configymlを作成\" class=\"fragment\"></span><a href=\"#2-configyml%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>2. config.ymlを作成</h1>\n\n<p>プロジェクト直下（Jenkinsfileと同じ場所）にconfig.ymlを作ります。 </p>\n\n<div class=\"code-frame\" data-lang=\"yaml\">\n<div class=\"code-lang\"><span class=\"bold\">config.yml</span></div>\n<div class=\"highlight\"><pre><span class=\"na\">someProp</span><span class=\"pi\">:</span> <span class=\"s\">値１</span>\n<span class=\"na\">someCategory</span><span class=\"pi\">:</span>\n  <span class=\"na\">prop</span><span class=\"pi\">:</span> <span class=\"s\">値２</span>\n  <span class=\"na\">arrayProp</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">配列値０</span>\n    <span class=\"pi\">-</span> <span class=\"s\">配列値１</span>\n    <span class=\"pi\">-</span> <span class=\"s\">配列値２</span>\n</pre></div>\n</div>\n\n<h1>\n<span id=\"3-jenkinsfileを作成\" class=\"fragment\"></span><a href=\"#3-jenkinsfile%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"></i></a>3. Jenkinsfileを作成</h1>\n\n<p>Jenkinsfileを下記のようにします。今回はDeclarative Pipelineの書き方ですが、Scripted Pipelinesでもほとんど同じ書き方だと思います。</p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">Jenkinsfie</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">pipeline</span> <span class=\"o\">{</span>\n    <span class=\"n\">agent</span> <span class=\"n\">any</span>\n\n    <span class=\"n\">environment</span> <span class=\"o\">{</span>\n        <span class=\"n\">CONFIG</span> <span class=\"o\">=</span> <span class=\"s2\">\"\"</span> <span class=\"c1\">//この時点ではプロジェクトの設定ファイルを読み込めないので仮の値を設定しておく</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"n\">stages</span> <span class=\"o\">{</span>\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'チェックアウトして設定ファイル読み込み'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// プロジェクトをチェックアウト</span>\n                <span class=\"n\">checkout</span> <span class=\"n\">scm</span>\n\n                <span class=\"n\">script</span> <span class=\"o\">{</span>\n                    <span class=\"c1\">// チェックアウト後に設定ファイルを読み込む</span>\n                    <span class=\"c1\">// Pipeline Utility Steps Pluginの関数を使う</span>\n                    <span class=\"n\">CONFIG</span> <span class=\"o\">=</span> <span class=\"n\">readYaml</span><span class=\"o\">(</span><span class=\"nl\">file:</span> <span class=\"s1\">'config.yml'</span><span class=\"o\">)</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'設定ファイル参照'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">echo</span> <span class=\"s2\">\"CONFIG.someProp ＝ ${CONFIG.someProp}\"</span>\n                <span class=\"n\">echo</span> <span class=\"s2\">\"CONFIG.someCategory.prop ＝ ${CONFIG.someCategory.prop}\"</span>\n                <span class=\"n\">echo</span> <span class=\"s2\">\"CONFIG.someCategory.arrayProp[0] ＝ ${CONFIG.someCategory.arrayProp[0]}\"</span>\n                <span class=\"n\">echo</span> <span class=\"s2\">\"CONFIG.someCategory.arrayProp[1] ＝ ${CONFIG.someCategory.arrayProp[1]}\"</span>\n                <span class=\"n\">echo</span> <span class=\"s2\">\"CONFIG.someCategory.arrayProp[2] ＝ ${CONFIG.someCategory.arrayProp[2]}\"</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p>これでJobを実行すると下記のようなコンソールログが出力されます。</p>\n\n<div class=\"code-frame\" data-lang=\"\">\n<div class=\"code-lang\"><span class=\"bold\">Jenkinsのコンソール出力（一部抜粋）</span></div>\n<div class=\"highlight\"><pre>[Pipeline] { (設定ファイル参照)\n[Pipeline] echo\nCONFIG.someProp ＝ 値１\n[Pipeline] echo\nCONFIG.someCategory.prop ＝ 値２\n[Pipeline] echo\nCONFIG.someCategory.arrayProp[0] ＝ 配列値０\n[Pipeline] echo\nCONFIG.someCategory.arrayProp[1] ＝ 配列値１\n[Pipeline] echo\nCONFIG.someCategory.arrayProp[2] ＝ 配列値２\n</pre></div>\n</div>\n\n<h2>\n<span id=\"最後に\" class=\"fragment\"></span><a href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"><i class=\"fa fa-link\"></i></a>最後に</h2>\n\n<p>今回はYamlファイルをJenkins Pipelineの設定ファイルとして使ってみました。<br>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Pipeline+Utility+Steps+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Pipeline Utility Steps Plugin</a>はpropertiesファイルも読み込めるので、gradle.propertiesを読み込んで、設定ファイルをGradleとJenkins Pipelineで共有することもできそうです。</p>\n","headings":[{"id":"1-pipeline-utility-steps-pluginをインストール","value":"1. Pipeline Utility Steps Pluginをインストール","depth":1,"parents":[]},{"id":"2-configymlを作成","value":"2. config.ymlを作成","depth":1,"parents":[]},{"id":"3-jenkinsfileを作成","value":"3. Jenkinsfileを作成","depth":1,"parents":[]},{"id":"最後に","value":"最後に","depth":2,"parents":[{"id":"3-jenkinsfileを作成","value":"3. Jenkinsfileを作成","depth":1}]}],"fields":{"title":"Jenkins PipelineでYamlを設定ファイルとして使う方法","excerpt":"Jenkins PipelineのJenkinsfileを作っていて、設定ファイル(Gradleでいう、gradle.propertiesのような感じ)が欲しいと思う時があります。今回はYamlファイルをJnekinsfileから読み込んで...","date":"2017-06-17T12:14:16+09:00","tags":["Jenkins","CI","Pipeline","Qiita"]},"user":{"id":"Takumon","profile_image_url":"https://qiita-image-store.s3.amazonaws.com/0/49915/profile-images/1488080194","description":"JavaのSIer. 趣味はJavaScript. \r\n週1でブログ更新してます. https://takumon.com/\r\n最近はGatsbyJS,Nuxt.js,GraphQLなどなど."}}},"pageContext":{"slug":"/94324d66-4d90-51bd-8970-5e5fce7ed13c/","relatedPosts":[{"fields":{"slug":"/4bf6ffd5-8640-508e-ab47-1a55df05d72e/","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","date":"2017-04-07T02:38:55+09:00","excerpt":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。Githubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイす...","tags":["Java","Jenkins","CI","gradle","Pipeline","Qiita"],"keywords":["Java"],"thumbnail":""},"id":"4bf6ffd5-8640-508e-ab47-1a55df05d72e","title":"Declarative PipelineでJenkinsfileを書いてみた(Checkstyle,Findbugs,PMD,CPDとか)","rendered_body":"<p>GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。<br>\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。</p>\n\n<h1>\n<span id=\"declarative-pipeline\" class=\"fragment\"></span><a href=\"#declarative-pipeline\"><i class=\"fa fa-link\"></i></a>Declarative Pipeline</h1>\n\n<p>いままではJenkinsfileを</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>node {\n  ....\n}\n</pre></div></div>\n\n<p>のように書いてましたが、<a href=\"https://jenkins.io/doc/book/pipeline/syntax/\" rel=\"nofollow noopener\" target=\"_blank\">Jenkinsの公式サイト</a>を見ると<br>\nこれはScripted Pipelinesの記法であり、<br>\nPipeline Pluginのバージョン2.5移行からは</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>pipeline {\n  ....  \n}\n</pre></div></div>\n\n<p>のように書くDeclarative Pipelineという記法が導入されて、<br>\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。<br>\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、<br>\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。</p>\n\n<h1>\n<span id=\"追加したプラグイン\" class=\"fragment\"></span><a href=\"#%E8%BF%BD%E5%8A%A0%E3%81%97%E3%81%9F%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3\"><i class=\"fa fa-link\"></i></a>追加したプラグイン</h1>\n\n<p>Jenkins初期設定時のSuggested Pluginに入っていないもの</p>\n\n<ul>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F\" rel=\"nofollow noopener\" target=\"_blank\">Checkstyle Plugin</a>（v3.47） - Checkstyeの結果収集用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">FindBugs Plugin</a>（v4.69） - Findbugsのレポート生成用 </li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">PMD Plugin</a>（v3.46） - PMDのレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">DRY Plugin</a>（v2.46） - CPD(重複コードチェック)のレポート生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Step Counter Plugin</a>（v2.0.0） - ソースコードのステップ数を集計してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Task Scanner Plugin</a>（v4.50） - ソースコード中のTODOとかを一覧化してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Javadoc Plugin</a>（v1.4） - JavaDoc生成用</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">Warnings Plugin</a>（v4.60） - ジョブ実行時の警告メッセージを収集してくれる</li>\n<li>\n<a href=\"https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin\" rel=\"nofollow noopener\" target=\"_blank\">JaCoCo Plugin</a>（v2.2.0） - テストカバレッジのレポート生成用</li>\n</ul>\n\n<h1>\n<span id=\"jenkinsfile\" class=\"fragment\"></span><a href=\"#jenkinsfile\"><i class=\"fa fa-link\"></i></a>Jenkinsfile</h1>\n\n<p>GithubからWebhookでJenkinsのパイプラインジョブを実行する。<br>\nパイプラインジョブではGithubのJenkinsfileを使う。<br>\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。<br>\n<a href=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a055f84cfb5b829f162a94d38542e6ab990a5199/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f35366338653132642d323637622d613633372d323234652d6663386362333437346466612e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png\"></a></p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">Jenkinsfile</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">pipeline</span> <span class=\"o\">{</span>\n    <span class=\"n\">agent</span> <span class=\"n\">any</span>\n    <span class=\"c1\">// 定数や変数を定義する</span>\n    <span class=\"n\">environment</span> <span class=\"o\">{</span>\n        <span class=\"n\">reportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/reports'</span>\n        <span class=\"n\">javaDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/java'</span>\n        <span class=\"n\">resourcesDir</span> <span class=\"o\">=</span> <span class=\"s1\">'src/main/resources'</span>\n        <span class=\"n\">testReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/test-results/test'</span>\n        <span class=\"n\">jacocoReportDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/jacoco'</span> \n        <span class=\"n\">javadocDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/docs/javadoc'</span>\n        <span class=\"n\">libsDir</span> <span class=\"o\">=</span> <span class=\"s1\">'build/libs'</span>\n        <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n        <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロック中に一つ以上のstageを定義する</span>\n    <span class=\"n\">stages</span> <span class=\"o\">{</span>\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'事前準備'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 実際の処理はstepsブロック中に定義する</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n\n                <span class=\"c1\">// このJobをトリガーしてきたGithubのプロジェクトをチェックアウト</span>\n                <span class=\"n\">checkout</span> <span class=\"n\">scm</span>\n\n                <span class=\"c1\">// ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"Jenkinsfile\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"build.gradle\"</span>\n\n                <span class=\"c1\">// scriptブロックを使うと従来のScripted Pipelinesの記法も使える</span>\n                <span class=\"n\">script</span> <span class=\"o\">{</span>\n                    <span class=\"c1\">// Permission deniedで怒られないために実行権限を付与する</span>\n                    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n                        <span class=\"n\">sh</span> <span class=\"s1\">'chmod +x gradlew'</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">}</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'clean'</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'コンパイル'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'classes testClasses'</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"c1\">// postブロックでstepsブロックの後に実行される処理が定義できる</span>\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n\n                    <span class=\"c1\">// JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので</span>\n                    <span class=\"c1\">// Javaコンパイル時の警告はコンパイル直後に収集する</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n\n                        <span class=\"c1\">// プラグインを実行するときのクラス指定は完全修飾名でなくてもOK</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n\n                        <span class=\"c1\">// Job実行時のコンソールから警告を収集する場合はconsoleParsers、</span>\n                        <span class=\"c1\">// pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。</span>\n                        <span class=\"c1\">// なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要</span>\n                        <span class=\"c1\">// パーサ名は下記プロパティファイルに定義されているものを使う</span>\n                        <span class=\"c1\">// https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'Java Compiler (javac)'</span><span class=\"o\">],</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'静的コード解析'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 並列処理の場合はparallelメソッドを使う</span>\n                <span class=\"n\">parallel</span><span class=\"o\">(</span>\n                    <span class=\"s1\">'静的コード解析'</span> <span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'check -x test'</span>\n\n                        <span class=\"c1\">// dirメソッドでカレントディレクトリを指定できる</span>\n                        <span class=\"n\">dir</span><span class=\"o\">(</span><span class=\"n\">reportDir</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'CheckStylePublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'FindBugsPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'PmdPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n                            <span class=\"n\">step</span><span class=\"o\">([</span>\n                                <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'DryPublisher'</span><span class=\"o\">,</span>\n                                <span class=\"nl\">pattern:</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                            <span class=\"o\">])</span>\n\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"checkstyle/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"findbugs/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"pmd/*.xml\"</span>\n                            <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"cpd/*.xml\"</span>\n                        <span class=\"o\">}</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'ステップカウント'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"c1\">// レポート作成</span>\n                        <span class=\"c1\">// outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる</span>\n                        <span class=\"n\">stepcounter</span> <span class=\"nl\">outputFile:</span> <span class=\"s1\">'stepcount.xls'</span><span class=\"o\">,</span> <span class=\"nl\">outputFormat:</span> <span class=\"s1\">'excel'</span><span class=\"o\">,</span> <span class=\"nl\">settings:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'Java'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${javaDir}/**/*.java\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'SQL'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.sql\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'HTML'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.html\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'JS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.js\"</span><span class=\"o\">],</span>\n                            <span class=\"o\">[</span><span class=\"nl\">key:</span><span class=\"s1\">'CSS'</span><span class=\"o\">,</span> <span class=\"nl\">filePattern:</span> <span class=\"s2\">\"${resourcesDir}/**/*.css\"</span><span class=\"o\">]</span>\n                        <span class=\"o\">]</span>\n                        <span class=\"c1\">// 一応エクセルファイルも成果物として保存する</span>\n                        <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"stepcount.xls\"</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'タスクスキャン'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'TasksPublisher'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">pattern:</span> <span class=\"s1\">'./**'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 集計対象を検索するときに大文字小文字を区別するか</span>\n                            <span class=\"nl\">ignoreCase:</span> <span class=\"kc\">true</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// 優先度別に集計対象の文字列を指定できる</span>\n                            <span class=\"c1\">// 複数指定する場合はカンマ区切りの文字列を指定する</span>\n                            <span class=\"nl\">high:</span> <span class=\"s1\">'System.out.System.err'</span><span class=\"o\">,</span>\n                            <span class=\"nl\">normal:</span> <span class=\"s1\">'TODO,FIXME,XXX'</span><span class=\"o\">,</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">},</span>\n                    <span class=\"s1\">'JavaDoc'</span><span class=\"o\">:</span> <span class=\"o\">{</span>\n                        <span class=\"n\">gradlew</span> <span class=\"s1\">'javadoc -x classes'</span>\n                        <span class=\"n\">step</span><span class=\"o\">([</span>\n                            <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JavadocArchiver'</span><span class=\"o\">,</span>\n                            <span class=\"c1\">// Javadocのindex.htmlがあるフォルダのパスを指定する</span>\n                            <span class=\"nl\">javadocDir:</span> <span class=\"s2\">\"${javadocDir}\"</span><span class=\"o\">,</span>\n                            <span class=\"nl\">keepAll:</span> <span class=\"kc\">true</span>\n                        <span class=\"o\">])</span>\n                    <span class=\"o\">}</span>\n                <span class=\"o\">)</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">post</span> <span class=\"o\">{</span>\n                <span class=\"n\">always</span> <span class=\"o\">{</span>\n                   <span class=\"c1\">// JavaDocの警告を収集</span>\n                    <span class=\"n\">step</span><span class=\"o\">([</span>\n                        <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'WarningsPublisher'</span><span class=\"o\">,</span>\n                        <span class=\"nl\">consoleParsers:</span> <span class=\"o\">[</span>\n                            <span class=\"o\">[</span><span class=\"nl\">parserName:</span> <span class=\"s1\">'JavaDoc Tool'</span><span class=\"o\">]</span>\n                        <span class=\"o\">],</span>\n                        <span class=\"nl\">canComputeNew:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">canResolveRelativesPaths:</span> <span class=\"kc\">false</span><span class=\"o\">,</span>\n                        <span class=\"nl\">usePreviousBuildAsReference:</span> <span class=\"kc\">true</span>\n                    <span class=\"o\">])</span>\n                <span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'テスト'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'test jacocoTestReport -x classes -x testClasses'</span>\n\n                <span class=\"n\">junit</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${testReportDir}/*.xml\"</span>\n\n                <span class=\"c1\">// カバレッジレポートを生成（テストクラスを除外）</span>\n                <span class=\"n\">step</span><span class=\"o\">([</span>\n                    <span class=\"n\">$class</span><span class=\"o\">:</span> <span class=\"s1\">'JacocoPublisher'</span><span class=\"o\">,</span>\n                    <span class=\"nl\">execPattern:</span> <span class=\"s2\">\"${jacocoReportDir}/*.exec\"</span><span class=\"o\">,</span>\n                    <span class=\"nl\">exclusionPattern:</span> <span class=\"s1\">'**/*Test.class'</span>\n                <span class=\"o\">])</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n\n        <span class=\"n\">stage</span><span class=\"o\">(</span><span class=\"s1\">'デプロイ'</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// whenブロックでstageを実行する条件を指定できる</span>\n            <span class=\"n\">when</span> <span class=\"o\">{</span>\n                <span class=\"c1\">// 静的コード解析とテスト失敗時はデプロイしない</span>\n                <span class=\"n\">expression</span> <span class=\"o\">{</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span> <span class=\"o\">==</span> <span class=\"s1\">'SUCCESS'</span><span class=\"o\">}</span>\n            <span class=\"o\">}</span>\n\n            <span class=\"n\">steps</span> <span class=\"o\">{</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'jar'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.jar\"</span>\n                <span class=\"n\">gradlew</span> <span class=\"s1\">'war'</span>\n                <span class=\"n\">archiveArtifacts</span> <span class=\"s2\">\"${libsDir}/${appName}-${appVersion}.war\"</span>\n                <span class=\"n\">deploy</span> <span class=\"nl\">warDir:</span> <span class=\"n\">libsDir</span><span class=\"o\">,</span> <span class=\"nl\">appName:</span> <span class=\"n\">appName</span><span class=\"o\">,</span> <span class=\"nl\">appVersion:</span> <span class=\"n\">appVersion</span>\n            <span class=\"o\">}</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// stagesブロックと同じレベルにpostブロックを定義すると</span>\n    <span class=\"c1\">// 全てのstage処理が終わった後の処理の定義が可能    </span>\n    <span class=\"n\">post</span> <span class=\"o\">{</span>\n        <span class=\"n\">always</span> <span class=\"o\">{</span>\n            <span class=\"c1\">// 最後にワークスペースの中身を削除</span>\n            <span class=\"n\">deleteDir</span><span class=\"o\">()</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 連続で成功しているとき以外は自分宛にメールを送信</span>\n\n        <span class=\"c1\">// 結果が前回と変わった時</span>\n        <span class=\"n\">changed</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"s2\">\"${currentBuild.previousBuild.result} =&gt; ${currentBuild.currentResult}\"</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 失敗した時</span>\n        <span class=\"n\">failure</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n        <span class=\"c1\">// 不安定な時（主にテスト失敗時）</span>\n        <span class=\"n\">unstable</span> <span class=\"o\">{</span>\n            <span class=\"n\">sendMail</span><span class=\"o\">(</span><span class=\"n\">currentBuild</span><span class=\"o\">.</span><span class=\"na\">currentResult</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n\n<span class=\"c1\">// Gradlewコマンドを実行する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">gradlew</span><span class=\"o\">(</span><span class=\"n\">command</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"k\">if</span><span class=\"o\">(</span><span class=\"n\">isUnix</span><span class=\"o\">())</span> <span class=\"o\">{</span>\n        <span class=\"n\">sh</span> <span class=\"s2\">\"./gradlew ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span> <span class=\"k\">else</span> <span class=\"o\">{</span>\n        <span class=\"n\">bat</span> <span class=\"s2\">\"./gradlew.bat ${command} --stacktrace\"</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// デプロイする</span>\n<span class=\"c1\">// args.warDir warの格納ディレクトリ </span>\n<span class=\"c1\">// args.appName アプリ名</span>\n<span class=\"c1\">// args.appVersion アプリのバージョン</span>\n<span class=\"kt\">def</span> <span class=\"nf\">deploy</span><span class=\"o\">(</span><span class=\"n\">Map</span> <span class=\"n\">args</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある</span>\n    <span class=\"kt\">def</span> <span class=\"n\">keyDir</span> <span class=\"o\">=</span> <span class=\"s1\">'/var/lib/jenkins/.ssh/xxx'</span>\n    <span class=\"c1\">// Tomcatサーバのアドレスとユーザ名</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerAddress</span> <span class=\"o\">=</span> <span class=\"s1\">'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServerUser</span> <span class=\"o\">=</span> <span class=\"s1\">'hoge-user'</span>\n    <span class=\"kt\">def</span> <span class=\"n\">webServer</span> <span class=\"o\">=</span> <span class=\"s2\">\"${webServerUser}@${webServerAddress}\"</span>\n\n    <span class=\"kt\">def</span> <span class=\"n\">srcWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}-${args.appVersion}.war\"</span>\n    <span class=\"kt\">def</span> <span class=\"n\">destWar</span> <span class=\"o\">=</span> <span class=\"s2\">\"${args.appName}.war\"</span>\n\n    <span class=\"c1\">// ファイル転送してTomcatのwebappsにwarを配置する</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"</span>\n    <span class=\"n\">sh</span> <span class=\"s2\">\"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// メールをGmailに送信する</span>\n<span class=\"kt\">def</span> <span class=\"nf\">sendMail</span><span class=\"o\">(</span><span class=\"n\">result</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">mail</span> <span class=\"nl\">to:</span> <span class=\"s2\">\"xxxxxxxx@gmail.com\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">subject:</span> <span class=\"s2\">\"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\"</span><span class=\"o\">,</span>\n        <span class=\"nl\">body:</span> <span class=\"s2\">\"Build URL: ${env.BUILD_URL}.\\n\\n\"</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<h1>\n<span id=\"躓いたこと\" class=\"fragment\"></span><a href=\"#%E8%BA%93%E3%81%84%E3%81%9F%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>躓いたこと</h1>\n\n<ul>\n<li>各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。</li>\n<li>currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ &gt; 設定 &gt; Pipeline Syntax &gt; Global Variables Reference に詳しく載っていた。\n<a href=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/dce98ca18e752127b3f57901a65249f540d2193f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30663631366435302d633537662d323335652d633231342d3863386430643139646139372e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png\"></a>\n</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/f2249e2915cbfd8a261d64823199f32a147bfe7a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61386666326463662d396438352d376334312d316565302d6662346638336562336333632e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png\"></a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/313541fc7e1ffe9781ad27141ed0b9d59400be18/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f66363362353066352d373639642d386666322d313930392d6630366165636330373130362e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png\"></a></p>\n\n<ul>\n<li>カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。</li>\n<li>JenkinsからGmailにメールする場合、Jenkins &gt; Jenkinsの管理 &gt; システムの設定 &gt; E-mail通知で下記のような設定が必要だった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a9ab429d39d5959f7d05fe968d1110ccd53738f1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f38356139313162622d303931642d393936622d333663612d6366303336306336353539322e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png\"></a></p>\n\n<ul>\n<li>JenkinsからGmailにメールする場合、<a href=\"https://support.google.com/accounts/answer/6010255?hl=ja\" rel=\"nofollow noopener\" target=\"_blank\">安全性の低いアプリがアカウントにアクセスするのを許可する</a>の手順に従って許可を有効にする必要があった。</li>\n</ul>\n\n<p><a href=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/2758c73a3bb32139599ba67b88c6ac3e77bae419/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f32343738646535352d633338332d396130622d366564622d3934623365383438376666342e706e67\" alt=\"image\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png\"></a></p>\n\n<h1>\n<span id=\"buildgradle\" class=\"fragment\"></span><a href=\"#buildgradle\"><i class=\"fa fa-link\"></i></a>build.gradle</h1>\n\n<p>Jenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、<br>\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。<br>\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。</p>\n\n<ul>\n<li>checkstyle</li>\n<li>findbugs</li>\n<li>pmd</li>\n<li>cpd(重複コードチェック)</li>\n<li>test</li>\n<li>jacocoReport</li>\n<li>jar</li>\n<li>war</li>\n</ul>\n\n<p>例えばこんな</p>\n\n<div class=\"code-frame\" data-lang=\"groovy\">\n<div class=\"code-lang\"><span class=\"bold\">build.gradle</span></div>\n<div class=\"highlight\"><pre><span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'java'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'war'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'checkstyle'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'findbugs'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'pmd'</span>\n<span class=\"n\">apply</span> <span class=\"nl\">plugin:</span> <span class=\"s1\">'jacoco'</span>\n\n<span class=\"n\">ext</span> <span class=\"o\">{</span>\n    <span class=\"n\">appVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'1.0.0'</span>\n    <span class=\"n\">appName</span> <span class=\"o\">=</span> <span class=\"s1\">'SampleApp'</span>\n    <span class=\"n\">javaVersion</span> <span class=\"o\">=</span> <span class=\"mf\">1.8</span>\n    <span class=\"n\">defaultEncoding</span> <span class=\"o\">=</span> <span class=\"s1\">'UTF-8'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">sourceCompatibility</span> <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">targetCompatibility</span>  <span class=\"o\">=</span> <span class=\"n\">javaVersion</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">AbstractCompile</span><span class=\"o\">)*.</span><span class=\"na\">options</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">GroovyCompile</span><span class=\"o\">)*.</span><span class=\"na\">groovyOptions</span><span class=\"o\">*.</span><span class=\"na\">encoding</span> <span class=\"o\">=</span> <span class=\"n\">defaultEncoding</span>\n<span class=\"n\">mainClassName</span> <span class=\"o\">=</span> <span class=\"s1\">'jp.takumon.sapmleapp.App'</span>\n\n<span class=\"n\">repositories</span> <span class=\"o\">{</span>\n    <span class=\"n\">mavenCentral</span><span class=\"o\">()</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">dependencies</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 依存ライブラリを記載 </span>\n\n    <span class=\"n\">compile</span> <span class=\"nl\">group:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">name:</span> <span class=\"s1\">'junit'</span><span class=\"o\">,</span> <span class=\"nl\">version:</span> <span class=\"s1\">'4.12'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jar</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">war</span> <span class=\"o\">{</span>\n    <span class=\"n\">baseName</span> <span class=\"o\">=</span> <span class=\"n\">appName</span>\n    <span class=\"n\">version</span> <span class=\"o\">=</span>  <span class=\"n\">appVersion</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">checkstyle</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'7.6.1'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">findbugs</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s2\">\"3.0.1\"</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">pmd</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">sourceSets</span> <span class=\"o\">=</span> <span class=\"o\">[</span><span class=\"n\">sourceSets</span><span class=\"o\">.</span><span class=\"na\">main</span><span class=\"o\">]</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">tasks</span><span class=\"o\">.</span><span class=\"na\">withType</span><span class=\"o\">(</span><span class=\"n\">Pmd</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"c1\">// CPD（重複コードチェック処理）をCheckタスクに追加</span>\n<span class=\"n\">check</span><span class=\"o\">.</span><span class=\"na\">doLast</span> <span class=\"o\">{</span>\n    <span class=\"n\">File</span> <span class=\"n\">outputDir</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"s2\">\"$reportsDir/cpd/\"</span><span class=\"o\">)</span>\n    <span class=\"n\">outputDir</span><span class=\"o\">.</span><span class=\"na\">mkdirs</span><span class=\"o\">()</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">taskdef</span><span class=\"o\">(</span>\n        <span class=\"nl\">name:</span> <span class=\"s1\">'cpd'</span><span class=\"o\">,</span> \n        <span class=\"nl\">classname:</span> <span class=\"s1\">'net.sourceforge.pmd.cpd.CPDTask'</span><span class=\"o\">,</span>\n        <span class=\"nl\">classpath:</span> <span class=\"n\">configurations</span><span class=\"o\">.</span><span class=\"na\">pmd</span><span class=\"o\">.</span><span class=\"na\">asPath</span><span class=\"o\">)</span>\n\n    <span class=\"n\">ant</span><span class=\"o\">.</span><span class=\"na\">cpd</span><span class=\"o\">(</span>\n        <span class=\"nl\">minimumTokenCount:</span> <span class=\"s1\">'100'</span><span class=\"o\">,</span>\n        <span class=\"nl\">format:</span> <span class=\"s1\">'xml'</span><span class=\"o\">,</span>\n        <span class=\"nl\">encoding:</span> <span class=\"n\">defaultEncoding</span><span class=\"o\">,</span>\n        <span class=\"nl\">outputFile:</span> <span class=\"k\">new</span> <span class=\"n\">File</span><span class=\"o\">(</span><span class=\"n\">outputDir</span><span class=\"o\">,</span> <span class=\"s1\">'cpd.xml'</span><span class=\"o\">)</span>\n    <span class=\"o\">)</span> <span class=\"o\">{</span>\n        <span class=\"n\">fileset</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"s2\">\"src/main/java\"</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n            <span class=\"n\">include</span><span class=\"o\">(</span><span class=\"nl\">name:</span> <span class=\"s1\">'**/*.java'</span><span class=\"o\">)</span>\n        <span class=\"o\">}</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">javadoc</span> <span class=\"o\">{</span>\n    <span class=\"n\">failOnError</span> <span class=\"o\">=</span> <span class=\"kc\">false</span>\n    <span class=\"c1\">// 好みのレベルで</span>\n    <span class=\"n\">options</span><span class=\"o\">.</span><span class=\"na\">memberLevel</span> <span class=\"o\">=</span> <span class=\"n\">JavadocMemberLevel</span><span class=\"o\">.</span><span class=\"na\">PRIVATE</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">test</span> <span class=\"o\">{</span>\n    <span class=\"c1\">// 失敗しても後続の処理を継続させる</span>\n    <span class=\"n\">ignoreFailures</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n        <span class=\"n\">junitXml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacoco</span> <span class=\"o\">{</span>\n    <span class=\"n\">toolVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'0.7.5.201505241946'</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">jacocoTestReport</span> <span class=\"o\">{</span>\n    <span class=\"n\">reports</span> <span class=\"o\">{</span>\n      <span class=\"n\">xml</span><span class=\"o\">.</span><span class=\"na\">enabled</span> <span class=\"o\">=</span> <span class=\"kc\">true</span>\n    <span class=\"o\">}</span>\n\n    <span class=\"c1\">// カバレッジレポートからテストクラスを除外</span>\n    <span class=\"n\">afterEvaluate</span> <span class=\"o\">{</span> \n        <span class=\"n\">classDirectories</span> <span class=\"o\">=</span> <span class=\"n\">files</span><span class=\"o\">(</span><span class=\"n\">classDirectories</span><span class=\"o\">.</span><span class=\"na\">files</span><span class=\"o\">.</span><span class=\"na\">collect</span> <span class=\"o\">{</span>\n            <span class=\"n\">fileTree</span><span class=\"o\">(</span><span class=\"nl\">dir:</span> <span class=\"n\">it</span><span class=\"o\">,</span> <span class=\"nl\">exclude:</span> <span class=\"o\">[</span><span class=\"s1\">'**/*Test.class'</span><span class=\"o\">])</span> \n        <span class=\"o\">})</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span>\n\n<span class=\"n\">task</span> <span class=\"nf\">wrapper</span> <span class=\"o\">(</span><span class=\"nl\">type:</span> <span class=\"n\">Wrapper</span><span class=\"o\">)</span> <span class=\"o\">{</span>\n    <span class=\"n\">gradleVersion</span> <span class=\"o\">=</span> <span class=\"s1\">'3.4.1'</span>\n<span class=\"o\">}</span>\n</pre></div>\n</div>\n\n<p>以上。</p>\n","body":"GradleのJavaアプリをJenkinsで１人CIするためのJenkinsfileを書いてみた。\nGithubにプッシュ時に、AWS上のJenkinsのパイプラインジョブが動いて、テストが成功したら同じくAWS上のTomcatにデプロイするみたいな感じで使ってます。\n\n# Declarative Pipeline\nいままではJenkinsfileを\n\n```\nnode {\n  ....\n}\n```\n\nのように書いてましたが、[Jenkinsの公式サイト](https://jenkins.io/doc/book/pipeline/syntax/)を見ると\nこれはScripted Pipelinesの記法であり、\nPipeline Pluginのバージョン2.5移行からは\n\n```\npipeline {\n  ....  \n}\n```\nのように書くDeclarative Pipelineという記法が導入されて、\nそっちのほうがシンプルでわかりやすく書けるよ!ということだったので書き直してみました。\n確かにすっきりしたし（特に最後のメールおくるとことか、デプロイするとことか）、\nいざとなったら従来のScripted Pipelinesもミックスできるのでいい感じです。\n\n# 追加したプラグイン\nJenkins初期設定時のSuggested Pluginに入っていないもの\n\n* [Checkstyle Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Checkstyle+Plugin;jsessionid=E9D4FA5064ACAE1CED7B19928DE0788F)（v3.47） - Checkstyeの結果収集用\n* [FindBugs Plugin](https://wiki.jenkins-ci.org/display/JENKINS/FindBugs+Plugin)（v4.69） - Findbugsのレポート生成用 \n* [PMD Plugin](https://wiki.jenkins-ci.org/display/JENKINS/PMD+Plugin)（v3.46） - PMDのレポート生成用\n* [DRY Plugin](https://wiki.jenkins-ci.org/display/JENKINS/DRY+Plugin)（v2.46） - CPD(重複コードチェック)のレポート生成用\n* [Step Counter Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Step+Counter+Plugin)（v2.0.0） - ソースコードのステップ数を集計してくれる\n* [Task Scanner Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Task+Scanner+Plugin)（v4.50） - ソースコード中のTODOとかを一覧化してくれる\n* [Javadoc Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Javadoc+Plugin)（v1.4） - JavaDoc生成用\n* [Warnings Plugin](https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin)（v4.60） - ジョブ実行時の警告メッセージを収集してくれる\n* [JaCoCo Plugin](https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin)（v2.2.0） - テストカバレッジのレポート生成用\n\n\n\n# Jenkinsfile\nGithubからWebhookでJenkinsのパイプラインジョブを実行する。\nパイプラインジョブではGithubのJenkinsfileを使う。\nジョブの流れは下記。デプロイは静的コード解析とテストが成功したときだけ実行する。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/56c8e12d-267b-a637-224e-fc8cb3474dfa.png)\n\n\n```groovy:Jenkinsfile\npipeline {\n    agent any\n    // 定数や変数を定義する\n    environment {\n        reportDir = 'build/reports'\n        javaDir = 'src/main/java'\n        resourcesDir = 'src/main/resources'\n        testReportDir = 'build/test-results/test'\n        jacocoReportDir = 'build/jacoco' \n        javadocDir = 'build/docs/javadoc'\n        libsDir = 'build/libs'\n        appName = 'SampleApp'\n        appVersion = '1.0.0'\n    }\n    \n    // stagesブロック中に一つ以上のstageを定義する\n    stages {\n        stage('事前準備') {\n            // 実際の処理はstepsブロック中に定義する\n            steps {\n                deleteDir()\n\n                // このJobをトリガーしてきたGithubのプロジェクトをチェックアウト\n                checkout scm\n\n                // ジョブ失敗の原因調査用にJenkinsfileとbuild.gradleは最初に保存する\n                archiveArtifacts \"Jenkinsfile\"\n                archiveArtifacts \"build.gradle\"\n\n                // scriptブロックを使うと従来のScripted Pipelinesの記法も使える\n                script {\n                    // Permission deniedで怒られないために実行権限を付与する\n                    if(isUnix()) {\n                        sh 'chmod +x gradlew'\n                    }\n                }\n                gradlew 'clean'\n            }\n        }\n        \n        stage('コンパイル') {\n            steps {\n                gradlew 'classes testClasses'\n            }\n            \n            // postブロックでstepsブロックの後に実行される処理が定義できる\n            post {\n                // alwaysブロックはstepsブロックの処理が失敗しても成功しても必ず実行される\n                always {\n\n                    // JavaDoc生成時に実行するとJavaDocの警告も含まれてしまうので\n                    // Javaコンパイル時の警告はコンパイル直後に収集する\n                    step([\n\n                        // プラグインを実行するときのクラス指定は完全修飾名でなくてもOK\n                        $class: 'WarningsPublisher',\n\n                        // Job実行時のコンソールから警告を収集する場合はconsoleParsers、\n                        // pmd.xmlなどのファイルから収集する場合はparserConfigurationsを指定する。\n                        // なおparserConfigurationsの場合はparserNameのほかにpattern(集計対象ファイルのパス)も指定が必要\n                        // パーサ名は下記プロパティファイルに定義されているものを使う\n                        // https://github.com/jenkinsci/warnings-plugin/blob/master/src/main/resources/hudson/plugins/warnings/parser/Messages.properties\n                        consoleParsers: [\n                            [parserName: 'Java Compiler (javac)'],\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n        stage('静的コード解析') {\n            steps {\n                // 並列処理の場合はparallelメソッドを使う\n                parallel(\n                    '静的コード解析' : {\n                        gradlew 'check -x test'\n\n                        // dirメソッドでカレントディレクトリを指定できる\n                        dir(reportDir) {\n                            step([\n                                $class: 'CheckStylePublisher',\n                                pattern: \"checkstyle/*.xml\"\n                            ])\n                            step([\n                                $class: 'FindBugsPublisher',\n                                pattern: \"findbugs/*.xml\"\n                            ])\n                            step([\n                                $class: 'PmdPublisher',\n                                pattern: \"pmd/*.xml\"\n                            ])\n                            step([\n                                $class: 'DryPublisher',\n                                pattern: \"cpd/*.xml\"\n                            ])\n                \n                            archiveArtifacts \"checkstyle/*.xml\"\n                            archiveArtifacts \"findbugs/*.xml\"\n                            archiveArtifacts \"pmd/*.xml\"\n                            archiveArtifacts \"cpd/*.xml\"\n                        }\n                    },\n                    'ステップカウント': {\n                        // レポート作成\n                        // outputFileとoutputFormatを指定するとエクセルファイルも作成してくれる\n                        stepcounter outputFile: 'stepcount.xls', outputFormat: 'excel', settings: [\n                            [key:'Java', filePattern: \"${javaDir}/**/*.java\"],\n                            [key:'SQL', filePattern: \"${resourcesDir}/**/*.sql\"],\n                            [key:'HTML', filePattern: \"${resourcesDir}/**/*.html\"],\n                            [key:'JS', filePattern: \"${resourcesDir}/**/*.js\"],\n                            [key:'CSS', filePattern: \"${resourcesDir}/**/*.css\"]\n                        ]\n                        // 一応エクセルファイルも成果物として保存する\n                        archiveArtifacts \"stepcount.xls\"\n                    },\n                    'タスクスキャン': {\n                        step([\n                            $class: 'TasksPublisher',\n                            pattern: './**',\n                            // 集計対象を検索するときに大文字小文字を区別するか\n                            ignoreCase: true,\n                            // 優先度別に集計対象の文字列を指定できる\n                            // 複数指定する場合はカンマ区切りの文字列を指定する\n                            high: 'System.out.System.err',\n                            normal: 'TODO,FIXME,XXX',\n                        ])\n                    },\n                    'JavaDoc': {\n                        gradlew 'javadoc -x classes'\n                        step([\n                            $class: 'JavadocArchiver',\n                            // Javadocのindex.htmlがあるフォルダのパスを指定する\n                            javadocDir: \"${javadocDir}\",\n                            keepAll: true\n                        ])\n                    }\n                )\n            }\n            \n            post {\n                always {\n                   // JavaDocの警告を収集\n                    step([\n                        $class: 'WarningsPublisher',\n                        consoleParsers: [\n                            [parserName: 'JavaDoc Tool']\n                        ],\n                        canComputeNew: false,\n                        canResolveRelativesPaths: false,\n                        usePreviousBuildAsReference: true\n                    ])\n                }\n            }\n        }\n        \n\n        stage('テスト') {\n            steps {\n                gradlew 'test jacocoTestReport -x classes -x testClasses'\n                \n                junit \"${testReportDir}/*.xml\"\n                archiveArtifacts \"${testReportDir}/*.xml\"\n\n                // カバレッジレポートを生成（テストクラスを除外）\n                step([\n                    $class: 'JacocoPublisher',\n                    execPattern: \"${jacocoReportDir}/*.exec\",\n                    exclusionPattern: '**/*Test.class'\n                ])\n            }\n        }\n        \n        stage('デプロイ') {\n            // whenブロックでstageを実行する条件を指定できる\n            when {\n                // 静的コード解析とテスト失敗時はデプロイしない\n                expression {currentBuild.currentResult == 'SUCCESS'}\n            }\n            \n            steps {\n                gradlew 'jar'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.jar\"\n                gradlew 'war'\n                archiveArtifacts \"${libsDir}/${appName}-${appVersion}.war\"\n                deploy warDir: libsDir, appName: appName, appVersion: appVersion\n            }\n        }\n    }\n    \n    // stagesブロックと同じレベルにpostブロックを定義すると\n    // 全てのstage処理が終わった後の処理の定義が可能    \n    post {\n        always {\n            // 最後にワークスペースの中身を削除\n            deleteDir()\n        }\n        // 連続で成功しているとき以外は自分宛にメールを送信\n\n        // 結果が前回と変わった時\n        changed {\n            sendMail(\"${currentBuild.previousBuild.result} => ${currentBuild.currentResult}\")\n        }\n        // 失敗した時\n        failure {\n            sendMail(currentBuild.currentResult)\n        }\n        // 不安定な時（主にテスト失敗時）\n        unstable {\n            sendMail(currentBuild.currentResult)\n        }\n    }\n}\n\n\n// Gradlewコマンドを実行する\ndef gradlew(command) {\n    if(isUnix()) {\n        sh \"./gradlew ${command} --stacktrace\"\n    } else {\n        bat \"./gradlew.bat ${command} --stacktrace\"\n    }\n}\n\n// デプロイする\n// args.warDir warの格納ディレクトリ \n// args.appName アプリ名\n// args.appVersion アプリのバージョン\ndef deploy(Map args) {\n    // 秘密鍵のパス ※Tomcatサーバにファイル転送するので事前にJenkinsサーバのどこかに秘密鍵を格納しておく必要がある\n    def keyDir = '/var/lib/jenkins/.ssh/xxx'\n    // Tomcatサーバのアドレスとユーザ名\n    def webServerAddress = 'ecX-XX-XXX-X-X.xx-xxxx-x.xxxxxxxx'\n    def webServerUser = 'hoge-user'\n    def webServer = \"${webServerUser}@${webServerAddress}\"\n    \n    def srcWar = \"${args.appName}-${args.appVersion}.war\"\n    def destWar = \"${args.appName}.war\"\n    \n    // ファイル転送してTomcatのwebappsにwarを配置する\n    sh \"sudo -S scp -i ${keyDir} ./${args.warDir}/${srcWar} ${webServer}:/home/ec2-user\"\n    sh \"sudo -S ssh -i ${keyDir} ${webServer} \\\"sudo cp /home/ec2-user/${srcWar} /usr/share/tomcat8/webapps/${destWar}\\\"\"\n}\n\n// メールをGmailに送信する\ndef sendMail(result) {\n    mail to: \"xxxxxxxx@gmail.com\",\n        subject: \"${env.JOB_NAME} #${env.BUILD_NUMBER} [${result}]\",\n        body: \"Build URL: ${env.BUILD_URL}.\\n\\n\"\n}\n```\n\n# 躓いたこと\n* 各プラグインともChangelogに「パイプライン対応したよ！」とは書いてあるが、\n具体的は書き方は明記していないことが多いので、\n各プラグインのGithubでソースコード（主に「なんちゃらPublisher」クラス）を見ながら、Jenkinsfileを書いた。\n* currentBuildオブジェクトの使い方がよくわからなかったが、Jenkinsのパイプラインジョブ > 設定 > Pipeline Syntax > Global Variables Reference に詳しく載っていた。\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/0f616d50-c57f-235e-c214-8c8d0d19da97.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/a8ff2dcf-9d85-7c41-1ee0-fb4f83eb3c3c.png)\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/f63b50f5-769d-8ff2-1909-f06aecc07106.png)\n \n* カバレッジレポートはbuild.gradleのjacocoTestReportタスクでカバレッジレポート対象外にしていてもJenkinsのほうではうまく除外されなかったので、Jenkinsfileのほうでも対象外設定をした。\n* JenkinsからGmailにメールする場合、Jenkins > Jenkinsの管理 > システムの設定 > E-mail通知で下記のような設定が必要だった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/85a911bb-091d-996b-36ca-cf0360c65592.png)\n\n* JenkinsからGmailにメールする場合、[安全性の低いアプリがアカウントにアクセスするのを許可する](https://support.google.com/accounts/answer/6010255?hl=ja)の手順に従って許可を有効にする必要があった。\n\n![image](https://qiita-image-store.s3.amazonaws.com/0/49915/2478de55-c383-9a0b-6edb-94b3e8487ff4.png)\n\n# build.gradle\nJenkins自体は、Gradleのコマンドを実行して出力結果をもとにレポートを生成するだけなので、\nGradleのJavaアプリのbuild.gradleで下記処理が実行できるようになっている必要があります。\nまたJenkinsでGradleをインストールしなくていいようにGradleラッパーを作成しておきます。\n\n * checkstyle\n * findbugs\n * pmd\n * cpd(重複コードチェック)\n * test\n * jacocoReport\n * jar\n * war\n\n例えばこんな\n\n```groovy:build.gradle\napply plugin: 'java'\napply plugin: 'war'\napply plugin: 'checkstyle'\napply plugin: 'findbugs'\napply plugin: 'pmd'\napply plugin: 'jacoco'\n\next {\n    appVersion = '1.0.0'\n    appName = 'SampleApp'\n    javaVersion = 1.8\n    defaultEncoding = 'UTF-8'\n}\n\nsourceCompatibility = javaVersion\ntargetCompatibility  = javaVersion\ntasks.withType(AbstractCompile)*.options*.encoding = defaultEncoding\ntasks.withType(GroovyCompile)*.groovyOptions*.encoding = defaultEncoding\nmainClassName = 'jp.takumon.sapmleapp.App'\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    // 依存ライブラリを記載 \n\n    compile group: 'junit', name: 'junit', version: '4.12'\n}\n\njar {\n    baseName = appName\n    version =  appVersion\n}\n\nwar {\n    baseName = appName\n    version =  appVersion\n}\n\ncheckstyle {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = '7.6.1'\n}\n\nfindbugs {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n    toolVersion = \"3.0.1\"\n}\n\npmd {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    sourceSets = [sourceSets.main]\n}\n\ntasks.withType(Pmd) {\n    reports {\n      xml.enabled = true\n    }\n}\n\n// CPD（重複コードチェック処理）をCheckタスクに追加\ncheck.doLast {\n    File outputDir = new File(\"$reportsDir/cpd/\")\n    outputDir.mkdirs()\n  \n    ant.taskdef(\n        name: 'cpd', \n        classname: 'net.sourceforge.pmd.cpd.CPDTask',\n        classpath: configurations.pmd.asPath)\n  \n    ant.cpd(\n        minimumTokenCount: '100',\n        format: 'xml',\n        encoding: defaultEncoding,\n        outputFile: new File(outputDir, 'cpd.xml')\n    ) {\n        fileset(dir: \"src/main/java\") {\n            include(name: '**/*.java')\n        }\n    }\n}\n\njavadoc {\n    failOnError = false\n    // 好みのレベルで\n    options.memberLevel = JavadocMemberLevel.PRIVATE\n}\n\ntest {\n    // 失敗しても後続の処理を継続させる\n    ignoreFailures = true\n    reports {\n        junitXml.enabled = true\n    }\n}\n\njacoco {\n    toolVersion = '0.7.5.201505241946'\n}\n\njacocoTestReport {\n    reports {\n      xml.enabled = true\n    }\n    \n    // カバレッジレポートからテストクラスを除外\n    afterEvaluate { \n        classDirectories = files(classDirectories.files.collect {\n            fileTree(dir: it, exclude: ['**/*Test.class']) \n        })\n    }\n}\n\ntask wrapper (type: Wrapper) {\n    gradleVersion = '3.4.1'\n}\n```\n\n\n以上。\n","comments_count":0,"created_at":"2017-04-07T02:38:55+09:00","likes_count":53,"reactions_count":0}],"latestPosts":[{"fields":{"slug":"/gatsby-related-posts-like-hugo","title":"GatsbyでRelated Content(関連記事)を表示する / Hugoの関連記事機能をGatsbyに移植した","date":"2019-02-09T17:00:00.000+09:00","excerpt":"なにこれブログでよく見かけるUIのひとつに関連記事リンクあります。記事下部に関連記事リンクを設けておくと、記事を読み終えたユーザーが、また別の記事を見てくれる可能性が上がるので、回遊率向上という観点で非常に効果的なUIです。そんな関連記事リ...","tags":["Gatsby","Hugo","golang"],"keywords":["Gatsby"],"thumbnail":"/thumbnail/2019/02/gatsby-related-posts-like-hugo.png"}},{"fields":{"slug":"/mdx-deck-and-code-surfer","title":"WEBエンジニア勉強会 初LT感想と参加レポート / 「MDX-DeckとCode Surferでスライドを作ろう！」補足情報","date":"2019-02-03T17:15:00.000+09:00","excerpt":"なにこれ2019/2/1(金)、WEBエンジニア勉強会 #11でLTしてきました。本記事では自分のLTスライドと、10分の枠では伝えきれなかった補足情報を紹介します。また他の方のLTの様子や、勉強会の雰囲気なども参加レポートとして書いていま...","tags":["勉強会","LT","mdx-deck","mdx","code-surfer","markdown","プレゼン","スライド"],"keywords":["mdx-deck"],"thumbnail":"/thumbnail/2019/02/mdx-deck-and-code-surfer.png"}},{"fields":{"slug":"/graphpack-graphql-zero-config-server","title":"設定いらずのNode製GraphQLサーバー「Graphpack」の使い方 / Query, Mutation, Subscriptionを試す","date":"2019-01-23T19:50:00.000+09:00","excerpt":"なにこれ「とりあえずクライアント側と同じJavaScriptで手っ取り早くGraphQLサーバー立てたい！」このようなユースケースにGraphpackはピッタリです。設定いらずのNode製GraphQLサーバーで 「GraphQLのスキーマ...","tags":["GraphQL","Graphpack"],"keywords":["GraphQL"],"thumbnail":"/thumbnail/2019/01/graphpack-graphql-zero-config-server.png"}},{"fields":{"slug":"/impression-of-cherrypick-js-20190119","title":"懇親会で飛び込みLTに参加した / 「JavaScriptつまみ食い LT 会 ～ つまみ食い LT 大会！」の感想","date":"2019-01-21T03:30:00.000+09:00","excerpt":"なにこれ2019/1/19(土)、JavaScriptつまみ食い LT 会 #4 ～ つまみ食い LT 大会！で懇親会にて飛び込みLTに参加しました。勉強会の様子も含めLTの感想を書きます。どんな勉強会だったか今回で開催5回目となり、4回目...","tags":["JavaScript","mdx-deck","勉強会","LT"],"keywords":["勉強会"],"thumbnail":"/thumbnail/2019/01/impression-of-cherrypick-js-20190119.png"}},{"fields":{"slug":"/how-to-register-your-blog-in-gatsby-showcase","title":"Gatsbyショーケースに自分のWebサイトを登録する方法","date":"2019-01-15T22:00:00.000+09:00","excerpt":"なにこれGatsbyの公式サイトにはショーケースなるものがあって、世の中に公開されているGatsby製のWebサイトを一覧で見ることができます。実はこのショーケース、けっこう簡単に自分のWebサイトを登録できるということに最近気づきました。...","tags":["Gatsby"],"keywords":["Gatsby"],"thumbnail":"/thumbnail/2019/01/how-to-register-your-blog-in-gatsby-showcase.png"}}],"previous":{"fields":{"slug":"/386efa75-7773-5424-94a8-1a2b3ae52a6b/","title":"Asciidoc文法クイックリファレンスの日本語訳","date":"2017-05-29T03:14:20+09:00","excerpt":"概要AsciiDoc Syntax Quick Reference を日本語訳したものです。ところどころ意訳したり、補足説明を追加したりしています。これからAsciidoctorを使ってみようという方々のお役に立てれば幸いです。ドキュメント...","tags":["Markdown","ドキュメント","asciidoctor","asciidoc","Qiita"],"keywords":["Markdown"],"thumbnail":""},"id":"386efa75-7773-5424-94a8-1a2b3ae52a6b","title":"Asciidoc文法クイックリファレンスの日本語訳","rendered_body":"\n<h1>\n<span id=\"概要\" class=\"fragment\"></span><a href=\"#%E6%A6%82%E8%A6%81\"><i class=\"fa fa-link\"></i></a>概要</h1>\n\n<p><a href=\"http://asciidoctor.org/docs/asciidoc-syntax-quick-reference/\" rel=\"nofollow noopener\" target=\"_blank\">AsciiDoc Syntax Quick Reference</a> を日本語訳したものです。<br>\nところどころ意訳したり、補足説明を追加したりしています。<br>\nこれからAsciidoctorを使ってみようという方々のお役に立てれば幸いです。</p>\n\n<h1>\n<span id=\"ドキュメントのurl\" class=\"fragment\"></span><a href=\"#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AEurl\"><i class=\"fa fa-link\"></i></a>ドキュメントのURL</h1>\n\n<p>GitHub Pagesの下記URLにて公開しています。<br>\n<a href=\"https://takumon.github.io/asciidoc-syntax-quick-reference-japanese-translation/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://takumon.github.io/asciidoc-syntax-quick-reference-japanese-translation/</a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/f9d71b849f52ad0e5c128d814f813939a770567a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36616463636335332d623866322d323964302d613461382d3738656639326461306236382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/f9d71b849f52ad0e5c128d814f813939a770567a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36616463636335332d623866322d323964302d613461382d3738656639326461306236382e706e67\" alt=\"スクリーンショット 2017-06-03 12.43.12.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/6adccc53-b8f2-29d0-a4a8-78ef92da0b68.png\"></a></p>\n\n<h1>\n<span id=\"asciidoctorとは\" class=\"fragment\"></span><a href=\"#asciidoctor%E3%81%A8%E3%81%AF\"><i class=\"fa fa-link\"></i></a>Asciidoctorとは</h1>\n\n<p>AsciidoctorはAsciidocコンテンツをHTML5やDocBook 5、PDFに変換するためのツール群です。Rubyで実装されておりRubyGem.orgでパッケージが公開されています。オープンソースでGithubにホストされており、MITライセンスです。</p>\n\n<h1>\n<span id=\"asciidocとは\" class=\"fragment\"></span><a href=\"#asciidoc%E3%81%A8%E3%81%AF\"><i class=\"fa fa-link\"></i></a>Asciidocとは</h1>\n\n<p>Markdownなどのような軽量マークアップ言語の一つです。Markdownよりも高い表現力、高い可読性を持ち合わせたもので、技術文書を書くのに適しています。<br>\nまたOffice文章と比べてもテキストベースなので、軽量で、GITなどの構成管理ツールと相性が良いといったメリットがあります。</p>\n","body":"# 概要\n[AsciiDoc Syntax Quick Reference](http://asciidoctor.org/docs/asciidoc-syntax-quick-reference/) を日本語訳したものです。\nところどころ意訳したり、補足説明を追加したりしています。\nこれからAsciidoctorを使ってみようという方々のお役に立てれば幸いです。\n\n# ドキュメントのURL\nGitHub Pagesの下記URLにて公開しています。\nhttps://takumon.github.io/asciidoc-syntax-quick-reference-japanese-translation/\n\n![スクリーンショット 2017-06-03 12.43.12.png](https://qiita-image-store.s3.amazonaws.com/0/49915/6adccc53-b8f2-29d0-a4a8-78ef92da0b68.png)\n\n# Asciidoctorとは\nAsciidoctorはAsciidocコンテンツをHTML5やDocBook 5、PDFに変換するためのツール群です。Rubyで実装されておりRubyGem.orgでパッケージが公開されています。オープンソースでGithubにホストされており、MITライセンスです。\n\n# Asciidocとは\nMarkdownなどのような軽量マークアップ言語の一つです。Markdownよりも高い表現力、高い可読性を持ち合わせたもので、技術文書を書くのに適しています。\nまたOffice文章と比べてもテキストベースなので、軽量で、GITなどの構成管理ツールと相性が良いといったメリットがあります。\n\n\n","comments_count":2,"created_at":"2017-05-29T03:14:20+09:00","likes_count":14,"reactions_count":0},"next":{"fields":{"slug":"/270e2fae-ed90-5539-8c90-a2ed93ebba83/","title":"Fessを使用して、Asciidoctorで簡単に全文検索できるようにする","date":"2017-06-26T00:21:37+09:00","excerpt":"Asciidoctorを使うと、技術文書や手順書などのドキュメントを簡単にHTMLで公開できますが、ドキュメントが多くなると自分の調べたいキーワードが、どのドキュメントに載っているのか探すのが困難になってきます。そこで今回は、Dockerで...","tags":["JavaScript","全文検索","ドキュメント","Fess","asciidoctor","Qiita"],"keywords":["JavaScript"],"thumbnail":""},"id":"270e2fae-ed90-5539-8c90-a2ed93ebba83","title":"Fessを使用して、Asciidoctorで簡単に全文検索できるようにする","rendered_body":"<p><a href=\"http://asciidoctor.org/\" rel=\"nofollow noopener\" target=\"_blank\">Asciidoctor</a>を使うと、技術文書や手順書などのドキュメントを簡単にHTMLで公開できますが、ドキュメントが多くなると自分の調べたいキーワードが、どのドキュメントに載っているのか探すのが困難になってきます。</p>\n\n<p>そこで今回は、Dockerで全文検索サーバの<a href=\"http://fess.codelibs.org/ja/\" rel=\"nofollow noopener\" target=\"_blank\">Fess</a>を立てて、<br>\nドキュメントからJavaScript経由でFessのJSON APIを呼び出すことで、<br>\n全文検索を簡単に導入する方法をご紹介します。</p>\n\n<p>導入するとドキュメントの右上に検索窓が出てきて全文検索できるようになります。<br>\n<a href=\"https://camo.qiitausercontent.com/e020d2b6619c0b7ce4332c80ea15b89a6efb895e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f31323365633737312d666237372d653464632d646637652d6134623430373739323735392e676966\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/e020d2b6619c0b7ce4332c80ea15b89a6efb895e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f31323365633737312d666237372d653464632d646637652d6134623430373739323735392e676966\" alt=\"6月-24-2017 19-05-32.gif\" title=\"6月-24-2017 19-05-32.gif\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/123ec771-fb77-e4dc-df7e-a4b407792759.gif\"></a></p>\n\n<h2>\n<span id=\"fessとは\" class=\"fragment\"></span><a href=\"#fess%E3%81%A8%E3%81%AF\"><i class=\"fa fa-link\"></i></a>Fessとは</h2>\n\n<p><a href=\"http://fess.codelibs.org/ja/\" rel=\"nofollow noopener\" target=\"_blank\">Fess</a>は<strong>「5 分で簡単に構築可能な全文検索サーバー」</strong>です。<br>\nJavaベースで構築されており、Apacheライセンスで提供されるオープンソース製品で、無料で使用できます。<br>\n自分でクローラを設定して、自分だけの検索エンジンがつくれるようなイメージです。<br>\nデフォルトで検索画面を提供していますが、JSON APIも提供しているので、様々なシステムと連携可能です。</p>\n\n<h2>\n<span id=\"全体像\" class=\"fragment\"></span><a href=\"#%E5%85%A8%E4%BD%93%E5%83%8F\"><i class=\"fa fa-link\"></i></a>全体像</h2>\n\n<p>ドキュメント用Webサーバに全文検索用のJavaScriptファイルとCSSファイルを追加し、Dockerで全文検索用のFessサーバを立てます。<br>\nFessサーバはドキュメント用Webサーバをクロールし、その情報を保存しておきます。<br>\nドキュメントで全文検索を実施すると、JavaScript経由でFessサーバのJSON AIPを呼び出して、全文検索結果をドキュメントに表示します。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/6fe043176da6b6451722114a3d0418bc40ac8c99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f31306338616334362d323135352d386562372d613565642d3763313363653534346563322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/6fe043176da6b6451722114a3d0418bc40ac8c99/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f31306338616334362d323135352d386562372d613565642d3763313363653534346563322e706e67\" alt=\"0_Fess_全体像_1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/10c8ac46-2155-8eb7-a5ed-7c13ce544ec2.png\"></a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/729e46c74903de7be597a6ac4adea0c03cd8559f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34306531643435362d323633352d326165642d333333642d3862316165633434373933312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/729e46c74903de7be597a6ac4adea0c03cd8559f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34306531643435362d323633352d326165642d333333642d3862316165633434373933312e706e67\" alt=\"0_Fess_全体像_2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/40e1d456-2635-2aed-333d-8b1aec447931.png\"></a></p>\n\n<h2>\n<span id=\"導入手順\" class=\"fragment\"></span><a href=\"#%E5%B0%8E%E5%85%A5%E6%89%8B%E9%A0%86\"><i class=\"fa fa-link\"></i></a>導入手順</h2>\n\n<p>この導入手順は、下記のような環境（ローカルPCのDocker上にドキュメント用WebサーバとFessサーバが立っている環境）を作った時のものです。<br>\nDockerを使わなくても、ローカルPC以外でも、導入可能です。導入手順は適宜読み替えてください。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/a94911642557c486b240ffa8c3c184c64bfabc2c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30626164623864322d316135382d323262362d343537632d3132626563663361383931312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/a94911642557c486b240ffa8c3c184c64bfabc2c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30626164623864322d316135382d323262362d343537632d3132626563663361383931312e706e67\" alt=\"0_Fess_全体像_3.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/0badb8d2-1a58-22b6-457c-12becf3a8911.png\"></a></p>\n\n<h3>\n<span id=\"fessのインストール\" class=\"fragment\"></span><a href=\"#fess%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"><i class=\"fa fa-link\"></i></a>Fessのインストール</h3>\n\n<p>Docker Hubの<a href=\"https://hub.docker.com/r/codelibs/fess/\" rel=\"nofollow noopener\" target=\"_blank\">codelibs/fess</a>を使用します。今回ポートは10084で公開します。<br>\nDockerを使わない場合は<a href=\"http://fess.codelibs.org/ja/11.2/install/index.html\" rel=\"nofollow noopener\" target=\"_blank\">Fess インストールガイド</a>を参考にしてください。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ docker run -d -p 10084:8080 --name fess codelibs/fess:latest\n</pre></div></div>\n\n<h3>\n<span id=\"fessの設定\" class=\"fragment\"></span><a href=\"#fess%E3%81%AE%E8%A8%AD%E5%AE%9A\"><i class=\"fa fa-link\"></i></a>Fessの設定</h3>\n\n<h4>\n<span id=\"クローラの設定\" class=\"fragment\"></span><a href=\"#%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E8%A8%AD%E5%AE%9A\"><i class=\"fa fa-link\"></i></a>クローラの設定</h4>\n\n<p><code>http://[PCのローカルIPアドレス]:10084/login</code>にアクセスするとログイン画面が表示されます。<br>\nデフォルトのID/PASS　<code>admin/admin</code>でログインしましょう。<br>\n<a href=\"https://camo.qiitausercontent.com/d173fd5ce7a76eb7b5a6ef053a670dd6551d720c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65373930656361392d353037332d393438652d336534332d6437353436643537666165352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/d173fd5ce7a76eb7b5a6ef053a670dd6551d720c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65373930656361392d353037332d393438652d336534332d6437353436643537666165352e706e67\" alt=\"1_Fess管理者_ログイン画面.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/e790eca9-5073-948e-3e43-d7546d57fae5.png\"></a><br>\n<br></p>\n\n<p>ログインするとダッシュボードが表示されます。左ペインの<code>クローラ</code> &gt; <code>Web</code>　を選択しましょう。<br>\n<a href=\"https://camo.qiitausercontent.com/cbfee37bd5d06381615f013da8587b1af91c35aa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61636662653935302d666137342d643063622d336365652d3565386462346465356237342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/cbfee37bd5d06381615f013da8587b1af91c35aa/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f61636662653935302d666137342d643063622d336365652d3565386462346465356237342e706e67\" alt=\"2_Fess管理者_ダッシュボード.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/acfbe950-fa74-d0cb-3cee-5e8db4de5b74.png\"></a><br>\n<br></p>\n\n<p>Webクローラにはまだ何も登録されていないので、左上の<code>+　新規作成</code>ボタンをクリックしましょう。<br>\n<a href=\"https://camo.qiitausercontent.com/e60be4a90df24cb1275c165752de363b15859b87/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36333130333762342d616162322d386530642d663961612d3364323365633931376132392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/e60be4a90df24cb1275c165752de363b15859b87/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36333130333762342d616162322d386530642d663961612d3364323365633931376132392e706e67\" alt=\"3_Fess管理者_Webクロール設定_1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/631037b4-aab2-8e0d-f9aa-3d23ec917a29.png\"></a><br>\n<br></p>\n\n<p>Webクロール情報入力画面が表示されます。<br>\n<a href=\"https://camo.qiitausercontent.com/62cd6f97bb7dfebb163873f26b5fda4fabcf89c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65653561303963392d376363652d336665632d373838342d3132353863333266613931612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/62cd6f97bb7dfebb163873f26b5fda4fabcf89c5/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65653561303963392d376363652d336665632d373838342d3132353863333266613931612e706e67\" alt=\"3_Fess管理者_Webクロール設定_2.png\" title=\"3_Fess管理者_Webクロール設定_2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/ee5a09c9-7cce-3fec-7884-1258c32fa91a.png\"></a></p>\n\n<p>設定項目は色々ありますが、とりあえず下記項目だけ設定しましょう。</p>\n\n<ul>\n<li>名前 \n\n<ul>\n<li>任意の名前を設定してください。</li>\n</ul>\n</li>\n<li>URL \n\n<ul>\n<li>ドキュメント用Webサーバにおいてドキュメントが格納されているルートフォルダのURLを指定してください。末尾に<code>/</code>を付けてください。</li>\n</ul>\n</li>\n<li>クロール対象とするURL \n\n<ul>\n<li>正規表現で値を設定します。上記<code>URL</code>で設定したルートフォルダ配下の全資産を対象とするために、<code>URLで設定した値</code> + <code>.*</code> を指定してください。</li>\n</ul>\n</li>\n<li>検索対象とするURL\n\n<ul>\n<li>正規表現で値を設定します。HTMLのみを検索対象にしたい（JS、CSSなどは除外したい）ので、<code>URLで設定した値</code> + <code>.+\\.html$</code> を指定してください。\n<br>\n<br>\n</li>\n</ul>\n</li>\n</ul>\n\n<p>値を設定したら、画面を下にスクロールして<code>+　作成</code>ボタンをクリックします。<br>\nすると下記のようにWebクロールのデータが１件登録されます。<br>\n<a href=\"https://camo.qiitausercontent.com/8302d25592df90b2bdf59fbf3b43e31ecf106b3e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33643030626635612d663133312d643336372d646535332d6166313062623336383339642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/8302d25592df90b2bdf59fbf3b43e31ecf106b3e/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f33643030626635612d663133312d643336372d646535332d6166313062623336383339642e706e67\" alt=\"3_Fess管理者_Webクロール設定_4.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/3d00bf5a-f131-d367-de53-af10bb36839d.png\"></a><br>\n<br></p>\n\n<h4>\n<span id=\"クローラの実行\" class=\"fragment\"></span><a href=\"#%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%A9%E3%81%AE%E5%AE%9F%E8%A1%8C\"><i class=\"fa fa-link\"></i></a>クローラの実行</h4>\n\n<p>左ペインで　<code>システム</code> &gt; <code>スケジューラ</code> を選択してジョブスケジューラを開きます。<br>\nジョブスケジューラで <code>Default Crawler</code>を選択します。<br>\n<a href=\"https://camo.qiitausercontent.com/52e6c84dc635dabd786a05e2dc2dbc01bbcd62b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f62306165636130642d363461342d343364612d373832622d3061316130636437306238332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/52e6c84dc635dabd786a05e2dc2dbc01bbcd62b3/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f62306165636130642d363461342d343364612d373832622d3061316130636437306238332e706e67\" alt=\"4_Fess管理者_スケジューラ_1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/b0aeca0d-64a4-43da-782b-0a1a0cd70b83.png\"></a><br>\n<br></p>\n\n<p><code>今すぐ開始</code>をクリックします。<br>\n<a href=\"https://camo.qiitausercontent.com/15c56153ff7878a59bfda2bab0ac3b8b6182fa23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30306537363932302d626661642d656562312d636239392d3732346533613933393261392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/15c56153ff7878a59bfda2bab0ac3b8b6182fa23/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f30306537363932302d626661642d656562312d636239392d3732346533613933393261392e706e67\" alt=\"4_Fess管理者_スケジューラ_1.1.png\" title=\"4_Fess管理者_スケジューラ_1.1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/00e76920-bfad-eeb1-cb99-724e3a9392a9.png\"></a><br>\n<br></p>\n\n<p>するとクロールが実行されます。<br>\n<a href=\"https://camo.qiitausercontent.com/b34d527efb0b07d2b04cabccebe97f0e1e4b594c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f37323564333030662d303766352d373234642d636539332d3865316339373532653130652e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/b34d527efb0b07d2b04cabccebe97f0e1e4b594c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f37323564333030662d303766352d373234642d636539332d3865316339373532653130652e706e67\" alt=\"4_Fess管理者_スケジューラ_2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/725d300f-07f5-724d-ce93-8e1c9752e10e.png\"></a><br>\n<br></p>\n\n<p>しばらくして<code>F5</code>キーを押してブラウザを更新してください。<br>\nクロールが終了すると、スケジューラの状態が<code>実行中</code>から<code>有効</code>になります。<br>\n<a href=\"https://camo.qiitausercontent.com/2d860e111077a3a0b63a44b45e14e0e18b02fcb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65653466353237372d616163332d616437652d636465622d3431643339623733336331662e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/2d860e111077a3a0b63a44b45e14e0e18b02fcb1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f65653466353237372d616163332d616437652d636465622d3431643339623733336331662e706e67\" alt=\"4_Fess管理者_スケジューラ_3.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/ee4f5277-aac3-ad7e-cdeb-41d39b733c1f.png\"></a><br>\n<br></p>\n\n<h4>\n<span id=\"クローラ実行結果の確認\" class=\"fragment\"></span><a href=\"#%E3%82%AF%E3%83%AD%E3%83%BC%E3%83%A9%E5%AE%9F%E8%A1%8C%E7%B5%90%E6%9E%9C%E3%81%AE%E7%A2%BA%E8%AA%8D\"><i class=\"fa fa-link\"></i></a>クローラ実行結果の確認</h4>\n\n<p>左ペインの<code>システム情報</code>&gt;<code>クロール情報</code>を選択すると、先ほど実行したクロールの結果が表示されています。その行を選択します。<br>\n<a href=\"https://camo.qiitausercontent.com/e35eccd76c8d85dcc368298adfebb71871f083a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39326633313062352d383366362d646564612d343438642d6166613863356230663130342e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/e35eccd76c8d85dcc368298adfebb71871f083a7/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39326633313062352d383366362d646564612d343438642d6166613863356230663130342e706e67\" alt=\"5_Fess管理者_システム情報_クロール情報_1.png\" title=\"5_Fess管理者_システム情報_クロール情報_1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/92f310b5-83f6-deda-448d-afa8c5b0f104.png\"></a><br>\n<br></p>\n\n<p>セッションIDを選択します。<br>\n<a href=\"https://camo.qiitausercontent.com/341936c3d088fb04a1029cc6c891a35253a079da/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34653830636431342d333633342d663636352d623434382d3862346234653761386432312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/341936c3d088fb04a1029cc6c891a35253a079da/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f34653830636431342d333633342d663636352d623434382d3862346234653761386432312e706e67\" alt=\"5_Fess管理者_システム情報_クロール情報_2.png\" title=\"5_Fess管理者_システム情報_クロール情報_2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/4e80cd14-3634-f665-b448-8b4b4e7a8d21.png\"></a><br>\n<br></p>\n\n<p>ここにドキュメント用Webサーバのドキュメントが全て表示されればOKです。<br>\n<a href=\"https://camo.qiitausercontent.com/767e79c91f7521caf880a890deee50513f520ea9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36306238366263342d663730662d343263382d613031372d3566313338623362383865332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/767e79c91f7521caf880a890deee50513f520ea9/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f36306238366263342d663730662d343263382d613031372d3566313338623362383865332e706e67\" alt=\"5_Fess管理者_システム情報_クロール情報_3.png\" title=\"5_Fess管理者_システム情報_クロール情報_3.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/60b86bc4-f70f-42c8-a017-5f138b3b88e3.png\"></a><br>\n<br></p>\n\n<h3>\n<span id=\"ドキュメント用webサーバに全文検索用資産を配置\" class=\"fragment\"></span><a href=\"#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E7%94%A8web%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AB%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E7%94%A8%E8%B3%87%E7%94%A3%E3%82%92%E9%85%8D%E7%BD%AE\"><i class=\"fa fa-link\"></i></a>ドキュメント用Webサーバに全文検索用資産を配置</h3>\n\n<p>全文検索用の資産は<code>full-text-search.js</code>と<code>full-text-search.css</code>の２つです。<br>\n<code>full-text-search.js</code>の変数 FESS_JSON_ENDPOINT(FESSサーバのJSON APIのエンドポイント) は適時置き換えてください。<br>\nこれらの資産をドキュメント用Webサーバのドキュメントのルートフォルダ直下に配置してください。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\">\n<div class=\"code-lang\"><span class=\"bold\">full-text-search.js</span></div>\n<div class=\"highlight\"><pre><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"s1\">'use strict'</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// FESSサーバのJSON APIのエンドポイント（FessサーバのIPアドレス + /json）</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">FESS_JSON_ENDPOINT</span> <span class=\"o\">=</span> <span class=\"s1\">'http://192.168.1.5:10084/json'</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// １ページあたりの検索結果表示件数</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">COUNT_PAR_PAGE</span> <span class=\"o\">=</span> <span class=\"mi\">10</span><span class=\"p\">;</span>\n\n\n    <span class=\"c1\">// 目次の</span>\n    <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#toc'</span><span class=\"p\">)</span>\n        <span class=\"c1\">// 一番上に検索条件入力エリアを挿入</span>\n        <span class=\"p\">.</span><span class=\"nx\">prepend</span><span class=\"p\">(</span>\n            <span class=\"s1\">'&lt;div id=\"search-area\"&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;form id=\"search-form\"&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;div class=\"search-input-area\"&gt;'</span> <span class=\"o\">+</span>\n                        <span class=\"s1\">'&lt;i class=\"fa fa-search left-icon\"&gt;&lt;/i&gt;'</span> <span class=\"o\">+</span>\n                        <span class=\"s1\">'&lt;input id=\"search-query\" placeholder=\"全文検索\" /&gt;'</span> <span class=\"o\">+</span>\n                        <span class=\"s1\">'&lt;i class=\"fa fa-close right-icon\"&gt;&lt;/i&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;/div&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;input id=\"search-start\" type=\"hidden\" value=\"0\"/&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;input id=\"search-num\" type=\"hidden\" value=\"'</span> <span class=\"o\">+</span> <span class=\"nx\">COUNT_PAR_PAGE</span> <span class=\"o\">+</span> <span class=\"s1\">'\"/&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;form&gt;'</span> <span class=\"o\">+</span>\n            <span class=\"s1\">'&lt;/div&gt;'</span><span class=\"p\">)</span>\n        <span class=\"c1\">// イベント登録</span>\n        <span class=\"p\">.</span><span class=\"nx\">ready</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n            <span class=\"kd\">var</span> <span class=\"nx\">$searchArea</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">);</span>\n\n            <span class=\"c1\">// 入力項目の検索条件でEnterを押したら、検索処理を実行する</span>\n            <span class=\"nx\">$searchArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s1\">'#search-form'</span><span class=\"p\">).</span><span class=\"nx\">submit</span><span class=\"p\">({</span><span class=\"na\">navi</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">},</span> <span class=\"nx\">doSearch</span><span class=\"p\">);</span>\n\n            <span class=\"c1\">// 虫眼鏡アイコン押下したら、検索処理を実行する</span>\n            <span class=\"nx\">$searchArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s2\">\".left-icon\"</span><span class=\"p\">).</span><span class=\"nx\">click</span><span class=\"p\">({</span><span class=\"na\">navi</span><span class=\"p\">:</span><span class=\"mi\">0</span><span class=\"p\">},</span> <span class=\"nx\">doSearch</span><span class=\"p\">);</span>\n\n            <span class=\"c1\">// 検索条件入力したら、</span>\n            <span class=\"nx\">$searchArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s2\">\"#search-query\"</span><span class=\"p\">).</span><span class=\"nx\">keyup</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(){</span>\n              <span class=\"kd\">var</span> <span class=\"nx\">$this</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">);</span>\n              <span class=\"kd\">var</span> <span class=\"nx\">$rightIcon</span> <span class=\"o\">=</span> <span class=\"nx\">$this</span><span class=\"p\">.</span><span class=\"nx\">parent</span><span class=\"p\">().</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s2\">\".right-icon\"</span><span class=\"p\">);</span>\n\n              <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">$this</span><span class=\"p\">.</span><span class=\"nx\">val</span><span class=\"p\">().</span><span class=\"nx\">length</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                 <span class=\"c1\">// 検索条件に値がある場合は×アイコンの色を濃くする</span>\n                 <span class=\"nx\">$rightIcon</span><span class=\"p\">.</span><span class=\"nx\">css</span><span class=\"p\">(</span><span class=\"s1\">'color'</span><span class=\"p\">,</span><span class=\"s1\">'#555'</span><span class=\"p\">);</span>\n              <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n                 <span class=\"c1\">// 検索条件に値がない場合は×アイコンの色を薄くする</span>\n                 <span class=\"nx\">$rightIcon</span><span class=\"p\">.</span><span class=\"nx\">css</span><span class=\"p\">(</span><span class=\"s1\">'color'</span><span class=\"p\">,</span><span class=\"s1\">'#ccc'</span><span class=\"p\">);</span>\n              <span class=\"p\">}</span>\n            <span class=\"p\">});</span>\n\n            <span class=\"c1\">// ×アイコン押下したら、</span>\n            <span class=\"nx\">$searchArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s2\">\".right-icon\"</span><span class=\"p\">).</span><span class=\"nx\">click</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(){</span>\n              <span class=\"c1\">// ×アイコンの色を薄くして</span>\n              <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">).</span><span class=\"nx\">css</span><span class=\"p\">(</span><span class=\"s1\">'color'</span><span class=\"p\">,</span><span class=\"s1\">'#ccc'</span><span class=\"p\">)</span>\n                      <span class=\"c1\">// 検索条件をクリアする</span>\n                     <span class=\"p\">.</span><span class=\"nx\">parent</span><span class=\"p\">().</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s2\">\"input\"</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">(</span><span class=\"s1\">''</span><span class=\"p\">);</span>\n            <span class=\"p\">});</span>\n        <span class=\"p\">});</span>\n\n    <span class=\"c1\">// ドキュメントタイトルの</span>\n    <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#header&gt;h1'</span><span class=\"p\">)</span>\n        <span class=\"c1\">// 直下に検索結果エリアを挿入</span>\n        <span class=\"p\">.</span><span class=\"nx\">before</span><span class=\"p\">(</span>\n            <span class=\"s1\">'&lt;div id=\"search-result-area\"&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;div id=\"search-result-subheader\"&gt;&lt;/div&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;div id=\"search-result-content\"&gt;&lt;/div&gt;'</span> <span class=\"o\">+</span>\n            <span class=\"s1\">'&lt;/div&gt;'</span><span class=\"p\">)</span>\n        <span class=\"c1\">// イベント登録</span>\n        <span class=\"p\">.</span><span class=\"nx\">ready</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n            <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">)</span>\n                <span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-area'</span><span class=\"p\">)</span>\n                    <span class=\"c1\">// 検索結果エリアのバツアイコンをクリックしたら、</span>\n                    <span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s2\">\"click\"</span><span class=\"p\">,</span> <span class=\"s1\">'#remove-search-result'</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n                      <span class=\"kd\">var</span> <span class=\"nx\">$searchResultArea</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">delegateTarget</span><span class=\"p\">)</span>\n                      <span class=\"c1\">// 検索結果エリアを非表示モードにする</span>\n                      <span class=\"nx\">$searchResultArea</span><span class=\"p\">.</span><span class=\"nx\">removeClass</span><span class=\"p\">(</span><span class=\"s1\">'show'</span><span class=\"p\">);</span>\n                      <span class=\"c1\">// 検索結果エリアの中身を削除する</span>\n                      <span class=\"nx\">$searchResultArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-subheader'</span><span class=\"p\">).</span><span class=\"nx\">empty</span><span class=\"p\">();</span>\n                      <span class=\"nx\">$searchResultArea</span><span class=\"p\">.</span><span class=\"nx\">find</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-content'</span><span class=\"p\">).</span><span class=\"nx\">empty</span><span class=\"p\">();</span>\n                    <span class=\"p\">})</span>\n                    <span class=\"c1\">// 前ページリンクをクリックしたら、１ページ前を検索する</span>\n                    <span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s2\">\"click\"</span><span class=\"p\">,</span> <span class=\"s2\">\"#prevPageLink\"</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"na\">navi</span><span class=\"p\">:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">},</span> <span class=\"nx\">doSearch</span><span class=\"p\">)</span>\n                    <span class=\"c1\">// 次ページリンクをクリックしたら、１ページ後を検索する</span>\n                    <span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s2\">\"click\"</span><span class=\"p\">,</span> <span class=\"s2\">\"#nextPageLink\"</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"na\">navi</span><span class=\"p\">:</span><span class=\"mi\">1</span><span class=\"p\">},</span> <span class=\"nx\">doSearch</span><span class=\"p\">);</span>\n        <span class=\"p\">});</span>\n\n\n\n    <span class=\"cm\">/**\n     * 検索処理\n     *\n     * @param  {eventObject} event\n     * @return {boolean}  submit処理を中断させるために必ずfalseを返却する\n     */</span>\n    <span class=\"kd\">function</span> <span class=\"nx\">doSearch</span><span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">){</span>\n      <span class=\"c1\">// 検索フィールドの値をトリムして取得</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">searchQuery</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">.</span><span class=\"nx\">trim</span><span class=\"p\">(</span><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-query'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">());</span>\n      <span class=\"c1\">// 空の場合は検索処理を実行しない</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">searchQuery</span><span class=\"p\">.</span><span class=\"nx\">length</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">return</span> <span class=\"kc\">false</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n\n\n      <span class=\"c1\">// 表示開始位置、表示件数の取得</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">start</span> <span class=\"o\">=</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-start'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">()),</span>\n          <span class=\"nx\">num</span> <span class=\"o\">=</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-num'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">());</span>\n      <span class=\"c1\">// 表示開始位置のチェック</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">start</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nx\">start</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"c1\">// 表示件数のチェック</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">num</span> <span class=\"o\">&lt;</span> <span class=\"mi\">1</span> <span class=\"o\">||</span> <span class=\"nx\">num</span> <span class=\"o\">&gt;</span> <span class=\"mi\">100</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nx\">num</span> <span class=\"o\">=</span> <span class=\"mi\">20</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n      <span class=\"c1\">// 表示ページ情報の取得</span>\n      <span class=\"k\">switch</span><span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">navi</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">case</span> <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">:</span>\n          <span class=\"c1\">// 前のページの場合</span>\n          <span class=\"nx\">start</span> <span class=\"o\">-=</span> <span class=\"nx\">num</span><span class=\"p\">;</span>\n          <span class=\"k\">break</span><span class=\"p\">;</span>\n        <span class=\"k\">case</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n          <span class=\"c1\">// 次のページの場合</span>\n          <span class=\"nx\">start</span> <span class=\"o\">+=</span> <span class=\"nx\">num</span><span class=\"p\">;</span>\n          <span class=\"k\">break</span><span class=\"p\">;</span>\n        <span class=\"nl\">default</span><span class=\"p\">:</span>\n        <span class=\"k\">case</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n          <span class=\"nx\">start</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n          <span class=\"k\">break</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n\n\n      <span class=\"c1\">// URLを構築</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">url</span> <span class=\"o\">=</span> <span class=\"nx\">FESS_JSON_ENDPOINT</span> <span class=\"o\">+</span> <span class=\"s1\">'?callback=?'</span> <span class=\"o\">+</span> <span class=\"c1\">// 別ドメインを想定してJSONP形式でリクエストを送信する</span>\n                                     <span class=\"s1\">'&amp;q='</span> <span class=\"o\">+</span> <span class=\"nb\">encodeURIComponent</span><span class=\"p\">(</span><span class=\"nx\">searchQuery</span><span class=\"p\">)</span> <span class=\"o\">+</span>\n                                     <span class=\"s1\">'&amp;start='</span> <span class=\"o\">+</span> <span class=\"nx\">start</span> <span class=\"o\">+</span>\n                                     <span class=\"s1\">'&amp;num='</span> <span class=\"o\">+</span> <span class=\"nx\">num</span><span class=\"p\">;</span>\n\n      <span class=\"c1\">// 検索リクエスト送信</span>\n      <span class=\"c1\">// 別ドメインを想定してJSONP形式でリクエストを送信する</span>\n      <span class=\"nx\">$</span><span class=\"p\">.</span><span class=\"nx\">ajax</span><span class=\"p\">({</span>\n          <span class=\"na\">url</span><span class=\"p\">:</span> <span class=\"nx\">url</span><span class=\"p\">,</span>\n          <span class=\"na\">dataType</span><span class=\"p\">:</span> <span class=\"s1\">'jsonp'</span><span class=\"p\">,</span>\n          <span class=\"na\">success</span><span class=\"p\">:</span> <span class=\"nx\">renderSearchResult</span>\n      <span class=\"p\">});</span>\n\n\n      <span class=\"c1\">// ページ情報の更新</span>\n      <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#searchNum'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">(</span><span class=\"nx\">num</span><span class=\"p\">);</span>\n\n      <span class=\"c1\">// ページ表示を上部に移動</span>\n      <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nb\">document</span><span class=\"p\">).</span><span class=\"nx\">scrollTop</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n      <span class=\"c1\">// サブミットを抑止するためにfalseを返す</span>\n      <span class=\"k\">return</span> <span class=\"kc\">false</span><span class=\"p\">;</span>\n    <span class=\"p\">};</span>\n\n\n    <span class=\"cm\">/**\n     * 検索成功時に検索結果を描画する\n     *\n     * @param  {Anything} data レスポンスデータ\n     */</span>\n    <span class=\"kd\">function</span> <span class=\"nx\">renderSearchResult</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"c1\">// 検索結果処理</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">dataResponse</span> <span class=\"o\">=</span> <span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">;</span>\n      <span class=\"c1\">// ステータスチェック</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nx\">alert</span><span class=\"p\">(</span><span class=\"s2\">\"検索中に問題が発生しました。\"</span><span class=\"p\">);</span>\n        <span class=\"k\">return</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n\n      <span class=\"c1\">// 検索結果領域を表示する</span>\n      <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-area'</span><span class=\"p\">).</span><span class=\"nx\">addClass</span><span class=\"p\">(</span><span class=\"s1\">'show'</span><span class=\"p\">);</span>\n\n      <span class=\"kd\">var</span> <span class=\"nx\">$searchResultSubheader</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-subheader'</span><span class=\"p\">),</span>\n          <span class=\"nx\">$searchResultContent</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-result-content'</span><span class=\"p\">),</span>\n          <span class=\"nx\">record_count</span> <span class=\"o\">=</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">record_count</span><span class=\"p\">;</span>\n\n      <span class=\"c1\">// 検索結果がない場合</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">record_count</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// サブヘッダーに出力</span>\n        <span class=\"nx\">$searchResultSubheader</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span>  <span class=\"s1\">'&lt;div id=\"remove-search-result\" style=\"float:right;\"&gt;&lt;i class=\"fa fa-times\"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class=\"p\">;</span>\n\n        <span class=\"c1\">// 結果領域に出力</span>\n        <span class=\"nx\">$searchResultContent</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"s1\">'&lt;b&gt;'</span> <span class=\"o\">+</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">q</span> <span class=\"o\">+</span> <span class=\"s1\">'&lt;/b&gt;に一致する情報は見つかりませんでした。'</span><span class=\"p\">;</span>\n\n        <span class=\"k\">return</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n\n\n      <span class=\"c1\">// 検索にヒットした場合</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">page_number</span> <span class=\"o\">=</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">page_number</span><span class=\"p\">,</span>\n          <span class=\"nx\">page_size</span> <span class=\"o\">=</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">page_size</span><span class=\"p\">,</span>\n          <span class=\"nx\">page_count</span> <span class=\"o\">=</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">page_count</span><span class=\"p\">,</span>\n          <span class=\"nx\">startRange</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">page_number</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">*</span> <span class=\"nx\">page_size</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n          <span class=\"nx\">endRange</span> <span class=\"o\">=</span> <span class=\"nx\">page_number</span> <span class=\"o\">*</span> <span class=\"nx\">page_size</span><span class=\"p\">,</span>\n          <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">,</span>\n          <span class=\"nx\">max</span><span class=\"p\">,</span>\n          <span class=\"nx\">offset</span> <span class=\"o\">=</span> <span class=\"nx\">startRange</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n\n      <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s1\">'#search-start'</span><span class=\"p\">).</span><span class=\"nx\">val</span><span class=\"p\">(</span><span class=\"nx\">offset</span><span class=\"p\">);</span>\n\n\n      <span class=\"c1\">// サブヘッダーに出力</span>\n      <span class=\"nx\">$searchResultSubheader</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"s1\">'&lt;b&gt;'</span> <span class=\"o\">+</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">q</span> <span class=\"o\">+</span> <span class=\"s1\">'&lt;/b&gt; の検索結果 '</span> <span class=\"o\">+</span>\n                                <span class=\"nx\">record_count</span> <span class=\"o\">+</span> <span class=\"s2\">\" 件中 \"</span> <span class=\"o\">+</span>  <span class=\"nx\">startRange</span> <span class=\"o\">+</span> <span class=\"s1\">' - '</span> <span class=\"o\">+</span>\n                                <span class=\"nx\">endRange</span> <span class=\"o\">+</span> <span class=\"s1\">' 件目 ('</span> <span class=\"o\">+</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">exec_time</span> <span class=\"o\">+</span> <span class=\"s1\">' 秒)'</span> <span class=\"o\">+</span>\n                               <span class=\"s1\">'&lt;div id=\"remove-search-result\" style=\"float:right;\"&gt;&lt;i class=\"fa fa-times\"&gt;&lt;/i&gt;&lt;/div&gt;'</span>\n\n      <span class=\"c1\">// 検索結果領域のクリア</span>\n      <span class=\"nx\">$searchResultContent</span><span class=\"p\">.</span><span class=\"nx\">empty</span><span class=\"p\">();</span>\n\n\n      <span class=\"c1\">// 検索結果の出力</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">$resultBody</span> <span class=\"o\">=</span> <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"s2\">\"&lt;ol/&gt;\"</span><span class=\"p\">);</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">results</span> <span class=\"o\">=</span> <span class=\"nx\">dataResponse</span><span class=\"p\">.</span><span class=\"nx\">result</span><span class=\"p\">;</span>\n      <span class=\"k\">for</span><span class=\"p\">(</span><span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"nx\">max</span> <span class=\"o\">=</span> <span class=\"nx\">results</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"nx\">max</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"kd\">var</span> <span class=\"nx\">element</span> <span class=\"o\">=</span>\n            <span class=\"s1\">'&lt;li&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;h4 class=\"title\"&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;a href=\"'</span> <span class=\"o\">+</span><span class=\"nx\">results</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">].</span><span class=\"nx\">url_link</span> <span class=\"o\">+</span> <span class=\"s1\">'\"&gt;'</span> <span class=\"o\">+</span> <span class=\"nx\">results</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">].</span><span class=\"nx\">title</span> <span class=\"o\">+</span> <span class=\"s1\">'&lt;/a&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;/h4&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;div class=\"body\"&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"nx\">results</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">].</span><span class=\"nx\">content_description</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;br/&gt;'</span> <span class=\"o\">+</span>\n                    <span class=\"s1\">'&lt;cite&gt;'</span> <span class=\"o\">+</span> <span class=\"nx\">results</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">].</span><span class=\"nx\">site</span> <span class=\"o\">+</span> <span class=\"s1\">'&lt;/cite&gt;'</span> <span class=\"o\">+</span>\n                <span class=\"s1\">'&lt;/div&gt;'</span> <span class=\"o\">+</span>\n            <span class=\"s1\">'&lt;/li&gt;'</span><span class=\"p\">;</span>\n\n        <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nx\">element</span><span class=\"p\">).</span><span class=\"nx\">appendTo</span><span class=\"p\">(</span><span class=\"nx\">$resultBody</span><span class=\"p\">);</span>\n      <span class=\"p\">}</span>\n      <span class=\"nx\">$resultBody</span><span class=\"p\">.</span><span class=\"nx\">appendTo</span><span class=\"p\">(</span><span class=\"nx\">$searchResultContent</span><span class=\"p\">);</span>\n\n\n      <span class=\"c1\">// ページ番号情報の出力</span>\n      <span class=\"kd\">var</span> <span class=\"nx\">pageArea</span> <span class=\"o\">=</span> <span class=\"p\">[];</span>\n      <span class=\"nx\">pageArea</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"s1\">'&lt;div id=\"pageInfo\"&gt;'</span><span class=\"p\">,</span> <span class=\"nx\">page_number</span><span class=\"p\">,</span> <span class=\"s1\">'ページ目&lt;br/&gt;'</span><span class=\"p\">);</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">page_number</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// 前のページへのリンク</span>\n        <span class=\"nx\">pageArea</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"s1\">'&lt;a id=\"prevPageLink\" href=\"#\"&gt;&amp;lt;&amp;lt;前ページへ&lt;/a&gt; '</span><span class=\"p\">);</span>\n      <span class=\"p\">}</span>\n      <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"nx\">page_number</span> <span class=\"o\">&lt;</span> <span class=\"nx\">page_count</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// 次のページへのリンク</span>\n        <span class=\"nx\">pageArea</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"s1\">'&lt;a id=\"nextPageLink\" href=\"#\"&gt;次ページへ&amp;gt;&amp;gt;&lt;/a&gt;'</span><span class=\"p\">);</span>\n      <span class=\"p\">}</span>\n      <span class=\"nx\">pageArea</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"s1\">'&lt;/div&gt;'</span><span class=\"p\">);</span>\n      <span class=\"nx\">$</span><span class=\"p\">(</span><span class=\"nx\">pageArea</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"s2\">\"\"</span><span class=\"p\">)).</span><span class=\"nx\">appendTo</span><span class=\"p\">(</span><span class=\"nx\">$searchResultContent</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n</pre></div>\n</div>\n\n<div class=\"code-frame\" data-lang=\"css\">\n<div class=\"code-lang\"><span class=\"bold\">full-text-search.css</span></div>\n<div class=\"highlight\"><pre><span class=\"k\">@charset</span> <span class=\"s1\">\"UTF-8\"</span><span class=\"p\">;</span>\n\n<span class=\"nf\">#search-area</span> <span class=\"p\">{</span>\n    <span class=\"nl\">margin-bottom</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"nc\">.search-input-area</span> <span class=\"p\">{</span>\n    <span class=\"nl\">position</span><span class=\"p\">:</span><span class=\"nb\">relative</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c\">/* 入力項目 */</span>\n<span class=\"nf\">#search-query</span> <span class=\"p\">{</span>\n    <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">0.7em</span> <span class=\"m\">2em</span><span class=\"p\">;</span>\n    <span class=\"nl\">width</span><span class=\"p\">:</span> <span class=\"m\">100%</span><span class=\"p\">;</span>\n    <span class=\"nl\">color</span><span class=\"p\">:</span> <span class=\"no\">black</span><span class=\"p\">;</span>\n    <span class=\"nl\">font-family</span><span class=\"p\">:</span> <span class=\"n\">arial</span><span class=\"p\">,</span><span class=\"nb\">sans-serif</span><span class=\"p\">;</span>\n    <span class=\"nl\">font-size</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n    <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">1px</span> <span class=\"nb\">solid</span> <span class=\"m\">#ccc</span><span class=\"p\">;</span>\n    <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">2em</span><span class=\"p\">;</span>\n    <span class=\"nl\">outline</span><span class=\"p\">:</span> <span class=\"m\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"nc\">.search-input-area</span> <span class=\"nt\">input</span><span class=\"nd\">:focus</span> <span class=\"p\">{</span>\n    <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">1px</span> <span class=\"nb\">solid</span> <span class=\"m\">#4d90fe</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c\">/* アイコンは入力項目の左と右に配置する */</span>\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.left-icon</span><span class=\"o\">,</span>\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.right-icon</span> <span class=\"p\">{</span>\n    <span class=\"c\">/* 縦方向の中央寄せ */</span>\n    <span class=\"nl\">position</span><span class=\"p\">:</span><span class=\"nb\">absolute</span><span class=\"p\">;</span>\n    <span class=\"nl\">top</span><span class=\"p\">:</span> <span class=\"m\">50%</span><span class=\"p\">;</span>\n    <span class=\"nl\">margin-top</span><span class=\"p\">:</span> <span class=\"m\">-0.5em</span><span class=\"p\">;</span>\n    <span class=\"py\">font-sise</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n    <span class=\"c\">/* 要素にマウスを合わせたら、マウスポインタのマークを変える */</span>\n    <span class=\"nl\">cursor</span><span class=\"p\">:</span><span class=\"nb\">pointer</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.left-icon</span> <span class=\"p\">{</span>\n    <span class=\"nl\">left</span><span class=\"p\">:</span> <span class=\"m\">0.7em</span><span class=\"p\">;</span>\n    <span class=\"nl\">color</span><span class=\"p\">:</span><span class=\"m\">#444</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.right-icon</span> <span class=\"p\">{</span>\n    <span class=\"nl\">right</span><span class=\"p\">:</span> <span class=\"m\">0.7em</span><span class=\"p\">;</span>\n    <span class=\"c\">/* 最初は、グレーアウトしておく */</span>\n    <span class=\"nl\">color</span><span class=\"p\">:</span> <span class=\"m\">#ccc</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c\">/* アイコンにマウスを合わせたら、サイズを大きくする */</span>\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.left-icon</span><span class=\"nd\">:hover</span><span class=\"o\">,</span>\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.right-icon</span><span class=\"nd\">:hover</span> <span class=\"p\">{</span>\n    <span class=\"nl\">font-size</span><span class=\"p\">:</span> <span class=\"m\">1.4em</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.left-icon</span><span class=\"nd\">:hover</span> <span class=\"p\">{</span>\n    <span class=\"nl\">left</span><span class=\"p\">:</span> <span class=\"m\">0.5em</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"nc\">.search-input-area</span> <span class=\"nc\">.right-icon</span><span class=\"nd\">:hover</span> <span class=\"p\">{</span>\n    <span class=\"nl\">right</span><span class=\"p\">:</span> <span class=\"m\">0.5em</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"c\">/* 検索結果表示時に適用するスタイル */</span>\n<span class=\"nf\">#search-result-area</span><span class=\"nc\">.show</span> <span class=\"p\">{</span>\n    <span class=\"nl\">background</span><span class=\"p\">:</span> <span class=\"m\">#f8f8f7</span><span class=\"p\">;</span>\n    <span class=\"nl\">border</span><span class=\"p\">:</span> <span class=\"m\">0px</span> <span class=\"nb\">solid</span><span class=\"p\">;</span>\n    <span class=\"nl\">border-radius</span><span class=\"p\">:</span> <span class=\"m\">0.5em</span><span class=\"p\">;</span>\n    <span class=\"nl\">margin-top</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n    <span class=\"nl\">margin-bottom</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n    <span class=\"nl\">padding</span><span class=\"p\">:</span> <span class=\"m\">1em</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n</pre></div>\n</div>\n\n<h3>\n<span id=\"ドキュメントに全文検索用資産の読み込み処理を追加\" class=\"fragment\"></span><a href=\"#%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88%E3%81%AB%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E7%94%A8%E8%B3%87%E7%94%A3%E3%81%AE%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E5%87%A6%E7%90%86%E3%82%92%E8%BF%BD%E5%8A%A0\"><i class=\"fa fa-link\"></i></a>ドキュメントに全文検索用資産の読み込み処理を追加</h3>\n\n<p>前手順でドキュメント用Webサーバに配置した<code>full-text-search.js</code>と<code>full-text-search.css</code>を、<br>\n各ドキュメントから読み込むようにします。<br>\n<code>full-text-search.js</code>はjQueryに依存しているので、<br>\n既存のドキュメントで読み込んでいない場合はjQueryも読み込みも追加してください。</p>\n\n<p>ドキュメント用Webサーバがこのようなフォルダ構成だとしたら、</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>ドキュメント用Webサーバのドキュメントルート\n├── full-text-search.css\n├── full-text-search.js\n└── asciidoctor-sample\n    └── asciidoctor-sample.html\n</pre></div></div>\n\n<p><code>asciidoctor-sample.adoc</code>には下記を追加します。</p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>++++\n&lt;link rel=\"stylesheet\" href=\"../full-text-search.css\"&gt;&lt;/link&gt;\n&lt;script\n  src=\"https://code.jquery.com/jquery-3.2.1.min.js\"\n  integrity=\"sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=\"\n  crossorigin=\"anonymous\"&gt;&lt;/script&gt;\n&lt;script src=\"../full-text-search.js\"&gt;&lt;/script&gt;\n++++\n</pre></div></div>\n\n<h3>\n<span id=\"全文検索ができるかの確認\" class=\"fragment\"></span><a href=\"#%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%81%8C%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%8B%E3%81%AE%E7%A2%BA%E8%AA%8D\"><i class=\"fa fa-link\"></i></a>全文検索ができるかの確認</h3>\n\n<p>以上の手順を実施すると、Asdciidoctorで全文検索ができるようになります。<br>\nドキュメントをブラウザで見ると、目次上部に検索窓が追加されています。<br>\n<a href=\"https://camo.qiitausercontent.com/daf3699de0e01b28ba4d3c2a8b8b535d3c54a2ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39393039336364362d353865382d376364652d613364382d3562656332613032303636382e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/daf3699de0e01b28ba4d3c2a8b8b535d3c54a2ab/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f39393039336364362d353865382d376364652d613364382d3562656332613032303636382e706e67\" alt=\"7_全文検索イメージ_1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/99093cd6-58e8-7cde-a3d8-5bec2a020668.png\"></a><br>\n<br></p>\n\n<p>検索条件を入力し、虫眼鏡アイコンをクリックすると、検索結果が表示されます。<br>\n<a href=\"https://camo.qiitausercontent.com/5d8e0c5f2db223d5f021d484351b0c840010bb4f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f63646533643865612d643838332d613636622d663838642d3961353934313032366263392e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://camo.qiitausercontent.com/5d8e0c5f2db223d5f021d484351b0c840010bb4f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e616d617a6f6e6177732e636f6d2f302f34393931352f63646533643865612d643838332d613636622d663838642d3961353934313032366263392e706e67\" alt=\"7_全文検索イメージ_2.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/49915/cde3d8ea-d883-a66b-f88d-9a5941026bc9.png\"></a><br>\n<br></p>\n\n<h2>\n<span id=\"まとめ\" class=\"fragment\"></span><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"><i class=\"fa fa-link\"></i></a>まとめ</h2>\n\n<p>FessのREST APIを使用してAsciidoctorで全文検索できるようにする方法を紹介しました。<br>\nFessのREST APIを使えば、Asciidoctorに限らず、様々なシステムに全文検索機能を導入できそうです。</p>\n\n<h2>\n<span id=\"参考\" class=\"fragment\"></span><a href=\"#%E5%8F%82%E8%80%83\"><i class=\"fa fa-link\"></i></a>参考</h2>\n\n<ul>\n<li><a href=\"http://fess.codelibs.org/ja/articles/article-4.html#js\" rel=\"nofollow noopener\" target=\"_blank\">Fess で作るApache Solrベースの検索サーバー 〜 REST API 編</a></li>\n<li><a href=\"http://qiita.com/cookienote/items/1f2443be25630a78d946\" id=\"reference-69c989703115d994be84\">全文検索サーバー Fess を Docker で動かす</a></li>\n</ul>\n","body":"[Asciidoctor](http://asciidoctor.org/)を使うと、技術文書や手順書などのドキュメントを簡単にHTMLで公開できますが、ドキュメントが多くなると自分の調べたいキーワードが、どのドキュメントに載っているのか探すのが困難になってきます。\n\nそこで今回は、Dockerで全文検索サーバの[Fess](http://fess.codelibs.org/ja/)を立てて、\nドキュメントからJavaScript経由でFessのJSON APIを呼び出すことで、\n全文検索を簡単に導入する方法をご紹介します。\n\n導入するとドキュメントの右上に検索窓が出てきて全文検索できるようになります。\n![6月-24-2017 19-05-32.gif](https://qiita-image-store.s3.amazonaws.com/0/49915/123ec771-fb77-e4dc-df7e-a4b407792759.gif \"6月-24-2017 19-05-32.gif\")\n\n\n## Fessとは\n[Fess](http://fess.codelibs.org/ja/)は**「5 分で簡単に構築可能な全文検索サーバー」**です。\nJavaベースで構築されており、Apacheライセンスで提供されるオープンソース製品で、無料で使用できます。\n自分でクローラを設定して、自分だけの検索エンジンがつくれるようなイメージです。\nデフォルトで検索画面を提供していますが、JSON APIも提供しているので、様々なシステムと連携可能です。\n\n\n## 全体像\nドキュメント用Webサーバに全文検索用のJavaScriptファイルとCSSファイルを追加し、Dockerで全文検索用のFessサーバを立てます。\nFessサーバはドキュメント用Webサーバをクロールし、その情報を保存しておきます。\nドキュメントで全文検索を実施すると、JavaScript経由でFessサーバのJSON AIPを呼び出して、全文検索結果をドキュメントに表示します。\n\n![0_Fess_全体像_1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/10c8ac46-2155-8eb7-a5ed-7c13ce544ec2.png)\n\n![0_Fess_全体像_2.png](https://qiita-image-store.s3.amazonaws.com/0/49915/40e1d456-2635-2aed-333d-8b1aec447931.png)\n\n## 導入手順\nこの導入手順は、下記のような環境\u001c（ローカルPCのDocker上にドキュメント用WebサーバとFessサーバが立っている環境）を作った時のものです。\nDockerを使わなくても、ローカルPC以外でも、導入可能です。導入手順は適宜読み替えてください。\n\n![0_Fess_全体像_3.png](https://qiita-image-store.s3.amazonaws.com/0/49915/0badb8d2-1a58-22b6-457c-12becf3a8911.png)\n\n\n### Fessのインストール\nDocker Hubの[codelibs/fess](https://hub.docker.com/r/codelibs/fess/)を使用します。今回ポートは10084で公開します。\nDockerを使わない場合は[Fess インストールガイド](http://fess.codelibs.org/ja/11.2/install/index.html)を参考にしてください。\n\n```\n$ docker run -d -p 10084:8080 --name fess codelibs/fess:latest\n```\n\n### Fessの設定\n#### クローラの設定\n`http://[PCのローカルIPアドレス]:10084/login`にアクセスするとログイン画面が表示されます。\nデフォルトのID/PASS　`admin/admin`でログインしましょう。\n![1_Fess管理者_ログイン画面.png](https://qiita-image-store.s3.amazonaws.com/0/49915/e790eca9-5073-948e-3e43-d7546d57fae5.png)\n<br/>\n\nログインするとダッシュボードが表示されます。左ペインの`クローラ` > `Web`　を選択しましょう。\n![2_Fess管理者_ダッシュボード.png](https://qiita-image-store.s3.amazonaws.com/0/49915/acfbe950-fa74-d0cb-3cee-5e8db4de5b74.png)\n<br/>\n\nWebクローラにはまだ何も登録されていないので、左上の`+　新規作成`ボタンをクリックしましょう。\n![3_Fess管理者_Webクロール設定_1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/631037b4-aab2-8e0d-f9aa-3d23ec917a29.png)\n<br/>\n\nWebクロール情報入力画面が表示されます。\n![3_Fess管理者_Webクロール設定_2.png](https://qiita-image-store.s3.amazonaws.com/0/49915/ee5a09c9-7cce-3fec-7884-1258c32fa91a.png \"3_Fess管理者_Webクロール設定_2.png\")\n\n設定項目は色々ありますが、とりあえず下記項目だけ設定しましょう。\n\n* 名前 \n    * 任意の名前を設定してください。\n* URL \n    * ドキュメント用Webサーバにおいてドキュメントが格納されているルートフォルダのURLを指定してください。末尾に`/`を付けてください。\n* クロール対象とするURL \n    * 正規表現で値を設定します。上記`URL`で設定したルートフォルダ配下の全資産を対象とするために、`URLで設定した値` + `.*` を指定してください。\n* 検索対象とするURL\n   * 正規表現で値を設定します。HTMLのみを検索対象にしたい（JS、CSSなどは除外したい）ので、`URLで設定した値` + `.+\\.html$` を指定してください。\n<br/>\n<br/>\n\n\n値を設定したら、画面を下にスクロールして`+　作成`ボタンをクリックします。\nすると下記のようにWebクロールのデータが１件登録されます。\n![3_Fess管理者_Webクロール設定_4.png](https://qiita-image-store.s3.amazonaws.com/0/49915/3d00bf5a-f131-d367-de53-af10bb36839d.png)\n<br/>\n\n\n#### クローラの実行\n左ペインで　`システム` > `スケジューラ` を選択してジョブスケジューラを開きます。\nジョブスケジューラで `Default Crawler`を選択します。\n![4_Fess管理者_スケジューラ_1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/b0aeca0d-64a4-43da-782b-0a1a0cd70b83.png)\n<br/>\n\n`今すぐ開始`をクリックします。\n![4_Fess管理者_スケジューラ_1.1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/00e76920-bfad-eeb1-cb99-724e3a9392a9.png \"4_Fess管理者_スケジューラ_1.1.png\")\n<br/>\n\nするとクロールが実行されます。\n![4_Fess管理者_スケジューラ_2.png](https://qiita-image-store.s3.amazonaws.com/0/49915/725d300f-07f5-724d-ce93-8e1c9752e10e.png)\n<br/>\n\nしばらくして`F5`キーを押してブラウザを更新してください。\nクロールが終了すると、スケジューラの状態が`実行中`から`有効`になります。\n![4_Fess管理者_スケジューラ_3.png](https://qiita-image-store.s3.amazonaws.com/0/49915/ee4f5277-aac3-ad7e-cdeb-41d39b733c1f.png)\n<br/>\n\n\n#### クローラ実行結果の確認\n左ペインの`システム情報`>`クロール情報`を選択すると、先ほど実行したクロールの結果が表示されています。その行を選択します。\n![5_Fess管理者_システム情報_クロール情報_1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/92f310b5-83f6-deda-448d-afa8c5b0f104.png \"5_Fess管理者_システム情報_クロール情報_1.png\")\n<br/>\n\n\nセッションIDを選択します。\n![5_Fess管理者_システム情報_クロール情報_2.png](https://qiita-image-store.s3.amazonaws.com/0/49915/4e80cd14-3634-f665-b448-8b4b4e7a8d21.png \"5_Fess管理者_システム情報_クロール情報_2.png\")\n<br/>\n\nここにドキュメント用Webサーバのドキュメントが全て表示されればOKです。\n![5_Fess管理者_システム情報_クロール情報_3.png](https://qiita-image-store.s3.amazonaws.com/0/49915/60b86bc4-f70f-42c8-a017-5f138b3b88e3.png \"5_Fess管理者_システム情報_クロール情報_3.png\")\n<br/>\n\n### ドキュメント用Webサーバに全文検索用資産を配置\n全文検索用の資産は`full-text-search.js`と`full-text-search.css`の２つです。\n`full-text-search.js`の変数 FESS_JSON_ENDPOINT(FESSサーバのJSON APIのエンドポイント) は適時置き換えてください。\nこれらの資産をドキュメント用Webサーバのドキュメントのルートフォルダ直下に配置してください。\n\n```javascript:full-text-search.js\n$(function() {\n    'use strict';\n\n    // FESSサーバのJSON APIのエンドポイント（FessサーバのIPアドレス + /json）\n    var FESS_JSON_ENDPOINT = 'http://192.168.1.5:10084/json';\n\n    // １ページあたりの検索結果表示件数\n    var COUNT_PAR_PAGE = 10;\n\n\n    // 目次の\n    $('#toc')\n        // 一番上に検索条件入力エリアを挿入\n        .prepend(\n            '<div id=\"search-area\">' +\n                '<form id=\"search-form\">' +\n                    '<div class=\"search-input-area\">' +\n                        '<i class=\"fa fa-search left-icon\"></i>' +\n                        '<input id=\"search-query\" placeholder=\"全文検索\" />' +\n                        '<i class=\"fa fa-close right-icon\"></i>' +\n                    '</div>' +\n                    '<input id=\"search-start\" type=\"hidden\" value=\"0\"/>' +\n                    '<input id=\"search-num\" type=\"hidden\" value=\"' + COUNT_PAR_PAGE + '\"/>' +\n                '<form>' +\n            '</div>')\n        // イベント登録\n        .ready(function() {\n            var $searchArea = $(this);\n\n            // 入力項目の検索条件でEnterを押したら、検索処理を実行する\n            $searchArea.find('#search-form').submit({navi:0}, doSearch);\n\n            // 虫眼鏡アイコン押下したら、検索処理を実行する\n            $searchArea.find(\".left-icon\").click({navi:0}, doSearch);\n\n            // 検索条件入力したら、\n            $searchArea.find(\"#search-query\").keyup(function(){\n              var $this = $(this);\n              var $rightIcon = $this.parent().find(\".right-icon\");\n\n              if($this.val().length > 0) {\n                 // 検索条件に値がある場合は×アイコンの色を濃くする\n                 $rightIcon.css('color','#555');\n              } else {\n                 // 検索条件に値がない場合は×アイコンの色を薄くする\n                 $rightIcon.css('color','#ccc');\n              }\n            });\n\n            // ×アイコン押下したら、\n            $searchArea.find(\".right-icon\").click(function(){\n              // ×アイコンの色を薄くして\n              $(this).css('color','#ccc')\n                      // 検索条件をクリアする\n                     .parent().find(\"input\").val('');\n            });\n        });\n\n    // ドキュメントタイトルの\n    $('#header>h1')\n        // 直下に検索結果エリアを挿入\n        .before(\n            '<div id=\"search-result-area\">' +\n                '<div id=\"search-result-subheader\"></div>' +\n                '<div id=\"search-result-content\"></div>' +\n            '</div>')\n        // イベント登録\n        .ready(function() {\n            $(this)\n                .find('#search-result-area')\n                    // 検索結果エリアのバツアイコンをクリックしたら、\n                    .on(\"click\", '#remove-search-result', function(e) {\n                      var $searchResultArea = $(e.delegateTarget)\n                      // 検索結果エリアを非表示モードにする\n                      $searchResultArea.removeClass('show');\n                      // 検索結果エリアの中身を削除する\n                      $searchResultArea.find('#search-result-subheader').empty();\n                      $searchResultArea.find('#search-result-content').empty();\n                    })\n                    // 前ページリンクをクリックしたら、１ページ前を検索する\n                    .on(\"click\", \"#prevPageLink\", {navi:-1}, doSearch)\n                    // 次ページリンクをクリックしたら、１ページ後を検索する\n                    .on(\"click\", \"#nextPageLink\", {navi:1}, doSearch);\n        });\n\n\n\n    /**\n     * 検索処理\n     *\n     * @param  {eventObject} event\n     * @return {boolean}  submit処理を中断させるために必ずfalseを返却する\n     */\n    function doSearch(event){\n      // 検索フィールドの値をトリムして取得\n      var searchQuery = $.trim($('#search-query').val());\n      // 空の場合は検索処理を実行しない\n      if(searchQuery.length == 0) {\n        return false;\n      }\n\n\n      // 表示開始位置、表示件数の取得\n      var start = parseInt($('#search-start').val()),\n          num = parseInt($('#search-num').val());\n      // 表示開始位置のチェック\n      if(start < 0) {\n        start = 0;\n      }\n      // 表示件数のチェック\n      if(num < 1 || num > 100) {\n        num = 20;\n      }\n      // 表示ページ情報の取得\n      switch(event.data.navi) {\n        case -1:\n          // 前のページの場合\n          start -= num;\n          break;\n        case 1:\n          // 次のページの場合\n          start += num;\n          break;\n        default:\n        case 0:\n          start = 0;\n          break;\n      }\n\n\n      // URLを構築\n      var url = FESS_JSON_ENDPOINT + '?callback=?' + // 別ドメインを想定してJSONP形式でリクエストを送信する\n                                     '&q=' + encodeURIComponent(searchQuery) +\n                                     '&start=' + start +\n                                     '&num=' + num;\n\n      // 検索リクエスト送信\n      // 別ドメインを想定してJSONP形式でリクエストを送信する\n      $.ajax({\n          url: url,\n          dataType: 'jsonp',\n          success: renderSearchResult\n      });\n\n\n      // ページ情報の更新\n      $('#searchNum').val(num);\n\n      // ページ表示を上部に移動\n      $(document).scrollTop(0);\n\n      // サブミットを抑止するためにfalseを返す\n      return false;\n    };\n\n\n    /**\n     * 検索成功時に検索結果を描画する\n     *\n     * @param  {Anything} data レスポンスデータ\n     */\n    function renderSearchResult(data) {\n      // 検索結果処理\n      var dataResponse = data.response;\n      // ステータスチェック\n      if(dataResponse.status != 0) {\n        alert(\"検索中に問題が発生しました。\");\n        return;\n      }\n\n      // 検索結果領域を表示する\n      $('#search-result-area').addClass('show');\n\n      var $searchResultSubheader = $('#search-result-subheader'),\n          $searchResultContent = $('#search-result-content'),\n          record_count = dataResponse.record_count;\n\n      // 検索結果がない場合\n      if(record_count == 0) {\n        // サブヘッダーに出力\n        $searchResultSubheader[0].innerHTML =  '<div id=\"remove-search-result\" style=\"float:right;\"><i class=\"fa fa-times\"></i></div>';\n\n        // 結果領域に出力\n        $searchResultContent[0].innerHTML = '<b>' + dataResponse.q + '</b>に一致する情報は見つかりませんでした。';\n\n        return;\n      }\n\n\n      // 検索にヒットした場合\n      var page_number = dataResponse.page_number,\n          page_size = dataResponse.page_size,\n          page_count = dataResponse.page_count,\n          startRange = (page_number - 1) * page_size + 1,\n          endRange = page_number * page_size,\n          i = 0,\n          max,\n          offset = startRange - 1;\n\n      $('#search-start').val(offset);\n\n\n      // サブヘッダーに出力\n      $searchResultSubheader[0].innerHTML = '<b>' + dataResponse.q + '</b> の検索結果 ' +\n                                record_count + \" 件中 \" +  startRange + ' - ' +\n                                endRange + ' 件目 (' + dataResponse.exec_time + ' 秒)' +\n                               '<div id=\"remove-search-result\" style=\"float:right;\"><i class=\"fa fa-times\"></i></div>'\n\n      // 検索結果領域のクリア\n      $searchResultContent.empty();\n\n\n      // 検索結果の出力\n      var $resultBody = $(\"<ol/>\");\n      var results = dataResponse.result;\n      for(i = 0, max = results.length; i < max; i++) {\n        var element =\n            '<li>' +\n                '<h4 class=\"title\">' +\n                    '<a href=\"' +results[i].url_link + '\">' + results[i].title + '</a>' +\n                '</h4>' +\n                '<div class=\"body\">' +\n                    results[i].content_description +\n                    '<br/>' +\n                    '<cite>' + results[i].site + '</cite>' +\n                '</div>' +\n            '</li>';\n\n        $(element).appendTo($resultBody);\n      }\n      $resultBody.appendTo($searchResultContent);\n\n\n      // ページ番号情報の出力\n      var pageArea = [];\n      pageArea.push('<div id=\"pageInfo\">', page_number, 'ページ目<br/>');\n      if(page_number > 1) {\n        // 前のページへのリンク\n        pageArea.push('<a id=\"prevPageLink\" href=\"#\">&lt;&lt;前ページへ</a> ');\n      }\n      if(page_number < page_count) {\n        // 次のページへのリンク\n        pageArea.push('<a id=\"nextPageLink\" href=\"#\">次ページへ&gt;&gt;</a>');\n      }\n      pageArea.push('</div>');\n      $(pageArea.join(\"\")).appendTo($searchResultContent);\n    }\n});\n\n```\n\n\n```css:full-text-search.css\n@charset \"UTF-8\";\n\n#search-area {\n    margin-bottom: 1em;\n}\n\n.search-input-area {\n    position:relative;\n}\n\n/* 入力項目 */\n#search-query {\n    padding: 0.7em 2em;\n    width: 100%;\n    color: black;\n    font-family: arial,sans-serif;\n    font-size: 1em;\n    border: 1px solid #ccc;\n    border-radius: 2em;\n    outline: 0;\n}\n\n.search-input-area input:focus {\n    border: 1px solid #4d90fe;\n}\n\n/* アイコンは入力項目の左と右に配置する */\n.search-input-area .left-icon,\n.search-input-area .right-icon {\n    /* 縦方向の中央寄せ */\n    position:absolute;\n    top: 50%;\n    margin-top: -0.5em;\n    font-sise: 1em;\n    /* 要素にマウスを合わせたら、マウスポインタのマークを変える */\n    cursor:pointer;\n}\n\n.search-input-area .left-icon {\n    left: 0.7em;\n    color:#444;\n}\n\n.search-input-area .right-icon {\n    right: 0.7em;\n    /* 最初は、グレーアウトしておく */\n    color: #ccc;\n}\n\n/* アイコンにマウスを合わせたら、サイズを大きくする */\n.search-input-area .left-icon:hover,\n.search-input-area .right-icon:hover {\n    font-size: 1.4em;\n}\n\n\n.search-input-area .left-icon:hover {\n    left: 0.5em;\n}\n\n\n.search-input-area .right-icon:hover {\n    right: 0.5em;\n}\n\n/* 検索結果表示時に適用するスタイル */\n#search-result-area.show {\n    background: #f8f8f7;\n    border: 0px solid;\n    border-radius: 0.5em;\n    margin-top: 1em;\n    margin-bottom: 1em;\n    padding: 1em;\n}\n\n```\n\n### ドキュメントに全文検索用資産の読み込み処理を追加\n前手順でドキュメント用Webサーバに配置した`full-text-search.js`と`full-text-search.css`を、\n各ドキュメントから読み込むようにします。\n`full-text-search.js`はjQueryに依存しているので、\n既存のドキュメントで読み込んでいない場合はjQueryも読み込みも追加してください。\n\nドキュメント用Webサーバがこのようなフォルダ構成だとしたら、\n\n```\nドキュメント用Webサーバのドキュメントルート\n├── full-text-search.css\n├── full-text-search.js\n└── asciidoctor-sample\n    └── asciidoctor-sample.html\n```\n\n\n`asciidoctor-sample.adoc`には下記を追加します。\n\n```\n++++\n<link rel=\"stylesheet\" href=\"../full-text-search.css\"></link>\n<script\n  src=\"https://code.jquery.com/jquery-3.2.1.min.js\"\n  integrity=\"sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=\"\n  crossorigin=\"anonymous\"></script>\n<script src=\"../full-text-search.js\"></script>\n++++\n```\n\n### 全文検索ができるかの確認\n以上の手順を実施すると、Asdciidoctorで全文検索ができるようになります。\nドキュメントをブラウザで見ると、目次上部に検索窓が追加されています。\n![7_全文検索イメージ_1.png](https://qiita-image-store.s3.amazonaws.com/0/49915/99093cd6-58e8-7cde-a3d8-5bec2a020668.png)\n<br/>\n\n検索条件を入力し、虫眼鏡アイコンをクリックすると、検索結果が表示されます。\n![7_全文検索イメージ_2.png](https://qiita-image-store.s3.amazonaws.com/0/49915/cde3d8ea-d883-a66b-f88d-9a5941026bc9.png)\n<br/>\n\n\n## まとめ\nFessのREST APIを使用してAsciidoctorで全文検索できるようにする方法を紹介しました。\nFessのREST APIを使えば、Asciidoctorに限らず、様々なシステムに全文検索機能を導入できそうです。\n\n\n## 参考\n* [Fess で作るApache Solrベースの検索サーバー 〜 REST API 編](http://fess.codelibs.org/ja/articles/article-4.html#js)\n* [全文検索サーバー Fess を Docker で動かす](http://qiita.com/cookienote/items/1f2443be25630a78d946)\n\n","comments_count":0,"created_at":"2017-06-26T00:21:37+09:00","likes_count":21,"reactions_count":0}}}